"use strict";(globalThis.webpackChunkkairos_docs=globalThis.webpackChunkkairos_docs||[]).push([[1954],{28453:(e,t,s)=>{s.d(t,{R:()=>n,x:()=>r});var o=s(96540);const a={},i=o.createContext(a);function n(e){const t=o.useContext(i);return o.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function r(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:n(e.components),o.createElement(i.Provider,{value:t},e.children)}},72009:(e,t,s)=>{s.r(t),s.d(t,{assets:()=>l,contentTitle:()=>r,default:()=>h,frontMatter:()=>n,metadata:()=>o,toc:()=>d});const o=JSON.parse('{"id":"Upgrade/boot_assessment","title":"Boot assessment","description":"Learn how Kairos handles failed upgrades","source":"@site/versioned_docs/version-3.6.0/Upgrade/boot_assessment.md","sourceDirName":"Upgrade","slug":"/Upgrade/boot_assessment","permalink":"/kairos-docs/docs/3.6.0/Upgrade/boot_assessment","draft":false,"unlisted":false,"editUrl":"https://github.com/kairos-io/kairos-docs/tree/main/versioned_docs/version-3.6.0/Upgrade/boot_assessment.md","tags":[],"version":"3.6.0","lastUpdatedBy":"Jasper De Keukelaere (imec)","lastUpdatedAt":1765142882000,"sidebarPosition":7,"frontMatter":{"title":"Boot assessment","sidebar_label":"Boot assessment","sidebar_position":7,"date":"2024-09-17T00:00:00.000Z","description":"Learn how Kairos handles failed upgrades"},"sidebar":"tutorialSidebar","previous":{"title":"Trusted Boot","permalink":"/kairos-docs/docs/3.6.0/Upgrade/trustedboot"},"next":{"title":"Reference","permalink":"/kairos-docs/docs/3.6.0/category/reference"}}');var a=s(74848),i=s(28453);const n={title:"Boot assessment",sidebar_label:"Boot assessment",sidebar_position:7,date:new Date("2024-09-17T00:00:00.000Z"),description:"Learn how Kairos handles failed upgrades"},r=void 0,l={},d=[{value:"Automatic reboot in case of a kernel panic",id:"automatic-reboot-in-case-of-a-kernel-panic",level:2},{value:"Automatic reboot in case of systemd crash",id:"automatic-reboot-in-case-of-systemd-crash",level:2},{value:"Booting to fallback",id:"booting-to-fallback",level:2},{value:"Validating the image signatures (Trusted boot installations)",id:"validating-the-image-signatures-trusted-boot-installations",level:2}];function c(e){const t={a:"a",code:"code",h2:"h2",li:"li",p:"p",ul:"ul",...(0,i.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(t.p,{children:"Kairos upgrades are atomic in the sense that the new version of the OS fully\nreplaces the old one or it doesn't replace it at all. This allows users to test\nthe upgrade in the lab, before they upgrade any of their nodes and be sure that\nthe upgrade will work the same way in production."}),"\n",(0,a.jsx)(t.p,{children:"While this is very useful strategy, failed upgrades cannot be completely avoided.\nSome difference in hardware, a network hick-up or even a human error, can result\nin a failed upgrade. For systems in remote locations, upgrading to a non-bootable\nOS is one of the worst scenarios."}),"\n",(0,a.jsx)(t.p,{children:"For this reason, Kairos is taking various measures to minimize the possibility of\na non-bootable system. This section describes those measure and how they work."}),"\n",(0,a.jsx)(t.h2,{id:"automatic-reboot-in-case-of-a-kernel-panic",children:"Automatic reboot in case of a kernel panic"}),"\n",(0,a.jsxs)(t.ul,{children:["\n",(0,a.jsxs)(t.li,{children:["\n",(0,a.jsxs)(t.p,{children:["Simple installations:\nBy default, Kairos adds ",(0,a.jsx)(t.code,{children:"panic=5"})," to the kernel cmdline. This instructs the kernel to reboot after 5 seconds if a panic occurs."]}),"\n"]}),"\n",(0,a.jsxs)(t.li,{children:["\n",(0,a.jsxs)(t.p,{children:['"Trusted boot" installations:\nThe same option are included in ',(0,a.jsx)(t.a,{href:"https://github.com/kairos-io/AuroraBoot/blob/5d5bd2742520d654cd1bb865864acc3d37c43e57/pkg/constants/constants.go#L77",children:"the default cmdline"}),", when an image is built with aurorabootk(",(0,a.jsx)(t.a,{href:"../../Installation/trustedboot",children:"trusted boot docs"}),")."]}),"\n"]}),"\n"]}),"\n",(0,a.jsx)(t.h2,{id:"automatic-reboot-in-case-of-systemd-crash",children:"Automatic reboot in case of systemd crash"}),"\n",(0,a.jsxs)(t.ul,{children:["\n",(0,a.jsxs)(t.li,{children:["\n",(0,a.jsxs)(t.p,{children:["Simple installations:\nBy default, Kairos adds ",(0,a.jsx)(t.code,{children:"rd.shell=0 systemd.crash_reboot=yes"})," to the kernel cmdline. This makes systemd restart in case it crashes (",(0,a.jsx)(t.a,{href:"https://www.freedesktop.org/software/systemd/man/249/systemd.html#systemd.crash_reboot",children:"Read more"}),")"]}),"\n"]}),"\n",(0,a.jsxs)(t.li,{children:["\n",(0,a.jsxs)(t.p,{children:['"Trusted boot" installations:\nThe same options are included in ',(0,a.jsx)(t.a,{href:"https://github.com/kairos-io/AuroraBoot/blob/5d5bd2742520d654cd1bb865864acc3d37c43e57/pkg/constants/constants.go#L77",children:"the default cmdline"}),", when an image is built with auroraboot (",(0,a.jsx)(t.a,{href:"../../Installation/trustedboot",children:"trusted boot docs"}),")."]}),"\n"]}),"\n"]}),"\n",(0,a.jsx)(t.h2,{id:"booting-to-fallback",children:"Booting to fallback"}),"\n",(0,a.jsxs)(t.ul,{children:["\n",(0,a.jsxs)(t.li,{children:["\n",(0,a.jsx)(t.p,{children:'Simple installations:\nIn the sections above, we described how Kairos configures the system so that it automatically reboots when a failure occurs.\nAdditionally, Kairos uses a combination of grub environment variables and sentinel files to detect that the failed boot,\noccurred after an upgrade. In that case, it sets the "fallback" boot entry as the default one.\nIn other words, if the system fails to boot after an upgrade, the system will reboot automatically to the previous version\nof Kairos (the one before the upgrade).'}),"\n"]}),"\n",(0,a.jsxs)(t.li,{children:["\n",(0,a.jsxs)(t.p,{children:['"Trusted boot" installations:\nWhile ',(0,a.jsx)(t.a,{href:"https://systemd.io/AUTOMATIC_BOOT_ASSESSMENT/",children:"a similar solution exists"})," in systemd to automatically reboot to a fallback entry, it's not yet implemented in Kairos. You can monitor ",(0,a.jsx)(t.a,{href:"https://github.com/kairos-io/kairos/issues/2864",children:"the tracking issue"})," for updates."]}),"\n"]}),"\n"]}),"\n",(0,a.jsx)(t.h2,{id:"validating-the-image-signatures-trusted-boot-installations",children:"Validating the image signatures (Trusted boot installations)"}),"\n",(0,a.jsxs)(t.p,{children:["When Kairos is installed ",(0,a.jsx)(t.a,{href:"../../Installation/trustedboot",children:"in trusted boot mode"}),", the OS image comes as a single signed file. The certificate signing the image has to be enrolled in the system's firmware database otherwise the system won't allow booting it. This is also true when Kairos is being upgraded to a new version (which is a new image). For this reason, when upgrading, the ",(0,a.jsx)(t.code,{children:"kairos-agent"})," will perform a check to see if the certificate that signs the new image is enrolled (and not blacklisted) in the firmware database. If not, the upgrade will be aborted to avoid a situation where booting is not possible."]})]})}function h(e={}){const{wrapper:t}={...(0,i.R)(),...e.components};return t?(0,a.jsx)(t,{...e,children:(0,a.jsx)(c,{...e})}):c(e)}}}]);