"use strict";(globalThis.webpackChunkkairos_docs=globalThis.webpackChunkkairos_docs||[]).push([[5190],{12865:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>r,default:()=>c,frontMatter:()=>s,metadata:()=>i,toc:()=>d});const i=JSON.parse('{"id":"Examples/cluster-setup/multi-node-p2p-ha-kubevip","title":"Self-coordinating P2P Multi-Node Cluster with High Availability and KubeVIP","description":"This guide walks through the process of deploying a highly-available, P2P self-coordinated k3s cluster with KubeVIP, which provides a high available Elastic IP for the control plane.","source":"@site/docs/Examples/cluster-setup/multi-node-p2p-ha-kubevip.md","sourceDirName":"Examples/cluster-setup","slug":"/Examples/cluster-setup/multi-node-p2p-ha-kubevip","permalink":"/kairos-docs/docs/next/Examples/cluster-setup/multi-node-p2p-ha-kubevip","draft":false,"unlisted":false,"editUrl":"https://github.com/kairos-io/kairos-docs/tree/main/docs/Examples/cluster-setup/multi-node-p2p-ha-kubevip.md","tags":[],"version":"current","lastUpdatedBy":"Jasper De Keukelaere (imec)","lastUpdatedAt":1765187035000,"frontMatter":{"title":"Self-coordinating P2P Multi-Node Cluster with High Availability and KubeVIP","sidebar_label":"Self-coordinating P2P multi-node cluster HA with KubeVIP","description":"This guide walks through the process of deploying a highly-available, P2P self-coordinated k3s cluster with KubeVIP, which provides a high available Elastic IP for the control plane."},"sidebar":"tutorialSidebar","previous":{"title":"Cluster Setup","permalink":"/kairos-docs/docs/next/category/cluster-setup"},"next":{"title":"Self-coordinating P2P multi-node cluster HA","permalink":"/kairos-docs/docs/next/Examples/cluster-setup/multi-node-p2p-ha"}}');var o=n(74848),a=n(28453);const s={title:"Self-coordinating P2P Multi-Node Cluster with High Availability and KubeVIP",sidebar_label:"Self-coordinating P2P multi-node cluster HA with KubeVIP",description:"This guide walks through the process of deploying a highly-available, P2P self-coordinated k3s cluster with KubeVIP, which provides a high available Elastic IP for the control plane."},r=void 0,l={},d=[];function u(e){const t={a:"a",admonition:"admonition",code:"code",p:"p",pre:"pre",...(0,a.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(t.admonition,{title:"Network",type:"warning",children:(0,o.jsx)(t.p,{children:"This feature is experimental and has only been tested on local setups. Run in production servers at your own risk.\nFeedback and bug reports are welcome, as we are improving the p2p aspects of Kairos."})}),"\n",(0,o.jsx)(t.admonition,{title:"K8s Distribution",type:"warning",children:(0,o.jsx)(t.p,{children:"This feature is only working with the k3s distribution."})}),"\n",(0,o.jsxs)(t.p,{children:["K3s is a lightweight Kubernetes distribution that is easy to install and operate. It's a great choice for small and edge deployments, but it can also be used to create a high-availability (HA) cluster with the help of ",(0,o.jsx)(t.a,{href:"https://kube-vip.io/",children:"KubeVIP"}),". In this guide, we'll walk through the process of deploying a highly-available k3s cluster with KubeVIP, which provides a high available ip for the control plane."]}),"\n",(0,o.jsx)(t.p,{children:"The first step is to set up the cluster. Kairos automatically deploys an HA k3s cluster with KubeVIP to provide a high available ip for the control plane. KubeVIP allows to setup an ElasticIP that is advertized in the node's network and, as managed as a daemonset in kubernetes it is already running in HA."}),"\n",(0,o.jsx)(t.p,{children:"The difference between this setup is that we just use the p2p network to automatically co-ordinate nodes, while the connection of the cluster is not being routed to a VPN. The p2p network is used for co-ordination, self-management, and used to add nodes on day 2."}),"\n",(0,o.jsx)(t.p,{children:"In order to deploy this setup you need to configure the cloud-config file. You can see the example of the yaml file below. You need to configure the hostname, user and ssh_authorized_keys. You need also to configure kubevip with the elastic ip and the p2p network with the options you prefer."}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-yaml",children:'#cloud-config\n\nhostname: kairoslab-{{ trunc 4 .MachineID }}\nusers:\n- name: kairos\n  groups: [ "admin" ]\n  ssh_authorized_keys:\n  # Replace with your github user and un-comment the line below:\n  # - github:mudler\n\nkubevip:\n  eip: "192.168.1.110"\n\np2p:\n # Disabling DHT makes co-ordination to discover nodes only in the local network\n disable_dht: true #Enabled by default\n\n vpn:\n   create: false # defaults to true\n   use: false # defaults to true\n # network_token is the shared secret used by the nodes to co-ordinate with p2p.\n # Setting a network token implies auto.enable = true.\n # To disable, just set auto.enable = false\n network_token: ""\n\n # Automatic cluster deployment configuration\n auto:\n   # Enables Automatic node configuration (self-coordination)\n   # for role assignment\n   enable: true\n   # HA enables automatic HA roles assignment.\n   # A master cluster init is always required,\n   # Any additional master_node is configured as part of the \n   # HA control plane.\n   # If auto is disabled, HA has no effect.\n   ha:\n     # Enables HA control-plane\n     enable: true\n     # Number of HA additional master nodes.\n     # A master node is always required for creating the cluster and is implied.\n     # The setting below adds 2 additional master nodes, for a total of 3.\n     master_nodes: 2\n'})}),"\n",(0,o.jsxs)(t.p,{children:["When configuring the ",(0,o.jsx)(t.code,{children:"p2p"})," section, start by adding your desired ",(0,o.jsx)(t.code,{children:"network_token"})," under the p2p configuration in the cloud-config file. To generate a network token, see ",(0,o.jsx)(t.a,{href:"../../installation/p2p#network_token",children:"documentation"}),"."]}),"\n",(0,o.jsxs)(t.p,{children:["Next, set up an Elastic IP (",(0,o.jsx)(t.code,{children:"kubevip.eip"}),") with a free IP in your network. KubeVIP will advertise this IP, so make sure to select an IP that is available for use on your network."]}),"\n",(0,o.jsx)(t.p,{children:"In the VPN configuration, the create and use options are disabled, so the VPN setup is skipped and not used to route any traffic into."})]})}function c(e={}){const{wrapper:t}={...(0,a.R)(),...e.components};return t?(0,o.jsx)(t,{...e,children:(0,o.jsx)(u,{...e})}):u(e)}},28453:(e,t,n)=>{n.d(t,{R:()=>s,x:()=>r});var i=n(96540);const o={},a=i.createContext(o);function s(e){const t=i.useContext(a);return i.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function r(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:s(e.components),i.createElement(a.Provider,{value:t},e.children)}}}]);