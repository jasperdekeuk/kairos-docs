"use strict";(globalThis.webpackChunkkairos_docs=globalThis.webpackChunkkairos_docs||[]).push([[2468],{28453:(e,t,s)=>{s.d(t,{R:()=>r,x:()=>a});var o=s(96540);const i={},n=o.createContext(i);function r(e){const t=o.useContext(n);return o.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),o.createElement(n.Provider,{value:t},e.children)}},44991:(e,t,s)=>{s.r(t),s.d(t,{assets:()=>d,contentTitle:()=>a,default:()=>h,frontMatter:()=>r,metadata:()=>o,toc:()=>c});const o=JSON.parse('{"id":"Architecture/trustedboot","title":"Trusted Boot Architecture","description":"Trusted boot is a combination of technologies that allows us to enhance the security posture of a running system. It is composed by FDE, Secure Boot and Measured Boot.","source":"@site/versioned_docs/version-3.5.7/Architecture/trustedboot.md","sourceDirName":"Architecture","slug":"/Architecture/trustedboot","permalink":"/docs/3.5.7/Architecture/trustedboot","draft":false,"unlisted":false,"editUrl":"https://github.com/kairos-io/kairos-docs/tree/main/versioned_docs/version-3.5.7/Architecture/trustedboot.md","tags":[],"version":"3.5.7","lastUpdatedBy":"Jasper De Keukelaere (imec)","lastUpdatedAt":1765142882000,"sidebarPosition":6,"frontMatter":{"title":"Trusted Boot Architecture","sidebar_label":"Trusted Boot","sidebar_position":6,"date":"2022-11-13T00:00:00.000Z"},"sidebar":"tutorialSidebar","previous":{"title":"P2P Network","permalink":"/docs/3.5.7/Architecture/network"},"next":{"title":"Examples","permalink":"/docs/3.5.7/category/examples"}}');var i=s(74848),n=s(28453);const r={title:"Trusted Boot Architecture",sidebar_label:"Trusted Boot",sidebar_position:6,date:new Date("2022-11-13T00:00:00.000Z")},a=void 0,d={},c=[{value:"UKI and USI",id:"uki-and-usi",level:3},{value:"Building process",id:"building-process",level:3},{value:"Booting process",id:"booting-process",level:3},{value:"Booting system",id:"booting-system",level:3},{value:"User data encryption and key generation",id:"user-data-encryption-and-key-generation",level:3},{value:"Expanding the system with system extensions",id:"expanding-the-system-with-system-extensions",level:3},{value:"Trusted Boot - Boot Assessment",id:"trusted-boot---boot-assessment",level:3},{value:"Considerations",id:"considerations",level:3},{value:"Booting command lines",id:"booting-command-lines",level:4},{value:"References",id:"references",level:3}];function l(e){const t={a:"a",blockquote:"blockquote",code:"code",em:"em",h3:"h3",h4:"h4",img:"img",li:"li",ol:"ol",p:"p",strong:"strong",ul:"ul",...(0,n.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(t.p,{children:["Trusted boot is a combination of technologies that allows us to enhance the security posture of a running system. It is composed by FDE, Secure Boot and Measured Boot.\nTrusted boot is an architectural requirement of ",(0,i.jsx)(t.a,{href:"https://www.spectrocloud.com/product/sena",children:"SENA (Secure Edge Native Architecture)"})," and is a key component of Kairos."]}),"\n",(0,i.jsxs)(t.blockquote,{children:["\n",(0,i.jsxs)(t.p,{children:["You can read more about Trusted Boot in ",(0,i.jsx)(t.a,{href:"https://0pointer.de/blog/brave-new-trusted-boot-world.html",children:"https://0pointer.de/blog/brave-new-trusted-boot-world.html"})," and about SENA here: ",(0,i.jsx)(t.a,{href:"https://kairos.io/blog/2023/04/18/kairos-is-now-part-of-the-secure-edge-native-architecture-by-spectro-cloud-and-intel/",children:"https://kairos.io/blog/2023/04/18/kairos-is-now-part-of-the-secure-edge-native-architecture-by-spectro-cloud-and-intel/"})]}),"\n"]}),"\n",(0,i.jsx)(t.p,{children:'By combining Secure Boot, Measured Boot and FDE we can guarantee that a system was not tampered with, and the user-data is protected by cold attacks, we refer to this combination of technologies stacked together with "Trusted Boot" or "Trusted Boot Experience".'}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.em,{children:"FDE"})," stands for Full Disk Encryption. It is a security measure that encrypts the entire contents of a disk drive, including the operating system, system files, and user data. The purpose of FDE is to protect data stored on the disk from unauthorized access in the event of theft or loss of the device."]}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.em,{children:"Secure Boot"})," is a security feature in modern computer systems that ensures only properly signed and authenticated OSes are allowed to run during the boot process. It helps prevent the loading of malicious or unauthorized code at the early stages of the system startup, thus helping in protecting the integrity of the boot process."]}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.em,{children:"Measured Boot"}),', on the other hand, is a security mechanism that goes beyond Secure Boot. It involves creating a record, or "measurements," of each step in the boot process and storing these measurements in a specific hardware dedicated to cryptographically secure operations ( trusted platform module, or TPM) or a similar secure storage. This allows the system to verify the integrity of each component of the boot process and detect any unauthorized changes. Measured Boot provides a more comprehensive and continuous security check throughout the boot sequence.']}),"\n",(0,i.jsx)(t.h3,{id:"uki-and-usi",children:"UKI and USI"}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.a,{href:"https://uapi-group.org/specifications/specs/unified_kernel_image/",children:"UKI"})," is a specific file format tailored to achieve a tamper-proof system and encryption of user-data bound to the silicon by relying on HW capabilities."]}),"\n",(0,i.jsxs)(t.blockquote,{children:["\n",(0,i.jsxs)(t.p,{children:['UKI stands for "Unified Kernel Images". UKI files are a single, fat binary that encompasses the OS and the needed bits in order to boot the full system with a single, verified file. You can read technical details here: ',(0,i.jsx)(t.a,{href:"https://0pointer.de/blog/brave-new-trusted-boot-world.html",children:"Brave New Trusted Boot World"}),"."]}),"\n"]}),"\n",(0,i.jsx)(t.p,{children:"Trusted Boot in Kairos works by generating UKI images from container images. The UKI file is a single, fat binary that encompasses the OS and the needed bits in order to boot the full system with a single, verified file. This file can be used for upgrades and used as usual in the lifecycle of the Kairos node."}),"\n",(0,i.jsx)(t.p,{children:"The UKI file is signed with the Secure Boot keys, and the user-data is encrypted with the PCR policies. The UKI file is then loaded by the firmware and booted directly, without any second stage or system pivoting. This is why the UKI file can grow large, and why it requires a specific firmware that supports booting large EFI files."}),"\n",(0,i.jsxs)(t.p,{children:["Due to the design choice to not boot into a second stage, this is being refered nowadays as ",(0,i.jsx)(t.strong,{children:"USI"}),' (Unified System Image) instead of UKI, or more simply "Bootstrap Image". The benefits of using Unified system images in opposite of UKIs are that the system can be upgraded without the need of a second stage, and that the entire system is verified and signed.']}),"\n",(0,i.jsx)(t.h3,{id:"building-process",children:"Building process"}),"\n",(0,i.jsx)(t.p,{children:"Trusted Boot requires you to create a specific installable ISO file that includes the UKI files and a container image used for upgrades. Each time you upgrade a system, you must regenerate these assets using the same keys and then use the newly generated container image for the upgrade process."}),"\n",(0,i.jsx)(t.p,{children:"The UKI files are generated from container images as usual."}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{src:"https://github.com/kairos-io/kairos-docs/assets/2420543/2f49d592-9ae3-43ee-b22b-0313be455bf7",alt:"Trusted boot"})}),"\n",(0,i.jsxs)(t.p,{children:["The process to generate the installable medium is described in the ",(0,i.jsx)(t.a,{href:"./trustedboot",children:"Trustedboot installation documentation"}),". Internally we rely on the ",(0,i.jsx)(t.em,{children:"osbuilder"})," tool to generate all the installation artifacts from a single container image."]}),"\n",(0,i.jsx)(t.h3,{id:"booting-process",children:"Booting process"}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{src:"https://github.com/kairos-io/kairos-docs/assets/2420543/9c406796-b622-4571-abd5-b8d8fed44591",alt:"boot_1"})}),"\n",(0,i.jsx)(t.p,{children:"The booting process of an installed system with Trusted Boot is different from a standard Kairos installation, and can be split down in 4 steps:"}),"\n",(0,i.jsxs)(t.ol,{children:["\n",(0,i.jsxs)(t.li,{children:["The Firmware loads the ",(0,i.jsx)(t.code,{children:"systemd-boot"})," bootloader from the EFI partition"]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.code,{children:"systemd-boot"})," loads the UKI file from the EFI partition (that can be either the Active system, the passive or recovery system)"]}),"\n",(0,i.jsx)(t.li,{children:"The EFI system starts. The kernel and the initrd are loaded from the UKI file, and the kernel is booted with the command line specified in the UKI file."}),"\n",(0,i.jsxs)(t.li,{children:["The initrd will decrypt the user-data and mount the portions of it in the root filesystem. This includes for instance any changes to ",(0,i.jsx)(t.code,{children:"/etc"})," (like adding new users and passwords), ",(0,i.jsx)(t.code,{children:"/usr/local"}),", and all the mount bindpoints specified in the configuration file (see ",(0,i.jsx)(t.a,{href:"./customizing#bind-mounts",children:"Bind mount documentation"})," ). There is no second stage loaded and no system pivoting, the system is booted directly from the UKI file."]}),"\n"]}),"\n",(0,i.jsx)(t.h3,{id:"booting-system",children:"Booting system"}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{src:"https://github.com/kairos-io/kairos-docs/assets/2420543/757870d3-3b40-46ea-9c86-13c4a545f167",alt:"Trusted boot"})}),"\n",(0,i.jsxs)(t.p,{children:["There is no difference with a layout of a standard Kairos system (as explained in the ",(0,i.jsx)(t.a,{href:"./immutable",children:"Immutable OS"})," page), however in this setup now the partitions containing data are always encrypted:"]}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.a,{href:"https://github.com/kairos-io/packages/blob/528682cddf7191fb52580e7c41a33e73c1ee0001/packages/static/kairos-overlay-files/files/system/oem/00_rootfs_uki.yaml#L18",children:"List of persistent data path overlayed and encrypted"})," (see also ",(0,i.jsx)(t.a,{href:"./customizing#bind-mounts",children:"the bind mount documentation"})," to customize it with your own paths)."]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.code,{children:"/oem"})," encrypted"]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.code,{children:"/usr/local"})," encrypted"]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.code,{children:"/etc"})," ephemeral"]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.code,{children:"/usr"})," read only"]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.code,{children:"/"})," immutable"]}),"\n"]}),"\n",(0,i.jsx)(t.h3,{id:"user-data-encryption-and-key-generation",children:"User data encryption and key generation"}),"\n",(0,i.jsx)(t.p,{children:"It is required in order to generate USI images to have a set of keys and certificates. In order to understand why those keys are required, we need to understand how the user-data is encrypted and how the system is booted."}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{src:"https://github.com/kairos-io/kairos-docs/assets/2420543/725745a0-0ea6-4330-bea3-e6483f53cc3f",alt:"bootingkeys"})}),"\n",(0,i.jsxs)(t.p,{children:["The keys are used to sign the UKI file, and to generate a PCR policy keypair required later on by the system in order to decrypt the encrypted partitions. The keys and certificates are generated with the ",(0,i.jsx)(t.code,{children:"auroraboot"})," tool, that is available in the ",(0,i.jsx)(t.code,{children:"auroraboot"})," container image."]}),"\n",(0,i.jsx)(t.h3,{id:"expanding-the-system-with-system-extensions",children:"Expanding the system with system extensions"}),"\n",(0,i.jsxs)(t.p,{children:["Check the relevant documentation on how to ",(0,i.jsx)(t.a,{href:"./sys-extensions",children:"extend the system with system extensions"})," and how to ",(0,i.jsx)(t.a,{href:"./adding_opt_to_system_extensions",children:"use /opt with system extensions"}),"."]}),"\n",(0,i.jsx)(t.h3,{id:"trusted-boot---boot-assessment",children:"Trusted Boot - Boot Assessment"}),"\n",(0,i.jsxs)(t.p,{children:["See the ",(0,i.jsx)(t.a,{href:"./boot_assessment_trusted_boot",children:"Trusted Boot - Boot Assessment"})," documentation for more information on how to enable automatic boot assessment with Trusted Boot and how to make your own services participate in the boot assessment process."]}),"\n",(0,i.jsx)(t.h3,{id:"considerations",children:"Considerations"}),"\n",(0,i.jsx)(t.h4,{id:"booting-command-lines",children:"Booting command lines"}),"\n",(0,i.jsx)(t.p,{children:"UKI file's signatures are including also the kernel command line, so any change to the kernel command line will require a new UKI file to be generated and the installer image to be rebuilt. This implies that you cannot change the booting options once the system is installed (and the system won't be able to access the encrypted data)"}),"\n",(0,i.jsx)(t.h3,{id:"references",children:"References"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:(0,i.jsx)(t.a,{href:"https://uefi.org/sites/default/files/resources/UEFI_Spec_2_8_final.pdf",children:"UEFI specification"})}),"\n",(0,i.jsx)(t.li,{children:(0,i.jsx)(t.a,{href:"https://documentation.suse.com/sled/15-SP5/html/SLED-all/cha-uefi.html",children:"UEFI (SLE documentation)"})}),"\n",(0,i.jsx)(t.li,{children:(0,i.jsx)(t.a,{href:"https://cdrdv2-public.intel.com/671120/a-tour-beyond-bios-implementing-uefi-authenticated-variables-in-smm-with-edkii.pdf",children:"https://cdrdv2-public.intel.com/671120/a-tour-beyond-bios-implementing-uefi-authenticated-variables-in-smm-with-edkii.pdf"})}),"\n",(0,i.jsx)(t.li,{children:(0,i.jsx)(t.a,{href:"https://www.vut.cz/www_base/zav_prace_soubor_verejne.php?file_id=132208",children:"SUPPORT OF SECURE BOOT IN SYSTEMD-BOOT PROJECT"})}),"\n",(0,i.jsx)(t.li,{children:(0,i.jsx)(t.a,{href:"https://uapi-group.org/specifications/specs/unified_kernel_image/#file-format",children:"UKI file format"})}),"\n",(0,i.jsx)(t.li,{children:(0,i.jsx)(t.a,{href:"https://wiki.archlinux.org/title/Unified_Extensible_Firmware_Interface/Secure_Boot",children:"Secure Boot"})}),"\n"]}),"\n",(0,i.jsxs)(t.p,{children:["For more information about installing Kairos with Trusted Boot, see the ",(0,i.jsx)(t.a,{href:"./trustedboot",children:"Trusted Boot Installation Guide"}),"."]}),"\n",(0,i.jsxs)(t.p,{children:["For more information about customizing Kairos images, see the ",(0,i.jsx)(t.a,{href:"./customizing",children:"Customizing Images"})," guide."]}),"\n",(0,i.jsxs)(t.p,{children:["For more information about the immutable nature of Kairos, see the ",(0,i.jsx)(t.a,{href:"./immutable",children:"Immutable Architecture"})," guide."]}),"\n",(0,i.jsxs)(t.p,{children:["For more information about system extensions, see the ",(0,i.jsx)(t.a,{href:"./sys-extensions",children:"System Extensions"})," guide."]}),"\n",(0,i.jsxs)(t.p,{children:["For more informations about revoking certificates, see ",(0,i.jsx)(t.a,{href:"./../advanced/revoking-secureboot-access",children:"Revoking secure boot access"})]}),"\n",(0,i.jsxs)(t.p,{children:["For a complete example of boot assessment with Trusted Boot, see the ",(0,i.jsx)(t.a,{href:"./boot_assessment_trusted_boot",children:"Boot Assessment with Trusted Boot"})," guide."]})]})}function h(e={}){const{wrapper:t}={...(0,n.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(l,{...e})}):l(e)}}}]);