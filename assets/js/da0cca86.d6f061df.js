"use strict";(globalThis.webpackChunkkairos_docs=globalThis.webpackChunkkairos_docs||[]).push([[959],{28453:(e,n,t)=>{t.d(n,{R:()=>r,x:()=>i});var a=t(96540);const o={},s=a.createContext(o);function r(e){const n=a.useContext(s);return a.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:r(e.components),a.createElement(s.Provider,{value:n},e.children)}},44303:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>i,default:()=>h,frontMatter:()=>r,metadata:()=>a,toc:()=>d});var a=t(77979),o=t(74848),s=t(28453);const r={authors:["mauro-morales"],slug:"kairos-doorbell",tags:["kairos"],title:"How I Automated My Doorbell with Kairos (and You Can Too)"},i=void 0,l={authorsImageUrls:[void 0]},d=[{value:"Requirements",id:"requirements",level:2},{value:"Hardware",id:"hardware",level:2},{value:"Software",id:"software",level:2},{value:"System Image",id:"system-image",level:3},{value:"Telegram Bot",id:"telegram-bot",level:3},{value:"Python Script",id:"python-script",level:3},{value:"Dockerfile",id:"dockerfile",level:3},{value:"Kubernetes",id:"kubernetes",level:3},{value:"Conclusion",id:"conclusion",level:2}];function c(e){const n={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,s.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.p,{children:"Picture this: You\u2019re deep in focus, coding away, and the doorbell rings. Except\u2026 you never hear it. The mailman leaves, and now your package is on an adventure you didn't plan for. That\u2019s exactly what happened to me, so I did what any geek would do\u2014turn my dumb doorbell into a smart one using Kairos."}),"\n",(0,o.jsx)(n.admonition,{title:"Disclaimer",type:"warning",children:(0,o.jsx)(n.p,{children:"The information provided in this post is for educational and informational purposes only. I am not a professional electrician, engineer, or security expert. Any modifications to electrical systems, including doorbells, carry inherent risks, such as damage to property, malfunction, or personal injury. If you choose to follow the steps outlined here, you do so at your own risk. Always take proper safety precautions, consult professionals when necessary, and ensure compliance with local laws and regulations. I cannot be held liable for any consequences resulting from the use or misuse of the information in this post."})}),"\n",(0,o.jsx)(n.h2,{id:"requirements",children:"Requirements"}),"\n",(0,o.jsx)(n.p,{children:"For this setup I used the following hardware"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"Honeywell D117 doorbell using the D780 transformer"}),"\n",(0,o.jsx)(n.li,{children:"Finder 40.52.8.006.0000 6V AC relay and 95.85.3 relay socket"}),"\n",(0,o.jsx)(n.li,{children:"Doorbell cable and male to female jumper cables"}),"\n",(0,o.jsx)(n.li,{children:"Raspberry Pi 4B 8G with its power adapter and an SD card and a RJ45 cable to connect it to the internet"}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:"And on the software side of things all you need is docker, but you can also use other container engine if you have experience building and running images there."}),"\n",(0,o.jsx)(n.h2,{id:"hardware",children:"Hardware"}),"\n",(0,o.jsx)(n.p,{children:"My doorbell is a Honeywell D117, aka Ding Dong (gotta love the name). It\u2019s using the D780 transformer with the following connection (diagram on the left of the picture)."}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{src:"https://github.com/user-attachments/assets/2fbdd893-dba4-496e-9bbc-6450418d5eb4",alt:"Diagram of a Honeywell D117 doorbell with a D780 transformer"})}),"\n",(0,o.jsx)(n.p,{children:"The transformer takes 220V and produces an 8V current"}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{src:"https://github.com/user-attachments/assets/da048846-16f8-41ca-8673-1467a1028fa3",alt:"Transformer D780"})}),"\n",(0,o.jsxs)(n.p,{children:["We can now use a relay to detect when the circuit is closed. I wasn\u2019t able to find an 8V AC relay, so I tried with a 12V AC and a 6V AC. The 12V one didn't work but the 6V one did. I cannot tell how bad an idea this is so only try this at your own risk. The brand is FINDER and the part number is ",(0,o.jsx)(n.code,{children:"40.52.8.006.0000"}),", I bought it from ",(0,o.jsx)(n.a,{href:"https://www.reichelt.de/de/de/shop/produkt/steckrelais_2x_um_250v_8a_6vac_rm_5_0mm-271335",children:"Reichelt"})," and got it sent to Belgium"]}),"\n",(0,o.jsxs)(n.p,{children:["Connect ",(0,o.jsx)(n.code,{children:"A1"})," and ",(0,o.jsx)(n.code,{children:"A2"})," to ",(0,o.jsx)(n.code,{children:"0F"})," and ",(0,o.jsx)(n.code,{children:"T3"})," respectively."]}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{src:"https://github.com/user-attachments/assets/f1afd596-60ef-4181-92c3-250af52693a3",alt:"Doorbell Wiring"})}),"\n",(0,o.jsx)(n.p,{children:"We will use the always open circuit on the other side of the relay so connect a male to female cable on 11 and 14 which will go to the Raspberry Pi."}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{src:"https://github.com/user-attachments/assets/8aac2983-3208-4792-a14e-713afea7bd0d",alt:"Relay Wiring"})}),"\n",(0,o.jsxs)(n.p,{children:["I connected it to ",(0,o.jsx)(n.a,{href:"https://pinout.xyz/pinout/pin16_gpio23/",children:"GPIO 23"})," and ",(0,o.jsx)(n.a,{href:"https://pinout.xyz/pinout/ground",children:"Ground (14)"})]}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{src:"https://github.com/user-attachments/assets/c10b4573-dc3d-478c-9853-07abbafaef8c",alt:"RPi Wiring"})}),"\n",(0,o.jsx)(n.h2,{id:"software",children:"Software"}),"\n",(0,o.jsx)(n.h3,{id:"system-image",children:"System Image"}),"\n",(0,o.jsx)(n.p,{children:"Now that all the cabling is done, let\u2019s prepare the software. First I\u2019m going to prepare the image for the SD card. For that I\u2019ll use Kairos because it will make it easier for me to do upgrades in the future and because it\u2019s immutable so I can have my infrastructure as code easily. All I have to do is build a raw image which I can then copy to the SD card."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:'docker run --rm --privileged \\\n  -v /var/run/docker.sock:/var/run/docker.sock \\\n  -v $PWD/build/:/output \\\n  quay.io/kairos/auroraboot:latest \\\n  --debug \\\n  --set "disable_http_server=true" \\\n  --set "disable_netboot=true" \\\n  --set "container_image=quay.io/kairos/opensuse:leap-15.6-standard-arm64-rpi4-v3.3.1-k3sv1.32.1-k3s1" \\\n  --set "state_dir=/output" \\\n  --set "disk.raw=true"\n'})}),"\n",(0,o.jsx)(n.p,{children:"There\u2019s a lot in this command, which you can learn in the Kairos documentation but the one important thing to know is that I\u2019m consuming the Kairos image that is specially built for Raspberry Pi 4 and that it contains the K3s Kubernetes distribution in it so I can deploy my script via Kubernetes and leave the base image unchanged."}),"\n",(0,o.jsxs)(n.p,{children:["If everything is successful you should get the image ",(0,o.jsx)(n.code,{children:"build/kairos-opensuse-leap-15.6-standard-arm64-rpi4-v3.3.1-k3s1.32.1.raw"})," so let\u2019s copy it into the SD card, I\u2019m on Linux so I can run the following"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"sudo dd if=./build/kairos-opensuse-leap-15.6-standard-arm64-rpi4-v3.3.1-k3s1.32.1.raw \\\n  of=/dev/mmblk0 \\\n  oflag=sync \\\n  status=progress \\\n  bs=10MB\n"})}),"\n",(0,o.jsx)(n.p,{children:"Once it finishes copying, you can insert it on the Raspberry Pi and boot it. It will do an initial boot to setup the system and reboot on its own. In the meantime let\u2019s prepare the software we are going to deploy."}),"\n",(0,o.jsx)(n.h3,{id:"telegram-bot",children:"Telegram Bot"}),"\n",(0,o.jsx)(n.p,{children:"I will be using a telegram bot to send the messages. This way anyone in the family can subscribe to it and mute it if they want. If you prefer a different solution just adapt the Python script in the next section."}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsx)(n.li,{children:"Open Telegram and search for BotFather."}),"\n",(0,o.jsx)(n.li,{children:"Type /newbot and follow the steps to create a bot."}),"\n",(0,o.jsx)(n.li,{children:"Copy the API token that BotFather gives you."}),"\n",(0,o.jsx)(n.li,{children:"Interact with your bot by sending any message"}),"\n",(0,o.jsxs)(n.li,{children:["Extract the Chat ID by going to a browser using the api token you got in one of the previous steps ",(0,o.jsx)(n.a,{href:"https://api.telegram.org/botYOUR_API_TOKEN/getUpdates",children:"https://api.telegram.org/botYOUR_API_TOKEN/getUpdates"})]}),"\n"]}),"\n",(0,o.jsx)(n.h3,{id:"python-script",children:"Python Script"}),"\n",(0,o.jsx)(n.p,{children:"This script will detect when there\u2019s a signal in GPIO 23, write a log and send a Telegram message"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-python",children:'import os\nimport lgpio as GPIO\nimport time\nimport requests\nfrom datetime import datetime\n\n# Read environment variables\nBOT_TOKEN = os.environ.get("TELEGRAM_BOT_TOKEN")\nCHAT_ID = os.environ.get("TELEGRAM_CHAT_ID")\n\n# GPIO Setup\nGPIO_PIN = 23\nh = GPIO.gpiochip_open(0)\nGPIO.gpio_claim_input(h, GPIO_PIN, GPIO.SET_PULL_UP)\n\ndef send_telegram_message(message):\n    if not BOT_TOKEN or not CHAT_ID:\n        print("\u274c Error: Missing environment variables for Telegram bot.")\n        return\n    url = f"<https://api.telegram.org/bot{BOT_TOKEN}/sendMessage>"\n    payload = {"chat_id": CHAT_ID, "text": message}\n    requests.post(url, json=payload)\n\nprint("\ud83d\ude80 Doorbell monitor started...")\nwhile True:\n    if GPIO.gpio_read(h, GPIO_PIN) == 0:  # Button pressed\n        timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")\n        message = f"\ud83d\udeaa Doorbell pressed at {timestamp}!"\n        print(f"[{timestamp}] \ud83d\udd14 {message}")\n        send_telegram_message(message)\n        time.sleep(2)  # Avoid spamming messages\n    time.sleep(0.1)\n'})}),"\n",(0,o.jsx)(n.h3,{id:"dockerfile",children:"Dockerfile"}),"\n",(0,o.jsx)(n.p,{children:"We won\u2019t run the script directly on the Raspberry Pi, it will be running in a Docker container. This is very useful when having the underlying system be immutable because I can still iterate without having to rebuild and burn a new SD card and restart the system. Instead all I have to do is install the packages I need in this container and run it in privilege mode. This of course can open some security risks, but again, this is just for learning purposes and for fun."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-dockerfile",children:'# Use a lightweight Python base image for Raspberry Pi (ARM)\nFROM python:3.9-slim\n\n# Install system dependencies\nRUN apt update && apt install -y python3-dev gcc\n\nRUN pip install lgpio requests\n\n# Set the working directory inside the container\nWORKDIR /app\n\n# Copy the Python script into the container\nCOPY doorbell.py /app/doorbell.py\n\n# Set the script to run on startup\nCMD ["python3", "/app/doorbell.py"]\n'})}),"\n",(0,o.jsx)(n.p,{children:"Since the image is going to be running on the Raspberry Pi but I\u2019m going to build it on an AMD platform, then I need to cross-compile. Use any tag you prefer, just keep in mind it is the same tag you have to use in the deployment in the next section"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"docker buildx build --platform=linux/arm64 \\\n  -t quay.io/mauromorales/doorbell:telegram-v1 \\\n  .\n"})}),"\n",(0,o.jsx)(n.p,{children:"And publish it to a repository, I\u2019m using Quay but you can use any repo you prefer"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"docker push quay.io/mauromorales/doorbell:telegram-v1\n"})}),"\n",(0,o.jsx)(n.p,{children:"Yes that image is public and will remain static, but I\u2019d recommend you build your own instead of using mine because at any moment I might decide to remove it."}),"\n",(0,o.jsx)(n.h3,{id:"kubernetes",children:"Kubernetes"}),"\n",(0,o.jsxs)(n.p,{children:["Last piece of the puzzle is the Kubernetes deployment. Let\u2019s log into our Kairos system with user ",(0,o.jsx)(n.code,{children:"kairos"})," and password ",(0,o.jsx)(n.code,{children:"kairos"})]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"ssh kairos@IP\n"})}),"\n",(0,o.jsx)(n.p,{children:"Switch to root"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"sudo -i\n"})}),"\n",(0,o.jsxs)(n.p,{children:["We want to create some secrets and pass them as environment variables in the container. Take the telegram bot token and chat id and encode them. For example if my Chat ID is ",(0,o.jsx)(n.code,{children:"1234567890"})," then I\u2019d do as follows:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:'echo -n "1234567890" | base64\n'})}),"\n",(0,o.jsxs)(n.p,{children:["do the same with the bot token, e.g. if my bot token was ",(0,o.jsx)(n.code,{children:"999999999:FooooooBaaaaaaaaR"})," then I\u2019d do"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:'echo -n "999999999:FooooooBaaaaaaaaR" | base64\n'})}),"\n",(0,o.jsxs)(n.p,{children:["and copy them in a file called ",(0,o.jsx)(n.code,{children:"telegram-secrets.yaml"})," and add the following content (remember to replace with your actual encoded values). Yes Kairos is immutable in some areas but the home directory is writable."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",children:"apiVersion: v1\nkind: Secret\nmetadata:\n  name: telegram-secrets\ntype: Opaque\ndata:\n  bot_token: OTk5OTk5OTk5OkZvb29vb29CYWFhYWFhYWFS\n  chat_id: MTIzNDU2Nzg5MA==\n"})}),"\n",(0,o.jsx)(n.p,{children:"Save the file and apply it"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"kubectl apply -f telegram-secret.yaml\n"})}),"\n",(0,o.jsxs)(n.p,{children:["Now we create a ",(0,o.jsx)(n.code,{children:"deployment.yaml"})," file to connect everything together"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",children:'apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: rpi-doorbell\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: doorbell\n  template:\n    metadata:\n      labels:\n        app: doorbell\n    spec:\n      containers:\n      - name: doorbell\n        image: quay.io/mauromorales/doorbell:telegram-v1\n        imagePullPolicy: Always   # Forces Kubernetes to always pull the latest image\n        securityContext:\n          privileged: true  # Allows access to GPIO hardware\n        resources:\n          limits:\n            memory: "128Mi"\n            cpu: "100m"\n        env:\n          - name: TELEGRAM_BOT_TOKEN\n            valueFrom:\n              secretKeyRef:\n                name: telegram-secrets\n                key: bot_token\n          - name: TELEGRAM_CHAT_ID\n            valueFrom:\n              secretKeyRef:\n                name: telegram-secrets\n                key: chat_id\n'})}),"\n",(0,o.jsx)(n.p,{children:"And apply it"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"kubectl apply -f deployment.yaml\n"})}),"\n",(0,o.jsx)(n.p,{children:"If everything went as expected, you should see your pod running"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"localhost:~ # kubectl get pods\nNAME                            READY   STATUS    RESTARTS   AGE\nrpi-doorbell-67c78c5969-s6pw8   1/1     Running   0          20h\n"})}),"\n",(0,o.jsx)(n.p,{children:"And you can get logs from that pod tracking every time someone pressed your doorbell in addition to sending the Telegram message"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"localhost:~ # kubectl logs rpi-doorbell-67c78c5969-s6pw8\n\ud83d\ude80 Doorbell monitor started...\n[2025-03-05 13:51:34] \ud83d\udd14 \ud83d\udeaa Doorbell pressed at 2025-03-05 13:51:34!\n[2025-03-05 15:41:25] \ud83d\udd14 \ud83d\udeaa Doorbell pressed at 2025-03-05 15:41:25!\n[2025-03-05 15:42:13] \ud83d\udd14 \ud83d\udeaa Doorbell pressed at 2025-03-05 15:42:13!\n[2025-03-05 18:28:26] \ud83d\udd14 \ud83d\udeaa Doorbell pressed at 2025-03-05 18:28:26!\n[2025-03-06 09:59:18] \ud83d\udd14 \ud83d\udeaa Doorbell pressed at 2025-03-06 09:59:18!\n"})}),"\n",(0,o.jsx)(n.h2,{id:"conclusion",children:"Conclusion"}),"\n",(0,o.jsx)(n.p,{children:"With this setup me and my partner can subscribe to the Telegram Bot and get notifications to our phones. I can also mute the bot if I\u2019m in a meeting and don\u2019t want to be disturbed. I could extend the system to not notify at certain hours of the day but still keep logs. If I\u2019m not happy with Telegram then I can connect it to a different system. Whenever there\u2019s a new version of Kairos I can upgrade the system remotely via the command line or through Kubernetes. If you have a similar setup but don\u2019t want to buy a smart doorbell just yet, I can only recommend this setup."}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{src:"https://github.com/user-attachments/assets/c86d85e4-86b5-465d-bf1a-83a8850916bc",alt:"Telegram Bot"})})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(c,{...e})}):c(e)}},77979:e=>{e.exports=JSON.parse('{"permalink":"/blog/kairos-doorbell","editUrl":"https://github.com/kairos-io/kairos/tree/main/packages/create-kairos/templates/shared/blog/2025-03-18-kairos-doorbell.md","source":"@site/blog/2025-03-18-kairos-doorbell.md","title":"How I Automated My Doorbell with Kairos (and You Can Too)","description":"Picture this: You\u2019re deep in focus, coding away, and the doorbell rings. Except\u2026 you never hear it. The mailman leaves, and now your package is on an adventure you didn\'t plan for. That\u2019s exactly what happened to me, so I did what any geek would do\u2014turn my dumb doorbell into a smart one using Kairos.","date":"2025-03-18T00:00:00.000Z","tags":[{"inline":false,"label":"Kairos","permalink":"/blog/tags/kairos","description":"Posts about Kairos, an open-source, cloud-native, and immutable Linux distribution"}],"readingTime":9.01,"hasTruncateMarker":true,"authors":[{"name":"Mauro Morales","socials":{"github":"https://github.com/mauromorales","x":"https://x.com/mauromrls"},"url":"https://github.com/mauromorales","imageURL":"https://github.com/mauromorales.png","key":"mauro-morales","page":null}],"frontMatter":{"authors":["mauro-morales"],"slug":"kairos-doorbell","tags":["kairos"],"title":"How I Automated My Doorbell with Kairos (and You Can Too)"},"unlisted":false,"prevItem":{"title":"How We Rebuilt Kairos building From the Ground Up","permalink":"/blog/kairos-init-announcement"},"nextItem":{"title":"Kairos Joins the CNCF as a Sandbox Project","permalink":"/blog/cncf-sandbox-project"}}')}}]);