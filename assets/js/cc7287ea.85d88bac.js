"use strict";(globalThis.webpackChunkkairos_docs=globalThis.webpackChunkkairos_docs||[]).push([[875],{2933:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>d,contentTitle:()=>i,default:()=>h,frontMatter:()=>s,metadata:()=>a,toc:()=>l});const a=JSON.parse('{"id":"Upgrade/trustedboot","title":"Trusted Boot Upgrades","description":"Learn how to upgrade a Kairos node with Trusted Boot enabled","source":"@site/versioned_docs/version-3.6.0/Upgrade/trustedboot.md","sourceDirName":"Upgrade","slug":"/Upgrade/trustedboot","permalink":"/docs/3.6.0/Upgrade/trustedboot","draft":false,"unlisted":false,"editUrl":"https://github.com/kairos-io/kairos-docs/tree/main/versioned_docs/version-3.6.0/Upgrade/trustedboot.md","tags":[],"version":"3.6.0","lastUpdatedBy":"Jasper De Keukelaere (imec)","lastUpdatedAt":1765142882000,"sidebarPosition":6,"frontMatter":{"title":"Trusted Boot Upgrades","sidebar_label":"Trusted Boot","sidebar_position":6,"date":"2022-11-13T00:00:00.000Z","description":"Learn how to upgrade a Kairos node with Trusted Boot enabled"},"sidebar":"tutorialSidebar","previous":{"title":"System Upgrade Controller (Deprecated)","permalink":"/docs/3.6.0/Upgrade/system-upgrade-controller"},"next":{"title":"Boot assessment","permalink":"/docs/3.6.0/Upgrade/boot_assessment"}}');var o=n(74848),r=n(28453);const s={title:"Trusted Boot Upgrades",sidebar_label:"Trusted Boot",sidebar_position:6,date:new Date("2022-11-13T00:00:00.000Z"),description:"Learn how to upgrade a Kairos node with Trusted Boot enabled"},i=void 0,d={},l=[{value:"Upgrades",id:"upgrades",level:3},{value:"Generate the upgrade image",id:"generate-the-upgrade-image",level:4},{value:"Upgrade with kairos-agent",id:"upgrade-with-kairos-agent",level:4},{value:"Upgrades with Kubernetes",id:"upgrades-with-kubernetes",level:4}];function c(e){const t={a:"a",admonition:"admonition",code:"code",h3:"h3",h4:"h4",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,r.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(t.admonition,{title:"Warning",type:"warning",children:(0,o.jsx)(t.p,{children:"This section is still a work in progress and only available in Kairos v3.x releases and alphas."})}),"\n",(0,o.jsx)(t.p,{children:"This section covers how to upgrade a Kairos node with Trusted Boot enabled."}),"\n",(0,o.jsxs)(t.p,{children:["See the ",(0,o.jsx)(t.a,{href:"../../installation/trustedboot",children:"Trusted Boot Installation"})," and ",(0,o.jsx)(t.a,{href:"../../architecture/trustedboot",children:"Trusted Boot Architecture"})," pages for more references."]}),"\n",(0,o.jsx)(t.h3,{id:"upgrades",children:"Upgrades"}),"\n",(0,o.jsx)(t.p,{children:"In order to upgrade a node to a new version of the OS, you need to generate again the installable medium with the same keys used in the steps before."}),"\n",(0,o.jsx)(t.admonition,{title:"Note",type:"note",children:(0,o.jsxs)(t.p,{children:["The resulting container image can be used for upgrades with ",(0,o.jsx)(t.code,{children:"kairos-agent"}),"."]})}),"\n",(0,o.jsx)(t.p,{children:"The process will generate an EFI file which we will pack into a container image that will be used to upgrade the node."}),"\n",(0,o.jsx)(t.h4,{id:"generate-the-upgrade-image",children:"Generate the upgrade image"}),"\n",(0,o.jsxs)(t.ol,{children:["\n",(0,o.jsx)(t.li,{children:"Build the Container image used for upgrades"}),"\n"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",metastring:'title="Ubuntu+24.04,Fedora+40"',children:"CONTAINER_IMAGE=quay.io/kairos/kairos-core:latest\n\ndocker run --rm -v $PWD/keys:/keys -v $PWD:/work -ti quay.io/kairos/auroraboot:latest build-uki -t container --public-keys /keys --tpm-pcr-private-key $PATH_TO_TPM_KEY --sb-key $PATH_TO_SB_KEY --sb-cert $PATH_TO_SB_CERT $CONTAINER_IMAGE\n"})}),"\n",(0,o.jsxs)(t.ol,{start:"2",children:["\n",(0,o.jsx)(t.li,{children:"Push the upgrade image to a registry"}),"\n"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:"# Now you can load upgrade_image.tar to a registry and use it with kairos-agent\ndocker load -i *.tar\n#401b8e83daf6: Loading layer [==================================================>]  1.263GB/1.263GB\n# Loaded image: kairos_uki:v3.0.0-alpha2\ndocker push <IMAGE_NAME>\n"})}),"\n",(0,o.jsx)(t.h4,{id:"upgrade-with-kairos-agent",children:"Upgrade with kairos-agent"}),"\n",(0,o.jsx)(t.admonition,{title:"Warning",type:"warning",children:(0,o.jsxs)(t.p,{children:["For upgrading use the image that has been loaded with ",(0,o.jsx)(t.code,{children:"docker load"})," in the step earlier. That contains the EFI files for the upgrade process. ",(0,o.jsx)(t.strong,{children:"Do not use"})," the source/base image used (",(0,o.jsx)(t.code,{children:"$CONTAINER_IMAGE"})," in the example above) used as input!"]})}),"\n",(0,o.jsxs)(t.p,{children:["Let's assume an upgrade image named ",(0,o.jsx)(t.code,{children:"acme.com/acme/kairos"})," has been built and pushed\nas described in the section above. From a shell inside a running Kairos OS,\nthe following command will upgrade to the new version:"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:"kairos-agent upgrade --source oci:acme.com/acme/kairos\n"})}),"\n",(0,o.jsx)(t.h4,{id:"upgrades-with-kubernetes",children:"Upgrades with Kubernetes"}),"\n",(0,o.jsxs)(t.p,{children:["To upgrade Kairos with Kubernetes, the Kairos operator needs to be deployed on the target cluster. ",(0,o.jsx)(t.a,{href:".././kairos-operator",children:"Read the instructions here"}),"."]}),"\n",(0,o.jsxs)(t.p,{children:["A ",(0,o.jsx)(t.code,{children:"NodeOp"})," resource needs to be created which will use the image generated in the step above.\nSince that image only contains the EFI files for the upgrade and in order to be able use any ImagePullSecrets\ndefined on the cluster, we will create an image that can be used to start a Pod and also contains\nthe efi and conf files for the upgrade."]}),"\n",(0,o.jsxs)(t.p,{children:["Assuming an upgrade image named ",(0,o.jsx)(t.code,{children:"acme.com/acme/kairosUpgradeImage"})," was built using a Kairos\nimage named ",(0,o.jsx)(t.code,{children:"acme.com/acme/baseImage"}),", the following\ndockerfile will create an image that can be used to start a Plan for upgrade:"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{children:"FROM acme.com/acme/kairos as upgradeImage\nFROM acme.com/acme/baseImage\nCOPY --from=upgradeImage / /trusted-boot\n"})}),"\n",(0,o.jsxs)(t.p,{children:["(Let's call the image built with this dockerfile ",(0,o.jsx)(t.code,{children:"planImage:vx.y.z"}),")"]}),"\n",(0,o.jsx)(t.p,{children:"The following NodeOp can now be deployed on the cluster:"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-yaml",children:'apiVersion: operator.kairos.io/v1alpha1\nkind: NodeOp\nmetadata:\n  name: trusted-boot-upgrade\n  namespace: default\nspec:\n  # NodeSelector to target specific nodes\n  nodeSelector:\n    matchLabels:\n      kairos.io/managed: "true"\n\n  # The container image containing the upgrade files\n  image: "planImage"\n\n  # Custom command to execute the trusted boot upgrade\n  command:\n    - sh\n    - -c\n    - |\n      set -e\n      rm -rf /host/usr/local/trusted-boot\n      mkdir -p /host/usr/local/trusted-boot\n      mount --rbind /trusted-boot /host/usr/local/trusted-boot\n      chroot /host kairos-agent --debug upgrade --source dir:/usr/local/trusted-boot\n\n  # Path where the node\'s root filesystem will be mounted\n  hostMountPath: /host\n\n  # Whether to cordon the node before running the operation\n  cordon: true\n\n  # Drain options for pod eviction\n  drainOptions:\n    enabled: true\n    force: false\n    gracePeriodSeconds: 30\n    ignoreDaemonSets: true\n    deleteEmptyDirData: false\n    timeoutSeconds: 300\n\n  # Whether to reboot the node after successful operation\n  rebootOnSuccess: true\n\n  # Maximum number of nodes that can run the operation simultaneously\n  concurrency: 1\n\n  # Whether to stop creating new jobs when a job fails\n  stopOnFailure: true\n'})}),"\n",(0,o.jsx)(t.admonition,{title:"Note",type:"note",children:(0,o.jsxs)(t.p,{children:["To understand more on how this works, see the ",(0,o.jsx)(t.a,{href:".././kairos-operator",children:"Kairos operator documentation"})," for general information about the operator and the ",(0,o.jsx)(t.a,{href:".././kubernetes",children:"regular upgrade process"})," for non-trusted boot upgrades."]})})]})}function h(e={}){const{wrapper:t}={...(0,r.R)(),...e.components};return t?(0,o.jsx)(t,{...e,children:(0,o.jsx)(c,{...e})}):c(e)}},28453:(e,t,n)=>{n.d(t,{R:()=>s,x:()=>i});var a=n(96540);const o={},r=a.createContext(o);function s(e){const t=a.useContext(r);return a.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function i(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:s(e.components),a.createElement(r.Provider,{value:t},e.children)}}}]);