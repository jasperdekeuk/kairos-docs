"use strict";(globalThis.webpackChunkkairos_docs=globalThis.webpackChunkkairos_docs||[]).push([[6675],{28453:(e,n,o)=>{o.d(n,{R:()=>r,x:()=>s});var t=o(96540);const i={},a=t.createContext(i);function r(e){const n=t.useContext(a);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),t.createElement(a.Provider,{value:n},e.children)}},47405:(e,n,o)=>{o.r(n),o.d(n,{assets:()=>l,contentTitle:()=>s,default:()=>u,frontMatter:()=>r,metadata:()=>t,toc:()=>c});const t=JSON.parse('{"id":"Examples/virtual-box","title":"Kairos\' Trusted Boot in Virtual Box","description":"This section describes how to use Virtual Box to boot Kairos in \\"Trusted boot\\" mode","source":"@site/versioned_docs/version-3.5.7/Examples/virtual-box.md","sourceDirName":"Examples","slug":"/Examples/virtual-box","permalink":"/docs/3.5.7/Examples/virtual-box","draft":false,"unlisted":false,"editUrl":"https://github.com/kairos-io/kairos-docs/tree/main/versioned_docs/version-3.5.7/Examples/virtual-box.md","tags":[],"version":"3.5.7","lastUpdatedBy":"Jasper De Keukelaere (imec)","lastUpdatedAt":1765142882000,"frontMatter":{"title":"Kairos\' Trusted Boot in Virtual Box","sidebar_label":"Trusted Boot in Virtual Box","description":"This section describes how to use Virtual Box to boot Kairos in \\"Trusted boot\\" mode"},"sidebar":"tutorialSidebar","previous":{"title":"Manual single-node cluster","permalink":"/docs/3.5.7/Examples/single-node"},"next":{"title":"WiFi","permalink":"/docs/3.5.7/Examples/wifi"}}');var i=o(74848),a=o(28453);const r={title:"Kairos' Trusted Boot in Virtual Box",sidebar_label:"Trusted Boot in Virtual Box",description:'This section describes how to use Virtual Box to boot Kairos in "Trusted boot" mode'},s=void 0,l={},c=[{value:"Create an ISO",id:"create-an-iso",level:2},{value:"Create a VM",id:"create-a-vm",level:2},{value:"Change boot order",id:"change-boot-order",level:2},{value:"Use localai web UI",id:"use-localai-web-ui",level:2}];function d(e){const n={a:"a",code:"code",h2:"h2",li:"li",p:"p",pre:"pre",ul:"ul",...(0,a.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(n.p,{children:["To install Kairos in ",(0,i.jsx)(n.a,{href:"../../architecture/trustedboot",children:'"Trusted Boot Mode"'})," the machine needs to meet the following requirements:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Must have a tpm v2.0 chip"}),"\n",(0,i.jsx)(n.li,{children:'Must be able to boot in EFI mode (not "legacy BIOS")'}),"\n",(0,i.jsx)(n.li,{children:"Must have 1Gb of RAM or more"}),"\n",(0,i.jsx)(n.li,{children:"Must have 40Gb of disk or more"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["The following steps describe how to create a virtual machine suitable for Kairos\ntrusted boot setup, using ",(0,i.jsx)(n.a,{href:"https://www.virtualbox.org/",children:"VirtualBox"}),".\nAs an example workload, ",(0,i.jsx)(n.a,{href:"https://localai.io/",children:"LocalAI"})," will be used."]}),"\n",(0,i.jsx)(n.h2,{id:"create-an-iso",children:"Create an ISO"}),"\n",(0,i.jsx)(n.p,{children:"If you don't already have an ISO to boot, you can create one using the following script:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'#!/bin/bash\n\nset -e\n\nIMAGE="${IMAGE:-quay.io/kairos/ubuntu:24.04-core-amd64-generic-latest-uki}"\nAURORABOOT_IMAGE="quay.io/kairos/auroraboot:latest"\nOUTDIR=$PWD/build\n\ncleanup() {\n  # Run with docker to avoid sudo\n  docker run --rm --entrypoint /bin/bash -v $PWD/build:/result $AURORABOOT_IMAGE -c \'rm -rf /result/*\'\n  rm -rf $OUTDIR\n}\n\ngenerateEfiKeys() {\n  mkdir -p $OUTDIR/keys\n  docker run --rm -v $OUTDIR/keys:/result $AURORABOOT_IMAGE genkey -e 7 --output /result KairosKeys\n}\n\ngenerateConfig() {\n  mkdir -p $OUTDIR/config\n  cat << EOF > "$OUTDIR/config/config.yaml"\n#cloud-config\n\nusers:\n  - name: kairos\n    passwd: kairos\n    groups:\n      - admin\n\ninstall:\n  auto: true\n  reboot: true\n\nstages:\n  initramfs:\n    - files:\n        - path: /etc/systemd/system/localai.service\n          permissions: 0644\n          content: |\n            [Unit]\n            Description=Local AI server\n            After=network-online.target\n            Wants=network-online.target\n\n            [Service]\n            Type=simple\n            ExecStart=/usr/bin/localai --models-path="/usr/local/models"\n            Restart=on-failure\n            RestartSec=10\n\n            [Install]\n            WantedBy=multi-user.target\n  boot:\n    - name: "Starting localai"\n      commands:\n        - |\n          systemctl enable localai.service\n          systemctl start localai.service\nEOF\n\n}\n\nbuildBaseImage() {\n  docker build -t kairos-localai - <<EOF\n  FROM $IMAGE\n  RUN curl -L -o localai https://github.com/mudler/LocalAI/releases/download/v2.22.1/local-ai-Linux-x86_64\n  RUN chmod +x localai\n  RUN mv localai /usr/bin/localai\nEOF\n}\n\nbuildISO() {\n  docker run --rm \\\n    -v /var/run/docker.sock:/var/run/docker.sock \\\n    -v $OUTDIR:/result \\\n    -v $OUTDIR/keys/:/keys  \\\n    -v $OUTDIR/config/:/config \\\n    $AURORABOOT_IMAGE build-uki \\\n    --output-dir /result \\\n    --keys /keys \\\n    --output-type iso \\\n    --boot-branding "KairosAI" \\\n    --overlay-iso /config \\\n    --extend-cmdline "rd.immucore.debug rd.debug rd.shell" \\\n    oci://kairos-localai\n}\n\nfixPermissions() {\n  docker run --privileged -e USERID=$(id -u) -e GROUPID=$(id -g) --entrypoint /usr/bin/sh -v $OUTDIR:/workdir --rm $AURORABOOT_IMAGE -c \'chown -R $USERID:$GROUPID /workdir\'\n}\n\nmoveISOFile() {\n  mv build/kairos*.iso ./kairos.iso\n}\n\necho "Cleaning up old artifacts" && cleanup\necho "Generating Config" && generateConfig\necho "Generating UEFI keys" && generateEfiKeys\necho "Building base image" && buildBaseImage\necho "Building ISO" && buildISO\necho "Fixing permissions" && fixPermissions\necho "Moving iso to current dir" && moveISOFile\n'})}),"\n",(0,i.jsxs)(n.p,{children:["If the script succeeds, you will find a ",(0,i.jsx)(n.code,{children:".iso"})," file inside ",(0,i.jsx)(n.code,{children:"$PWD/build"})," and a\nkeys directory with the UEFI keys used to sign the image."]}),"\n",(0,i.jsx)(n.h2,{id:"create-a-vm",children:"Create a VM"}),"\n",(0,i.jsx)(n.p,{children:"On macOS you need to make sure you install the VirtualBox Extension Pack to enable USB 2.0 and USB 3.0 support."}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.a,{href:"https://www.virtualbox.org/wiki/Downloads",children:"https://www.virtualbox.org/wiki/Downloads"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'#!/bin/bash\n\nset -e\n\nVM_NAME="KairosAI"\nISO_PATH=$PWD/kairos.iso\nDISK_PATH=$PWD/Kairos.vdi\n\ncleanup() {\n    if VBoxManage list vms | grep -q "\\"$VM_NAME\\""; then\n        echo "VM \'$VM_NAME\' found. Proceeding with cleanup."\n\n        # Check if the VM is running\n        if VBoxManage list runningvms | grep -q "\\"$VM_NAME\\""; then\n            echo "VM \'$VM_NAME\' is running. Powering off..."\n            VBoxManage controlvm "$VM_NAME" poweroff\n            sleep 2  # Wait for a moment to ensure the VM powers off\n        fi\n\n        # Unregister and delete the VM and all associated files\n        echo "Unregistering and deleting VM \'$VM_NAME\'..."\n        VBoxManage unregistervm "$VM_NAME" --delete\n\n        echo "Cleanup complete. VM \'$VM_NAME\' and associated files have been deleted."\n    else\n        echo "No VM named \'$VM_NAME\' found. No action needed."\n    fi\n}\n\ncreateVM() {\n    if [[ $(uname -m) == "x86_64" ]]; then\n        ostype="Linux_64"\n    else\n        ostype="Linux_arm64"\n    fi\n    VBoxManage createvm --name "$VM_NAME" --ostype "$ostype" --register\n    VBoxManage modifyvm "$VM_NAME" \\\n        --memory 10000 \\\n        --cpus 2 \\\n        --chipset piix3 \\\n        --firmware efi64 \\\n        --nictype1 82540EM \\\n        --nic1 nat \\\n        --natpf1 "guestssh,tcp,,2222,,22" \\\n        --natpf1 "localai,tcp,,8080,,8080" \\\n        --tpm-type "2.0" \\\n        --graphicscontroller vmsvga\n        # These don\'t work of efi\n        # https://www.virtualbox.org/ticket/19364\n        #--boot1 disk \\\n        #--boot2 dvd\n\n    VBoxManage createmedium disk --filename "$DISK_PATH" --size 40960\n    VBoxManage storagectl "$VM_NAME" --name "SATA Controller" --add sata --controller IntelAhci\n    VBoxManage storageattach "$VM_NAME" --storagectl "SATA Controller" --port 0 --device 0 --type hdd --medium "$DISK_PATH"\n\n    # Add an IDE controller for CD-ROM and attach the ISO\n    VBoxManage storagectl "$VM_NAME" --name "IDE Controller" --add ide\n    VBoxManage storageattach "$VM_NAME" --storagectl "IDE Controller" --port 0 --device 0 --type dvddrive --medium "$ISO_PATH"\n\n    # Hack to allow enrolling the PK key\n    # Not sure why, but only this works. We allow it to boot once,\n    # probably some default UEFI vars are written on the first boot which then\n    # allow us to just enroll our PK key.\n    # Also, it only works after adding disks and all (that\'s why it\'s here at the end).\n    # Probably because it needs the cdrom to enroll some of the keys except the PK (?)\n    VBoxManage startvm "$VM_NAME" --type=headless && sleep 3\n    VBoxManage controlvm "$VM_NAME" poweroff && sleep 3\n    VBoxManage modifynvram $VM_NAME enrollpk \u2011\u2011platform\u2011key=$PWD/build/keys/PK.der \u2011\u2011owner\u2011uuid=KairosKeys\n}\n\nusage() {\n    echo "Usage: $0 {create|start|stop|cleanup}"\n}\n\nrun() {\n    # Check if a command was provided\n    if [ -z "$1" ]; then\n        usage\n        exit 1\n    fi\n\n    # Determine which command to run based on the first argument\n    case "$1" in\n        create)\n            createVM\n            ;;\n        start)\n            VBoxManage startvm "$VM_NAME"\n            ;;\n        stop)\n            VBoxManage controlvm "$VM_NAME" poweroff\n            ;;\n        cleanup)\n            cleanup\n            ;;\n        *)\n            echo "Invalid command: $1"\n            usage\n            exit 1\n            ;;\n    esac\n}\n\nrun $@\n'})}),"\n",(0,i.jsx)(n.h2,{id:"change-boot-order",children:"Change boot order"}),"\n",(0,i.jsxs)(n.p,{children:["Unfortunately, Virtual box doesn't support changing boot order in efi mode (",(0,i.jsx)(n.a,{href:"https://www.virtualbox.org/ticket/19364",children:"https://www.virtualbox.org/ticket/19364"}),").\nThis means, after installation, the order needs to change manually, in order to boot from the disk instead of the cdrom (iso)."]}),"\n",(0,i.jsx)(n.h2,{id:"use-localai-web-ui",children:"Use localai web UI"}),"\n",(0,i.jsxs)(n.p,{children:["Visit ",(0,i.jsx)(n.a,{href:"http://127.0.0.1:8080",children:"http://127.0.0.1:8080"})," from your browser to use LocalAI web UI"]})]})}function u(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}}}]);