"use strict";(globalThis.webpackChunkkairos_docs=globalThis.webpackChunkkairos_docs||[]).push([[7994],{28453:(e,n,t)=>{t.d(n,{R:()=>s,x:()=>a});var r=t(96540);const i={},o=r.createContext(i);function s(e){const n=r.useContext(o);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:s(e.components),r.createElement(o.Provider,{value:n},e.children)}},34933:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>a,default:()=>u,frontMatter:()=>s,metadata:()=>r,toc:()=>l});const r=JSON.parse('{"id":"Examples/kubeadm-provider","title":"A Minimal Single-Node Kubernetes with Kubeadm","description":"Learn how to build a Kairos image for a single-node Kubernetes cluster using the provider-kubeadm.","source":"@site/docs/Examples/kubeadm-provider.md","sourceDirName":"Examples","slug":"/Examples/kubeadm-provider","permalink":"/kairos-docs/docs/next/Examples/kubeadm-provider","draft":false,"unlisted":false,"editUrl":"https://github.com/kairos-io/kairos-docs/tree/main/docs/Examples/kubeadm-provider.md","tags":[],"version":"current","lastUpdatedBy":"Jasper De Keukelaere (imec)","lastUpdatedAt":1765043763000,"frontMatter":{"title":"A Minimal Single-Node Kubernetes with Kubeadm","linkTitle":"A Minimal Single-Node Kubernetes with Kubeadm","description":"Learn how to build a Kairos image for a single-node Kubernetes cluster using the provider-kubeadm."},"sidebar":"tutorialSidebar","previous":{"title":"Keylime agent","permalink":"/kairos-docs/docs/next/Examples/keylime"},"next":{"title":"LocalAI","permalink":"/kairos-docs/docs/next/Examples/localai"}}');var i=t(74848),o=t(28453);const s={title:"A Minimal Single-Node Kubernetes with Kubeadm",linkTitle:"A Minimal Single-Node Kubernetes with Kubeadm",description:"Learn how to build a Kairos image for a single-node Kubernetes cluster using the provider-kubeadm."},a=void 0,d={},l=[{value:"\ud83e\uddf1 What Is <code>provider-kubeadm</code>?",id:"-what-is-provider-kubeadm",level:2},{value:"\ud83d\udd27 Building the Image",id:"-building-the-image",level:2},{value:"\u2601\ufe0f The Cloud-Config",id:"\ufe0f-the-cloud-config",level:2},{value:"\ud83d\udd04 What\u2019s Next?",id:"-whats-next",level:2}];function c(e){const n={a:"a",code:"code",h2:"h2",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(n.p,{children:["Kairos is all about giving you the power to customize your operating system just the way you need it\u2014declaratively, reproducibly, and predictably. Today, we're walking through how to build and boot a Kairos image using the ",(0,i.jsx)(n.a,{href:"https://github.com/kairos-io/provider-kubeadm",children:"provider-kubeadm"})," to set up a Kubernetes cluster with ",(0,i.jsx)(n.code,{children:"kubeadm"}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["This guide is focused on a simple use case: booting a ",(0,i.jsx)(n.strong,{children:"single-node Kubernetes cluster"})," with role ",(0,i.jsx)(n.code,{children:"init"}),", version ",(0,i.jsx)(n.code,{children:"v1.30.0"}),"."]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsxs)(n.h2,{id:"-what-is-provider-kubeadm",children:["\ud83e\uddf1 What Is ",(0,i.jsx)(n.code,{children:"provider-kubeadm"}),"?"]}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.a,{href:"https://github.com/kairos-io/provider-kubeadm",children:"provider-kubeadm"})," is a binary for Kairos that integrates with Kubernetes' ",(0,i.jsx)(n.code,{children:"kubeadm"})," bootstrap process. It translates the familiar ",(0,i.jsx)(n.code,{children:"kubeadm"})," configuration into a Kairos-compatible cloud-init YAML, wrapping everything in a reproducible and declarative boot process."]}),"\n",(0,i.jsxs)(n.p,{children:["With this provider, we can fully define Kubernetes cluster parameters\u2014including API server args, scheduler, networking, and etcd configuration\u2014right inside a Kairos ",(0,i.jsx)(n.code,{children:"#cloud-config"})," block."]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"-building-the-image",children:"\ud83d\udd27 Building the Image"}),"\n",(0,i.jsxs)(n.p,{children:["We start with a Kairos base image\u2014here, Ubuntu 24.04 Core\u2014and layer on everything ",(0,i.jsx)(n.code,{children:"kubeadm"})," needs: containerd, kubelet, kubectl, and the kubeadm binary. Also we will download and set the agent-provide-kubeadm to handle the ",(0,i.jsx)(n.code,{children:"kubeadm"})," configuration."]}),"\n",(0,i.jsx)(n.p,{children:"Here's the Dockerfile used to construct the image:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-Dockerfile",children:"FROM quay.io/kairos/ubuntu:24.04-core-amd64-generic-v3.4.2\n\n# Add Kubernetes apt repository\nRUN curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.31/deb/Release.key | gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg\nRUN echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.31/deb/ /' | tee /etc/apt/sources.list.d/kubernetes.list\n\n# Install required packages\nRUN apt-get update && apt-get install -y --no-install-recommends \\\n    socat \\\n    conntrack \\\n    containerd \\\n    runc \\\n    kubelet \\\n    kubeadm \\\n    kubectl \\\n && apt-get clean && rm -rf /var/lib/apt/lists/*\n# Copy the provider into place\nRUN mkdir -p /system/providers && curl -L https://github.com/kairos-io/provider-kubeadm/releases/download/v4.7.0-rc.4/agent-provider-kubeadm-v4.7.0-rc.4-linux-amd64.tar.gz | tar -xz -C /system/providers/\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Or with the modern ",(0,i.jsx)(n.a,{href:"./kairos-factory",children:"Kairos Factory"})," method:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-Dockerfile",children:"FROM quay.io/kairos/kairos-init:latest AS kairos-init\n\nFROM ubuntu:24.04\nARG VERSION=1.0.0\nRUN --mount=type=bind,from=kairos-init,src=/kairos-init,dst=/kairos-init /kairos-init --version \"${VERSION}\"\nRUN curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.31/deb/Release.key | gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg\nRUN echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.31/deb/ /' | tee /etc/apt/sources.list.d/kubernetes.list\n\n# Install required packages\nRUN apt-get update && apt-get install -y --no-install-recommends \\\n    socat \\\n    conntrack \\\n    containerd \\\n    runc \\\n    kubelet \\\n    kubeadm \\\n    kubectl \\\n && apt-get clean && rm -rf /var/lib/apt/lists/* \nRUN mkdir -p /system/providers && curl -L https://github.com/kairos-io/provider-kubeadm/releases/download/v4.7.0-rc.4/agent-provider-kubeadm-v4.7.0-rc.4-linux-amd64.tar.gz | tar -xz -C /system/providers/\n"})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"\ufe0f-the-cloud-config",children:"\u2601\ufe0f The Cloud-Config"}),"\n",(0,i.jsxs)(n.p,{children:["Here's the heart of the system\u2014a Kairos-compatible ",(0,i.jsx)(n.code,{children:"#cloud-config"})," YAML. This config installs the OS, sets up kernel and containerd parameters, and passes the full ",(0,i.jsx)(n.code,{children:"kubeadm"})," configuration block to the ",(0,i.jsx)(n.code,{children:"provider-kubeadm"}),"."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'#cloud-config\ninstall:\n  device: auto\n  auto: true\n  reboot: true\n\ncluster:\n  cluster_token: "random_token"\n  control_plane_host: "1.1.1.1"\n  role: init\n  config: |\n    clusterConfiguration:\n      apiServer:\n        extraArgs:\n          advertise-address: 0.0.0.0\n          anonymous-auth: "true"\n          audit-log-maxage: "30"\n          audit-log-maxbackup: "10"\n          audit-log-maxsize: "100"\n          audit-log-path: /var/log/apiserver/audit.log\n          authorization-mode: RBAC,Node\n          default-not-ready-toleration-seconds: "60"\n          default-unreachable-toleration-seconds: "60"\n          disable-admission-plugins: AlwaysAdmit\n          enable-admission-plugins: AlwaysPullImages,NamespaceLifecycle,ServiceAccount,NodeRestriction\n          profiling: "false"\n          secure-port: "6443"\n          tls-cipher-suites: TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,...\n        extraVolumes:\n          - hostPath: /var/log/apiserver\n            mountPath: /var/log/apiserver\n            name: audit-log\n            pathType: DirectoryOrCreate\n        timeoutForControlPlane: 10m0s\n      controllerManager:\n        extraArgs:\n          feature-gates: RotateKubeletServerCertificate=true\n          profiling: "false"\n          terminated-pod-gc-threshold: "25"\n          use-service-account-credentials: "true"\n      etcd:\n        local:\n          dataDir: /etc/kubernetes/etcd\n          extraArgs:\n            listen-client-urls: https://0.0.0.0:2379\n      kubernetesVersion: v1.30.0\n      networking:\n        podSubnet: 192.168.0.0/16\n        serviceSubnet: 192.169.0.0/16\n\n    initConfiguration:\n      nodeRegistration:\n        kubeletExtraArgs:\n          event-qps: "0"\n          feature-gates: RotateKubeletServerCertificate=true\n          protect-kernel-defaults: "true"\n          read-only-port: "0"\n\n    joinConfiguration:\n      nodeRegistration:\n        kubeletExtraArgs:\n          event-qps: "0"\n          feature-gates: RotateKubeletServerCertificate=true\n          protect-kernel-defaults: "true"\n          read-only-port: "0"\n\n    kubeletConfiguration:\n      authentication:\n        anonymous: {}\n        webhook: { cacheTTL: 0s }\n        x509: {}\n      authorization:\n        webhook:\n          cacheAuthorizedTTL: 0s\n          cacheUnauthorizedTTL: 0s\n      cpuManagerReconcilePeriod: 0s\n      logging:\n        flushFrequency: 0\n        options:\n          json:\n            infoBufferSize: "0"\n        verbosity: 0\n\nstages:\n  initramfs:\n    - name: pre-kubeadm\n      sysctl:\n        net.ipv4.conf.default.rp_filter: 0\n        net.ipv4.conf.all.rp_filter: 0\n        net.bridge.bridge-nf-call-ip6tables: 1\n        net.bridge.bridge-nf-call-iptables: 1\n        net.ipv4.ip_forward: 1\n        kernel.panic: "10"\n        kernel.panic_on_oops: "1"\n        vm.overcommit_memory: "1"\n      modules:\n        - br_netfilter\n        - overlay\n      files:\n        - path: /etc/containerd/config.toml\n          permissions: "0644"\n          content: |\n            [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc.options]\n              SystemdCgroup = true\n            [plugins."io.containerd.grpc.v1.cri"]\n              sandbox_image = "registry.k8s.io/pause:3.8"\n        - path: /etc/hosts\n          permissions: "0644"\n          content: |\n            127.0.0.1 localhost\n      users:\n        kairos:\n          passwd: kairos\n          groups:\n            - sudo\n      commands:\n        - ln -s /etc/kubernetes/admin.conf /run/kubeconfig\n        - mkdir -p /etc/kubernetes/manifests\n'})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"cluster.role"})," is set to ",(0,i.jsx)(n.code,{children:"init"}),", so this node bootstraps the control plane. For a multi-node setup, change this to ",(0,i.jsx)(n.code,{children:"join"})," and provide discovery options."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"-whats-next",children:"\ud83d\udd04 What\u2019s Next?"}),"\n",(0,i.jsx)(n.p,{children:"This is a minimal setup, but it lays the groundwork for more advanced clusters. From here, you can:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Customize the CNI (via the containerd config or an additional stage),"}),"\n",(0,i.jsxs)(n.li,{children:["Inject manifests into ",(0,i.jsx)(n.code,{children:"/etc/kubernetes/manifests"}),","]}),"\n",(0,i.jsxs)(n.li,{children:["Scale to multiple nodes with ",(0,i.jsx)(n.code,{children:"join"})," configurations and token-based discovery."]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"And, of course, all of this benefits from the immutability and reproducibility that Kairos brings to the OS layer."}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsxs)(n.p,{children:["If you want to see more examples or contribute to the ",(0,i.jsx)(n.code,{children:"provider-kubeadm"}),", check out the ",(0,i.jsx)(n.a,{href:"https://github.com/kairos-io/provider-kubeadm",children:"GitHub repo"})," or hop into our community channels."]}),"\n",(0,i.jsx)(n.p,{children:"Let us know how you're bootstrapping Kubernetes with Kairos\u2014we'd love to feature your use case!"})]})}function u(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}}}]);