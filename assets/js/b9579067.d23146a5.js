"use strict";(globalThis.webpackChunkkairos_docs=globalThis.webpackChunkkairos_docs||[]).push([[2646],{12729:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>l,contentTitle:()=>r,default:()=>u,frontMatter:()=>o,metadata:()=>t,toc:()=>d});const t=JSON.parse('{"id":"Advanced/bundles","title":"Bundles","description":"Bundles are a powerful feature of Kairos that let you customize and configure your operating system. This section explains how to use and build custom bundles.","source":"@site/docs/Advanced/bundles.md","sourceDirName":"Advanced","slug":"/Advanced/bundles","permalink":"/docs/next/Advanced/bundles","draft":false,"unlisted":false,"editUrl":"https://github.com/kairos-io/kairos-docs/tree/main/docs/Advanced/bundles.md","tags":[],"version":"current","lastUpdatedBy":"Jasper De Keukelaere (imec)","lastUpdatedAt":1765043763000,"sidebarPosition":5,"frontMatter":{"title":"Bundles","sidebar_label":"Bundles","sidebar_position":5,"description":"Bundles are a powerful feature of Kairos that let you customize and configure your operating system. This section explains how to use and build custom bundles."},"sidebar":"tutorialSidebar","previous":{"title":"Extending the system with systemd extensions","permalink":"/docs/next/Advanced/sys-extensions"},"next":{"title":"Encrypting User Data with Kairos","permalink":"/docs/next/Advanced/partition_encryption"}}');var i=s(74848),a=s(28453);const o={title:"Bundles",sidebar_label:"Bundles",sidebar_position:5,description:"Bundles are a powerful feature of Kairos that let you customize and configure your operating system. This section explains how to use and build custom bundles."},r=void 0,l={},d=[{value:"Consuming Bundles",id:"consuming-bundles",level:2},{value:"Bundle types",id:"bundle-types",level:2},{value:"Create bundles",id:"create-bundles",level:2}];function c(e){const n={a:"a",admonition:"admonition",code:"code",h2:"h2",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.p,{children:"Whether you need to add custom logic, install extra packages, or make other modifications to your system, bundles simplify the process. They can be applied after installation or before bootstrapping a node."}),"\n",(0,i.jsxs)(n.p,{children:["Bundles are container images containing only files (and not full OS) that can be used to install new software or extend the cloud-init syntax. You can find community-supported bundles in the ",(0,i.jsx)(n.a,{href:"https://github.com/kairos-io/community-bundles",children:"community-bundles"})," repository."]}),"\n",(0,i.jsx)(n.h2,{id:"consuming-bundles",children:"Consuming Bundles"}),"\n",(0,i.jsx)(n.p,{children:"To use a bundle in your Kairos configuration, you will need to specify the type of bundle and the target image in your cloud-config file."}),"\n",(0,i.jsx)(n.p,{children:"There are two points in time when the bundles may be installed:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Right after installation, before booting to the installed system."}),"\n",(0,i.jsx)(n.li,{children:'On first boot, after booting to the installed system. If you are booting a "standard" image (the one with Kubernetes), the bundle is installed before\nKubernetes starts.'}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["The first type of installation can be used to create ",(0,i.jsx)(n.a,{href:"https://www.freedesktop.org/software/systemd/man/devel/systemd-sysext.html",children:"systemd-sysext extensions"}),".\nYou can read more ",(0,i.jsx)(n.a,{href:"../sys-extensions",children:"here"}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["The second type of installation can be used to make changes to the installed system.\nE.g. create kubernetes resource files in ",(0,i.jsx)(n.code,{children:"/var/lib/rancher/k3s/server/manifests/"}),"\nlike ",(0,i.jsx)(n.a,{href:"https://github.com/kairos-io/community-bundles/blob/4673a2d7002a54e42f2780c30e7185bbe976eb7e/longhorn/run.sh#L5C38-L5C76",children:"longhorn community bundle does"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"To apply a bundle on the first boot (and before Kubernetes starts),\nyou can include it in your config like this:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"#cloud-config\n\nbundles:\n- targets:\n  - run://<image>\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Replace ",(0,i.jsx)(n.code,{children:"<image>"})," with the URL or path to the bundle image. The prefix (e.g. ",(0,i.jsx)(n.code,{children:"run://"}),") indicates the type of bundle being used."]}),"\n",(0,i.jsx)(n.p,{children:"To install a bundle after installation instead (for bundles that are created to\nbe used like that), use the following:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"#cloud-config\ninstall:\n bundles:\n - targets:\n   - run://<image>\n"})}),"\n",(0,i.jsx)(n.p,{children:"Bundles have access to the Kairos cloud-config during their installation.\nThis allows the user to add new blocks of configuration to configure the bundles."}),"\n",(0,i.jsxs)(n.p,{children:["For example, this is how ",(0,i.jsx)(n.code,{children:"metalLB"})," ",(0,i.jsx)(n.a,{href:"https://github.com/kairos-io/community-bundles",children:"community bundle"})," can be configured:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"#cloud-config\n\nhostname: kairoslab-{{ trunc 4 .MachineID }}\nusers:\n- name: kairos\n  ssh_authorized_keys:\n  # Add your github user here!\n  - github:mudler\n\nk3s:\n  enable: true\n  args:\n  - --disable=servicelb\n\n# Specify the bundle to use\nbundles:\n- targets:\n  - run://quay.io/kairos/community-bundles:metallb_latest\n\n# Specify metallb settings\nmetallb:\n  version: 0.13.7\n  address_pool: 192.168.1.10-192.168.1.20\n"})}),"\n",(0,i.jsx)(n.admonition,{title:"Warning",type:"warning",children:(0,i.jsx)(n.p,{children:"For both types of bundle installation (after installation, on first boot),\nthe installation only happens once. Changing the bundle's configuration block\nafter Kairos installation is complete, will not have any effect."})}),"\n",(0,i.jsxs)(n.p,{children:["If you want the installation to stop if a bundle installation fails, you can\nadd set the following option to ",(0,i.jsx)(n.code,{children:"true"})," in your Kairos config:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"fail_on_bundles_errors: true\n"})}),"\n",(0,i.jsxs)(n.p,{children:["If you want to install a bundle after installation has finished, you can use\nthe ",(0,i.jsx)(n.code,{children:"kairos-agent"})," to perform a manual installation. E.g.:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"kairos-agent install-bundle run://quay.io/kairos/community-bundles:cert-manager_latest\n"})}),"\n",(0,i.jsx)(n.h2,{id:"bundle-types",children:"Bundle types"}),"\n",(0,i.jsxs)(n.p,{children:["Bundles can carry also binaries that can be overlayed in the rootfs while ",(0,i.jsx)(n.a,{href:"../build",children:"building images"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"Kairos supports three types of bundles:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Container"}),": This type is a bare container that simply contains files that need to be copied to the system. It is useful for copying over configuration files, scripts, or any other static content that you want to include on your system (prefixed with ",(0,i.jsx)(n.code,{children:"container:"})," or ",(0,i.jsx)(n.code,{children:"docker:"}),")."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Run"}),": This type is also a bare container, but it comes with a script that can be run during the installation phase to add custom logic. This is useful for performing any necessary setup or configuration tasks that need to be done before the cluster is fully deployed (prefixed with ",(0,i.jsx)(n.code,{children:"run:"}),")."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Package"}),": This type is a ",(0,i.jsx)(n.a,{href:"https://luet.io",children:"luet"})," package that will be installed in the system. It requires you to specify a ",(0,i.jsx)(n.code,{children:"luet"})," repository in order to work. Luet packages are a powerful way to manage dependencies and install software on your system (prefixed with ",(0,i.jsx)(n.code,{children:"luet:"}),")."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["You can also specify ",(0,i.jsx)(n.code,{children:"local_file: true"})," in the bundles configuration. In that case the bundle's URL is translated as an absolute path to an image tarball on the filesystem.\nThis feature can be used in airgap situations, where you can pre-add bundles to the image before deployment."]}),"\n",(0,i.jsx)(n.p,{children:"For example:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"install:\n  bundles:\n  - targets:\n    - container:///home/kairos/mybundle.tar\n    local_file: true\n"})}),"\n",(0,i.jsxs)(n.p,{children:["The format of the bundle tarball is the one you get when you ",(0,i.jsx)(n.code,{children:"docker save myorg/myimage"})," or ",(0,i.jsx)(n.code,{children:"skopeo copy docker-daemon:myorg/myimage docker-archive:myimage.tar"})]}),"\n",(0,i.jsx)(n.p,{children:"It's important to note that bundles do not have any special meaning in terms of immutability. They install files over paths that are mutable in the system, as they are simply overlaid during the boot process. This means that you can use bundles to make changes to your system at any time, even after it has been deployed."}),"\n",(0,i.jsx)(n.h2,{id:"create-bundles",children:"Create bundles"}),"\n",(0,i.jsx)(n.p,{children:"To build your own bundle, start by creating a Dockerfile along with any required files and scripts. A bundle is essentially a container image that packages all the assets needed for a specific task."}),"\n",(0,i.jsx)(n.p,{children:"When defining your bundle, choose a base image and copy the relevant files and scripts into it. For example, the following Dockerfile creates a bundle that deploys everything inside assets to a Kubernetes cluster:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-Dockerfile",children:"FROM alpine\nCOPY ./run.sh /\nCOPY ./assets /assets\n"})}),"\n",(0,i.jsxs)(n.p,{children:["And the associated ",(0,i.jsx)(n.code,{children:"run.sh"})," that installs the assets depending on a cloud-config keyword can be:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'#!/bin/bash\n\nK3S_MANIFEST_DIR="/var/lib/rancher/k3s/server/manifests/"\n\nmkdir -p $K3S_MANIFEST_DIR\n\n# IF the user sets `example.enable` in the input cloud config, we install our assets\nif [ "$(kairos-agent config get example.enable | tr -d \'\\n\')" == "true" ]; then\n  cp -rf assets/* $K3S_MANIFEST_DIR\nfi\n'})}),"\n",(0,i.jsx)(n.p,{children:"This Dockerfile creates an image based on the Alpine base image, and copies over a script file and some assets to the image.\nYou can then add any additional instructions to the Dockerfile to install necessary packages, set environment variables, or perform any other tasks required by your bundle."}),"\n",(0,i.jsx)(n.p,{children:"Once you have created your Dockerfile and any necessary script files, you can build your bundle image by running docker build and specifying the path to your Dockerfile."}),"\n",(0,i.jsx)(n.p,{children:"For example:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"docker build -t <image> .\n"})}),"\n",(0,i.jsxs)(n.p,{children:["This command will build an image with the name you specify ( replace ",(0,i.jsx)(n.code,{children:"<image>"})," accordingly ) based on the instructions in your Dockerfile."]}),"\n",(0,i.jsx)(n.p,{children:"After building your bundle image, you will need to push it to a registry so that it can be accessed by Kairos. You can use a public registry like Docker Hub. To push your image to a registry, use the docker push command. For example:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"docker push <image>\n"})}),"\n",(0,i.jsxs)(n.p,{children:["This will push the ",(0,i.jsx)(n.code,{children:"<image>"})," to your specified registry."]}),"\n",(0,i.jsx)(n.p,{children:"And use it with Kairos:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"#cloud-config\n\nbundles:\n- targets:\n  # e.g. run://quay.io/...:tag\n  - run://<image>\n\nexample:\n  enable: true\n"})}),"\n",(0,i.jsxs)(n.p,{children:["See the ",(0,i.jsx)(n.a,{href:"https://github.com/kairos-io/community-bundles",children:"community-bundles repository"})," for further examples."]})]})}function u(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},28453:(e,n,s)=>{s.d(n,{R:()=>o,x:()=>r});var t=s(96540);const i={},a=t.createContext(i);function o(e){const n=t.useContext(a);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),t.createElement(a.Provider,{value:n},e.children)}}}]);