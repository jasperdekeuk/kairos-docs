"use strict";(globalThis.webpackChunkkairos_docs=globalThis.webpackChunkkairos_docs||[]).push([[9192],{11470:(e,t,n)=>{n.d(t,{A:()=>k});var r=n(96540),a=n(34164),o=n(17559),s=n(23104),i=n(56347),l=n(205),c=n(57485),u=n(31682),d=n(70679);function h(e){return r.Children.toArray(e).filter(e=>"\n"!==e).map(e=>{if(!e||(0,r.isValidElement)(e)&&function(e){const{props:t}=e;return!!t&&"object"==typeof t&&"value"in t}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)})?.filter(Boolean)??[]}function m(e){const{values:t,children:n}=e;return(0,r.useMemo)(()=>{const e=t??function(e){return h(e).map(({props:{value:e,label:t,attributes:n,default:r}})=>({value:e,label:t,attributes:n,default:r}))}(n);return function(e){const t=(0,u.XI)(e,(e,t)=>e.value===t.value);if(t.length>0)throw new Error(`Docusaurus error: Duplicate values "${t.map(e=>e.value).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e},[t,n])}function p({value:e,tabValues:t}){return t.some(t=>t.value===e)}function b({queryString:e=!1,groupId:t}){const n=(0,i.W6)(),a=function({queryString:e=!1,groupId:t}){if("string"==typeof e)return e;if(!1===e)return null;if(!0===e&&!t)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return t??null}({queryString:e,groupId:t});return[(0,c.aZ)(a),(0,r.useCallback)(e=>{if(!a)return;const t=new URLSearchParams(n.location.search);t.set(a,e),n.replace({...n.location,search:t.toString()})},[a,n])]}function f(e){const{defaultValue:t,queryString:n=!1,groupId:a}=e,o=m(e),[s,i]=(0,r.useState)(()=>function({defaultValue:e,tabValues:t}){if(0===t.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(e){if(!p({value:e,tabValues:t}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${e}" but none of its children has the corresponding value. Available values are: ${t.map(e=>e.value).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return e}const n=t.find(e=>e.default)??t[0];if(!n)throw new Error("Unexpected error: 0 tabValues");return n.value}({defaultValue:t,tabValues:o})),[c,u]=b({queryString:n,groupId:a}),[h,f]=function({groupId:e}){const t=function(e){return e?`docusaurus.tab.${e}`:null}(e),[n,a]=(0,d.Dv)(t);return[n,(0,r.useCallback)(e=>{t&&a.set(e)},[t,a])]}({groupId:a}),g=(()=>{const e=c??h;return p({value:e,tabValues:o})?e:null})();(0,l.A)(()=>{g&&i(g)},[g]);return{selectedValue:s,selectValue:(0,r.useCallback)(e=>{if(!p({value:e,tabValues:o}))throw new Error(`Can't select invalid tab value=${e}`);i(e),u(e),f(e)},[u,f,o]),tabValues:o}}var g=n(92303);const v={tabList:"tabList__CuJ",tabItem:"tabItem_LNqP"};var y=n(74848);function x({className:e,block:t,selectedValue:n,selectValue:r,tabValues:o}){const i=[],{blockElementScrollPositionUntilNextRender:l}=(0,s.a_)(),c=e=>{const t=e.currentTarget,a=i.indexOf(t),s=o[a].value;s!==n&&(l(t),r(s))},u=e=>{let t=null;switch(e.key){case"Enter":c(e);break;case"ArrowRight":{const n=i.indexOf(e.currentTarget)+1;t=i[n]??i[0];break}case"ArrowLeft":{const n=i.indexOf(e.currentTarget)-1;t=i[n]??i[i.length-1];break}}t?.focus()};return(0,y.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,a.A)("tabs",{"tabs--block":t},e),children:o.map(({value:e,label:t,attributes:r})=>(0,y.jsx)("li",{role:"tab",tabIndex:n===e?0:-1,"aria-selected":n===e,ref:e=>{i.push(e)},onKeyDown:u,onClick:c,...r,className:(0,a.A)("tabs__item",v.tabItem,r?.className,{"tabs__item--active":n===e}),children:t??e},e))})}function w({lazy:e,children:t,selectedValue:n}){const o=(Array.isArray(t)?t:[t]).filter(Boolean);if(e){const e=o.find(e=>e.props.value===n);return e?(0,r.cloneElement)(e,{className:(0,a.A)("margin-top--md",e.props.className)}):null}return(0,y.jsx)("div",{className:"margin-top--md",children:o.map((e,t)=>(0,r.cloneElement)(e,{key:t,hidden:e.props.value!==n}))})}function j(e){const t=f(e);return(0,y.jsxs)("div",{className:(0,a.A)(o.G.tabs.container,"tabs-container",v.tabList),children:[(0,y.jsx)(x,{...t,...e}),(0,y.jsx)(w,{...t,...e})]})}function k(e){const t=(0,g.A)();return(0,y.jsx)(j,{...e,children:h(e.children)},String(t))}},19365:(e,t,n)=>{n.d(t,{A:()=>s});n(96540);var r=n(34164);const a={tabItem:"tabItem_Ymn6"};var o=n(74848);function s({children:e,hidden:t,className:n}){return(0,o.jsx)("div",{role:"tabpanel",className:(0,r.A)(a.tabItem,n),hidden:t,children:e})}},28143:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>u,contentTitle:()=>c,default:()=>m,frontMatter:()=>l,metadata:()=>r,toc:()=>d});const r=JSON.parse('{"id":"Reference/reset","title":"Reset a node","description":"Discover how to reset a Kairos node using boot options, Kubernetes integration, or recovery tools while preserving config data.","source":"@site/docs/Reference/reset.md","sourceDirName":"Reference","slug":"/Reference/reset","permalink":"/kairos-docs/docs/next/Reference/reset","draft":false,"unlisted":false,"editUrl":"https://github.com/kairos-io/kairos-docs/tree/main/docs/Reference/reset.md","tags":[],"version":"current","lastUpdatedBy":"Jasper De Keukelaere (imec)","lastUpdatedAt":1765043763000,"sidebarPosition":4,"frontMatter":{"title":"Reset a node","sidebar_label":"Reset","description":"Discover how to reset a Kairos node using boot options, Kubernetes integration, or recovery tools while preserving config data.","sidebar_position":4,"date":"2022-11-13T00:00:00.000Z"},"sidebar":"tutorialSidebar","previous":{"title":"The Kairos Factory","permalink":"/kairos-docs/docs/next/Reference/kairos-factory"},"next":{"title":"Build Kairos from scratch","permalink":"/kairos-docs/docs/next/Reference/build-from-scratch"}}');var a=n(74848),o=n(28453),s=n(11470),i=n(19365);const l={title:"Reset a node",sidebar_label:"Reset",description:"Discover how to reset a Kairos node using boot options, Kubernetes integration, or recovery tools while preserving config data.",sidebar_position:4,date:new Date("2022-11-13T00:00:00.000Z")},c="How to",u={},d=[{value:"From the boot menu",id:"from-the-boot-menu",level:2},{value:"Remotely, via command line",id:"remotely-via-command-line",level:2},{value:"From Kubernetes",id:"from-kubernetes",level:2},{value:"Manual reset",id:"manual-reset",level:2},{value:"Cleaning up state directories",id:"cleaning-up-state-directories",level:3}];function h(e){const t={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",img:"img",p:"p",pre:"pre",...(0,o.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(t.p,{children:"Kairos has a recovery mechanism built-in which can be leveraged to restore the system to a known point. At installation time, the recovery partition is created from the installation medium and can be used to restore the system from scratch, leaving configuration intact and cleaning any persistent data accumulated by usage in the host (e.g. Kubernetes images, persistent volumes, etc. )."}),"\n",(0,a.jsxs)(t.p,{children:["The reset action will regenerate the bootloader configuration and the images in the state partition (labeled ",(0,a.jsx)(t.code,{children:"COS_STATE"}),") by using the recovery image generated at install time, cleaning up the host."]}),"\n",(0,a.jsxs)(t.p,{children:["The configuration files in ",(0,a.jsx)(t.code,{children:"/oem"})," are kept intact, the node on the next reboot after a reset will perform the same boot sequence (again) of a first-boot installation."]}),"\n",(0,a.jsx)(t.header,{children:(0,a.jsx)(t.h1,{id:"how-to",children:"How to"})}),"\n",(0,a.jsx)(t.admonition,{title:"Note",type:"note",children:(0,a.jsxs)(t.p,{children:["By following the steps below you will ",(0,a.jsx)(t.em,{children:"reset"})," entirely a node and the persistent data will be lost. This includes ",(0,a.jsx)(t.em,{children:"every"})," user-data stored on the machine."]})}),"\n",(0,a.jsx)(t.p,{children:"The reset action can be accessed via the Boot menu, remotely, triggered via Kubernetes or manually. In each scenario the machine will reboot into reset mode, perform the cleanup, and reboot automatically afterwards."}),"\n",(0,a.jsx)(t.h2,{id:"from-the-boot-menu",children:"From the boot menu"}),"\n",(0,a.jsx)(t.p,{children:'It is possible to reset the state of a node by either booting into the "Reset" mode into the boot menu, which automatically will reset the node:'}),"\n",(0,a.jsx)(t.p,{children:(0,a.jsx)(t.img,{src:"https://user-images.githubusercontent.com/2420543/191941281-573e2bed-f66c-48db-8c46-e8034417539e.gif?classes=border,shadow",alt:"reset"})}),"\n",(0,a.jsx)(t.h2,{id:"remotely-via-command-line",children:"Remotely, via command line"}),"\n",(0,a.jsx)(t.p,{children:"On a Kairos booted system, logged as root:"}),"\n","\n",(0,a.jsxs)(s.A,{children:[(0,a.jsxs)(i.A,{value:"kairos-v3.0.0-and-upwards",label:"Kairos v3.0.0 and upwards",children:[(0,a.jsx)(t.p,{children:"To directly select the entry:"}),(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-bash",children:"$ kairos-agent bootentry --select statereset\n"})}),(0,a.jsx)(t.p,{children:"Or to get a list of available boot entries and select one interactively:"}),(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-bash",children:"$ kairos-agent bootentry\n"})})]}),(0,a.jsx)(i.A,{value:"kairos-before-v3.0.0",label:"Kairos before v3.0.0",children:(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-bash",children:"$ grub2-editenv /oem/grubenv set next_entry=statereset\n$ reboot\n"})})})]}),"\n",(0,a.jsx)(t.h2,{id:"from-kubernetes",children:"From Kubernetes"}),"\n",(0,a.jsxs)(t.p,{children:["The ",(0,a.jsx)(t.a,{href:"../../Upgrade/kairos-operator",children:"Kairos operator"})," can be used to apply a NodeOp to the nodes to use Kubernetes to schedule the reset on the nodes itself, similarly on how upgrades are applied."]}),"\n",(0,a.jsx)(t.p,{children:"Consider the following example which resets a machine by changing the config file used during installation:"}),"\n",(0,a.jsxs)(s.A,{children:[(0,a.jsx)(i.A,{value:"kairos-v3.0.0-and-upwards",label:"Kairos v3.0.0 and upwards",children:(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-yaml",children:"apiVersion: operator.kairos.io/v1alpha1\nkind: NodeOp\nmetadata:\n  name: reset-and-reconfig\n  namespace: default\nspec:\n  # NodeSelector to target specific nodes\n  nodeSelector:\n    matchLabels:\n      kairos.io/managed: \"true\"\n\n  # The container image to use\n  image: quay.io/kairos/@flavor\n\n  # Custom command to execute\n  command:\n    - sh\n    - -c\n    - |\n      set -e\n\n      # Create new configuration\n      cat > /host/oem/90_custom.yaml << 'EOF'\n      #cloud-config\n      hostname: testcluster-{{ trunc 4 .MachineID }}\n      k3s:\n        enabled: true\n      users:\n      - name: kairos\n        passwd: kairos\n        groups:\n        - admin\n        ssh_authorized_keys:\n        - github:mudler\n      EOF\n\n      # Set next boot to reset state\n      grub2-editenv /host/oem/grubenv set next_entry=statereset\n      sync\n      # Note: The reboot is handled automatically by the operator when rebootOnSuccess: true\n\n  # Path where the node's root filesystem will be mounted\n  hostMountPath: /host\n\n  # Whether to cordon the node before running the operation\n  cordon: true\n\n  # Drain options for pod eviction\n  drainOptions:\n    enabled: true\n    force: false\n    gracePeriodSeconds: 30\n    ignoreDaemonSets: true\n    deleteEmptyDirData: false\n    timeoutSeconds: 300\n\n  # Whether to reboot the node after successful operation\n  rebootOnSuccess: true\n\n  # Maximum number of nodes that can run the operation simultaneously\n  concurrency: 2\n\n  # Whether to stop creating new jobs when a job fails\n  stopOnFailure: true\n"})})}),(0,a.jsx)(i.A,{value:"kairos-before-v3.0.0",label:"Kairos before v3.0.0",children:(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-yaml",children:'---\napiVersion: v1\nkind: Secret\nmetadata:\n  name: custom-script\n  namespace: system-upgrade\ntype: Opaque\nstringData:\n  config.yaml: |\n    #cloud-config\n    hostname: testcluster-{{ trunc 4 .MachineID }}\n    k3s:\n      enabled: true\n    users:\n    - name: kairos\n      passwd: kairos\n      groups:\n      - admin\n      ssh_authorized_keys:\n      - github:mudler\n  add-config-file.sh: |\n    #!/bin/sh\n    set -e\n    if diff /host/run/system-upgrade/secrets/custom-script/config.yaml /host/oem/90_custom.yaml >/dev/null; then\n        echo config present\n        exit 0\n    fi\n    # we can\'t cp, that\'s a symlink!\n    cat /host/run/system-upgrade/secrets/custom-script/config.yaml > /host/oem/90_custom.yaml\n    kairos-agent bootentry --select statereset\n    sync\n\n    mount --rbind /host/dev /dev\n    mount --rbind /host/run /run\n    nsenter -i -m -t 1 -- reboot\n    exit 1\n---\napiVersion: upgrade.cattle.io/v1\nkind: Plan\nmetadata:\n  name: reset-and-reconfig\n  namespace: system-upgrade\nspec:\n  concurrency: 2\n  # This is the version (tag) of the image.\n  version: "\x3c!-- Hugo shortcode: ociTag variant=\\"standard\\"  --\x3e"\n  nodeSelector:\n    matchExpressions:\n      - { key: kubernetes.io/hostname, operator: Exists }\n  serviceAccountName: system-upgrade\n  cordon: false\n  upgrade:\n    # Here goes the image which is tied to the flavor being used.\n    # Currently can pick between opensuse and alpine\n    image: quay.io/kairos/@flavor\n    command:\n      - "/bin/bash"\n      - "-c"\n    args:\n      - bash /host/run/system-upgrade/secrets/custom-script/add-config-file.sh\n  secrets:\n    - name: custom-script\n      path: /host/run/system-upgrade/secrets/custom-script\n'})})})]}),"\n",(0,a.jsx)(t.h2,{id:"manual-reset",children:"Manual reset"}),"\n",(0,a.jsxs)(t.p,{children:["It is possible to trigger the reset manually by logging into the recovery from the boot menu and running ",(0,a.jsx)(t.code,{children:"kairos reset"})," from the console."]}),"\n",(0,a.jsx)(t.h3,{id:"cleaning-up-state-directories",children:"Cleaning up state directories"}),"\n",(0,a.jsxs)(t.p,{children:["An alternative way and manual of resetting your system is possible by deleting the state paths. You can achieve this by deleting the contents of the ",(0,a.jsx)(t.code,{children:"/usr/local"})," directory. It's recommended that you do this while in recovery mode with all services turned off."]}),"\n",(0,a.jsxs)(t.p,{children:["Please note that within ",(0,a.jsx)(t.code,{children:"/usr/local"}),", there are two important folders to keep in mind. The first is ",(0,a.jsx)(t.code,{children:"/usr/local/.kairos"}),", which contains sentinel files that will trigger a complete deployment from scratch when deleted. However, your data will be preserved. The second folder is ",(0,a.jsx)(t.code,{children:"/usr/local/.state"}),", which contains the bind-mounted data for the system. By deleting these two folders, you can achieve a pristine environment while leaving all other contents of ",(0,a.jsx)(t.code,{children:"/usr/local"})," untouched."]})]})}function m(e={}){const{wrapper:t}={...(0,o.R)(),...e.components};return t?(0,a.jsx)(t,{...e,children:(0,a.jsx)(h,{...e})}):h(e)}},28453:(e,t,n)=>{n.d(t,{R:()=>s,x:()=>i});var r=n(96540);const a={},o=r.createContext(a);function s(e){const t=r.useContext(o);return r.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function i(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:s(e.components),r.createElement(o.Provider,{value:t},e.children)}}}]);