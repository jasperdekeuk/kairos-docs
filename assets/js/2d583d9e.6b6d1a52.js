"use strict";(globalThis.webpackChunkkairos_docs=globalThis.webpackChunkkairos_docs||[]).push([[8365],{28453:(e,n,a)=>{a.d(n,{R:()=>r,x:()=>o});var s=a(96540);const i={},t=s.createContext(i);function r(e){const n=s.useContext(t);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),s.createElement(t.Provider,{value:n},e.children)}},29595:(e,n,a)=>{a.r(n),a.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>h,frontMatter:()=>r,metadata:()=>s,toc:()=>d});const s=JSON.parse('{"id":"Examples/airgap","title":"How to Create an Airgap K3s Installation with Kairos","description":"This section describe examples on how to use AuroraBoot and Kairos bundles to create ISOs for airgapped installs","source":"@site/docs/Examples/airgap.md","sourceDirName":"Examples","slug":"/Examples/airgap","permalink":"/docs/next/Examples/airgap","draft":false,"unlisted":false,"editUrl":"https://github.com/kairos-io/kairos-docs/tree/main/docs/Examples/airgap.md","tags":[],"version":"current","lastUpdatedBy":"Jasper De Keukelaere (imec)","lastUpdatedAt":1765043763000,"frontMatter":{"title":"How to Create an Airgap K3s Installation with Kairos","sidebar_label":"Airgapped ISO","description":"This section describe examples on how to use AuroraBoot and Kairos bundles to create ISOs for airgapped installs"},"sidebar":"tutorialSidebar","previous":{"title":"Enabling Automatic Boot Assessment with Trusted Boot","permalink":"/docs/next/Examples/boot_assessment_trusted_boot"},"next":{"title":"Bandwidth Optimized Upgrades","permalink":"/docs/next/Examples/bandwidth-optimized-upgrades"}}');var i=a(74848),t=a(28453);const r={title:"How to Create an Airgap K3s Installation with Kairos",sidebar_label:"Airgapped ISO",description:"This section describe examples on how to use AuroraBoot and Kairos bundles to create ISOs for airgapped installs"},o=void 0,l={},d=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Creating the Bundle",id:"creating-the-bundle",level:2},{value:"Building the Offline ISO for Airgap",id:"building-the-offline-iso-for-airgap",level:2},{value:"See also",id:"see-also",level:2}];function c(e){const n={a:"a",admonition:"admonition",code:"code",h2:"h2",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,t.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(n.p,{children:["If you want to create an ",(0,i.jsx)(n.a,{href:"https://docs.k3s.io/installation/airgap",children:"airgap K3s installation"}),", Kairos provides a convenient way to do so using AuroraBoot. In this guide, we will go through the process of creating a custom ISO of Kairos that contains a configuration file and a ",(0,i.jsx)(n.a,{href:"../../advanced/bundles",children:"bundle"})," that executes preparatory steps after installation. The bundle will overlay new files in the system and prepare the node for having an airgapped K3s installation."]}),"\n",(0,i.jsx)(n.admonition,{title:"Note",type:"note",children:(0,i.jsx)(n.p,{children:"If you already have a Kubernetes cluster, you can use the osbuilder controller to generate container images with your additional files already inside."})}),"\n",(0,i.jsx)(n.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,i.jsx)(n.p,{children:"Docker running in the host"}),"\n",(0,i.jsx)(n.h2,{id:"creating-the-bundle",children:"Creating the Bundle"}),"\n",(0,i.jsxs)(n.p,{children:["First, we need to create a bundle that contains the K3s images used for the airgap installation. The bundle will place the images in the ",(0,i.jsx)(n.code,{children:"/var/lib/rancher/k3s/agent/images"})," directory. The ",(0,i.jsx)(n.code,{children:"/var/lib/rancher"})," is already configured as persistent by Kairos defaults and every change to that directory persist reboots. You can add additional persistent paths in the system with ",(0,i.jsx)(n.a,{href:"../../advanced/customizing#bind-mounts",children:"the cloud config"})]}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["Create a new directory named ",(0,i.jsx)(n.code,{children:"images-bundle"}),", and create a new file inside it called ",(0,i.jsx)(n.code,{children:"Dockerfile"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["Paste the following code into the ",(0,i.jsx)(n.code,{children:"Dockerfile"}),":"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-Dockerfile",children:"FROM alpine AS alpine\nWORKDIR /build\nRUN wget https://github.com/k3s-io/k3s/releases/download/v1.23.16%2Bk3s1/k3s-airgap-images-amd64.tar.gz\n\nFROM scratch\nCOPY ./run.sh /\nCOPY --from=alpine /build/k3s-airgap-images-amd64.tar.gz /assets\n"})}),"\n",(0,i.jsxs)(n.ol,{start:"3",children:["\n",(0,i.jsxs)(n.li,{children:["Create a new file called ",(0,i.jsx)(n.code,{children:"run.sh"})," inside the ",(0,i.jsx)(n.code,{children:"images-bundle"})," directory, and paste the following code:"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"#!/bin/bash\n\nmkdir -p /usr/local/.state/var-lib-rancher.bind/k3s/agent/images/\ncp -rfv ./k3s-airgap-images-amd64.tar.gz /usr/local/.state/var-lib-rancher.bind/k3s/agent/images/\n"})}),"\n",(0,i.jsxs)(n.ol,{start:"4",children:["\n",(0,i.jsxs)(n.li,{children:["Make the ",(0,i.jsx)(n.code,{children:"run.sh"})," file executable by running the following command:"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"chmod +x run.sh\n"})}),"\n",(0,i.jsxs)(n.ol,{start:"5",children:["\n",(0,i.jsxs)(n.li,{children:["Build the container image by running the following command inside the images-bundle directory. This will save the image as ",(0,i.jsx)(n.code,{children:"data/bundle.tar"}),":"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"docker build -t images-bundle .\n"})}),"\n",(0,i.jsxs)(n.ol,{start:"6",children:["\n",(0,i.jsx)(n.li,{children:"Save the bundle:"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"$ ls\nimages-bundle\n\n# create a directory\n$ mkdir data\n$ docker save images-bundle -o data/bundle.tar\n"})}),"\n",(0,i.jsx)(n.h2,{id:"building-the-offline-iso-for-airgap",children:"Building the Offline ISO for Airgap"}),"\n",(0,i.jsx)(n.p,{children:"Now that we have created the bundle, we can use it to build an offline ISO for the airgap installation."}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"Create a cloud config for the ISO and save it as config.yaml. The config.yaml file should contain your cloud configuration for Kairos and is used to set up the system when it is installed. An example can be:"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'#cloud-config\n\ninstall:\n auto: true\n device: "auto"\n reboot: true\n bundles:\n  # This bundle needs to run after-install as it consumes assets from the LiveCD\n  # which is not accessible otherwise at the first boot (there is no live-cd with any bundle.tar)\n - targets:\n   - run:///run/initramfs/live/bundle.tar\n   local_file: true\n\n# Define the user accounts on the node.\nusers:\n- name: "kairos"                       # The username for the user.\n  passwd: "kairos"                      # The password for the user.\n  ssh_authorized_keys:                  # A list of SSH keys to add to the user\'s authorized keys.\n  - github:mudler                       # A key from the user\'s GitHub account.\n\nk3s:\n  enabled: true\n'})}),"\n",(0,i.jsxs)(n.ol,{start:"2",children:["\n",(0,i.jsxs)(n.li,{children:["Build the ISO with ",(0,i.jsx)(n.a,{href:"../../reference/auroraboot",children:"AuroraBoot"})," by running the following command:"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'IMAGE=quay.io/kairos/kairos-standard:latest\n\ndocker pull $IMAGE\n\ndocker run -v $PWD/config.yaml:/config.yaml \\\n             -v $PWD/build:/tmp/auroraboot \\\n             -v /var/run/docker.sock:/var/run/docker.sock \\\n             -v $PWD/data:/tmp/data \\\n             --rm -ti quay.io/kairos/auroraboot:latest \\\n             --set "disable_http_server=true" \\\n             --set "disable_netboot=true" \\\n             --set "container_image=docker://$IMAGE" \\\n             --set "iso.data=/tmp/data" \\\n             --cloud-config /config.yaml \\\n             --set "state_dir=/tmp/auroraboot"\n'})}),"\n",(0,i.jsxs)(n.p,{children:["The resulting ISO should be available at: ",(0,i.jsx)(n.code,{children:"build/iso/kairos.iso"})]}),"\n",(0,i.jsxs)(n.p,{children:["This example is also available in the ",(0,i.jsx)(n.a,{href:"https://github.com/kairos-io/AuroraBoot/tree/master/examples/airgap",children:"AuroraBoot repository"})," in the ",(0,i.jsx)(n.code,{children:"examples/airgap"})," directory, where you can run ",(0,i.jsx)(n.code,{children:"build_docker.sh"})," to reproduce the example."]}),"\n",(0,i.jsx)(n.h2,{id:"see-also",children:"See also"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"../../advanced/customizing",children:"Customize the OS image"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"../../installation/automated#kubernetes",children:"Create ISOs with Kubernetes"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"../../advanced/bundles",children:"Bundles reference"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"../../advanced/sys-extensions",children:"System extensions"})}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}}}]);