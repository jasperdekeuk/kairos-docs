"use strict";(globalThis.webpackChunkkairos_docs=globalThis.webpackChunkkairos_docs||[]).push([[4022],{3792:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>r,default:()=>h,frontMatter:()=>i,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"Development/debugging-station","title":"Debugging station","description":"Debugging station","source":"@site/docs/Development/debugging-station.md","sourceDirName":"Development","slug":"/Development/debugging-station","permalink":"/docs/next/Development/debugging-station","draft":false,"unlisted":false,"editUrl":"https://github.com/kairos-io/kairos-docs/tree/main/docs/Development/debugging-station.md","tags":[],"version":"current","lastUpdatedBy":"Jasper De Keukelaere (imec)","lastUpdatedAt":1765043763000,"sidebarPosition":4,"frontMatter":{"title":"Debugging station","sidebar_label":"Debugging station","sidebar_position":4,"date":"2023-03-15T00:00:00.000Z","description":"Debugging station"},"sidebar":"tutorialSidebar","previous":{"title":"Development","permalink":"/docs/next/Development/"},"next":{"title":"Booting Kairos on Nvidia Jetson ARM","permalink":"/docs/next/Development/nvidia"}}');var a=t(74848),o=t(28453);const i={title:"Debugging station",sidebar_label:"Debugging station",sidebar_position:4,date:new Date("2023-03-15T00:00:00.000Z"),description:"Debugging station"},r=void 0,l={},c=[{value:"Configuration",id:"configuration",level:2},{value:"Deploy with AuroraBoot",id:"deploy-with-auroraboot",level:2},{value:"Connecting to the cluster",id:"connecting-to-the-cluster",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",p:"p",pre:"pre",strong:"strong",...(0,o.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(n.p,{children:["When developing or troubleshooting Kairos, it can be useful to share a local cluster with another peer. This section illustrates how to use ",(0,a.jsx)(n.a,{href:"../../reference/entangle",children:"Entangle"})," to achieve that. We call this setup ",(0,a.jsx)(n.em,{children:"debugging-station"}),"."]}),"\n",(0,a.jsx)(n.h2,{id:"configuration",children:"Configuration"}),"\n",(0,a.jsx)(n.admonition,{title:"Note",type:"warning",children:(0,a.jsxs)(n.p,{children:["This section describes the configuration step by step. If you are in a hurry, you can skip this section and directly go to ",(0,a.jsx)(n.strong,{children:"Deploy with AuroraBoot"}),"."]})}),"\n",(0,a.jsxs)(n.p,{children:["When deploying a new cluster, we can use ",(0,a.jsx)(n.a,{href:"../../advanced/bundles",children:"Bundles"})," to install the ",(0,a.jsx)(n.code,{children:"entangle"})," and ",(0,a.jsx)(n.code,{children:"cert-manager"})," chart automatically. We specify the bundles in the cloud config file as shown below:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:"bundles:\n- targets:\n  - run://quay.io/kairos/community-bundles:cert-manager_latest\n  - run://quay.io/kairos/community-bundles:kairos_latest\n"})}),"\n",(0,a.jsxs)(n.p,{children:["We also need to enable entangle by setting ",(0,a.jsx)(n.code,{children:"kairos.entangle.enable: true"}),"."]}),"\n",(0,a.jsx)(n.p,{children:"Next, we generate a new token that we will use to connect to the cluster later."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"docker run -ti --rm quay.io/mudler/edgevpn -b -g\n"})}),"\n",(0,a.jsxs)(n.p,{children:["In order for ",(0,a.jsx)(n.code,{children:"entangle"})," to use the token, we can define a ",(0,a.jsx)(n.code,{children:"Entanglement"})," to expose ssh in the mesh network like the following:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:'apiVersion: v1\nkind: Secret\nmetadata:\n  name: ssh-entanglement\n  namespace: kube-system\ntype: Opaque\nstringData:\n  network_token: ___GENERATED TOKEN HERE___\n---\napiVersion: entangle.kairos.io/v1alpha1\nkind: Entanglement\nmetadata:\n  name: ssh-entanglement\n  namespace: kube-system\nspec:\n    serviceUUID: "ssh"\n    secretRef: "ssh-entanglement"\n    host: "127.0.0.1"\n    port: "22"\n    hostNetwork: true\n'})}),"\n",(0,a.jsx)(n.admonition,{title:"Note",type:"warning",children:(0,a.jsxs)(n.p,{children:["If you have already a kubernetes cluster, you can install the ",(0,a.jsx)(n.a,{href:"../../reference/entangle",children:"Entangle"})," chart and just apply the manifest."]})}),"\n",(0,a.jsxs)(n.p,{children:["This entanglement will expose the port ",(0,a.jsx)(n.code,{children:"22"})," in the node over the mesh network with the ",(0,a.jsx)(n.code,{children:"ssh"})," service UUID so we can later connect to it. Replace ",(0,a.jsx)(n.code,{children:"___GENERATED TOKEN HERE___"})," with the token you previously generated with the ",(0,a.jsx)(n.code,{children:"docker"})," command (check out the ",(0,a.jsx)(n.a,{href:"../../reference/entangle",children:"documentation"})," for advanced usage)."]}),"\n",(0,a.jsxs)(n.p,{children:["In order to deploy the ",(0,a.jsx)(n.code,{children:"Entanglement"})," automatically, we can add it to the ",(0,a.jsx)(n.code,{children:"k3s"})," manifests folder in the cloud config file:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:'write_files:\n- path: /var/lib/rancher/k3s/server/manifests/expose-ssh.yaml\n  permissions: "0644"\n  owner: "root"\n  content: |\n      apiVersion: v1\n      kind: Secret\n      metadata:\n        name: ssh-entanglement\n        namespace: kube-system\n      type: Opaque\n      stringData:\n        network_token: ___GENERATED TOKEN HERE___\n      ---\n      apiVersion: entangle.kairos.io/v1alpha1\n      kind: Entanglement\n      metadata:\n        name: ssh-entanglement\n        namespace: kube-system\n      spec:\n         serviceUUID: "ssh"\n         secretRef: "ssh-entanglement"\n         host: "127.0.0.1"\n         port: "22"\n         hostNetwork: true\n'})}),"\n",(0,a.jsxs)(n.p,{children:["Here's an example of a complete cloud configuration file which automatically install a Kairos node in the bigger disk, and exposes ssh with ",(0,a.jsx)(n.code,{children:"entangle"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:'#cloud-config\n\ninstall:\n device: "auto"\n auto: true\n reboot: true\n\nhostname: debugging-station-{{ trunc 4 .MachineID }}\n\nusers:\n- name: kairos\n  passwd: kairos\n  groups:\n  - admin\n  ssh_authorized_keys:\n  - github:mudler\n\nk3s:\n  enabled: true\n\n# Specify the bundle to use\nbundles:\n- targets:\n  - run://quay.io/kairos/community-bundles:cert-manager_latest\n  - run://quay.io/kairos/community-bundles:kairos_latest\n\nkairos:\n  entangle:\n    enable: true\n\nwrite_files:\n- path: /var/lib/rancher/k3s/server/manifests/expose-ssh.yaml\n  permissions: "0644"\n  owner: "root"\n  content: |\n      apiVersion: v1\n      kind: Secret\n      metadata:\n        name: ssh-entanglement\n        namespace: kube-system\n      type: Opaque\n      stringData:\n        network_token: ___GENERATED TOKEN HERE___\n      ---\n      apiVersion: entangle.kairos.io/v1alpha1\n      kind: Entanglement\n      metadata:\n        name: ssh-entanglement\n        namespace: kube-system\n      spec:\n         serviceUUID: "ssh"\n         secretRef: "ssh-entanglement"\n         host: "127.0.0.1"\n         port: "22"\n         hostNetwork: true\n'})}),"\n",(0,a.jsxs)(n.p,{children:["In this file, you can specify various settings for your debugging station. For example, the ",(0,a.jsx)(n.code,{children:"hostname"})," field sets the name of the machine, and the ",(0,a.jsx)(n.code,{children:"users"}),' field creates a new user with the name "kairos" and a pre-defined password and SSH key. The ',(0,a.jsx)(n.code,{children:"k3s"})," field enables the installation of the k3s Kubernetes distribution."]}),"\n",(0,a.jsx)(n.h2,{id:"deploy-with-auroraboot",children:"Deploy with AuroraBoot"}),"\n",(0,a.jsxs)(n.p,{children:["To automatically boot and install the debugging station, we can use ",(0,a.jsx)(n.a,{href:"../../reference/auroraboot",children:"Auroraboot"}),". The following example shows how to use the cloud config above with it:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'cat <<EOF | docker run --rm -i --net host quay.io/kairos/auroraboot \\\n                    --cloud-config - \\\n                    --set "container_image=quay.io/kairos/kairos-standard:latest"\n#cloud-config\n\ninstall:\n device: "auto"\n auto: true\n reboot: true\n\nhostname: debugging-station-{{ trunc 4 .MachineID }}\n\nusers:\n- name: kairos\n  passwd: kairos\n  groups:\n  - admin\n  ssh_authorized_keys:\n  - github:mudler\n\nk3s:\n  enabled: true\n\n# Specify the bundle to use\nbundles:\n- targets:\n  - run://quay.io/kairos/community-bundles:cert-manager_latest\n  - run://quay.io/kairos/community-bundles:kairos_latest\n\nkairos:\n  entangle:\n    enable: true\n\nwrite_files:\n- path: /var/lib/rancher/k3s/server/manifests/expose-ssh.yaml\n  permissions: "0644"\n  owner: "root"\n  content: |\n      apiVersion: v1\n      kind: Secret\n      metadata:\n        name: ssh-entanglement\n        namespace: kube-system\n      type: Opaque\n      stringData:\n        network_token: ___GENERATED TOKEN HERE___\n      ---\n      apiVersion: entangle.kairos.io/v1alpha1\n      kind: Entanglement\n      metadata:\n        name: ssh-entanglement\n        namespace: kube-system\n      spec:\n         serviceUUID: "ssh"\n         secretRef: "ssh-entanglement"\n         host: "127.0.0.1"\n         port: "22"\n         hostNetwork: true\nEOF\n'})}),"\n",(0,a.jsx)(n.h2,{id:"connecting-to-the-cluster",children:"Connecting to the cluster"}),"\n",(0,a.jsx)(n.p,{children:"To connect to the cluster, we first need to open the tunnel in one terminal and then ssh from another one."}),"\n",(0,a.jsx)(n.p,{children:"In one terminal, run the following command (it will run in the foreground):"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'# Run in a terminal (it is foreground)\nexport EDGEVPNTOKEN="___GENERATED TOKEN HERE___"\ndocker run -e "EDGEVPNTOKEN=$EDGEVPNTOKEN" --net host quay.io/mudler/edgevpn service-connect ssh 127.0.0.1:2222\n'})}),"\n",(0,a.jsx)(n.p,{children:"In another terminal, run the following command to ssh to the box:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"# Run in another terminal\nssh kairos@127.0.0.1 -p 2222\n"})}),"\n",(0,a.jsx)(n.p,{children:"Note: it might take few attempts to establish a connection"})]})}function h(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(d,{...e})}):d(e)}},28453:(e,n,t)=>{t.d(n,{R:()=>i,x:()=>r});var s=t(96540);const a={},o=s.createContext(a);function i(e){const n=s.useContext(o);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:i(e.components),s.createElement(o.Provider,{value:n},e.children)}}}]);