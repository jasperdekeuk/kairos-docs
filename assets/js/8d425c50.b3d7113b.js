"use strict";(globalThis.webpackChunkkairos_docs=globalThis.webpackChunkkairos_docs||[]).push([[6710],{28453:(e,n,s)=>{s.d(n,{R:()=>d,x:()=>r});var i=s(96540);const o={},t=i.createContext(o);function d(e){const n=i.useContext(t);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:d(e.components),i.createElement(t.Provider,{value:n},e.children)}},50600:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>l,contentTitle:()=>r,default:()=>h,frontMatter:()=>d,metadata:()=>i,toc:()=>a});const i=JSON.parse('{"id":"Reference/stage_modules","title":"Stage modules","description":"Explore built-in modules for DNS, users, files, and services that help you customize Kairos via cloud-init during boot stages.","source":"@site/docs/Reference/stage_modules.md","sourceDirName":"Reference","slug":"/Reference/stage_modules","permalink":"/docs/next/Reference/stage_modules","draft":false,"unlisted":false,"editUrl":"https://github.com/kairos-io/kairos-docs/tree/main/docs/Reference/stage_modules.md","tags":[],"version":"current","lastUpdatedBy":"Jasper De Keukelaere (imec)","lastUpdatedAt":1765146647000,"sidebarPosition":3,"frontMatter":{"title":"Stage modules","sidebar_label":"Stage modules","description":"Explore built-in modules for DNS, users, files, and services that help you customize Kairos via cloud-init during boot stages.","sidebar_position":3,"date":"2024-09-19T00:00:00.000Z"},"sidebar":"tutorialSidebar","previous":{"title":"kairosctl","permalink":"/docs/next/Reference/kairosctl"},"next":{"title":"The Kairos Factory","permalink":"/docs/next/Reference/kairos-factory"}}');var o=s(74848),t=s(28453);const d={title:"Stage modules",sidebar_label:"Stage modules",description:"Explore built-in modules for DNS, users, files, and services that help you customize Kairos via cloud-init during boot stages.",sidebar_position:3,date:new Date("2024-09-19T00:00:00.000Z")},r=void 0,l={},a=[{value:"<code>dns</code>",id:"dns",level:3},{value:"<code>downloads</code>",id:"downloads",level:3},{value:"<code>git</code>",id:"git",level:3},{value:"<code>ensure_entities</code>",id:"ensure_entities",level:3},{value:"<code>directories</code>",id:"directories",level:3},{value:"<code>files</code>",id:"files",level:3},{value:"<code>commands</code>",id:"commands",level:3},{value:"<code>delete_entities</code>",id:"delete_entities",level:3},{value:"<code>hostname</code>",id:"hostname",level:3},{value:"<code>sysctl</code>",id:"sysctl",level:3},{value:"<code>users</code>",id:"users",level:3},{value:"<code>authorized_keys</code>",id:"authorized_keys",level:3},{value:"<code>modules</code>",id:"modules",level:3},{value:"<code>timesyncd</code>",id:"timesyncd",level:3},{value:"<code>systemctl</code>",id:"systemctl",level:3},{value:"<code>environment_file</code>",id:"environment_file",level:3},{value:"<code>environment</code>",id:"environment",level:3},{value:"<code>systemd_firstboot</code>",id:"systemd_firstboot",level:3},{value:"<code>datasource</code>",id:"datasource",level:3},{value:"<code>layout</code>",id:"layout",level:3}];function c(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.p,{children:"For each stage in the cloud-init file, various modules are available that\nimplement different functionality each. This page describes what each one does\nand how to use it."}),"\n",(0,o.jsxs)(n.p,{children:["The order in this document is also ",(0,o.jsx)(n.a,{href:"https://github.com/kairos-io/kairos-agent/blob/fbb64f2a826f3fcf9584ed65d59e5bd8eb0c26e8/pkg/cloudinit/cloudinit.go#L44",children:"the order in which they are executed"}),"."]}),"\n",(0,o.jsx)(n.h3,{id:"dns",children:(0,o.jsx)(n.code,{children:"dns"})}),"\n",(0,o.jsxs)(n.p,{children:["A way to configure the ",(0,o.jsx)(n.code,{children:"/etc/resolv.conf"})," file."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",children:'#cloud-config\n\nstages:\n  boot:\n    - name: "Setup dns"\n      dns:\n        nameservers:\n          - 8.8.8.8\n          - 1.1.1.1\n        search:\n          - foo.bar\n        options:\n          - ..\n        path: "/etc/resolv.conf.bak"\n'})}),"\n",(0,o.jsx)(n.h3,{id:"downloads",children:(0,o.jsx)(n.code,{children:"downloads"})}),"\n",(0,o.jsx)(n.p,{children:"Download files to specified locations"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",children:'#cloud-config\n\nstages:\n  boot:\n    - downloads:\n        - path: /tmp/out\n          url: "https://www...."\n          permissions: 0700\n          owner: 0\n          group: 0\n          timeout: 0\n          owner_string: "root"\n        - path: /tmp/out\n          url: "https://www...."\n          permissions: 0700\n          owner: 0\n          group: 0\n          timeout: 0\n          owner_string: "root"\n'})}),"\n",(0,o.jsx)(n.h3,{id:"git",children:(0,o.jsx)(n.code,{children:"git"})}),"\n",(0,o.jsx)(n.p,{children:"Pull git repositories, using golang native git (no need of git in the host)."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",children:'#cloud-config\n\nstages:\n  boot:\n    - git:\n        url: "git@gitlab.com:.....git"\n        path: "/oem/cloud-config-files"\n        branch: "main"\n        auth:\n          insecure: true\n          private_key: |\n            -----BEGIN RSA PRIVATE KEY-----\n            -----END RSA PRIVATE KEY-----\n'})}),"\n",(0,o.jsx)(n.h3,{id:"ensure_entities",children:(0,o.jsx)(n.code,{children:"ensure_entities"})}),"\n",(0,o.jsxs)(n.p,{children:["A ",(0,o.jsx)(n.code,{children:"user"})," or a ",(0,o.jsx)(n.code,{children:"group"})," in the ",(0,o.jsx)(n.a,{href:"https://github.com/mudler/entities",children:"entity"})," format to be configured in the system"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",children:'#cloud-config\n\nstages:\n  boot:\n    - name: "Setup users"\n      ensure_entities:\n        -  path: /etc/passwd\n           entity: |\n             kind: "user"\n             username: "foo"\n             password: "x"\n             uid: 0\n             gid: 0\n             info: "Foo!"\n             homedir: "/home/foo"\n             shell: "/bin/bash"\n'})}),"\n",(0,o.jsx)(n.h3,{id:"directories",children:(0,o.jsx)(n.code,{children:"directories"})}),"\n",(0,o.jsxs)(n.p,{children:["A list of directories to be created on disk. Runs before ",(0,o.jsx)(n.code,{children:"files"}),"."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",children:'#cloud-config\n\nstages:\n  boot:\n    - name: "Setup folders"\n      directories:\n        - path: "/etc/foo"\n          permissions: 0600\n          owner: 0\n          group: 0\n'})}),"\n",(0,o.jsx)(n.h3,{id:"files",children:(0,o.jsx)(n.code,{children:"files"})}),"\n",(0,o.jsx)(n.p,{children:"A list of files to write to disk."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",children:'#cloud-config\nstages:\n  boot:\n    - files:\n      - path: /tmp/bar\n        encoding: "b64" # "base64", "gz", "gzip", "gz+base64", "gzip+base64", "gz+b64", "gzip+b64"\n        content: IyEvYmluL3NoCgplY2hvICJ0ZXN0Igo=\n        permissions: 0777\n        owner: 1000\n        group: 100\n        # or\n        # owner_string: "user:group", or "user"\n'})}),"\n",(0,o.jsx)(n.h3,{id:"commands",children:(0,o.jsx)(n.code,{children:"commands"})}),"\n",(0,o.jsx)(n.p,{children:"A list of arbitrary commands to run after file writes and directory creation."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",children:'#cloud-config\n\nstages:\n  boot:\n    - name: "Setup something"\n      commands:\n        - echo 1 > /bar\n'})}),"\n",(0,o.jsx)(n.h3,{id:"delete_entities",children:(0,o.jsx)(n.code,{children:"delete_entities"})}),"\n",(0,o.jsxs)(n.p,{children:["A ",(0,o.jsx)(n.code,{children:"user"})," or a ",(0,o.jsx)(n.code,{children:"group"})," in the ",(0,o.jsx)(n.a,{href:"https://github.com/mudler/entities",children:"entity"})," format to be pruned from the system"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",children:'#cloud-config\n\nstages:\n  boot:\n    - name: "Setup users"\n      delete_entities:\n        -  path: /etc/passwd\n           entity: |\n             kind: "user"\n             username: "foo"\n             password: "x"\n             uid: 0\n             gid: 0\n             info: "Foo!"\n             homedir: "/home/foo"\n             shell: "/bin/bash"\n'})}),"\n",(0,o.jsx)(n.h3,{id:"hostname",children:(0,o.jsx)(n.code,{children:"hostname"})}),"\n",(0,o.jsxs)(n.p,{children:["A string representing the machine hostname. It sets it in the running system, updates ",(0,o.jsx)(n.code,{children:"/etc/hostname"})," and adds the new hostname to ",(0,o.jsx)(n.code,{children:"/etc/hosts"}),".\nTemplates can be used to allow dynamic configuration. For example in mass-install scenario it could be needed (and easier) to specify hostnames for multiple machines from a single cloud-init config file."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",children:'#cloud-config\n\nstages:\n  boot:\n    - name: "Setup hostname"\n      hostname: "node-{{ trunc 4 .MachineID }}"\n'})}),"\n",(0,o.jsx)(n.h3,{id:"sysctl",children:(0,o.jsx)(n.code,{children:"sysctl"})}),"\n",(0,o.jsxs)(n.p,{children:["Kernel configuration. It sets ",(0,o.jsx)(n.code,{children:"/proc/sys/<key>"})," accordingly, similarly to ",(0,o.jsx)(n.code,{children:"sysctl"}),"."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",children:'#cloud-config\n\nstages:\n  boot:\n    - name: "Setup exception trace"\n      systctl:\n        debug.exception-trace: "0"\n'})}),"\n",(0,o.jsx)(n.h3,{id:"users",children:(0,o.jsx)(n.code,{children:"users"})}),"\n",(0,o.jsx)(n.p,{children:"A map of users and user info to set. Passwords can also be encrypted."}),"\n",(0,o.jsxs)(n.p,{children:["The ",(0,o.jsx)(n.code,{children:"users"})," parameter adds or modifies the specified list of users. Each user is an object which consists of the following fields. Each field is optional and of type string unless otherwise noted.\nIn case the user already exists, only the ",(0,o.jsx)(n.code,{children:"password"})," and ",(0,o.jsx)(n.code,{children:"ssh-authorized-keys"})," are evaluated. The rest of the fields are ignored."]}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"name"}),": Required. Login name of user"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"gecos"}),": GECOS comment of user"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"passwd"}),": Hash of the password to use for this user. Unencrypted strings are supported too."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"homedir"}),": User's home directory. Defaults to /home/",(0,o.jsx)(n.em,{children:"name"})]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"no-create-home"}),": Boolean. Skip home directory creation."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"primary-group"}),": Default group for the user. Defaults to a new group created named after the user."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"groups"}),": Add user to these additional groups. Kairos creates an ",(0,o.jsx)(n.code,{children:"admin"})," group by default which is also added to the sudoers file. Add a user to the ",(0,o.jsx)(n.code,{children:"admin"})," group if you want them to have ",(0,o.jsx)(n.code,{children:"sudo"})," access."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"no-user-group"}),": Boolean. Skip default group creation."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"ssh-authorized-keys"}),": List of public SSH keys to authorize for this user"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"system"}),": Create the user as a system user. No home directory will be created."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"no-log-init"}),": Boolean. Skip initialization of lastlog and faillog databases."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"shell"}),": User's login shell."]}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",children:'#cloud-config\n\nstages:\n  boot:\n    - name: "Setup users"\n      users:\n        bastion:\n          passwd: "strongpassword"\n          homedir: "/home/foo\n'})}),"\n",(0,o.jsx)(n.h3,{id:"authorized_keys",children:(0,o.jsx)(n.code,{children:"authorized_keys"})}),"\n",(0,o.jsxs)(n.p,{children:["A list of SSH authorized keys that should be added for each user.\nSSH keys can be obtained from GitHub user accounts by using the format ",(0,o.jsx)(n.code,{children:"github:&#36;&#123;USERNAME&#125;"}),", similarly for GitLab with ",(0,o.jsx)(n.code,{children:"gitlab:&#36;&#123;USERNAME&#125;"}),"."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",children:'#cloud-config\n\nstages:\n  boot:\n    - name: "Setup exception trace"\n      authorized_keys:\n        mudler:\n          - "github:mudler"\n          - "ssh-rsa: ..."\n'})}),"\n",(0,o.jsx)(n.h3,{id:"modules",children:(0,o.jsx)(n.code,{children:"modules"})}),"\n",(0,o.jsx)(n.p,{children:"A list of kernel modules to load."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",children:'#cloud-config\n\nstages:\n  boot:\n    - name: "Setup users"\n      modules:\n        - nvidia\n'})}),"\n",(0,o.jsx)(n.h3,{id:"timesyncd",children:(0,o.jsx)(n.code,{children:"timesyncd"})}),"\n",(0,o.jsxs)(n.p,{children:["Sets the ",(0,o.jsx)(n.code,{children:"systemd-timesyncd"})," daemon file (",(0,o.jsx)(n.code,{children:"/etc/system/timesyncd.conf"}),") file accordingly. The documentation for ",(0,o.jsx)(n.code,{children:"timesyncd"})," and all the options can be found ",(0,o.jsx)(n.a,{href:"https://www.freedesktop.org/software/systemd/man/timesyncd.conf.html",children:"here"}),"."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",children:'#cloud-config\n\nstages:\n  boot:\n    - name: "Setup NTP"\n      systemctl:\n        enable:\n          - systemd-timesyncd\n      timesyncd:\n        NTP: "0.pool.org foo.pool.org"\n        FallbackNTP: "us.pool.ntp.org"\n    - name: "Restart NTP service so it gets the new config"\n      commands:\n        - systemctl restart systemd-timesyncd\n'})}),"\n",(0,o.jsx)(n.h3,{id:"systemctl",children:(0,o.jsx)(n.code,{children:"systemctl"})}),"\n",(0,o.jsxs)(n.p,{children:["A list of systemd services to ",(0,o.jsx)(n.code,{children:"enable"}),", ",(0,o.jsx)(n.code,{children:"disable"}),", ",(0,o.jsx)(n.code,{children:"mask"})," or ",(0,o.jsx)(n.code,{children:"start"}),"."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",children:'#cloud-config\n\nstages:\n  boot:\n    - name: "Setup users"\n      systemctl:\n        enable:\n          - systemd-timesyncd\n          - cronie\n        mask:\n          - purge-kernels\n        disable:\n          - crond\n        start:\n          - cronie\n'})}),"\n",(0,o.jsx)(n.h3,{id:"environment_file",children:(0,o.jsx)(n.code,{children:"environment_file"})}),"\n",(0,o.jsx)(n.p,{children:"A string to specify where to set the environment file"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",children:'#cloud-config\n\nstages:\n  boot:\n    - name: "Setup users"\n      environment_file: "/home/user/.envrc"\n      environment:\n        FOO: "bar"\n'})}),"\n",(0,o.jsx)(n.h3,{id:"environment",children:(0,o.jsx)(n.code,{children:"environment"})}),"\n",(0,o.jsxs)(n.p,{children:["A map of variables to write in ",(0,o.jsx)(n.code,{children:"/etc/environment"}),", or otherwise specified in ",(0,o.jsx)(n.code,{children:"environment_file"})]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",children:'#cloud-config\n\nstages:\n  boot:\n    - name: "Setup users"\n      environment:\n        FOO: "bar"\n'})}),"\n",(0,o.jsx)(n.h3,{id:"systemd_firstboot",children:(0,o.jsx)(n.code,{children:"systemd_firstboot"})}),"\n",(0,o.jsxs)(n.p,{children:["Runs ",(0,o.jsx)(n.a,{href:"https://www.freedesktop.org/software/systemd/man/latest/systemd-firstboot.html",children:(0,o.jsx)(n.code,{children:"systemd-firstboot"})})," with the arguments specified."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",children:'#cloud-config\n\ndebug: true\n\nstages:\n  boot:\n    - name: "Run systemd-firstboot"\n      systemd_firstboot:\n        hostname: "myhostname"\n'})}),"\n",(0,o.jsx)(n.h3,{id:"datasource",children:(0,o.jsx)(n.code,{children:"datasource"})}),"\n",(0,o.jsxs)(n.p,{children:["Sets to fetch user data from the specified cloud providers. It populates\nprovider specific data into ",(0,o.jsx)(n.code,{children:"/run/config"})," folder and the custom user data\nis stored into the provided path."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",children:'#cloud-config\n\nstages:\n  boot:\n    - name: "Fetch cloud provider\'s user data"\n      datasource:\n        providers:\n          - "aws"\n          - "digitalocean"\n        path: "/etc/cloud-data"\n'})}),"\n",(0,o.jsx)(n.h3,{id:"layout",children:(0,o.jsx)(n.code,{children:"layout"})}),"\n",(0,o.jsxs)(n.p,{children:["Sets additional partitions on disk free space, if any, and/or expands the last\npartition. All sizes are expressed in MiB only and default value of ",(0,o.jsx)(n.code,{children:"size: 0"}),"\nmeans all available free space in disk. This plugin is useful to be used in\noem images where the default partitions might not suit the actual disk geometry."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",children:'#cloud-config\n\nstages:\n  boot:\n    - name: "Repart disk"\n      layout:\n        device:\n          # It will partition a device including the given filesystem label\n          # or partition label (filesystem label matches first) or the device\n          # provided in \'path\'. The label check has precedence over path when\n          # both are provided.\n          label: "COS_RECOVERY"\n          path: "/dev/sda"\n        # Only last partition can be expanded and it happens after all the other\n        # partitions are created. size: 0 means all available free space\n        expand_partition:\n          size: 4096\n        add_partitions:\n          - fsLabel: "COS_STATE"\n            size: 8192\n            # No partition label is applied if omitted\n            pLabel: "state"\n          - fsLabel: "COS_PERSISTENT"\n            # default filesystem is ext2 if omitted\n            filesystem: "ext4"\n'})}),"\n",(0,o.jsxs)(n.p,{children:["You can also set custom partitions within the ",(0,o.jsx)(n.code,{children:"kairos-install.pre.before"})," stage. In the following example we will do a\ncustom partition in disk ",(0,o.jsx)(n.code,{children:"/dev/vda"}),"."]}),"\n",(0,o.jsx)(n.admonition,{title:"Warning",type:"warning",children:(0,o.jsxs)(n.p,{children:["You're responsible to make sure the sizes of the partitions fit properly within the disk. Issues of space will be highlighted by\nthe agent, but they will not fail the installation process unless you pass the ",(0,o.jsx)(n.code,{children:"--strict"})," flag."]})}),"\n",(0,o.jsx)(n.admonition,{title:"Warning",type:"warning",children:(0,o.jsxs)(n.p,{children:["In the case of multiple devices, make sure you don't choose ",(0,o.jsx)(n.code,{children:"auto"})," to determine on which device to install but instead to point\nthe installation to the device where you are creating the custom partitions."]})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell",children:'#cloud-config\n\ninstall:\n  # Make sure the installer won\'t delete our custom partitions\n  no-format: true\n\nstages:\n  kairos-install.pre.before:\n  - if:  \'[ -e /dev/vda ]\'\n    name: "Create partitions"\n    commands:\n      - |\n        parted --script --machine -- /dev/vda mklabel msdos\n    layout:\n      device:\n        path: /dev/vda\n      expand_partition:\n        size: 0 # All available space\n      add_partitions:\n        # all sizes bellow are in MB\n        - fsLabel: COS_OEM\n          size: 64\n          pLabel: oem\n        - fsLabel: COS_RECOVERY\n          size: 8500\n          pLabel: recovery\n        - fsLabel: COS_STATE\n          size: 18000\n          pLabel: state\n        - fsLabel: COS_PERSISTENT\n          pLabel: persistent\n          size: 25000\n          filesystem: "ext4"\n'})})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(c,{...e})}):c(e)}}}]);