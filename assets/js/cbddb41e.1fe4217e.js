"use strict";(globalThis.webpackChunkkairos_docs=globalThis.webpackChunkkairos_docs||[]).push([[2328],{11470:(e,n,s)=>{s.d(n,{A:()=>w});var t=s(96540),i=s(34164),a=s(17559),o=s(23104),r=s(56347),l=s(205),d=s(57485),c=s(31682),h=s(70679);function u(e){return t.Children.toArray(e).filter(e=>"\n"!==e).map(e=>{if(!e||(0,t.isValidElement)(e)&&function(e){const{props:n}=e;return!!n&&"object"==typeof n&&"value"in n}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)})?.filter(Boolean)??[]}function f(e){const{values:n,children:s}=e;return(0,t.useMemo)(()=>{const e=n??function(e){return u(e).map(({props:{value:e,label:n,attributes:s,default:t}})=>({value:e,label:n,attributes:s,default:t}))}(s);return function(e){const n=(0,c.XI)(e,(e,n)=>e.value===n.value);if(n.length>0)throw new Error(`Docusaurus error: Duplicate values "${n.map(e=>e.value).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e},[n,s])}function m({value:e,tabValues:n}){return n.some(n=>n.value===e)}function p({queryString:e=!1,groupId:n}){const s=(0,r.W6)(),i=function({queryString:e=!1,groupId:n}){if("string"==typeof e)return e;if(!1===e)return null;if(!0===e&&!n)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return n??null}({queryString:e,groupId:n});return[(0,d.aZ)(i),(0,t.useCallback)(e=>{if(!i)return;const n=new URLSearchParams(s.location.search);n.set(i,e),s.replace({...s.location,search:n.toString()})},[i,s])]}function g(e){const{defaultValue:n,queryString:s=!1,groupId:i}=e,a=f(e),[o,r]=(0,t.useState)(()=>function({defaultValue:e,tabValues:n}){if(0===n.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(e){if(!m({value:e,tabValues:n}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${e}" but none of its children has the corresponding value. Available values are: ${n.map(e=>e.value).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return e}const s=n.find(e=>e.default)??n[0];if(!s)throw new Error("Unexpected error: 0 tabValues");return s.value}({defaultValue:n,tabValues:a})),[d,c]=p({queryString:s,groupId:i}),[u,g]=function({groupId:e}){const n=function(e){return e?`docusaurus.tab.${e}`:null}(e),[s,i]=(0,h.Dv)(n);return[s,(0,t.useCallback)(e=>{n&&i.set(e)},[n,i])]}({groupId:i}),x=(()=>{const e=d??u;return m({value:e,tabValues:a})?e:null})();(0,l.A)(()=>{x&&r(x)},[x]);return{selectedValue:o,selectValue:(0,t.useCallback)(e=>{if(!m({value:e,tabValues:a}))throw new Error(`Can't select invalid tab value=${e}`);r(e),c(e),g(e)},[c,g,a]),tabValues:a}}var x=s(92303);const b={tabList:"tabList__CuJ",tabItem:"tabItem_LNqP"};var j=s(74848);function v({className:e,block:n,selectedValue:s,selectValue:t,tabValues:a}){const r=[],{blockElementScrollPositionUntilNextRender:l}=(0,o.a_)(),d=e=>{const n=e.currentTarget,i=r.indexOf(n),o=a[i].value;o!==s&&(l(n),t(o))},c=e=>{let n=null;switch(e.key){case"Enter":d(e);break;case"ArrowRight":{const s=r.indexOf(e.currentTarget)+1;n=r[s]??r[0];break}case"ArrowLeft":{const s=r.indexOf(e.currentTarget)-1;n=r[s]??r[r.length-1];break}}n?.focus()};return(0,j.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,i.A)("tabs",{"tabs--block":n},e),children:a.map(({value:e,label:n,attributes:t})=>(0,j.jsx)("li",{role:"tab",tabIndex:s===e?0:-1,"aria-selected":s===e,ref:e=>{r.push(e)},onKeyDown:c,onClick:d,...t,className:(0,i.A)("tabs__item",b.tabItem,t?.className,{"tabs__item--active":s===e}),children:n??e},e))})}function y({lazy:e,children:n,selectedValue:s}){const a=(Array.isArray(n)?n:[n]).filter(Boolean);if(e){const e=a.find(e=>e.props.value===s);return e?(0,t.cloneElement)(e,{className:(0,i.A)("margin-top--md",e.props.className)}):null}return(0,j.jsx)("div",{className:"margin-top--md",children:a.map((e,n)=>(0,t.cloneElement)(e,{key:n,hidden:e.props.value!==s}))})}function k(e){const n=g(e);return(0,j.jsxs)("div",{className:(0,i.A)(a.G.tabs.container,"tabs-container",b.tabList),children:[(0,j.jsx)(v,{...n,...e}),(0,j.jsx)(y,{...n,...e})]})}function w(e){const n=(0,x.A)();return(0,j.jsx)(k,{...e,children:u(e.children)},String(n))}},19365:(e,n,s)=>{s.d(n,{A:()=>o});s(96540);var t=s(34164);const i={tabItem:"tabItem_Ymn6"};var a=s(74848);function o({children:e,hidden:n,className:s}){return(0,a.jsx)("div",{role:"tabpanel",className:(0,t.A)(i.tabItem,s),hidden:n,children:e})}},19592:(e,n,s)=>{s.d(n,{A:()=>t});const t=s.p+"assets/images/schema-validation-preview-a9ef8bf4ad5336560e031257b69e9c7e.gif"},28453:(e,n,s)=>{s.d(n,{R:()=>o,x:()=>r});var t=s(96540);const i={},a=t.createContext(i);function o(e){const n=t.useContext(a);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),t.createElement(a.Provider,{value:n},e.children)}},37924:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>d,default:()=>f,frontMatter:()=>l,metadata:()=>t,toc:()=>h});const t=JSON.parse('{"id":"Reference/configuration","title":"Configuration","description":"Welcome to the Kairos configuration reference page. This page provides details on the fields available in the YAML file used for installing Kairos, a Linux distribution focused on running Kubernetes. This file, written in cloud-config format, allows you to enable Kairos features, configure k3s, and set various other options.","source":"@site/docs/Reference/configuration.md","sourceDirName":"Reference","slug":"/Reference/configuration","permalink":"/kairos-docs/docs/next/Reference/configuration","draft":false,"unlisted":false,"editUrl":"https://github.com/kairos-io/kairos-docs/tree/main/docs/Reference/configuration.md","tags":[],"version":"current","lastUpdatedBy":"Jasper De Keukelaere (imec)","lastUpdatedAt":1765043763000,"sidebarPosition":2,"frontMatter":{"title":"Configuration","sidebar_label":"Configuration","sidebar_position":2,"date":"2022-11-13T00:00:00.000Z","description":"Welcome to the Kairos configuration reference page. This page provides details on the fields available in the YAML file used for installing Kairos, a Linux distribution focused on running Kubernetes. This file, written in cloud-config format, allows you to enable Kairos features, configure k3s, and set various other options."},"sidebar":"tutorialSidebar","previous":{"title":"AuroraBoot","permalink":"/kairos-docs/docs/next/Reference/auroraboot"},"next":{"title":"kairosctl","permalink":"/kairos-docs/docs/next/Reference/kairosctl"}}');var i=s(74848),a=s(28453),o=s(11470),r=s(19365);const l={title:"Configuration",sidebar_label:"Configuration",sidebar_position:2,date:new Date("2022-11-13T00:00:00.000Z"),description:"Welcome to the Kairos configuration reference page. This page provides details on the fields available in the YAML file used for installing Kairos, a Linux distribution focused on running Kubernetes. This file, written in cloud-config format, allows you to enable Kairos features, configure k3s, and set various other options."},d=void 0,c={},h=[{value:"Syntax",id:"syntax",level:2},{value:"Test your cloud configs",id:"test-your-cloud-configs",level:3},{value:"Validate Your Cloud Config",id:"validate-your-cloud-config",level:3},{value:"Configuration Validation via the Kairos Command Line",id:"configuration-validation-via-the-kairos-command-line",level:4},{value:"Configuration Validation via Web UI",id:"configuration-validation-via-web-ui",level:4},{value:"Using templates",id:"using-templates",level:3},{value:"Automatic Hostname at scale",id:"automatic-hostname-at-scale",level:4},{value:"Grub options",id:"grub-options",level:3},{value:"Kubernetes manifests",id:"kubernetes-manifests",level:2},{value:"Kernel boot parameters",id:"kernel-boot-parameters",level:2},{value:"Additional users",id:"additional-users",level:2},{value:"Add a user",id:"add-a-user",level:3},{value:"Provider configs",id:"provider-configs",level:2},{value:"Stages",id:"stages",level:2},{value:"Logs Configuration",id:"logs-configuration",level:2},{value:"Default Services",id:"default-services",level:3},{value:"Default Files",id:"default-files",level:3},{value:"<code>journal</code>",id:"journal",level:3},{value:"<code>files</code>",id:"files",level:3},{value:"Filtering stages by node hostname",id:"filtering-stages-by-node-hostname",level:3},{value:"Filtering stages with if statement",id:"filtering-stages-with-if-statement",level:3},{value:"<code>name</code>",id:"name",level:3},{value:"<code>node</code>",id:"node",level:3},{value:"Modules",id:"modules",level:3},{value:"Running commands on different shells",id:"running-commands-on-different-shells",level:2}];function u(e){const n={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",h4:"h4",img:"img",li:"li",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,a.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.p,{children:"Welcome to the Kairos configuration reference page. This page provides details on the fields available in the YAML file used for installing Kairos, a Linux distribution focused on running Kubernetes. This file, written in cloud-config format, allows you to enable Kairos features, configure k3s, and set various other options."}),"\n",(0,i.jsx)(n.p,{children:"The structure of the configuration file is as follows:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'#cloud-config\n\n# Additional system users\nusers:\n- name: "kairos"\n  passwd: "kairos"\n  lock_passwd: true\n  groups: [ "admin" ]\n  # ssh_authorized_keys:\n  # - github:mudler\n\n# enable debug logging\ndebug: true\n\n# Logs configuration for collecting diagnostic information\n# Note: The following are examples of additional services and files to collect.\n# The system already includes comprehensive defaults for Kairos services.\nlogs:\n  # Additional systemd journal services to collect logs from\n  journal:\n    - "my-custom-service"\n    - "my-app"\n  # Additional log files to collect (supports glob patterns)\n  files:\n    - "/var/log/myapp/*.log"\n    - "/var/log/custom/*.log"\n\n# Additional paths for look for cloud-init files\ncloud-init-paths:\n  - "/some/path"\n# fail on cloud-init errors, defaults to false\nstrict: false\n\n# The install block is to drive automatic installations without user interaction.\ninstall:\n  # Device for automated installs\n  # This can be either a full device path (so /dev/sda) or you can use the udev facility to identify the disk by UUID, path, label, diskseq or id (/dev/disk/by-{uuid,label,path,diskseq})\n  # Note that to use a disk by UUID or label, it has first to have that added from userspace, for example with `mkfs.ext4 -L LABEL -U UUID /dev/sda` otherwise disks dont come with UUID/label if they are empty\n  device: "/dev/sda"\n  # Reboot after installation\n  reboot: true\n  # Power off after installation\n  poweroff: true\n  # Set to true when installing without Pairing\n  auto: true\n\n  # Override the grub entry name\n  grub-entry-name: Kairos\n  \n  # partitions setup\n  # setting a partition size key to 0 means that the partition will take over the rest of the free space on the disk\n  # after creating the rest of the partitions\n  # by default the persistent partition has a value of 0\n  # if you want any of the extra partitions to fill the rest of the space, you will need to set the persistent partition\n  # size to a different value, for example\n  # partitions:\n  #   persistent:\n  #     size: 300\n\n  # default partitions\n  # only \'oem\', \'recovery\', \'state\' and \'persistent\' objects allowed\n  # Only size and fs should be changed here\n  # size in MiB\n  partitions:\n    oem:\n      size: 60\n      fs: ext4\n    recovery:\n      size: 4096\n      fs: ext4\n  # note: This can also be set with dot notation like the following examples for a more condensed view:\n  # partitions.oem.size: 60\n  # partitions.oem.fs: ext4\n  # partitions.recovery.size: 4096\n  # partitions.recovery.fs: ext4\n\n  # extra partitions to create during install\n  # only size, label and fs are used\n  # name is used for the partition label, but it\'s not really used during the kairos lifecycle. No spaces allowed.\n  # if no fs is given the partition will be created but not formatted\n  # These partitions are not automounted only created and formatted\n  extra-partitions:\n    - name: myPartition\n      size: 100\n      fs: ext4\n      label: ONE_PARTITION\n    - name: myOtherPartition\n      size: 200\n      fs: ext4\n      label: TWO_PARTITION\n  \n  # no-format: true skips any disk partitioning and formatting\n  # If set to true installation procedure will error out if expected\n  # partitions are not already present within the disk.\n  no-format: false\n\n  # if no-format is used and Kairos is running over an existing deployment\n  # force can be used to force installation.\n  force: false\n\n  # Creates these dirs in the rootfs during installation. As the rootfs is RO from boot, sometimes we find that we\n  # some applications want to write to non-standard paths like /data\n  # If that dir is not already in the rootfs it makes it difficult to create that path on an RO system\n  # This allows to create some extra paths in the rootfs that then we count use for mounting or binding via\n  # the cloud-config stages\n  extra-dirs-rootfs:\n    - /data\n    - /src\n  \n  # Override image sizes for active/passive/recovery\n  # Note that the active+passive images are stored in the state partition and\n  # the recovery in the recovery partition, so they should be big enough to accommodate te images sizes set below\n  # size in MiB\n  system:\n    size: 4096\n  passive:\n    size: 4096\n  recovery-system:\n    size: 5000\n  # note: This can also be set with dot notation like the following examples for a more condensed view:\n  # system.size: 4096\n  # passive.size: 4096\n  # recovery-system.size: 5000\n  \n  # Use a different source for the installation\n  source: "oci:.."\n  # Add bundles in runtime\n  bundles:\n    - ...\n  # Set grub options\n  grub_options:\n    # additional Kernel option cmdline to apply\n    extra_cmdline: "config_url=http://"\n    # Same, just for active\n    extra_active_cmdline: ""\n    # Same, just for passive\n    extra_passive_cmdline: ""\n    # Change GRUB menu entry\n    default_menu_entry: ""\n  # Environmental variable to set to the installer calls\n  env:\n  - foo=bar\n  # custom user mounts\n  # bind mounts, can be read and modified, changes persist reboots\n  bind_mounts:\n  - /mnt/bind1\n  - /mnt/bind2\n  # ephemeral mounts, can be read and modified, changed are discarded at reboot\n  ephemeral_mounts:\n\n# The reset block configures what happens when reset is called\nreset:\n  # Reboot after reset\n  reboot: true\n  # Power off after reset\n  poweroff: true\n\n  # Use a different source for the reset\n  source: "oci:.."\n\n  # Override the grub entry name\n  grub-entry-name: Kairos\n\n  # if set to true it will format persistent partitions (\'oem \'and \'persistent\')\n  reset-persistent: true\n  reset-oem: false\n\n  # Creates these dirs in the rootfs during reset. As the rootfs is RO from boot, sometimes we find that we\n  # some applications want to write to non-standard paths like /data\n  # If that dir is not already in the rootfs it makes it difficult to create that path on an RO system\n  # This allows to create some extra paths in the rootfs that then we count use for mounting or binding via\n  # the cloud-config stages\n  extra-dirs-rootfs:\n    - /data\n    - /src\n\n\n# The upgrade block configures what happens when upgrade is called\nupgrade:\n  # Reboot after upgrade\n  reboot: true\n  # Power off after upgrade\n  poweroff: true\n\n  # Use a different source for the upgrade\n  source: "oci:.."\n  \n  # Override the grub entry name\n  grub-entry-name: Kairos\n\n  # if set to true upgrade command will upgrade recovery system instead\n  # of main active system\n  recovery: false\n\n  # Override image sizes for active/recovery\n  # Note that the active+passive images are stored in the state partition and\n  # the recovery in the recovery partition, so they should be big enough to accommodate te images sizes set below\n  # size in MiB\n  # During upgrade only the active or recovery image cna be resized as those are the ones that contain the upgrade\n  # passive image is the current system, and that its untouched during the upgrade\n  system:\n    size: 4096\n  recovery-system:\n    size: 5000\n\n  # Creates these dirs in the rootfs during upgrade. As the rootfs is RO from boot, sometimes we find that we\n  # some applications want to write to non-standard paths like /data\n  # If that dir is not already in the rootfs it makes it difficult to create that path on an RO system\n  # This allows to create some extra paths in the rootfs that then we count use for mounting or binding via\n  # the cloud-config stages\n  extra-dirs-rootfs:\n    - /data\n    - /src\n\n\nk3s:\n  # Additional env/args for k3s server instances\n  env:\n    K3S_RESOLV_CONF: ""\n    K3S_DATASTORE_ENDPOINT: "mysql://username:password@tcp(hostname:3306)/database-name"\n  args:\n    - --node-label ""\n    - --data-dir ""\n  # Enabling below it replaces args/env entirely\n  # replace_env: true\n  # replace_args: true\n\nk3s-agent:\n  # Additional env/args for k3s agent instances\n  env:\n    K3S_NODE_NAME: "foo"\n  args:\n    - --private-registry "..."\n  # Enabling below it replaces args/env entirely\n  # replace_env: true\n  # replace_args: true\n\n# The p2p block enables the p2p full-mesh functionalities.\n# To disable, don\'t specify one.\np2p:\n  # Manually set node role. Available: master, worker. Defaults auto (none). This is available\n role: "master"\n  # User defined network-id. Can be used to have multiple clusters in the same network\n network_id: "dev"\n  # Enable embedded DNS See also: https://mudler.github.io/edgevpn/docs/concepts/overview/dns/\n dns: true\n # Disabling DHT makes co-ordination to discover nodes only in the local network\n disable_dht: true #Enabled by default\n # Configures a VPN for the cluster nodes\n vpn:\n   create: false # defaults to true\n   use: false # defaults to true\n   env:\n    # EdgeVPN environment options\n    DHCP: "true"\n    # Disable DHT (for airgap)\n    EDGEVPNDHT: "false"\n    EDGEVPNMAXCONNS: "200"\n    # If DHCP is false, it\'s required to be given a specific node IP. Can be arbitrary\n    ADDRESS: "10.2.0.30/24"\n    # See all EDGEVPN options:\n    # - https://github.com/mudler/edgevpn/blob/master/cmd/util.go#L33\n    # - https://github.com/mudler/edgevpn/blob/master/cmd/main.go#L48\n # Automatic cluster deployment configuration\n auto:\n   # Enables Automatic node configuration (self-coordination)\n   # for role assignment\n   enable: true\n   # HA enables automatic HA roles assignment.\n   # A master cluster init is always required,\n   # Any additional master_node is configured as part of the \n   # HA control plane.\n   # If auto is disabled, HA has no effect.\n   ha:\n     # Enables HA control-plane\n     enable: true\n     # Number of HA additional master nodes.\n     # A master node is always required for creating the cluster and is implied.\n     # The setting below adds 2 additional master nodes, for a total of 3.\n     master_nodes: 2\n     # Use an External database for the HA control plane\n     external_db: "external-db-string"\n # network_token is the shared secret used by the nodes to co-ordinate with p2p\n network_token: "YOUR_TOKEN_GOES_HERE"\n\n## Sets the Elastic IP used in KubeVIP. Only valid with p2p\nkubevip:\n  eip: "192.168.1.110"\n  # Specify a manifest URL for KubeVIP. Empty uses default\n  manifest_url: ""\n  # Enables KubeVIP\n  enable: true\n  # Specifies a KubeVIP Interface\n  interface: "ens18"\n\n# Additional cloud init syntax can be used here.\n# See `stages` below.\nstages:\n  network:\n    - name: "Setup users"\n      authorized_keys:\n        kairos:\n          - github:mudler\n\n# Standard cloud-init syntax, see: https://github.com/mudler/yip/tree/e688612df3b6f24dba8102f63a76e48db49606b2#compatibility-with-cloud-init-format\ngrowpart:\n devices: [\'/\']\n\n\nruncmd:\n- foo\nhostname: "bar"\nwrite_files:\n- encoding: b64\n  content: CiMgVGhpcyBmaWxlIGNvbnRyb2xzIHRoZSBzdGF0ZSBvZiBTRUxpbnV4\n  path: /foo/bar\n  permissions: "0644"\n  owner: "bar"\n'})}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"p2p"})," block is used to enable the p2p full-mesh functionalities of Kairos. If you do not want to use these functionalities, simply don't specify a kairos block in your configuration file."]}),"\n",(0,i.jsxs)(n.p,{children:["Inside the ",(0,i.jsx)(n.code,{children:"p2p"})," block, you can specify the network_token field, which is used to establish the p2p full meshed network. If you do not want to use the full-mesh functionalities, don't specify a network_token value."]}),"\n",(0,i.jsxs)(n.p,{children:["The role field allows you to manually set the node role for your Kairos installation. The available options are ",(0,i.jsx)(n.code,{children:"master"})," and ",(0,i.jsx)(n.code,{children:"worker"}),", and the default value is auto (which means no role is set)."]}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"network_id"})," field allows you to set a user-defined network ID, which can be used to have multiple Kairos clusters on the same network."]}),"\n",(0,i.jsxs)(n.p,{children:["Finally, the ",(0,i.jsx)(n.code,{children:"dns"})," field allows you to enable embedded DNS for Kairos. For more information on DNS in Kairos, see the link provided in the YAML code above."]}),"\n",(0,i.jsx)(n.p,{children:"That's a brief overview of the structure and fields available in the Kairos configuration file. For more detailed information on how to use these fields, see the examples and explanations provided in the sections below."}),"\n",(0,i.jsx)(n.h2,{id:"syntax",children:"Syntax"}),"\n",(0,i.jsxs)(n.p,{children:["Kairos supports a portion of the standard ",(0,i.jsx)(n.a,{href:"https://cloud-init.io/",children:"cloud-init"})," syntax, and the extended syntax which is based on ",(0,i.jsx)(n.a,{href:"https://github.com/mudler/yip",children:"yip"}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["Examples using the extended notation for running K3s as agent or server can be found in the ",(0,i.jsx)(n.a,{href:"https://github.com/kairos-io/kairos/tree/master/examples",children:"examples"}),"  directory of the Kairos repository."]}),"\n",(0,i.jsxs)(n.p,{children:["Here's an example that shows how to set up DNS at the ",(0,i.jsx)(n.a,{href:"../../architecture/cloud-init",children:"boot stage"})," using the extended syntax:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'#cloud-config\n\nstages:\n  boot:\n    - name: "DNS settings"\n      dns:\n        path: /etc/resolv.conf\n        nameservers:\n          - 8.8.8.8\n'})}),"\n",(0,i.jsxs)(n.admonition,{title:"Note",type:"note",children:[(0,i.jsxs)(n.p,{children:["Kairos does not use ",(0,i.jsx)(n.a,{href:"https://cloud-init.io/",children:"cloud-init"}),". ",(0,i.jsx)(n.a,{href:"https://github.com/mudler/yip",children:"yip"})," was created with the goal of being distro agnostic, and does not use Bash at all (with the exception of systemd configurations, which are assumed to be available). This makes it possible to run yip on minimal Linux distros that have been built from scratch."]}),(0,i.jsx)(n.p,{children:"The rationale behind using yip instead of cloud-init is that it allows Kairos to have very minimal requirements. The cloud-init implementation has dependencies, while yip does not, which keeps the dependency tree small. There is also a CoreOS implementation of cloud-init, but it makes assumptions about the layout of the system that are not always applicable to Kairos, making it less portable."})]}),"\n",(0,i.jsx)(n.p,{children:"The extended syntax can also be used to pass commands through Kernel boot parameters. See the examples below for more details."}),"\n",(0,i.jsx)(n.h3,{id:"test-your-cloud-configs",children:"Test your cloud configs"}),"\n",(0,i.jsx)(n.p,{children:"Writing YAML files can be a tedious process, and it's easy to make syntax or indentation errors. To make sure your configuration is correct, you can use the cloud-init commands to test your YAML files locally in a container."}),"\n",(0,i.jsxs)(n.p,{children:["Here's an example of how to test your configurations on the ",(0,i.jsx)(n.code,{children:"initramfs"})," stage using a Docker container:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"# List the YAML files in your current directory\n$ ls -liah\ntotal 4,0K\n9935 drwxr-xr-x.  2 itxaka itxaka  60 may 17 11:21 .\n   1 drwxrwxrwt. 31 root   root   900 may 17 11:28 ..\n9939 -rw-r--r--.  1 itxaka itxaka  59 may 17 11:21 00_test.yaml\n\n$ cat 00_test.yaml\nstages:\n  initramfs:\n    - commands:\n      - echo \"hello!\"\n\n\n# Run the cloud-init command on your YAML files in a Docker container\n$ docker run -ti -v $PWD:/test --entrypoint /usr/bin/kairos-agent --rm quay.io/kairos/kairos-core:latest run-stage --cloud-init-paths /test initramfs\n\n# Output from the run-stage command\nINFO[2023-05-17T11:32:09+02:00] kairos-agent version 0.0.0                   \nINFO[2023-05-17T11:32:09+02:00] Running stage: initramfs.before              \nINFO[2023-05-17T11:32:09+02:00] Done executing stage 'initramfs.before'      \nINFO[2023-05-17T11:32:09+02:00] Running stage: initramfs                     \nINFO[2023-05-17T11:32:09+02:00] Processing stage step ''. ( commands: 1, files: 0, ... ) \nINFO[2023-05-17T11:32:09+02:00] Command output: hello!                       \nINFO[2023-05-17T11:32:09+02:00] Done executing stage 'initramfs'             \nINFO[2023-05-17T11:32:09+02:00] Running stage: initramfs.after               \nINFO[2023-05-17T11:32:09+02:00] Done executing stage 'initramfs.after'       \nINFO[2023-05-17T11:32:09+02:00] Running stage: initramfs.before              \nINFO[2023-05-17T11:32:09+02:00] Done executing stage 'initramfs.before'      \nINFO[2023-05-17T11:32:09+02:00] Running stage: initramfs                     \nINFO[2023-05-17T11:32:09+02:00] Done executing stage 'initramfs'             \nINFO[2023-05-17T11:32:09+02:00] Running stage: initramfs.after               \nINFO[2023-05-17T11:32:09+02:00] Done executing stage 'initramfs.after'          \n\n"})}),"\n",(0,i.jsx)(n.h3,{id:"validate-your-cloud-config",children:"Validate Your Cloud Config"}),"\n",(0,i.jsx)(n.admonition,{title:"Note",type:"note",children:(0,i.jsxs)(n.p,{children:["Validation of configuration is available on Kairos ",(0,i.jsx)(n.a,{href:"https://github.com/kairos-io/kairos/releases/tag/v1.6.0-rc1",children:"v1.6.0-rc1"})," and later. If you're interested in the validation rules or want to build a tool based on it, you can access them online via ",(0,i.jsx)(n.code,{children:"https://kairos.io/RELEASE/cloud-config.json"})," e.g. ",(0,i.jsx)(n.a,{href:"https://kairos.io/v1.6.0/cloud-config.json",children:"v1.6.0 cloud-config.json"})]})}),"\n",(0,i.jsx)(n.p,{children:"You have two options to validate your Cloud Config, one is with the Kairos command line, and the other with the Web UI."}),"\n",(0,i.jsx)(n.h4,{id:"configuration-validation-via-the-kairos-command-line",children:"Configuration Validation via the Kairos Command Line"}),"\n",(0,i.jsxs)(n.p,{children:["To validate a configuration using the command line, we have introduced the ",(0,i.jsx)(n.code,{children:"validate"})," command. As an argument you need to pass a URL or local file to be validated, e.g.:"]}),"\n",(0,i.jsxs)(n.p,{children:["If you had the following ",(0,i.jsx)(n.code,{children:"cloud-config.yaml"})," in the current working directory"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"#cloud-config\nusers:\n  - name: 007\n"})}),"\n",(0,i.jsx)(n.p,{children:"You could validate it as follows"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"kairos validate ./cloud-config.yaml\njsonschema: '/users/0/name' does not validate with file:///home/mauro/workspace/kairos/schema.json#/properties/users/items/$ref/properties/name/type: expected string, but got number\n"})}),"\n",(0,i.jsx)(n.h4,{id:"configuration-validation-via-web-ui",children:"Configuration Validation via Web UI"}),"\n",(0,i.jsx)(n.p,{children:"The validation in the Web UI is automatic, all you need to do is copy/paste or type your configuration on the input."}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Schema Validation Preview",src:s(19592).A+"",width:"600",height:"310"})}),"\n",(0,i.jsx)(n.h3,{id:"using-templates",children:"Using templates"}),"\n",(0,i.jsxs)(n.p,{children:["Fields in the Kairos cloud-init configuration can be templated, which allows for dynamic configuration. Node information is retrieved using the ",(0,i.jsx)(n.a,{href:"https://github.com/zcalusic/sysinfo#sample-output",children:"sysinfo"})," library, and can be templated in the ",(0,i.jsx)(n.code,{children:"commands"}),", ",(0,i.jsx)(n.code,{children:"file"}),", and ",(0,i.jsx)(n.code,{children:"entity"})," fields."]}),"\n",(0,i.jsx)(n.p,{children:"Here's an example of how you can use templating in your Kairos configuration:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'#cloud-config\n\nstages:\n  foo:\n  - name: "echo"\n    commands:\n    - echo "{{.Values.node.hostname}}"\n'})}),"\n",(0,i.jsxs)(n.p,{children:["In addition to standard templating, ",(0,i.jsx)(n.a,{href:"http://masterminds.github.io/sprig/",children:"sprig functions"})," are also available for use in your Kairos configuration."]}),"\n",(0,i.jsx)(n.h4,{id:"automatic-hostname-at-scale",children:"Automatic Hostname at scale"}),"\n",(0,i.jsxs)(n.p,{children:["You can also use templating to automatically generate hostnames for a set of machines. For example, if you have a single ",(0,i.jsx)(n.code,{children:"cloud-init"})," file that you want to use for multiple machines, you can use the machine ID (which is generated for each host) to automatically set the hostname for each machine."]}),"\n",(0,i.jsx)(n.p,{children:"Here's an example of how you can do this:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'#cloud-config\n\nstages:\n  initramfs:\n    - name: "Setup hostname"\n      hostname: "node-{{ trunc 4 .MachineID }}"\n'})}),"\n",(0,i.jsxs)(n.p,{children:["This will set the hostname for each machine based on the first 4 characters of the machine ID. For example, if the machine ID for a particular machine is ",(0,i.jsx)(n.code,{children:"abcdef123456"}),", the hostname for that machine will be set to ",(0,i.jsx)(n.code,{children:"node-abcd"}),"."]}),"\n",(0,i.jsx)(n.h3,{id:"grub-options",children:"Grub options"}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"install.grub_options"})," field in the Kairos configuration file allows you to set key/value pairs for GRUB options that will be set in the GRUB environment after installation."]}),"\n",(0,i.jsxs)(n.p,{children:["Here's an example of how you can use this field to set the ",(0,i.jsx)(n.code,{children:"panic=0"})," boot argument:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'#cloud-config\n\ninstall:\n  grub_options:\n    extra_cmdline: "panic=0"\n'})}),"\n",(0,i.jsxs)(n.p,{children:["The table below lists all the available options for the ",(0,i.jsx)(n.code,{children:"install.grub_options"})," field:"]}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Variable"}),(0,i.jsx)(n.th,{children:"Description"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"next_entry"}),(0,i.jsx)(n.td,{children:"Set the next reboot entry"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"saved_entry"}),(0,i.jsx)(n.td,{children:"Set the default boot entry"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"default_menu_entry"}),(0,i.jsx)(n.td,{children:"Set the name entries on the GRUB menu"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"extra_active_cmdline"}),(0,i.jsx)(n.td,{children:"Set additional boot commands when booting into active"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"extra_passive_cmdline"}),(0,i.jsx)(n.td,{children:"Set additional boot commands when booting into passive"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"extra_recovery_cmdline"}),(0,i.jsx)(n.td,{children:"Set additional boot commands when booting into recovery"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"extra_cmdline"}),(0,i.jsx)(n.td,{children:"Set additional boot commands for all entries"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"default_fallback"}),(0,i.jsx)(n.td,{children:"Sets default fallback logic"})]})]})]}),"\n",(0,i.jsx)(n.h2,{id:"kubernetes-manifests",children:"Kubernetes manifests"}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"k3s"})," distribution of Kubernetes allows you to automatically deploy Helm charts or Kubernetes resources after deployment."]}),"\n",(0,i.jsxs)(n.p,{children:["Here's an example of how you can use the ",(0,i.jsx)(n.code,{children:"k3s"})," configuration file to deploy Fleet out of the box:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'name: "Deploy fleet out of the box"\nstages:\n  boot:\n    - name: "Copy fleet deployment files"\n      files:\n        - path: /var/lib/rancher/k3s/server/manifests/fleet-config.yaml\n          content: |\n            apiVersion: v1\n            kind: Namespace\n            metadata:\n              name: cattle-system\n            ---\n            apiVersion: helm.cattle.io/v1\n            kind: HelmChart\n            metadata:\n              name: fleet-crd\n              namespace: cattle-system\n            spec:\n              chart: https://github.com/rancher/fleet/releases/download/v0.3.8/fleet-crd-0.3.8.tgz\n            ---\n            apiVersion: helm.cattle.io/v1\n            kind: HelmChart\n            metadata:\n              name: fleet\n              namespace: cattle-system\n            spec:\n              chart: https://github.com/rancher/fleet/releases/download/v0.3.8/fleet-0.3.8.tgz\n'})}),"\n",(0,i.jsxs)(n.p,{children:["This configuration will automatically deploy the Fleet Helm chart in the cattle-system namespace after the deployment of ",(0,i.jsx)(n.code,{children:"k3s"})," using the extended syntax."]}),"\n",(0,i.jsx)(n.h2,{id:"kernel-boot-parameters",children:"Kernel boot parameters"}),"\n",(0,i.jsx)(n.p,{children:"All the configurations can be issued via Kernel boot parameters, for instance, consider to add an user from the boot menu:"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.code,{children:"stages.boot[0].authorized_keys.root[0]=github:mudler"})}),"\n",(0,i.jsx)(n.p,{children:"Or to either load a config url from network:"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.code,{children:"config_url=http://..."})}),"\n",(0,i.jsx)(n.p,{children:"Usually secret gists are used to share such config files."}),"\n",(0,i.jsx)(n.h2,{id:"additional-users",children:"Additional users"}),"\n",(0,i.jsxs)(n.p,{children:["Kairos comes with the ",(0,i.jsx)(n.code,{children:"kairos"})," user pre-configured, however, it is possible to configure additional users to the system via the cloud-init config mechanism"]}),"\n",(0,i.jsx)(n.h3,{id:"add-a-user",children:"Add a user"}),"\n",(0,i.jsxs)(n.p,{children:["Consider the following example cloud-config, containing the default ",(0,i.jsx)(n.code,{children:"kairos"})," user (which always has sudo access) and adds the ",(0,i.jsx)(n.code,{children:"testuser"})," user to the system with admin access:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'#cloud-config\ninstall:\n  device: /dev/sda\nk3s:\n  enabled: true\n\nusers:\n- name: "kairos"\n  passwd: "kairos"\n  ssh_authorized_keys:\n  - github:mudler\n- name: "testuser"\n  passwd: "testuser"\n  ssh_authorized_keys:\n  - github:mudler\n  groups:\n  - "admin"\n'})}),"\n",(0,i.jsxs)(n.p,{children:["The above cloud config will be respected on every boot. Adding a user in the config at any point will be reflected on the next boot.\nThe top level ",(0,i.jsx)(n.code,{children:"users:"})," key is mapped automatically to a ",(0,i.jsxs)(n.a,{href:"https://github.com/mudler/yip/blob/4fd77a2709e0d98c25c14925530f74f55d704ac6/pkg/schema/loader_cloudinit.go#L96",children:[(0,i.jsx)(n.code,{children:"boot"})," stage"]}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["For this reason, the above snippet is equivalent to adding the user by explicitly defining the stage. E.g. by creating this file inside ",(0,i.jsx)(n.code,{children:"/oem"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'stages:\n   initramfs:\n     - name: "Set user and password"\n       users:\n        testuser:\n          groups:\n          - "admin"\n          passwd: "mypassword"\n          shell: /bin/bash\n          homedir: "/home/testuser"\n'})}),"\n",(0,i.jsxs)(n.p,{children:["This configuration can be either manually copied over, or can be propagated also via Kubernetes using the system upgrade controller. See ",(0,i.jsx)(n.a,{href:"../../advanced/after-install",children:"the after-install"})," section for an example."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"\u276f ssh testuser@192.168.1.238\ntestuser@192.168.1.238's password:\nWelcome to kairos!\n\nRefer to https://kairos.io for documentation.\nlocalhost:~$ sudo su -\nlocalhost:~# whoami\nroot\nlocalhost:~# exit\nlocalhost:~$ whoami\ntestuser\nlocalhost:~$\n"})}),"\n",(0,i.jsx)(n.h2,{id:"provider-configs",children:"Provider configs"}),"\n",(0,i.jsx)(n.p,{children:"Providers are small binaries that can be used to extend the capabilities of Kairos. They are typically used to provide additional functionality or to integrate with external systems like k3s, k0s, rke2, or other Kubernetes distributions or even to provide additional functionality like p2p networking."}),"\n",(0,i.jsx)(n.p,{children:"This allows to use the same configuration file to install different Kubernetes distributions or to enable additional features like p2p networking."}),"\n",(0,i.jsx)(n.p,{children:"Below is a list of the configurations available for the current providers."}),"\n",(0,i.jsx)(n.p,{children:"Note that there is currently more providers available but some are community maintained. You should refer to the provider documentation for more information on how to use them."}),"\n","\n",(0,i.jsxs)(o.A,{children:[(0,i.jsxs)(r.A,{value:"k3s",label:"k3s",children:[(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Key"}),(0,i.jsx)(n.th,{children:"Description"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"k3s.enabled"})}),(0,i.jsxs)(n.td,{children:["Enables the k3s server instance. Accepted: ",(0,i.jsx)(n.code,{children:"true"}),", ",(0,i.jsx)(n.code,{children:"false"}),"."]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"k3s.env"})}),(0,i.jsx)(n.td,{children:"Additional environment variables for the k3s server instance."})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"k3s.args"})}),(0,i.jsx)(n.td,{children:"Additional arguments for the k3s server instance."})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"k3s.replace_env"})}),(0,i.jsx)(n.td,{children:"Replaces all environment variables otherwise passed to k3s by Kairos with those supplied here. Make sure you pass all the environment variables you need."})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"k3s.replace_args"})}),(0,i.jsx)(n.td,{children:"Replaces all arguments otherwise passed to k3s by Kairos with those supplied here. Make sure you pass all the arguments you need."})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"k3s.embedded_registry"})}),(0,i.jsxs)(n.td,{children:["Enables the embedded registry in k3s. Accepted: ",(0,i.jsx)(n.code,{children:"true"}),", ",(0,i.jsx)(n.code,{children:"false"}),"."]})]})]})]}),(0,i.jsxs)(n.p,{children:["WARNING: The K3s args are only applied when the K3s service is created, which is during installation. Changing the ",(0,i.jsx)(n.code,{children:"args"})," key after installation won't have any effect."]}),(0,i.jsx)(n.p,{children:"In order to override an existing k3s install arguments, you need to override the default service ones."}),(0,i.jsxs)(n.p,{children:["For Alpine services, the trick is to write via cloud config the ",(0,i.jsx)(n.code,{children:"/etc/rancher/k3s/k3s.env"})," file to set the proper ",(0,i.jsx)(n.code,{children:"command_args"})," like so:"]}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'stages:\n  initramfs:\n    - name: "Override k3s environment"\n      environment_file: /etc/rancher/k3s/k3s.env\n      environment:\n        command_args: server --verbose\n'})}),(0,i.jsx)(n.p,{children:"For systemd services, the usual override methods from systemd itself are available to override any services config, so we can lean on the yip plugin for systemd:"}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'stages:\n  initramfs:\n    - name: "Expand k3s modules load"\n      systemctl:\n        overrides:\n          - service: k3s.service\n            content: |\n              [Service]\n              ExecStartPre=-/sbin/modprobe nfs\n'})})]}),(0,i.jsx)(r.A,{value:"k3s-agent",label:"k3s-agent",children:(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Key"}),(0,i.jsx)(n.th,{children:"Description"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"k3s-agent.enabled"})}),(0,i.jsxs)(n.td,{children:["Enables the k3s agent instance. Accepted: ",(0,i.jsx)(n.code,{children:"true"}),", ",(0,i.jsx)(n.code,{children:"false"}),"."]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"k3s-agent.env"})}),(0,i.jsx)(n.td,{children:"Additional environment variables for the k3s server instance."})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"k3s-agent.args"})}),(0,i.jsx)(n.td,{children:"Additional arguments for the k3s server instance."})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"k3s-agent.replace_env"})}),(0,i.jsx)(n.td,{children:"Replaces all environment variables otherwise passed to k3s by Kairos with those supplied here. Make sure you pass all the environment variables you need."})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"k3s-agent.replace_args"})}),(0,i.jsx)(n.td,{children:"Replaces all arguments otherwise passed to k3s by Kairos with those supplied here. Make sure you pass all the arguments you need."})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"k3s-agent.embedded_registry"})}),(0,i.jsxs)(n.td,{children:["Enables the embedded registry in k3s. Accepted: ",(0,i.jsx)(n.code,{children:"true"}),", ",(0,i.jsx)(n.code,{children:"false"}),"."]})]})]})]})}),(0,i.jsx)(r.A,{value:"k0s",label:"k0s",children:(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Key"}),(0,i.jsx)(n.th,{children:"Description"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"k0s.enabled"})}),(0,i.jsxs)(n.td,{children:["Enables the k0s server instance. Accepted: ",(0,i.jsx)(n.code,{children:"true"}),", ",(0,i.jsx)(n.code,{children:"false"}),"."]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"k0s.env"})}),(0,i.jsx)(n.td,{children:"Additional environment variables for the k0s server instance."})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"k0s.args"})}),(0,i.jsx)(n.td,{children:"Additional arguments for the k0s server instance."})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"k0s.replace_env"})}),(0,i.jsx)(n.td,{children:"Replaces all environment variables otherwise passed to k3s by Kairos with those supplied here. Make sure you pass all the environment variables you need."})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"k0s.replace_args"})}),(0,i.jsx)(n.td,{children:"Replaces all arguments otherwise passed to k3s by Kairos with those supplied here. Make sure you pass all the arguments you need."})]})]})]})}),(0,i.jsx)(r.A,{value:"k0s-worker",label:"k0s-worker",children:(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Key"}),(0,i.jsx)(n.th,{children:"Description"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"k0s-worker.enabled"})}),(0,i.jsxs)(n.td,{children:["Enables the k0s worker instance. Accepted: ",(0,i.jsx)(n.code,{children:"true"}),", ",(0,i.jsx)(n.code,{children:"false"}),"."]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"k0s-worker.env"})}),(0,i.jsx)(n.td,{children:"Additional environment variables for the k0s worker instance."})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"k0s-worker.args"})}),(0,i.jsx)(n.td,{children:"Additional arguments for the k0s worker instance."})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"k0s-worker.replace_env"})}),(0,i.jsx)(n.td,{children:"Replaces all environment variables otherwise passed to k3s by Kairos with those supplied here. Make sure you pass all the environment variables you need."})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"k0s-worker.replace_args"})}),(0,i.jsx)(n.td,{children:"Replaces all arguments otherwise passed to k0s by Kairos with those supplied here. Make sure you pass all the arguments you need."})]})]})]})}),(0,i.jsx)(r.A,{value:"kubevip",label:"kubevip",children:(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Key"}),(0,i.jsx)(n.th,{children:"Description"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"kubevip.enable"})}),(0,i.jsxs)(n.td,{children:["Enables kubevip. Accepted: ",(0,i.jsx)(n.code,{children:"true"}),", ",(0,i.jsx)(n.code,{children:"false"}),"."]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"kubevip.eip"})}),(0,i.jsx)(n.td,{children:"VIP address to use"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"kubevip.manifest_url"})}),(0,i.jsxs)(n.td,{children:["Download and use the manifest from that url. You can see the default used otherwise ",(0,i.jsx)(n.a,{href:"https://github.com/kairos-io/provider-kairos/blob/main/internal/assets/static/kube_vip_rbac.yaml",children:"here"})]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"kubevip.interface"})}),(0,i.jsx)(n.td,{children:"Interface to use for the Kubevip EIP to attach to"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"kubevip.static_pod"})}),(0,i.jsxs)(n.td,{children:["Use a pod deployment for Kubevip instead of a daemonset. Accepted: ",(0,i.jsx)(n.code,{children:"true"}),", ",(0,i.jsx)(n.code,{children:"false"})]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"kubevip.version"})}),(0,i.jsx)(n.td,{children:"Set the specific Kubevip version to use"})]})]})]})}),(0,i.jsx)(r.A,{value:"kubeadm",label:"kubeadm",children:(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Key"}),(0,i.jsx)(n.th,{children:"Description"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"cluster.cluster_token"})}),(0,i.jsx)(n.td,{children:"Unique string that can be used to distinguish different clusters on networks with multiple clusters."})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"cluster.control_plane_host"})}),(0,i.jsx)(n.td,{children:"Host that all nodes can resolve and use for node registration."})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"cluster.role"})}),(0,i.jsxs)(n.td,{children:["The role of the node in the cluster. Accepted values are ",(0,i.jsx)(n.code,{children:"master"}),", ",(0,i.jsx)(n.code,{children:"worker"}),", and ",(0,i.jsx)(n.code,{children:"none"}),". Defaults to ",(0,i.jsx)(n.code,{children:"none"}),"."]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"cluster.config"})}),(0,i.jsx)(n.td,{children:"The configuration for the cluster."})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"cluster.env"})}),(0,i.jsx)(n.td,{children:"List of environment variables to be set on the cluster."})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"cluster.local_images_path"})}),(0,i.jsx)(n.td,{children:"Path to the local archive images to import."})]})]})]})}),(0,i.jsx)(r.A,{value:"p2p",label:"p2p",children:(0,i.jsxs)(n.p,{children:["As P2P is a very complex topic, we have a dedicated ",(0,i.jsx)(n.a,{href:"../../installation/p2p",children:"P2P documentation page"})," that explains how to use it with deep details."]})})]}),"\n",(0,i.jsx)(n.h2,{id:"stages",children:"Stages"}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"stages"})," key is a map that allows to execute blocks of cloud-init directives during the lifecycle of the node ",(0,i.jsx)(n.a,{href:"../../architecture/cloud-init",children:"stages"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"A full example of a stage is the following:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'#cloud-config\n\nstages:\n   # "boot" is the stage\n   boot:\n     - systemd_firstboot:\n         keymap: us\n     - files:\n        - path: /tmp/bar\n          content: |\n                    test\n          permissions: 0777\n          owner: 1000\n          group: 100\n       if: "[ ! -e /tmp/bar ]"\n     - files:\n        - path: /tmp/foo\n          content: |\n                    test\n          permissions: 0777\n          owner: 1000\n          group: 100\n       commands:\n        - echo "test"\n       modules:\n       - nvidia\n       environment:\n         FOO: "bar"\n       systctl:\n         debug.exception-trace: "0"\n       hostname: "foo"\n       systemctl:\n         enable:\n         - foo\n         disable:\n         - bar\n         start:\n         - baz\n         mask:\n         - foobar\n       authorized_keys:\n          user:\n          - "github:mudler"\n          - "ssh-rsa ...."\n       dns:\n         path: /etc/resolv.conf\n         nameservers:\n         - 8.8.8.8\n       ensure_entities:\n       -  path: /etc/passwd\n          entity: |\n                  kind: "user"\n                  username: "foo"\n                  password: "pass"\n                  uid: 0\n                  gid: 0\n                  info: "Foo!"\n                  homedir: "/home/foo"\n                  shell: "/bin/bash"\n       delete_entities:\n       -  path: /etc/passwd\n          entity: |\n                  kind: "user"\n                  username: "foo"\n                  password: "pass"\n                  uid: 0\n                  gid: 0\n                  info: "Foo!"\n                  homedir: "/home/foo"\n                  shell: "/bin/bash"\n       datasource:\n        path: "/usr/local/etc"\n        providers:\n          - "digitalocean"\n          - "aws"\n          - "gcp"\n'})}),"\n",(0,i.jsx)(n.p,{children:"Note multiple stages can be specified, to execute blocks into different stages, consider:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'#cloud-config\n\nstages:\n   boot:\n   - commands:\n     - echo "hello from the boot stage"\n   initramfs:\n   - commands:\n     - echo "hello from the boot stage"\n   - commands:\n     - echo "so much wow, /foo/bar bar exists!"\n     if: "[ -e /foo/bar ]"\n'})}),"\n",(0,i.jsx)(n.h2,{id:"logs-configuration",children:"Logs Configuration"}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"logs"})," configuration allows you to specify additional systemd journal services and log files to collect when using the ",(0,i.jsx)(n.code,{children:"kairos-agent logs"})," command. This is useful for debugging and issue reporting."]}),"\n",(0,i.jsx)(n.p,{children:"The system already includes comprehensive defaults for Kairos services and common log files. You only need to specify additional services or files that are not covered by the defaults."}),"\n",(0,i.jsx)(n.h3,{id:"default-services",children:"Default Services"}),"\n",(0,i.jsx)(n.p,{children:"The following services are automatically included:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"kairos-agent"}),", ",(0,i.jsx)(n.code,{children:"kairos-installer"}),", ",(0,i.jsx)(n.code,{children:"kairos-webui"})]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"cos-setup-boot"}),", ",(0,i.jsx)(n.code,{children:"cos-setup-fs"}),", ",(0,i.jsx)(n.code,{children:"cos-setup-network"}),", ",(0,i.jsx)(n.code,{children:"cos-setup-reconcile"})]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"k3s"}),", ",(0,i.jsx)(n.code,{children:"k3s-agent"}),", ",(0,i.jsx)(n.code,{children:"k0scontroller"}),", ",(0,i.jsx)(n.code,{children:"k0sworker"})]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"default-files",children:"Default Files"}),"\n",(0,i.jsx)(n.p,{children:"The following log file patterns are automatically included:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"/var/log/kairos/*.log"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"/var/log/*.log"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"/run/immucore/*.log"})}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"journal",children:(0,i.jsx)(n.code,{children:"journal"})}),"\n",(0,i.jsx)(n.p,{children:"A list of additional systemd journal service names to collect logs from. Only specify services that are not already included in the defaults."}),"\n",(0,i.jsx)(n.h3,{id:"files",children:(0,i.jsx)(n.code,{children:"files"})}),"\n",(0,i.jsx)(n.p,{children:"A list of additional log file paths to collect. Supports glob patterns for matching multiple files. Only specify files that are not already covered by the default patterns."}),"\n",(0,i.jsx)(n.p,{children:"Example configuration for adding custom services and files:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'#cloud-config\n\nlogs:\n  journal:\n    - "my-custom-service"\n    - "my-app"\n  files:\n    - "/var/log/myapp/*.log"\n    - "/var/log/custom/*.log"\n'})}),"\n",(0,i.jsx)(n.p,{children:"Below you can find a list of all the supported fields. Mind to replace with the appropriate stage you want to hook into."}),"\n",(0,i.jsx)(n.h3,{id:"filtering-stages-by-node-hostname",children:"Filtering stages by node hostname"}),"\n",(0,i.jsxs)(n.p,{children:["Stages can be filtered using the ",(0,i.jsx)(n.code,{children:"node"})," key with a hostname value:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'#cloud-config\n\nstages:\n  foo:\n  - name: "echo"\n    commands:\n    - echo hello\n    node: "the_node_hostname_here" # Node hostname\n\n'})}),"\n",(0,i.jsx)(n.h3,{id:"filtering-stages-with-if-statement",children:"Filtering stages with if statement"}),"\n",(0,i.jsx)(n.p,{children:"Stages can be skipped based on if statements:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'#cloud-config\n\nstages:\n  foo:\n  - name: "echo"\n    commands:\n    - echo hello\n    if: "cat /proc/cmdline | grep debug"\n\nname: "Test yip!"\n'})}),"\n",(0,i.jsxs)(n.p,{children:["The expression inside the ",(0,i.jsx)(n.code,{children:"if"})," will be evaluated in bash and, if specified, the stage gets executed only if the condition returns successfully (exit 0)."]}),"\n",(0,i.jsx)(n.h3,{id:"name",children:(0,i.jsx)(n.code,{children:"name"})}),"\n",(0,i.jsx)(n.p,{children:"A description of the stage step. Used only when printing output to console."}),"\n",(0,i.jsx)(n.h3,{id:"node",children:(0,i.jsx)(n.code,{children:"node"})}),"\n",(0,i.jsxs)(n.p,{children:["If defined, the node hostname where this stage has to run, otherwise it skips the execution. The node can also be a regexp in the ",(0,i.jsx)(n.a,{href:"https://pkg.go.dev/regexp/syntax",children:"Golang format"}),"."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'#cloud-config\n\nstages:\n   boot:\n     - name: "Setup logging"\n       node: "bastion"\n'})}),"\n",(0,i.jsx)(n.h3,{id:"modules",children:"Modules"}),"\n",(0,i.jsxs)(n.p,{children:["For each stage, a number of modules are available, that implement various useful functions.\nRead more about them in this page: ",(0,i.jsx)(n.a,{href:"../../Reference/stage_modules",children:"Stage modules"})]}),"\n",(0,i.jsx)(n.h2,{id:"running-commands-on-different-shells",children:"Running commands on different shells"}),"\n",(0,i.jsxs)(n.p,{children:["By default, all commands are executed in the ",(0,i.jsx)(n.code,{children:"sh"})," shell. However, it is possible to run commands in a different shell by prefixing the command with the executable."]}),"\n",(0,i.jsxs)(n.p,{children:["For example, to run a command in the ",(0,i.jsx)(n.code,{children:"bash"})," shell, you can use the following syntax:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'#cloud-config\nstages:\n  boot.after:\n    - name: "do something"\n      commands:\n        - bash /path/to/script.sh\n'})})]})}function f(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(u,{...e})}):u(e)}}}]);