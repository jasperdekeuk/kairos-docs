"use strict";(globalThis.webpackChunkkairos_docs=globalThis.webpackChunkkairos_docs||[]).push([[2625],{28453:(e,n,o)=>{o.d(n,{R:()=>s,x:()=>l});var t=o(96540);const a={},i=t.createContext(a);function s(e){const n=t.useContext(i);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:s(e.components),t.createElement(i.Provider,{value:n},e.children)}},73902:(e,n,o)=>{o.r(n),o.d(n,{assets:()=>r,contentTitle:()=>l,default:()=>u,frontMatter:()=>s,metadata:()=>t,toc:()=>c});const t=JSON.parse('{"id":"Examples/p2p_e2e","title":"P2P Multi-Node Cluster Provisioned via Netboot","description":"Full end to end example to bootstrap a self-coordinated cluster with Kairos and AuroraBoot","source":"@site/docs/Examples/p2p_e2e.md","sourceDirName":"Examples","slug":"/Examples/p2p_e2e","permalink":"/docs/next/Examples/p2p_e2e","draft":false,"unlisted":false,"editUrl":"https://github.com/kairos-io/kairos-docs/tree/main/docs/Examples/p2p_e2e.md","tags":[],"version":"current","lastUpdatedBy":"Jasper De Keukelaere (imec)","lastUpdatedAt":1765043763000,"frontMatter":{"title":"P2P Multi-Node Cluster Provisioned via Netboot","sidebar_label":"P2P multi-node cluster netboot","description":"Full end to end example to bootstrap a self-coordinated cluster with Kairos and AuroraBoot"},"sidebar":"tutorialSidebar","previous":{"title":"Intel Open AMT Registration","permalink":"/docs/next/Examples/openamt"},"next":{"title":"Self-configured P2P single-node cluster","permalink":"/docs/next/Examples/single-node-p2p"}}');var a=o(74848),i=o(28453);const s={title:"P2P Multi-Node Cluster Provisioned via Netboot",sidebar_label:"P2P multi-node cluster netboot",description:"Full end to end example to bootstrap a self-coordinated cluster with Kairos and AuroraBoot"},l=void 0,r={},c=[{value:"Description",id:"description",level:2},{value:"Prepare your <code>cloud-config</code> file",id:"prepare-your-cloud-config-file",level:2},{value:"Provisioning with AuroraBoot",id:"provisioning-with-auroraboot",level:2},{value:"Booting and access the cluster",id:"booting-and-access-the-cluster",level:2},{value:"Notes",id:"notes",level:2},{value:"Troubleshooing",id:"troubleshooing",level:2},{value:"See also",id:"see-also",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",li:"li",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.admonition,{title:"Network",type:"warning",children:(0,a.jsx)(n.p,{children:"This feature is experimental and has only been tested on local setups. Run in production servers at your own risk.\nFeedback and bug reports are welcome, as we are improving the p2p aspects of Kairos."})}),"\n",(0,a.jsx)(n.p,{children:"Deploying Kubernetes at the Edge can be a complex and time-consuming process, especially when it comes to setting up and managing multiple clusters. To make this process easier, Kairos leverages peer-to-peer technology to automatically coordinate and create Kubernetes clusters without the need of a control management interface."}),"\n",(0,a.jsxs)(n.p,{children:["To leverage p2p self-coordination capabilities of Kairos, you will need to configure the ",(0,a.jsx)(n.code,{children:"network_token"})," under the ",(0,a.jsx)(n.code,{children:"p2p"})," configuration block in your cloud-config file. Once you have set this, Kairos will handle the configuration of each node."]}),"\n",(0,a.jsx)(n.h2,{id:"description",children:"Description"}),"\n",(0,a.jsx)(n.p,{children:"In the following example we are going to bootstrap a new multi-node, single cluster with Kairos. We will use at least 2 nodes, one as a master and one as a worker. Note how we don't specify any role, or either pin any IP in the following configurations."}),"\n",(0,a.jsxs)(n.p,{children:["We will first create a cloud config file for our deployment, and then run ",(0,a.jsx)(n.a,{href:"../../reference/auroraboot",children:"AuroraBoot"})," locally. We then start 2 VMs configured for netbooting."]}),"\n",(0,a.jsxs)(n.h2,{id:"prepare-your-cloud-config-file",children:["Prepare your ",(0,a.jsx)(n.code,{children:"cloud-config"})," file"]}),"\n",(0,a.jsx)(n.p,{children:"Consider the following example, which uses cloud-config to automatically configure the cluster:"}),"\n",(0,a.jsx)(n.p,{children:"We start by creating a cloud config file locally, that could look similar to this:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:'#cloud-config\n\nhostname: kairoslab-{{ trunc 4 .MachineID }}\nusers:\n- name: kairos\n  passwd: kairos\n  groups:\n  - admin\n  ssh_authorized_keys:\n  # Replace with your github user and un-comment the line below:\n  - github:mudler\n  - github:mauromorales\n\np2p:\n disable_dht: true # Enable for LAN-only clusters\n network_token: ""\n'})}),"\n",(0,a.jsxs)(n.p,{children:["As we want the installation to be triggered automatically, we add also the ",(0,a.jsx)(n.code,{children:"install block"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:'install:\n auto: true\n device: "auto"\n reboot: true\n'})}),"\n",(0,a.jsx)(n.p,{children:"In order to leverage p2p and automatic node co-ordination, we need to generate a unique pre-shared token that will be used by all the nodes that we want to be part of our cluster."}),"\n",(0,a.jsxs)(n.p,{children:["We can generate a network token by using the ",(0,a.jsx)(n.code,{children:"edgevpn"})," images, by running it locally:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"$ docker run -ti --rm quay.io/mudler/edgevpn -b -g\nb3RwOgogIGRodDoKICAgIGludGVydmFsOiA5MDAwCiAgICBrZXk6IGtkdGtoY21sMHVJM2hzVUFUMXpUY1B2aDhBblkzNDZUbHJ3NklVRmUxYUoKICAgIGxlbmd0aDogNDMKICBjcnlwdG86CiAgICBpbnRlcnZhbDogOTAwMAogICAga2V5OiBIcEJGaGxxdlFrcTZVd3BPSTBPVkJWQ1daRjNRYlE3WGdDa1R1bnI0cGV3CiAgICBsZW5ndGg6IDQzCnJvb206IGFBUE5oRTdlODgyZUZhM2NMTW56VkM0ZDZjWFdpTU5EYlhXMDE4Skl2Q3oKcmVuZGV6dm91czogOHVzaGhzNnFrTU92U2ZvQmZXMHZPaEY1ZFlodVZlN1Flc00zRWlMM2pNMwptZG5zOiBJZ0ljaGlvRlVYOFN6V1VKQjNXQ0NyT2UzZXZ3YzE4MWVIWm42SmlYZjloCm1heF9tZXNzYWdlX3NpemU6IDIwOTcxNTIwCg==\n"})}),"\n",(0,a.jsx)(n.p,{children:"This command will generate a network token that we can use in the configuration, which now looks like the following:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:'#cloud-config\n\ninstall:\n auto: true\n device: "auto"\n reboot: true\n\nhostname: kairoslab-{{ trunc 4 .MachineID }}\nusers:\n- name: kairos\n  passwd: kairos\n  groups:\n  - admin\n  ssh_authorized_keys:\n  - github:mudler\n  - github:mauromorales\n\np2p:\n disable_dht: true #Enabled by default\n network_token: "b3RwOgogIGRodDoKICAgIGludGVydmFsOiA5MDAwCiAgICBrZXk6IGtkdGtoY21sMHVJM2hzVUFUMXpUY1B2aDhBblkzNDZUbHJ3NklVRmUxYUoKICAgIGxlbmd0aDogNDMKICBjcnlwdG86CiAgICBpbnRlcnZhbDogOTAwMAogICAga2V5OiBIcEJGaGxxdlFrcTZVd3BPSTBPVkJWQ1daRjNRYlE3WGdDa1R1bnI0cGV3CiAgICBsZW5ndGg6IDQzCnJvb206IGFBUE5oRTdlODgyZUZhM2NMTW56VkM0ZDZjWFdpTU5EYlhXMDE4Skl2Q3oKcmVuZGV6dm91czogOHVzaGhzNnFrTU92U2ZvQmZXMHZPaEY1ZFlodVZlN1Flc00zRWlMM2pNMwptZG5zOiBJZ0ljaGlvRlVYOFN6V1VKQjNXQ0NyT2UzZXZ3YzE4MWVIWm42SmlYZjloCm1heF9tZXNzYWdlX3NpemU6IDIwOTcxNTIwCg=="\n'})}),"\n",(0,a.jsx)(n.p,{children:"Change also accordingly the users that can access to the machine:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:"ssh_authorized_keys:\n- github:mudler <--- put your GitHub handle here\n"})}),"\n",(0,a.jsx)(n.h2,{id:"provisioning-with-auroraboot",children:"Provisioning with AuroraBoot"}),"\n",(0,a.jsxs)(n.p,{children:["We now can run ",(0,a.jsx)(n.a,{href:"../../reference/auroraboot",children:"AuroraBoot"})," with  to provision ",(0,a.jsx)(n.code,{children:"openSUSE Leap"})," machines with those k3s and kairos versions."]}),"\n",(0,a.jsxs)(n.p,{children:["AuroraBoot takes ",(0,a.jsx)(n.code,{children:"cloud-config"})," files also from ",(0,a.jsx)(n.em,{children:"STDIN"}),", so we will pipe the configuration file to it, and specify the container image that we want to use for our nodes:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'cat <<EOF | docker run --rm -i --net host quay.io/kairos/auroraboot \\\n                    --cloud-config - \\\n                    --set "container_image=quay.io/kairos/kairos-standard:latest"\n#cloud-config\n\n# https://github.com/kairos-io/kairos/issues/885\nconfig_url: ""\n\ninstall:\n auto: true\n device: "auto"\n reboot: true\n\nhostname: kairoslab-{{ trunc 4 .MachineID }}\nusers:\n- name: kairos\n  passwd: kairos\n  groups:\n  - admin\n  ssh_authorized_keys:\n  - github:mudler\n  - github:mauromorales\np2p:\n disable_dht: true #Enabled by default\n network_token: "b3RwOgogIGRodDoKICAgIGludGVydmFsOiA5MDAwCiAgICBrZXk6IGtkdGtoY21sMHVJM2hzVUFUMXpUY1B2aDhBblkzNDZUbHJ3NklVRmUxYUoKICAgIGxlbmd0aDogNDMKICBjcnlwdG86CiAgICBpbnRlcnZhbDogOTAwMAogICAga2V5OiBIcEJGaGxxdlFrcTZVd3BPSTBPVkJWQ1daRjNRYlE3WGdDa1R1bnI0cGV3CiAgICBsZW5ndGg6IDQzCnJvb206IGFBUE5oRTdlODgyZUZhM2NMTW56VkM0ZDZjWFdpTU5EYlhXMDE4Skl2Q3oKcmVuZGV6dm91czogOHVzaGhzNnFrTU92U2ZvQmZXMHZPaEY1ZFlodVZlN1Flc00zRWlMM2pNMwptZG5zOiBJZ0ljaGlvRlVYOFN6V1VKQjNXQ0NyT2UzZXZ3YzE4MWVIWm42SmlYZjloCm1heF9tZXNzYWdlX3NpemU6IDIwOTcxNTIwCg=="\nEOF\n'})}),"\n",(0,a.jsx)(n.h2,{id:"booting-and-access-the-cluster",children:"Booting and access the cluster"}),"\n",(0,a.jsxs)(n.p,{children:["Start the Machines (VM, or baremetal) with Netboot ( see also ",(0,a.jsx)(n.a,{href:"../../reference/auroraboot#3-start-nodes",children:"here"})," ) and wait for the installation to finish."]}),"\n",(0,a.jsx)(n.p,{children:"Afterward, you should be able to ssh to one of the machines and be able to use your Kubernetes cluster:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"$ ssh kairos@IP\n$ sudo su -\n$ k9s\n"})}),"\n",(0,a.jsxs)(n.admonition,{title:"Warning",type:"warning",children:[(0,a.jsx)(n.p,{children:"If k9s doesn't automatically pick up the kubeconfig, you can manually fetch it and pass it to k9s:"}),(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"$ kairos get-kubeconfig > kubeconfig\n$ KUBECONFIG=kubeconfig k9s\n"})})]}),"\n",(0,a.jsx)(n.h2,{id:"notes",children:"Notes"}),"\n",(0,a.jsxs)(n.p,{children:["By default, the Kubernetes API endpoint is not exposed outside the VPN. This is an opinionated configuration from Kairos. To check out configurations without VPN, see also ",(0,a.jsx)(n.a,{href:"../../examples/multi-node-p2p-ha-kubevip",children:"the KubeVIP example"}),"."]}),"\n",(0,a.jsx)(n.h2,{id:"troubleshooing",children:"Troubleshooing"}),"\n",(0,a.jsxs)(n.p,{children:["During the first-boot, you can check the provisioning status by looking at the ",(0,a.jsx)(n.code,{children:"kairos-agent"})," logs:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"$ systemctl status kairos-agent\n$ journalctl -fu kairos-agent\n"})}),"\n",(0,a.jsx)(n.h2,{id:"see-also",children:"See also"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"../../installation/p2p",children:"Installation with p2p"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"../../architecture/network",children:"P2P Architecture"})}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(d,{...e})}):d(e)}}}]);