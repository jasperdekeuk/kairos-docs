"use strict";(globalThis.webpackChunkkairos_docs=globalThis.webpackChunkkairos_docs||[]).push([[8546],{8922:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>d,contentTitle:()=>a,default:()=>u,frontMatter:()=>r,metadata:()=>t,toc:()=>c});const t=JSON.parse('{"id":"Advanced/adding_opt_to_system_extensions","title":"Using /opt with System Extensions","description":"Using /opt with System Extensions","source":"@site/versioned_docs/version-3.6.0/Advanced/adding_opt_to_system_extensions.md","sourceDirName":"Advanced","slug":"/Advanced/adding_opt_to_system_extensions","permalink":"/kairos-docs/docs/3.6.0/Advanced/adding_opt_to_system_extensions","draft":false,"unlisted":false,"editUrl":"https://github.com/kairos-io/kairos-docs/tree/main/versioned_docs/version-3.6.0/Advanced/adding_opt_to_system_extensions.md","tags":[],"version":"3.6.0","lastUpdatedBy":"Jasper De Keukelaere (imec)","lastUpdatedAt":1765142882000,"sidebarPosition":3,"frontMatter":{"title":"Using /opt with System Extensions","sidebar_label":"Using /opt with System Extensions","sidebar_position":3},"sidebar":"tutorialSidebar","previous":{"title":"Private registries authentication","permalink":"/kairos-docs/docs/3.6.0/Advanced/private_registry_auth"},"next":{"title":"Build","permalink":"/kairos-docs/docs/3.6.0/Advanced/build"}}');var i=n(74848),o=n(28453);const r={title:"Using /opt with System Extensions",sidebar_label:"Using /opt with System Extensions",sidebar_position:3},a=void 0,d={},c=[{value:"Using /opt with System Extensions",id:"using-opt-with-system-extensions",level:2},{value:"Why <code>/opt</code> Might Be Needed",id:"why-opt-might-be-needed",level:3},{value:"Enabling <code>/opt</code> in System Extensions: Cloud-Init Configuration",id:"enabling-opt-in-system-extensions-cloud-init-configuration",level:2}];function l(e){const s={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",hr:"hr",p:"p",pre:"pre",strong:"strong",...(0,o.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(s.h2,{id:"using-opt-with-system-extensions",children:"Using /opt with System Extensions"}),"\n",(0,i.jsxs)(s.p,{children:["By default, Kairos does not include ",(0,i.jsx)(s.code,{children:"/opt"})," as a system extension (",(0,i.jsx)(s.code,{children:"sysext"}),") overlay hierarchy. This is because in normal runtime, ",(0,i.jsx)(s.code,{children:"/opt"})," is writable and bind-mounted to the persistent partition, allowing users and applications to freely write data that persists across reboots."]}),"\n",(0,i.jsxs)(s.p,{children:["However, when a system extension is loaded that includes a ",(0,i.jsx)(s.code,{children:"/opt"})," hierarchy, the behavior of that directory changes: it becomes ",(0,i.jsx)(s.strong,{children:"read-only"}),", overridden by the overlay from the system extension image. This is a consequence of how ",(0,i.jsx)(s.code,{children:"systemd-sysext"})," currently operates and reflects a known upstream limitation."]}),"\n",(0,i.jsxs)(s.h3,{id:"why-opt-might-be-needed",children:["Why ",(0,i.jsx)(s.code,{children:"/opt"})," Might Be Needed"]}),"\n",(0,i.jsxs)(s.p,{children:["If your use case includes deploying system extensions that provide optional software, plugins, or third-party tools installed under ",(0,i.jsx)(s.code,{children:"/opt"}),", you might need to explicitly enable ",(0,i.jsx)(s.code,{children:"/opt"})," as a supported hierarchy for sysext overlays."]}),"\n",(0,i.jsxs)(s.p,{children:["This can be done by configuring the environment variable ",(0,i.jsx)(s.code,{children:"SYSTEMD_SYSEXT_HIERARCHIES"})," to include ",(0,i.jsx)(s.code,{children:"/opt"}),", and ensuring that the ",(0,i.jsx)(s.code,{children:"systemd-sysext"})," service uses this setting both at runtime and in the initramfs phase."]}),"\n",(0,i.jsxs)(s.admonition,{type:"warning",children:[(0,i.jsxs)(s.p,{children:["Once ",(0,i.jsx)(s.code,{children:"/opt"})," is included in the sysext overlay, the directory becomes read-only as soon as any system extension mounts a ",(0,i.jsx)(s.code,{children:"/opt"})," subtree. This can break applications or scripts expecting to write to ",(0,i.jsx)(s.code,{children:"/opt"}),"."]}),(0,i.jsxs)(s.p,{children:["As of systemd 255, there is no way to mark overlay hierarchies as mutable. However, upstream efforts are underway to address this in ",(0,i.jsx)(s.a,{href:"https://www.freedesktop.org/software/systemd/man/latest/systemd-sysext.html#Mutability",children:"systemd 256"})," and beyond, allowing finer control over the mutability of sysext mount points."]})]}),"\n",(0,i.jsx)(s.hr,{}),"\n",(0,i.jsxs)(s.h2,{id:"enabling-opt-in-system-extensions-cloud-init-configuration",children:["Enabling ",(0,i.jsx)(s.code,{children:"/opt"})," in System Extensions: Cloud-Init Configuration"]}),"\n",(0,i.jsxs)(s.p,{children:["To allow system extensions to provide content under ",(0,i.jsx)(s.code,{children:"/opt"}),", you can modify the ",(0,i.jsx)(s.code,{children:"systemd-sysext"})," configuration using Kairos cloud config."]}),"\n",(0,i.jsxs)(s.p,{children:["Below is an example cloud-init YAML you can embed in your OEM configuration or custom image. It ensures that ",(0,i.jsx)(s.code,{children:"/opt"})," is registered as a sysext hierarchy both in normal and Trusted Boot installations. In here we are overriding the existing files to include the ",(0,i.jsx)(s.code,{children:"/opt"})," directory in the ",(0,i.jsx)(s.code,{children:"SYSTEMD_SYSEXT_HIERARCHIES"})," environment variable that Kairos sets by default."]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-yaml",children:'name: "sysext using /opt"\nstages:\n  initramfs.after:\n    - name: "systemd-sysext uki config"\n      if: \'[ -e "/run/cos/uki_boot_mode" ] && [ ! -e "/run/cos/recovery_mode" ] && [ ! -e "/run/cos/autoreset_mode" ]\'\n      files:\n        - path: /etc/systemd/system/systemd-sysext.service.d/kairos-uki.conf\n          permissions: 0644\n          owner: 0\n          group: 0\n          content: |\n            [Service]\n            TimeoutStartSec=10\n            ExecStart=\n            ExecStart=systemd-sysext refresh --image-policy="root=verity+signed+absent:usr=verity+signed+absent"\n            ExecReload=\n            ExecReload=systemd-sysext refresh --image-policy="root=verity+signed+absent:usr=verity+signed+absent"\n            Environment="SYSTEMD_SYSEXT_HIERARCHIES=/usr/local/bin:/usr/local/sbin:/usr/local/include:/usr/local/lib:/usr/local/share:/usr/local/src:/usr/bin:/usr/share:/usr/lib:/usr/include:/usr/src:/usr/sbin:/opt"\n            [Unit]\n            JobRunningTimeoutSec=5\n\n    - name: "systemd-sysext config"\n      if: \'[ ! -e "/run/cos/uki_boot_mode" ] && [ ! -e "/run/cos/recovery_mode" ] && [ ! -e "/run/cos/autoreset_mode" ]\'\n      files:\n        - path: /etc/systemd/system/systemd-sysext.service.d/kairos.conf\n          permissions: 0644\n          owner: 0\n          group: 0\n          content: |\n            [Service]\n            TimeoutStartSec=10\n            ExecStart=\n            ExecStart=systemd-sysext refresh --image-policy="root=verity+absent:usr=verity+absent"\n            ExecReload=\n            ExecReload=systemd-sysext refresh --image-policy="root=verity+absent:usr=verity+absent"\n            Environment="SYSTEMD_SYSEXT_HIERARCHIES=/usr/local/bin:/usr/local/sbin:/usr/local/include:/usr/local/lib:/usr/local/share:/usr/local/src:/usr/bin:/usr/share:/usr/lib:/usr/include:/usr/src:/usr/sbin:/opt"\n            [Unit]\n            JobRunningTimeoutSec=5\n\n    - name: "systemd-sysext set hierarchy system-wide"\n      if: \'[ ! -e "/run/cos/recovery_mode" ] && [ ! -e "/run/cos/autoreset_mode" ]\'\n      files:\n        - path: /etc/profile.d/systemd-sysext.sh\n          permissions: 0644\n          owner: 0\n          group: 0\n          content: |\n            export SYSTEMD_SYSEXT_HIERARCHIES="/usr/local/bin:/usr/local/sbin:/usr/local/include:/usr/local/lib:/usr/local/share:/usr/local/src:/usr/bin:/usr/share:/usr/lib:/usr/include:/usr/src:/usr/sbin:/opt"\n\n    - name: "systemd-sysext initramfs settings"\n      if: \'[ -e "/sbin/systemctl" ] || [ -e "/usr/bin/systemctl" ] || [ -e "/usr/sbin/systemctl" ] || [ -e "/bin/systemctl" ]\'\n      systemctl:\n        enable:\n          - systemd-sysext\n'})})]})}function u(e={}){const{wrapper:s}={...(0,o.R)(),...e.components};return s?(0,i.jsx)(s,{...e,children:(0,i.jsx)(l,{...e})}):l(e)}},28453:(e,s,n)=>{n.d(s,{R:()=>r,x:()=>a});var t=n(96540);const i={},o=t.createContext(i);function r(e){const s=t.useContext(o);return t.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function a(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),t.createElement(o.Provider,{value:s},e.children)}}}]);