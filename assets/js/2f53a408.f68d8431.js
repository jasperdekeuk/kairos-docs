"use strict";(globalThis.webpackChunkkairos_docs=globalThis.webpackChunkkairos_docs||[]).push([[208],{28453:(e,t,s)=>{s.d(t,{R:()=>r,x:()=>a});var n=s(96540);const o={},i=n.createContext(o);function r(e){const t=n.useContext(i);return n.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:r(e.components),n.createElement(i.Provider,{value:t},e.children)}},37699:(e,t,s)=>{s.r(t),s.d(t,{assets:()=>c,contentTitle:()=>a,default:()=>h,frontMatter:()=>r,metadata:()=>n,toc:()=>l});const n=JSON.parse('{"id":"Examples/boot_assessment_trusted_boot","title":"Enabling Automatic Boot Assessment with Trusted Boot","description":"This section describe examples on how to enable Automatic Boot Assessment with Trusted Boot in your own services.","source":"@site/versioned_docs/version-3.5.7/Examples/boot_assessment_trusted_boot.md","sourceDirName":"Examples","slug":"/Examples/boot_assessment_trusted_boot","permalink":"/docs/3.5.7/Examples/boot_assessment_trusted_boot","draft":false,"unlisted":false,"editUrl":"https://github.com/kairos-io/kairos-docs/tree/main/versioned_docs/version-3.5.7/Examples/boot_assessment_trusted_boot.md","tags":[],"version":"3.5.7","lastUpdatedBy":"Jasper De Keukelaere (imec)","lastUpdatedAt":1765142882000,"sidebarPosition":4,"frontMatter":{"title":"Enabling Automatic Boot Assessment with Trusted Boot","sidebar_label":"Enabling Automatic Boot Assessment with Trusted Boot","sidebar_position":4,"description":"This section describe examples on how to enable Automatic Boot Assessment with Trusted Boot in your own services."},"sidebar":"tutorialSidebar","previous":{"title":"Examples","permalink":"/docs/3.5.7/category/examples"},"next":{"title":"Airgapped ISO","permalink":"/docs/3.5.7/Examples/airgap"}}');var o=s(74848),i=s(28453);const r={title:"Enabling Automatic Boot Assessment with Trusted Boot",sidebar_label:"Enabling Automatic Boot Assessment with Trusted Boot",sidebar_position:4,description:"This section describe examples on how to enable Automatic Boot Assessment with Trusted Boot in your own services."},a=void 0,c={},l=[{value:"Boot Assessment in Kairos: Introduction and Extensions",id:"boot-assessment-in-kairos-introduction-and-extensions",level:2},{value:"Part 1: Kairos Default Boot Assessment Strategy",id:"part-1-kairos-default-boot-assessment-strategy",level:2},{value:"Part 2: Extending the Default Boot Assessment with Your Own Services",id:"part-2-extending-the-default-boot-assessment-with-your-own-services",level:2},{value:"Step 1: Configuring a Service to Trigger <code>boot-complete.target</code>",id:"step-1-configuring-a-service-to-trigger-boot-completetarget",level:2},{value:"Step 2: Adding Automatic Reboot to a Service",id:"step-2-adding-automatic-reboot-to-a-service",level:2},{value:"Step 3: Combining Both Approaches",id:"step-3-combining-both-approaches",level:2},{value:"Using cloud configs to automate the process",id:"using-cloud-configs-to-automate-the-process",level:2},{value:"Notes",id:"notes",level:2}];function d(e){const t={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(t.h2,{id:"boot-assessment-in-kairos-introduction-and-extensions",children:"Boot Assessment in Kairos: Introduction and Extensions"}),"\n",(0,o.jsxs)(t.p,{children:["Kairos provides a robust mechanism for assessing the success or failure of boot entries through integration with ",(0,o.jsx)(t.code,{children:"systemd-boot"}),". This document is divided into two parts:"]}),"\n",(0,o.jsxs)(t.ol,{children:["\n",(0,o.jsxs)(t.li,{children:[(0,o.jsx)(t.strong,{children:"Kairos Default Boot Assessment Strategy"}),": Explains how boot assessment is managed in a standard Kairos installation."]}),"\n",(0,o.jsxs)(t.li,{children:[(0,o.jsx)(t.strong,{children:"Extending the Default Boot Assessment"}),": Shows how to customize and extend Kairos boot assessment by integrating additional systemd services and adding automatic reboot mechanisms."]}),"\n"]}),"\n",(0,o.jsx)(t.hr,{}),"\n",(0,o.jsx)(t.h2,{id:"part-1-kairos-default-boot-assessment-strategy",children:"Part 1: Kairos Default Boot Assessment Strategy"}),"\n",(0,o.jsxs)(t.p,{children:["Kairos uses ",(0,o.jsx)(t.code,{children:"systemd-boot"})," to manage boot entries and determine their health based on runtime behavior. The current boot assessment strategy in Kairos works as follows:"]}),"\n",(0,o.jsxs)(t.ol,{children:["\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsxs)(t.p,{children:[(0,o.jsx)(t.strong,{children:"Boot Entry Marking"}),":"]}),"\n",(0,o.jsxs)(t.ul,{children:["\n",(0,o.jsxs)(t.li,{children:["If the system successfully reaches ",(0,o.jsx)(t.code,{children:"multi-user.target"}),", the boot entry is marked as ",(0,o.jsx)(t.em,{children:"good"}),"."]}),"\n",(0,o.jsx)(t.li,{children:"If it does not, retries are consumed for the boot entry."}),"\n"]}),"\n"]}),"\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsxs)(t.p,{children:[(0,o.jsx)(t.strong,{children:"Failure Handling"}),":"]}),"\n",(0,o.jsxs)(t.ul,{children:["\n",(0,o.jsxs)(t.li,{children:["Kernel panics, ",(0,o.jsx)(t.code,{children:"initramfs"})," failures, or any unexpected reboots reduce the retry count for the current boot entry."]}),"\n",(0,o.jsx)(t.li,{children:"No Kairos services explicitly auto-reboot on failure."}),"\n"]}),"\n"]}),"\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsxs)(t.p,{children:[(0,o.jsx)(t.strong,{children:"Retry Exhaustion and Fallbacks"}),":"]}),"\n",(0,o.jsxs)(t.ul,{children:["\n",(0,o.jsx)(t.li,{children:"Each boot entry is given a limited number of retries (3 by default)."}),"\n",(0,o.jsxs)(t.li,{children:["If retries are exhausted:","\n",(0,o.jsxs)(t.ul,{children:["\n",(0,o.jsxs)(t.li,{children:["The ",(0,o.jsx)(t.strong,{children:"passive (fallback)"})," entry is booted next."]}),"\n",(0,o.jsxs)(t.li,{children:["If the passive entry also fails, the system boots into ",(0,o.jsx)(t.strong,{children:"recovery"})," mode."]}),"\n",(0,o.jsxs)(t.li,{children:["If recovery fails, the system attempts ",(0,o.jsx)(t.strong,{children:"autorecovery"}),"."]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(t.admonition,{type:"info",children:(0,o.jsx)(t.p,{children:"Current boot fallback behaviour is not set in stone yet and prone to changes in the future."})}),"\n",(0,o.jsx)(t.p,{children:"This default behavior ensures resilience and an automatic progression to recovery states, but it can be further extended to incorporate custom services and automatic reboot logic."}),"\n",(0,o.jsx)(t.h2,{id:"part-2-extending-the-default-boot-assessment-with-your-own-services",children:"Part 2: Extending the Default Boot Assessment with Your Own Services"}),"\n",(0,o.jsx)(t.p,{children:"While the default Kairos behavior is sufficient for many use cases, you can extend the boot assessment mechanism to include custom services and additional robustness features, such as:"}),"\n",(0,o.jsxs)(t.ul,{children:["\n",(0,o.jsx)(t.li,{children:"Integrating custom systemd services into the boot assessment process."}),"\n",(0,o.jsx)(t.li,{children:"Adding automatic reboot behavior for services that fail."}),"\n"]}),"\n",(0,o.jsx)(t.admonition,{type:"info",children:(0,o.jsx)(t.p,{children:"All the commands shown in this tutorial are meant to be run on a Kairos node."})}),"\n",(0,o.jsxs)(t.h2,{id:"step-1-configuring-a-service-to-trigger-boot-completetarget",children:["Step 1: Configuring a Service to Trigger ",(0,o.jsx)(t.code,{children:"boot-complete.target"})]}),"\n",(0,o.jsxs)(t.p,{children:["To ensure a service's failure impacts the boot assessment, modify its service file to interact with ",(0,o.jsx)(t.code,{children:"boot-complete.target"}),":"]}),"\n",(0,o.jsxs)(t.ol,{children:["\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsxs)(t.p,{children:[(0,o.jsx)(t.strong,{children:"Edit the Service File"}),":"]}),"\n",(0,o.jsx)(t.p,{children:"Override the service configuration using:"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:"sudo systemctl edit <service-name>\n"})}),"\n"]}),"\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsxs)(t.p,{children:[(0,o.jsx)(t.strong,{children:"Add Dependencies and Order to the Service File"}),":"]}),"\n",(0,o.jsx)(t.p,{children:"Append the following to the override file:"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:"[Unit]\n# Ensure this unit starts after default system targets\nAfter=default.target graphical.target multi-user.target\n# Ensure this unit completes before boot-complete.target\nBefore=boot-complete.target\n\n[Install]\n# Make this service a hard dependency of boot-complete.target\nRequiredBy=boot-complete.target\n"})}),"\n"]}),"\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsxs)(t.p,{children:[(0,o.jsx)(t.strong,{children:"Reload Systemd and Enable the Service:"}),":"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:"sudo systemctl daemon-reload\nsudo systemctl enable <service-name>\n"})}),"\n"]}),"\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsxs)(t.p,{children:[(0,o.jsx)(t.strong,{children:"Explanation"}),":"]}),"\n"]}),"\n"]}),"\n",(0,o.jsxs)(t.ul,{children:["\n",(0,o.jsx)(t.li,{children:"The service runs after critical system targets (e.g., default.target) to ensure the system is operational."}),"\n",(0,o.jsx)(t.li,{children:"The service must complete successfully to allow boot-complete.target to be reached."}),"\n",(0,o.jsx)(t.li,{children:"If the service fails, the boot entry is not marked as good."}),"\n"]}),"\n",(0,o.jsx)(t.h2,{id:"step-2-adding-automatic-reboot-to-a-service",children:"Step 2: Adding Automatic Reboot to a Service"}),"\n",(0,o.jsx)(t.p,{children:"To configure a service to automatically reboot the system upon failure:"}),"\n",(0,o.jsxs)(t.ol,{children:["\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsx)(t.p,{children:"Edit the Service File:"}),"\n",(0,o.jsx)(t.p,{children:"Override the service configuration using:"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:"sudo systemctl edit <service-name>\n"})}),"\n"]}),"\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsx)(t.p,{children:"Add the Reboot Action:"}),"\n",(0,o.jsx)(t.p,{children:"In the [Unit] section, add:"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:"[Unit]\nFailureAction=reboot\n"})}),"\n"]}),"\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsx)(t.p,{children:"Reload Systemd:"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:"sudo systemctl daemon-reload\n"})}),"\n"]}),"\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsx)(t.p,{children:"Explanation:"}),"\n",(0,o.jsxs)(t.ul,{children:["\n",(0,o.jsx)(t.li,{children:"On failure, FailureAction=reboot instructs systemd to reboot the system."}),"\n",(0,o.jsx)(t.li,{children:"This causes the boot entry to retry until success or retries are exhausted."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(t.h2,{id:"step-3-combining-both-approaches",children:"Step 3: Combining Both Approaches"}),"\n",(0,o.jsx)(t.p,{children:"While the above configurations are independent, combining them can create a robust system:"}),"\n",(0,o.jsxs)(t.ol,{children:["\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsx)(t.p,{children:"Trigger boot-complete.target:\nConfigure services as described in Step 1 to impact boot assessment."}),"\n"]}),"\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsxs)(t.p,{children:["Enable Automatic Reboot:\nAdd ",(0,o.jsx)(t.code,{children:"FailureAction=reboot"})," to relevant services as described in Step 2."]}),"\n"]}),"\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsx)(t.p,{children:"Behavior:"}),"\n"]}),"\n"]}),"\n",(0,o.jsxs)(t.ul,{children:["\n",(0,o.jsxs)(t.li,{children:["On a service failure, the system reboots (",(0,o.jsx)(t.code,{children:"FailureAction=reboot"}),")."]}),"\n",(0,o.jsx)(t.li,{children:"During the retry, if boot-complete.target is not reached, the boot entry is not marked as good, and retries continue."}),"\n",(0,o.jsx)(t.li,{children:"If retries are exhausted, the system attempts the next available boot entry."}),"\n"]}),"\n",(0,o.jsx)(t.h2,{id:"using-cloud-configs-to-automate-the-process",children:"Using cloud configs to automate the process"}),"\n",(0,o.jsx)(t.p,{children:"As usual you can use ./cloud-init.md with the different ./stage_modules.md) to automate this process. Here is an example of how to use cloud-init to enable boot assessment and configure services to participate in the boot assessment process:"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-yaml",children:"#cloud-config\nname: Enable Boot assessment for <service-name>\nstages:\n  initramfs:\n    - name: Configure service to trigger boot-complete.target\n      files:\n         - path: /etc/systemd/system/<service-name>.service.d/override.conf\n           permissions: 0644\n           owner: 0\n           group: 0\n           content: |\n             [Unit]\n             # Ensure this unit starts after default system targets\n             After=default.target graphical.target multi-user.target\n             # Ensure this unit completes before boot-complete.target\n             Before=boot-complete.target\n             # If auto reboot on service failure is wanted\n             FailureAction=reboot\n             [Install]\n             # Make this service a hard dependency of boot-complete.target\n             RequiredBy=boot-complete.target\n    - name: Enable service\n      systemctl:\n         enabled:\n            - <service-name>\n"})}),"\n",(0,o.jsx)(t.h2,{id:"notes",children:"Notes"}),"\n",(0,o.jsxs)(t.ul,{children:["\n",(0,o.jsx)(t.li,{children:'We expect the number of checks for a system to be marked "good" to keep growing as we add more checks to the boot assessment process.'}),"\n",(0,o.jsx)(t.li,{children:"Services are started on both passive and active boot entries. So if a service is failing on active, and the failure is not due to the OS, it will also fail on passive. This can lead to the system rebooting on passive boot entries as well as active and end in the system booting to recovery."}),"\n",(0,o.jsx)(t.li,{children:"We recommend using this feature with caution, as it can lead to a boot loop if not configured correctly."}),"\n",(0,o.jsxs)(t.li,{children:["Ideally, as the upgrade is done against the active images, we would recommend having 2 service overrides, one for the active and one for the passive, to avoid the system rebooting on passive boot entries and having a safe fallback to the active boot entry. This can be achieved by using and IF stanza when using cloud-init to check for the system state (marked by the files ",(0,o.jsx)(t.code,{children:"/run/cos/active_mode"})," and ",(0,o.jsx)(t.code,{children:"/run/cos/passive_mode"}),") so the service that auto reboots can be started only on the active boot entry."]}),"\n"]}),"\n",(0,o.jsx)(t.p,{children:"The follow up example uses ./cloud-init.md to generate 2 different service overrides during initramfs, one for the active and one for the passive boot entry. Only when selecting the active entry will the service auto restart:"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-yaml",children:"#cloud-config\nname: Enable Boot assessment for <service-name>\nstages:\n  initramfs:\n    - name: Configure service to trigger boot-complete.target on active\n      if: '[ ! -f \"/run/cos/active_mode\" ]'\n      files:\n        - path: /etc/systemd/system/<service-name>.service.d/override.conf\n          permissions: 0644\n          owner: 0\n          group: 0\n          content: |\n            [Unit]\n            # Ensure this unit starts after default system targets\n            After=default.target graphical.target multi-user.target\n            # Ensure this unit completes before boot-complete.target\n            Before=boot-complete.target\n            # If auto reboot on service failure is wanted\n            FailureAction=reboot\n            [Install]\n            # Make this service a hard dependency of boot-complete.target\n            RequiredBy=boot-complete.target\n    - name: Configure service to trigger boot-complete.target on passive\n      if: '[ ! -f \"/run/cos/passive_mode\" ]'\n      files:\n        - path: /etc/systemd/system/<service-name>.service.d/override.conf\n          permissions: 0644\n          owner: 0\n          group: 0\n          content: |\n            [Unit]\n            # Ensure this unit starts after default system targets\n            After=default.target graphical.target multi-user.target\n            # Ensure this unit completes before boot-complete.target\n            Before=boot-complete.target\n            [Install]\n            # Make this service a hard dependency of boot-complete.target\n            RequiredBy=boot-complete.target\n    - name: Enable service\n      systemctl:\n         enabled:\n            - <service-name>\n"})}),"\n",(0,o.jsxs)(t.p,{children:["For more information about cloud-init in Kairos, see the ",(0,o.jsx)(t.a,{href:"./cloud-init",children:"Cloud-Init Architecture"})," guide.\nFor more information about stage modules, see the ",(0,o.jsx)(t.a,{href:"./stage_modules",children:"Stage Modules Reference"}),"."]})]})}function h(e={}){const{wrapper:t}={...(0,i.R)(),...e.components};return t?(0,o.jsx)(t,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}}}]);