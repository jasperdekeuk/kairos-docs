"use strict";(globalThis.webpackChunkkairos_docs=globalThis.webpackChunkkairos_docs||[]).push([[8391],{28453:(e,n,s)=>{s.d(n,{R:()=>r,x:()=>a});var t=s(96540);const i={},o=t.createContext(i);function r(e){const n=t.useContext(o);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),t.createElement(o.Provider,{value:n},e.children)}},60267:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>d,contentTitle:()=>a,default:()=>h,frontMatter:()=>r,metadata:()=>t,toc:()=>l});const t=JSON.parse('{"id":"Advanced/sys-extensions","title":"Extending the system with systemd extensions","description":"This feature is in preview state and only available in Kairos v3.4.x releases and alphas.","source":"@site/versioned_docs/version-3.6.0/Advanced/sys-extensions.md","sourceDirName":"Advanced","slug":"/Advanced/sys-extensions","permalink":"/docs/3.6.0/Advanced/sys-extensions","draft":false,"unlisted":false,"editUrl":"https://github.com/kairos-io/kairos-docs/tree/main/versioned_docs/version-3.6.0/Advanced/sys-extensions.md","tags":[],"version":"3.6.0","lastUpdatedBy":"Jasper De Keukelaere (imec)","lastUpdatedAt":1765142882000,"sidebarPosition":3,"frontMatter":{"title":"Extending the system with systemd extensions","sidebar_label":"Extending the system with systemd extensions","sidebar_position":3},"sidebar":"tutorialSidebar","previous":{"title":"Networking","permalink":"/docs/3.6.0/Advanced/networking"},"next":{"title":"Bundles","permalink":"/docs/3.6.0/Advanced/bundles"}}');var i=s(74848),o=s(28453);const r={title:"Extending the system with systemd extensions",sidebar_label:"Extending the system with systemd extensions",sidebar_position:3},a=void 0,d={},l=[{value:"Introduction",id:"introduction",level:3},{value:"Building system extensions manually",id:"building-system-extensions-manually",level:3},{value:"Building system extensions from a docker image with auroraboot",id:"building-system-extensions-from-a-docker-image-with-auroraboot",level:3},{value:"Verifying the system extensions",id:"verifying-the-system-extensions",level:3},{value:"\ud83d\udcc2 Where Extensions Live",id:"-where-extensions-live",level:2},{value:"\ud83d\udee0\ufe0f CLI Usage",id:"\ufe0f-cli-usage",level:2},{value:"Subcommands",id:"subcommands",level:2},{value:"\ud83d\udce5 <code>download</code>",id:"-download",level:3},{value:"\u2705 <code>enable</code>",id:"-enable",level:3},{value:"\ud83d\udd04 Use <code>--now</code> for Immediate Activation",id:"-use---now-for-immediate-activation",level:4},{value:"\ud83d\udeab <code>disable</code>",id:"-disable",level:3},{value:"\ud83e\uddf9 <code>remove</code>",id:"-remove",level:3},{value:"\ud83d\udccb <code>list</code>",id:"-list",level:3},{value:"\ud83e\uddea Example Workflow",id:"-example-workflow",level:2},{value:"\ud83e\uddfc Designed for Clean State Management",id:"-designed-for-clean-state-management",level:2},{value:"Boot workflow",id:"boot-workflow",level:3},{value:"Known issues",id:"known-issues",level:3}];function c(e){const n={a:"a",admonition:"admonition",blockquote:"blockquote",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",h4:"h4",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,o.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.admonition,{title:"Warning",type:"warning",children:(0,i.jsx)(n.p,{children:'This feature is in preview state and only available in Kairos v3.4.x releases and alphas.\nPlease check the section "Known issues" at the bottom for more information.'})}),"\n",(0,i.jsx)(n.admonition,{title:"Signing keys for system extensions under Trusted Boot",type:"info",children:(0,i.jsx)(n.p,{children:"Sysexts need to be signed with the same key/cert as the ones used to sign the EFI files. As those are part of the system and available in the EFI firmware, we can extract the public part and verify the sysexts locally. Any of the PK, KEK or DB keys can be used to sign sysexts. This only affects Trusted Boot."})}),"\n",(0,i.jsx)(n.h3,{id:"introduction",children:"Introduction"}),"\n",(0,i.jsx)(n.p,{children:"System extensions are a way to extend the system with additional files and directories that are mounted at boot time. System extension images may \u2013 dynamically at runtime \u2014 extend the /usr/ directory hierarchies with additional files. This is particularly useful on immutable system images where a /usr/ hierarchy residing on a read-only file system shall be extended temporarily at runtime without making any persistent modifications.\nOr on a Trusted Boot system where the system is booted from a read-only EFI and cannot be extended easily without breaking the signature."}),"\n",(0,i.jsx)(n.p,{children:"This feature works on both Trusted Boot and normal Kairos installations, the only difference is the signature verification of the system extension images. On Trusted Boot, the system extension images are verified against the public keys stored in the firmware. This is done to ensure that only trusted extensions are loaded into the system."}),"\n",(0,i.jsxs)(n.p,{children:["For more information on system extensions, please refer to the ",(0,i.jsx)(n.a,{href:"https://www.freedesktop.org/software/systemd/man/latest/systemd-sysext.html",children:"System extensions documentation"}),"."]}),"\n",(0,i.jsx)(n.h3,{id:"building-system-extensions-manually",children:"Building system extensions manually"}),"\n",(0,i.jsxs)(n.p,{children:["To build a system extension, you need to create a directory with the files you want to add to the system. Then you can use the ",(0,i.jsx)(n.code,{children:"systemd-repart"})," tool to create a system extension image which is signed and verity protected."]}),"\n",(0,i.jsx)(n.p,{children:"The directory with the sources needs to be structured in a way that the files are placed in the same path as they would be in the final system. For example, this is the dir tree for k3s:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-text",children:".\n\u2514\u2500\u2500 v1.29.2+k3s1\n    \u2514\u2500\u2500 usr\n        \u251c\u2500\u2500 lib\n        \u2502\xa0\xa0 \u2514\u2500\u2500 extension-release.d\n        \u2502\xa0\xa0     \u2514\u2500\u2500 extension-release.k3s-v1.29.2+k3s1\n        \u2514\u2500\u2500 local\n            \u251c\u2500\u2500 bin\n            \u2502\xa0\xa0 \u251c\u2500\u2500 crictl -> ./k3s\n            \u2502\xa0\xa0 \u251c\u2500\u2500 ctr -> ./k3s\n            \u2502\xa0\xa0 \u251c\u2500\u2500 k3s\n            \u2502\xa0\xa0 \u2514\u2500\u2500 kubectl -> ./k3s\n            \u2514\u2500\u2500 lib\n                \u2514\u2500\u2500 systemd\n                    \u2514\u2500\u2500 system\n                        \u251c\u2500\u2500 k3s-agent.service\n                        \u2514\u2500\u2500 k3s.service\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Then you can use the ",(0,i.jsx)(n.code,{children:"systemd-repart"})," tool to create the sysext image:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"$ systemd-repart -S -s SOURCE_DIR NAME.sysext.raw --private-key=PRIVATE_KEY --certificate=CERTIFICATE\n"})}),"\n",(0,i.jsx)(n.admonition,{title:"Warning",type:"warning",children:(0,i.jsxs)(n.p,{children:["Note that the extensions MUST have a ",(0,i.jsx)(n.code,{children:"/usr/lib/extension-release.d/extension-release.NAME"})," file in which the NAME needs to match the sysext NAME (extension is ignored). This is an enforcement by systemd to ensure the sysext is correctly identified and some sanity checks are done with the info in that file."]})}),"\n",(0,i.jsx)(n.p,{children:"This will generate a signed+verity sysextension that can then be used by sysext to extend the system."}),"\n",(0,i.jsxs)(n.p,{children:["Some extension examples are available under ",(0,i.jsx)(n.a,{href:"https://github.com/Itxaka/sysext-examples",children:"https://github.com/Itxaka/sysext-examples"})," for k3s and sbctl."]}),"\n",(0,i.jsx)(n.h3,{id:"building-system-extensions-from-a-docker-image-with-auroraboot",children:"Building system extensions from a docker image with auroraboot"}),"\n",(0,i.jsx)(n.admonition,{title:"Warning",type:"warning",children:(0,i.jsx)(n.p,{children:"This feature is in preview state and only available in Auroraboot from version v0.3.0"})}),"\n",(0,i.jsxs)(n.p,{children:["You can also build a system extension from a docker image directly by using ",(0,i.jsx)(n.a,{href:"https://github.com/kairos-io/AuroraBoot",children:"auroraboot"})," and using a dockerfile to isolate the artifacts you want converted into a system extension."]}),"\n",(0,i.jsx)(n.p,{children:"Notice that when converting a docker image into a system extension, the last layer is the only one converted (The last command in a given Dockerfile) so have that in mind. This is useful for packages that ONLY install things in /usr or manual installation under /usr."}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"/usr/lib/extension-release.d/extension-release.NAME"})," file necessary for identifying the system extension is automatically created by the command so in this case you should not worry about that file."]}),"\n",(0,i.jsx)(n.p,{children:"For example for a given Dockerfiles as such:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-dockerfile",children:"FROM anchore/grype:latest AS grype\n\n\nFROM scratch\nCOPY --from=grype /grype /usr/local/bin/grype\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Only the files added in the last step will be converted to a sysext, so the contents of the sysext would be the ",(0,i.jsx)(n.code,{children:"/usr/local/bin/grype"})," binary only."]}),"\n",(0,i.jsx)(n.p,{children:"Or for a even more manual one:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-dockerfile",children:"FROM alpine:3.19\nRUN apk add curl\nRUN curl -L https://github.com/Foxboron/sbctl/releases/download/0.15.4/sbctl-0.15.4-linux-amd64.tar.gz | tar xvzf - --strip-components=1 -C /usr/local/bin/\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Again, only the files in the last step would be converted into a system extension, so we would get the contents of the extracted tar archive at the ",(0,i.jsx)(n.code,{children:"/usr/local/bin/"})," path."]}),"\n",(0,i.jsxs)(n.p,{children:["After building the chosen Dockerfile, we would just need to run osbuilder with the ",(0,i.jsx)(n.code,{children:"sysext"})," command and the key and certificate, like we would do with ",(0,i.jsx)(n.code,{children:"systemd-repart"}),". Notice that we are binding the local ",(0,i.jsx)(n.code,{children:"keys/"})," dir into the container ",(0,i.jsx)(n.code,{children:"/keys"})," dir for ease of access to the given keys and the current dir under ",(0,i.jsx)(n.code,{children:"/build"})," on the container so we set the ",(0,i.jsx)(n.code,{children:"--output=/build"})," flag when calling auroraboot:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'$ docker run \\\n-v "$PWD"/keys:/keys \\\n-v "$PWD":/build/ \\\n-v /var/run/docker.sock:/var/run/docker.sock \\\n--rm \\\nquay.io/kairos/auroraboot:latest sysext --private-key=/keys/PRIVATE_KEY --certificate=/keys/CERTIFICATE --output=/build NAME CONTAINER_IMAGE\n'})}),"\n",(0,i.jsx)(n.p,{children:"The explanation of the docker command flags is as follows:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:'-v "$PWD"/keys:/keys'}),": We mount the current dir + keys dir into the container ",(0,i.jsx)(n.code,{children:"/keys"})," path. So auroraboot has access to the keys to sign the sysext."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:'-v "$PWD":/build/'}),": Mount the current dir into the container ",(0,i.jsx)(n.code,{children:"/build"})," path. So the generated sysext is available after the container is gone."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"-v /var/run/docker.sock:/var/run/docker.sock"}),": We pass the docker sock into the container so it can access our locally built container images. So we avoid pushing them and pulling them from a remote registry."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"--rm"}),": Once the container exit, remove it so we dont leave stuff lying around."]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"The explanation of the auroraboot command flags is as follows:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"sysext"}),": Subcommand to call, in this case we want to build a sysext"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"--private-key"}),": Private key to sign the system extension."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"--certificate"}),": Certificate to sign the system extension."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"--output"}),": Dir where we will output the system extension. Make sure that this matches the directory that passed to the docker command to be able to keep the generated system extension once the container exists and its removed."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"NAME"}),": Output and internal name of the sysext."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"CONTAINER_IMAGE"}),": Image from which we will extract the last layer and covert it to a system extension."]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Example of a successful run:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'$ docker run -v "$PWD":/build/ -v /tmp/keys/:/keys -v /var/run/docker.sock:/var/run/docker.sock --rm -ti quay.io/kairos/auroraboot:latest sysext --private-key=/keys/db.key --certificate=/keys/db.pem --output /build grype sysext\n2024-09-16T14:59:36Z INF Starting auroraboot version\n2024-09-16T14:59:36Z INF \ud83d\ude80 Start sysext creation\n2024-09-16T14:59:36Z INF \ud83d\udcbf Getting image info\n2024-09-16T14:59:36Z INF \ud83d\udce4 Extracting archives from image layer\n2024-09-16T14:59:37Z INF \ud83d\udce6 Packing sysext into raw image\n2024-09-16T14:59:37Z INF \ud83c\udf89 Done sysext creation output=/build/grype.sysext.raw\n$ ls -ltra *.raw\n-rw-r--r-- 1 root root 64729088 sep 16 17:24 grype.sysext.raw\n'})}),"\n",(0,i.jsx)(n.h3,{id:"verifying-the-system-extensions",children:"Verifying the system extensions"}),"\n",(0,i.jsxs)(n.p,{children:["You can use ",(0,i.jsx)(n.code,{children:"systemd-dissect"})," to verify the system extension, the ID, ARCHITECTURE and the partitions that are included in the system extension."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"$ sudo systemd-dissect sbctl-0.14.sysext.raw\n      Name: sbctl-0.14.sysext.raw\n      Size: 21.0M\n Sec. Size: 512\n     Arch.: x86-64\n\nImage UUID: 351f0e17-35e5-42ff-bf09-8db65c756f7b\n sysext R.: ID=_any\n            ARCHITECTURE=x86-64\n\n    Use As: \u2717 bootable system for UEFI\n            \u2717 bootable system for container\n            \u2717 portable service\n            \u2717 initrd\n            \u2713 sysext for system\n            \u2713 sysext for portable service\n            \u2717 sysext for initrd\n            \u2717 confext for system\n            \u2717 confext for portable service\n            \u2717 confext for initrd\n\nRW DESIGNATOR      PARTITION UUID                       PARTITION LABEL        FSTYPE                AR>\nro root            4afae1e5-c73c-2f5a-acdc-3655ed91d4e0 root-x86-64            erofs                 x8>\nro root-verity     abea5f2f-214d-4d9f-83f8-ee69ca7614ba root-x86-64-verity     DM_verity_hash        x8>\nro root-verity-sig bdb3ee65-ed86-480c-a750-93015254f1a7 root-x86-64-verity-sig verity_hash_signature x8>\n"})}),"\n",(0,i.jsx)(n.h1,{id:"managing-system-extensions-in-kairos",children:"Managing System Extensions in Kairos"}),"\n",(0,i.jsx)(n.h2,{id:"-where-extensions-live",children:"\ud83d\udcc2 Where Extensions Live"}),"\n",(0,i.jsx)(n.p,{children:"All system extensions are stored in:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"/var/lib/kairos/extensions/\n"})}),"\n",(0,i.jsx)(n.p,{children:"From there, they\u2019re symlinked into directories based on the system\u2019s boot profile:"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Directory"}),(0,i.jsx)(n.th,{children:"Behavior"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"active/"})}),(0,i.jsxs)(n.td,{children:["Loaded when booting into the ",(0,i.jsx)(n.em,{children:"active"})," profile"]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"passive/"})}),(0,i.jsxs)(n.td,{children:["Loaded during ",(0,i.jsx)(n.em,{children:"passive"})," boot"]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"recovery/"})}),(0,i.jsxs)(n.td,{children:["Loaded in ",(0,i.jsx)(n.em,{children:"recovery mode"})]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"common/"})}),(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.strong,{children:"Always loaded"}),", regardless of boot mode"]})]})]})]}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsxs)(n.p,{children:["\ud83d\udca1 These directories contain only ",(0,i.jsx)(n.strong,{children:"symlinks"}),"\u2014the actual disk image is stored once. This ensures there\u2019s no duplication or leftover state between boots."]}),"\n"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"\ufe0f-cli-usage",children:"\ud83d\udee0\ufe0f CLI Usage"}),"\n",(0,i.jsxs)(n.p,{children:["Manage extensions using ",(0,i.jsx)(n.code,{children:"kairos-agent sysext"})," commands."]}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsxs)(n.p,{children:["\ud83d\udcdd ",(0,i.jsx)(n.strong,{children:"Tip:"})," For enable, disable and remove commands, the extension name supports ",(0,i.jsx)(n.strong,{children:"regex matching"}),". You don\u2019t need to type the full filename.\nFor example, to match ",(0,i.jsx)(n.code,{children:"k3sv1.32.1.k3s0.sysext.raw"}),", you can simply use ",(0,i.jsx)(n.code,{children:"k3s"}),"."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"subcommands",children:"Subcommands"}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsxs)(n.h3,{id:"-download",children:["\ud83d\udce5 ",(0,i.jsx)(n.code,{children:"download"})]}),"\n",(0,i.jsx)(n.p,{children:"Downloads a system extension and stores it on the node."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"kairos-agent sysext download <URI>\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Supported URI formats:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"https://"})," \u2013 Download a raw disk image from a remote server"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"http://"})," \u2013 Same as above, unencrypted"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"file://"})," \u2013 Load a local disk image file"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"oci://"})," \u2013 Download from an OCI-compatible container registry"]}),"\n"]}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsxs)(n.p,{children:["\u26a0\ufe0f ",(0,i.jsx)(n.strong,{children:"Important Notes:"})]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"http(s)"})," and ",(0,i.jsx)(n.code,{children:"file://"})," URIs must point directly to a raw disk image file."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"oci://"})," support is ",(0,i.jsx)(n.strong,{children:"alpha-stage"})," and may change."]}),"\n",(0,i.jsxs)(n.li,{children:["When using ",(0,i.jsx)(n.code,{children:"oci://"}),", the disk image must be ",(0,i.jsx)(n.strong,{children:"embedded inside the OCI image layer"}),"."]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsxs)(n.h3,{id:"-enable",children:["\u2705 ",(0,i.jsx)(n.code,{children:"enable"})]}),"\n",(0,i.jsx)(n.p,{children:"Enable an extension for a specific boot profile:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"kairos-agent sysext enable --active my-extension\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Supported profile flags:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"--active"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"--passive"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"--recovery"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"--common"})}),"\n"]}),"\n",(0,i.jsxs)(n.h4,{id:"-use---now-for-immediate-activation",children:["\ud83d\udd04 Use ",(0,i.jsx)(n.code,{children:"--now"})," for Immediate Activation"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"kairos-agent sysext enable --active --now my-extension\n"})}),"\n",(0,i.jsx)(n.p,{children:"If the current boot mode matches, this also:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Creates a link in ",(0,i.jsx)(n.code,{children:"/run/extensions/"})]}),"\n",(0,i.jsxs)(n.li,{children:["Reloads ",(0,i.jsx)(n.code,{children:"systemd-sysext"})," so the extension is active ",(0,i.jsx)(n.em,{children:"immediately"})]}),"\n"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsxs)(n.h3,{id:"-disable",children:["\ud83d\udeab ",(0,i.jsx)(n.code,{children:"disable"})]}),"\n",(0,i.jsx)(n.p,{children:"Remove the symlink from the specified profile:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"kairos-agent sysext disable --common my-extension\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Add ",(0,i.jsx)(n.code,{children:"--now"})," to also unload the extension if it's currently live:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"kairos-agent sysext disable --common --now my-extension\n"})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsxs)(n.h3,{id:"-remove",children:["\ud83e\uddf9 ",(0,i.jsx)(n.code,{children:"remove"})]}),"\n",(0,i.jsxs)(n.p,{children:["Deletes the extension completely\u2014including ",(0,i.jsx)(n.strong,{children:"all symlinks"})," from any profile."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"kairos-agent sysext remove my-extension\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Use ",(0,i.jsx)(n.code,{children:"--now"})," to deactivate it immediately as well:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"kairos-agent sysext remove --now my-extension\n"})}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsxs)(n.p,{children:["\u26a0\ufe0f This is a ",(0,i.jsx)(n.strong,{children:"permanent wipe"}),". The extension will no longer be available for any boot profile."]}),"\n"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsxs)(n.h3,{id:"-list",children:["\ud83d\udccb ",(0,i.jsx)(n.code,{children:"list"})]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Without flags: lists all installed extensions"}),"\n",(0,i.jsx)(n.li,{children:"With a profile flag: lists extensions enabled for that boot profile"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"kairos-agent sysext list\nkairos-agent sysext list --recovery\n"})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"-example-workflow",children:"\ud83e\uddea Example Workflow"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"# Download a disk image over HTTPS\nkairos-agent sysext download https://example.org/extensions/k3sv1.32.1.raw\n\n# Enable for the active profile and activate it live\nkairos-agent sysext enable --active --now k3s\n\n# See what\u2019s currently enabled for active\nkairos-agent sysext list --active\n\n# Fully remove it and clean up live state\nkairos-agent sysext remove --now k3s\n"})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"-designed-for-clean-state-management",children:"\ud83e\uddfc Designed for Clean State Management"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"No duplication: all symlinks point to a single image"}),"\n",(0,i.jsx)(n.li,{children:"Reversible: simply unlink or remove to disable"}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"--now"})," lets you test and roll out changes live"]}),"\n",(0,i.jsxs)(n.li,{children:["All state reset at boot via ephemeral ",(0,i.jsx)(n.code,{children:"/run/extensions"})]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"boot-workflow",children:"Boot workflow"}),"\n",(0,i.jsx)(n.p,{children:"During boot, Immucore will identify under which boot state is running (active, passive, recovery) and will link the found extensions to the /run/extensions dir during initramfs. Then it will enable the systemd-sysext service so they are loaded correctly."}),"\n",(0,i.jsx)(n.p,{children:"Under Trusted Boot, the extensions signature will be verified and if they dont match they will be ignored and a warning emitted under the logs at /run/immucore/."}),"\n",(0,i.jsx)(n.h3,{id:"known-issues",children:"Known issues"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Sysext images need to be named with the extension ",(0,i.jsx)(n.code,{children:".sysext.raw"})," to be identified correctly. This is a design choice to avoid conflicts with other files that could be present in the EFI partition and we don't expect this to change in the future."]}),"\n",(0,i.jsxs)(n.li,{children:["Any folder that is mounted as a system extension will be mounted as read-only. So if your sysext is mounting ",(0,i.jsx)(n.code,{children:"/usr/local/bin"})," to add binaries, it will be mounted as read-only. Other sysexts can be added and they will be merged correctly, but the final dir will be read-only. This is a limitation of the current systemd version (lower than 256) and will be addressed in future releases."]}),"\n",(0,i.jsxs)(n.li,{children:["Only ",(0,i.jsx)(n.code,{children:"/usr"})," can be extended. This is a design choice and might change in the future to allow other directories to be extended."]}),"\n",(0,i.jsxs)(n.li,{children:["System extensions provided binaries are only available after the ",(0,i.jsx)(n.code,{children:"initramfs"})," stage."]}),"\n",(0,i.jsx)(n.li,{children:"Currently only signed+verity sysexts are supported under Trusted Boot (UKI). For non-uki Kairos, the signature is not enforced yet."}),"\n",(0,i.jsx)(n.li,{children:"Sysexts need to be signed with the same key/cert as the ones used to sign the EFI files. As those are part of the system and available in the EFI firmware, we can extract the public part and verify the sysexts locally. Any of the PK, KEK or DB keys can be used to sign sysexts. This is planned to be expanded in the future to allow signing them with a different key/cert and provide the public keys as part of the install configuration so they can be verified."}),"\n",(0,i.jsx)(n.li,{children:"Sysexts are mounted by the name order by trying to parse the name as a version and comparing it to others. This is done directly by systemd so be aware of the naming of your extensions and try to keep them in a versioned format. And example from systemd source code is provided as a guide:"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-text",children:"*  (older) 122.1\n         *     ^    123~rc1-1\n         *     |    123\n         *     |    123-a\n         *     |    123-a.1\n         *     |    123-1\n         *     |    123-1.1\n         *     |    123^post1\n         *     |    123.a-1\n         *     |    123.1-1\n         *     v    123a-1\n         *  (newer) 124-1\n"})})]})}function h(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}}}]);