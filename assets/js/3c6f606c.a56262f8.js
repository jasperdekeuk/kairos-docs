"use strict";(globalThis.webpackChunkkairos_docs=globalThis.webpackChunkkairos_docs||[]).push([[2554],{4347:(e,i,n)=>{n.r(i),n.d(i,{assets:()=>l,contentTitle:()=>r,default:()=>u,frontMatter:()=>a,metadata:()=>o,toc:()=>d});const o=JSON.parse('{"id":"Reference/build_raw_images_with_qemu","title":"Build Raw images with QEMU","description":"This article shows how to bring your own image with Kairos, and build a Kairos derivative from scratch using base container images from popular distributions such as Ubuntu, Fedora, openSUSE, etc.","source":"@site/versioned_docs/version-3.6.0/Reference/build_raw_images_with_qemu.md","sourceDirName":"Reference","slug":"/Reference/build_raw_images_with_qemu","permalink":"/docs/3.6.0/Reference/build_raw_images_with_qemu","draft":false,"unlisted":false,"editUrl":"https://github.com/kairos-io/kairos-docs/tree/main/versioned_docs/version-3.6.0/Reference/build_raw_images_with_qemu.md","tags":[],"version":"3.6.0","lastUpdatedBy":"Jasper De Keukelaere (imec)","lastUpdatedAt":1765142882000,"sidebarPosition":5,"frontMatter":{"title":"Build Raw images with QEMU","sidebar_label":"Build Raw images with QEMU","sidebar_position":5,"description":"This article shows how to bring your own image with Kairos, and build a Kairos derivative from scratch using base container images from popular distributions such as Ubuntu, Fedora, openSUSE, etc."},"sidebar":"tutorialSidebar","previous":{"title":"Build Kairos from scratch","permalink":"/docs/3.6.0/Reference/build-from-scratch"},"next":{"title":"Image support matrix","permalink":"/docs/3.6.0/Reference/image_matrix"}}');var t=n(74848),s=n(28453);const a={title:"Build Raw images with QEMU",sidebar_label:"Build Raw images with QEMU",sidebar_position:5,description:"This article shows how to bring your own image with Kairos, and build a Kairos derivative from scratch using base container images from popular distributions such as Ubuntu, Fedora, openSUSE, etc."},r=void 0,l={},d=[{value:"Requirements",id:"requirements",level:2},{value:"Default Cloud Configuration",id:"default-cloud-configuration",level:2},{value:"Script to Build Raw Images",id:"script-to-build-raw-images",level:2},{value:"Script Breakdown",id:"script-breakdown",level:3},{value:"Customizing the Cloud Configuration and Building the Image",id:"customizing-the-cloud-configuration-and-building-the-image",level:2}];function c(e){const i={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(i.p,{children:"This page provides a reference guide on how to build raw images for Kairos using QEMU. It covers the process of using a default cloud configuration and a script to generate bootable images. The cloud configuration can be customized to suit different use cases. This mechanism can be used to create golden images, or simply be an alternative to use tools like Packer."}),"\n",(0,t.jsx)(i.admonition,{title:"Note",type:"note",children:(0,t.jsxs)(i.p,{children:["This method differs from the ones documented in the ",(0,t.jsx)(i.a,{href:"./auroraboot",children:"Auroraboot"})," section: this method is suitable if you need to create appliances that have to run a full-installation. AuroraBoot will create instead images pre-installed which will skip the usual Kairos installation process in runtime"]})}),"\n",(0,t.jsxs)(i.p,{children:["For more information about AuroraBoot, see the ",(0,t.jsx)(i.a,{href:"./auroraboot",children:"AuroraBoot Reference"}),"."]}),"\n",(0,t.jsx)(i.h2,{id:"requirements",children:"Requirements"}),"\n",(0,t.jsx)(i.p,{children:"The following tools are required in the system:"}),"\n",(0,t.jsxs)(i.ul,{children:["\n",(0,t.jsx)(i.li,{children:(0,t.jsx)(i.code,{children:"qemu"})}),"\n",(0,t.jsx)(i.li,{children:"A Kairos ISO (or a custom built one)"}),"\n"]}),"\n",(0,t.jsx)(i.h2,{id:"default-cloud-configuration",children:"Default Cloud Configuration"}),"\n",(0,t.jsxs)(i.p,{children:["The following is the default ",(0,t.jsx)(i.code,{children:"cloud-config"})," file used for Kairos. You can modify this file as needed to fit your environment:"]}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{className:"language-yaml",children:'#cloud-config\n\nhostname: kairos-{{ trunc 4 .MachineID }}\n\n# Automated install block\ninstall:\n  # Device for automated installs\n  device: "auto"\n  # Reboot after installation\n  reboot: false\n  # Power off after installation\n  poweroff: true\n  # Set to true to enable automated installations\n  auto: true\n\n## Login\nusers:\n- name: "kairos"\n  passwd: kairos\n  groups:\n  - admin\n  #lock_passwd: true\n  #ssh_authorized_keys:\n  #- github:mudler\n\nstages:\n  boot:\n  - name: "Repart image"\n    layout:\n      device:\n        label: COS_PERSISTENT\n      expand_partition:\n        size: 0 # all space\n    commands:\n      # grow filesystem if not used 100%\n      - |\n         [[ "$(echo "$(df -h | grep COS_PERSISTENT)" | awk \'{print $5}\' | tr -d \'%\')" -ne 100 ]] && resize2fs /dev/disk/by-label/COS_PERSISTENT\n'})}),"\n",(0,t.jsx)(i.admonition,{title:"Note",type:"note",children:(0,t.jsxs)(i.p,{children:[(0,t.jsx)(i.code,{children:"install.poweroff"})," is set to ",(0,t.jsx)(i.code,{children:"true"})," to power off the machine after installation and ",(0,t.jsx)(i.code,{children:"install.auto"})," is set to ",(0,t.jsx)(i.code,{children:"true"})," to enable automated installations. Both of these settings are ",(0,t.jsx)(i.strong,{children:"needed"})," to function properly."]})}),"\n",(0,t.jsx)(i.h2,{id:"script-to-build-raw-images",children:"Script to Build Raw Images"}),"\n",(0,t.jsx)(i.p,{children:"Use the following Bash script to generate raw bootable images using QEMU. This script takes a cloud-init YAML file as an argument and creates a raw disk image for Kairos."}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{className:"language-bash",children:'#!/bin/bash\n# Generates raw bootable images with qemu\nset -ex\nCLOUD_INIT=${1:-cloud_init.yaml}\nQEMU=${QEMU:-qemu-system-x86_64}\nISO=${2:-iso.iso}\n\nmkdir -p build\npushd build\ntouch meta-data\ncp -rfv $CLOUD_INIT user-data\n\nmkisofs -output ci.iso -volid cidata -joliet -rock user-data meta-data\ntruncate -s "+$((20000*1024*1024))" disk.raw\n\n${QEMU} -m 8096 -smp cores=2 \\\n        -nographic -cpu host \\\n        -serial mon:stdio \\\n        -rtc base=utc,clock=rt \\\n        -chardev socket,path=qga.sock,server,nowait,id=qga0 \\\n        -device virtio-serial \\\n        -device virtserialport,chardev=qga0,name=org.qemu.guest_agent.0 \\\n        -drive if=virtio,media=disk,file=disk.raw \\\n        -drive format=raw,media=cdrom,readonly=on,file=$ISO \\\n        -drive format=raw,media=cdrom,readonly=on,file=ci.iso \\\n        -boot d \\\n        -enable-kvm\n'})}),"\n",(0,t.jsx)(i.h3,{id:"script-breakdown",children:"Script Breakdown"}),"\n",(0,t.jsxs)(i.ol,{children:["\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.strong,{children:"Cloud-init Setup"}),": Copies the cloud-init configuration to the build directory."]}),"\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.strong,{children:"Metadata"}),": Creates an empty ",(0,t.jsx)(i.code,{children:"meta-data"})," file as required by cloud-init."]}),"\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.strong,{children:"ISO Creation"}),": Creates a cloud-init ISO image (",(0,t.jsx)(i.code,{children:"ci.iso"}),") with ",(0,t.jsx)(i.code,{children:"mkisofs"}),"."]}),"\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.strong,{children:"Disk Image"}),": Generates a raw disk image (",(0,t.jsx)(i.code,{children:"disk.raw"}),") with a size of 20 GB."]}),"\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.strong,{children:"QEMU Command"}),": Uses QEMU to boot the Kairos installer with:","\n",(0,t.jsxs)(i.ul,{children:["\n",(0,t.jsxs)(i.li,{children:["8 GB memory (",(0,t.jsx)(i.code,{children:"-m 8096"}),")"]}),"\n",(0,t.jsxs)(i.li,{children:["2 CPU cores (",(0,t.jsx)(i.code,{children:"-smp cores=2"}),")"]}),"\n",(0,t.jsxs)(i.li,{children:["KVM acceleration (",(0,t.jsx)(i.code,{children:"-enable-kvm"}),")"]}),"\n",(0,t.jsx)(i.li,{children:"Attaching the raw disk and ISO images as drives."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(i.h2,{id:"customizing-the-cloud-configuration-and-building-the-image",children:"Customizing the Cloud Configuration and Building the Image"}),"\n",(0,t.jsx)(i.p,{children:"To customize your installation:"}),"\n",(0,t.jsxs)(i.ol,{children:["\n",(0,t.jsxs)(i.li,{children:["Modify the ",(0,t.jsx)(i.code,{children:"cloud-config"})," YAML as needed."]}),"\n",(0,t.jsx)(i.li,{children:"Pass the modified configuration as an argument to the script (optionally, pass the Kairos ISO as the second argument):"}),"\n"]}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{className:"language-bash",children:"./build_image.sh my_custom_cloud_config.yaml\n"})}),"\n",(0,t.jsx)(i.p,{children:"This script will generate a raw disk image with the specified cloud configuration."})]})}function u(e={}){const{wrapper:i}={...(0,s.R)(),...e.components};return i?(0,t.jsx)(i,{...e,children:(0,t.jsx)(c,{...e})}):c(e)}},28453:(e,i,n)=>{n.d(i,{R:()=>a,x:()=>r});var o=n(96540);const t={},s=o.createContext(t);function a(e){const i=o.useContext(s);return o.useMemo(function(){return"function"==typeof e?e(i):{...i,...e}},[i,e])}function r(e){let i;return i=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:a(e.components),o.createElement(s.Provider,{value:i},e.children)}}}]);