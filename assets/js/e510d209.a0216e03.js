"use strict";(globalThis.webpackChunkkairos_docs=globalThis.webpackChunkkairos_docs||[]).push([[3293],{11470:(e,t,n)=>{n.d(t,{A:()=>k});var a=n(96540),o=n(34164),i=n(17559),r=n(23104),s=n(56347),l=n(205),c=n(57485),u=n(31682),d=n(70679);function h(e){return a.Children.toArray(e).filter(e=>"\n"!==e).map(e=>{if(!e||(0,a.isValidElement)(e)&&function(e){const{props:t}=e;return!!t&&"object"==typeof t&&"value"in t}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)})?.filter(Boolean)??[]}function m(e){const{values:t,children:n}=e;return(0,a.useMemo)(()=>{const e=t??function(e){return h(e).map(({props:{value:e,label:t,attributes:n,default:a}})=>({value:e,label:t,attributes:n,default:a}))}(n);return function(e){const t=(0,u.XI)(e,(e,t)=>e.value===t.value);if(t.length>0)throw new Error(`Docusaurus error: Duplicate values "${t.map(e=>e.value).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e},[t,n])}function p({value:e,tabValues:t}){return t.some(t=>t.value===e)}function f({queryString:e=!1,groupId:t}){const n=(0,s.W6)(),o=function({queryString:e=!1,groupId:t}){if("string"==typeof e)return e;if(!1===e)return null;if(!0===e&&!t)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return t??null}({queryString:e,groupId:t});return[(0,c.aZ)(o),(0,a.useCallback)(e=>{if(!o)return;const t=new URLSearchParams(n.location.search);t.set(o,e),n.replace({...n.location,search:t.toString()})},[o,n])]}function b(e){const{defaultValue:t,queryString:n=!1,groupId:o}=e,i=m(e),[r,s]=(0,a.useState)(()=>function({defaultValue:e,tabValues:t}){if(0===t.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(e){if(!p({value:e,tabValues:t}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${e}" but none of its children has the corresponding value. Available values are: ${t.map(e=>e.value).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return e}const n=t.find(e=>e.default)??t[0];if(!n)throw new Error("Unexpected error: 0 tabValues");return n.value}({defaultValue:t,tabValues:i})),[c,u]=f({queryString:n,groupId:o}),[h,b]=function({groupId:e}){const t=function(e){return e?`docusaurus.tab.${e}`:null}(e),[n,o]=(0,d.Dv)(t);return[n,(0,a.useCallback)(e=>{t&&o.set(e)},[t,o])]}({groupId:o}),g=(()=>{const e=c??h;return p({value:e,tabValues:i})?e:null})();(0,l.A)(()=>{g&&s(g)},[g]);return{selectedValue:r,selectValue:(0,a.useCallback)(e=>{if(!p({value:e,tabValues:i}))throw new Error(`Can't select invalid tab value=${e}`);s(e),u(e),b(e)},[u,b,i]),tabValues:i}}var g=n(92303);const x={tabList:"tabList__CuJ",tabItem:"tabItem_LNqP"};var y=n(74848);function v({className:e,block:t,selectedValue:n,selectValue:a,tabValues:i}){const s=[],{blockElementScrollPositionUntilNextRender:l}=(0,r.a_)(),c=e=>{const t=e.currentTarget,o=s.indexOf(t),r=i[o].value;r!==n&&(l(t),a(r))},u=e=>{let t=null;switch(e.key){case"Enter":c(e);break;case"ArrowRight":{const n=s.indexOf(e.currentTarget)+1;t=s[n]??s[0];break}case"ArrowLeft":{const n=s.indexOf(e.currentTarget)-1;t=s[n]??s[s.length-1];break}}t?.focus()};return(0,y.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,o.A)("tabs",{"tabs--block":t},e),children:i.map(({value:e,label:t,attributes:a})=>(0,y.jsx)("li",{role:"tab",tabIndex:n===e?0:-1,"aria-selected":n===e,ref:e=>{s.push(e)},onKeyDown:u,onClick:c,...a,className:(0,o.A)("tabs__item",x.tabItem,a?.className,{"tabs__item--active":n===e}),children:t??e},e))})}function w({lazy:e,children:t,selectedValue:n}){const i=(Array.isArray(t)?t:[t]).filter(Boolean);if(e){const e=i.find(e=>e.props.value===n);return e?(0,a.cloneElement)(e,{className:(0,o.A)("margin-top--md",e.props.className)}):null}return(0,y.jsx)("div",{className:"margin-top--md",children:i.map((e,t)=>(0,a.cloneElement)(e,{key:t,hidden:e.props.value!==n}))})}function j(e){const t=b(e);return(0,y.jsxs)("div",{className:(0,o.A)(i.G.tabs.container,"tabs-container",x.tabList),children:[(0,y.jsx)(v,{...t,...e}),(0,y.jsx)(w,{...t,...e})]})}function k(e){const t=(0,g.A)();return(0,y.jsx)(j,{...e,children:h(e.children)},String(t))}},19365:(e,t,n)=>{n.d(t,{A:()=>r});n(96540);var a=n(34164);const o={tabItem:"tabItem_Ymn6"};var i=n(74848);function r({children:e,hidden:t,className:n}){return(0,i.jsx)("div",{role:"tabpanel",className:(0,a.A)(o.tabItem,n),hidden:t,children:e})}},28453:(e,t,n)=>{n.d(t,{R:()=>r,x:()=>s});var a=n(96540);const o={},i=a.createContext(o);function r(e){const t=a.useContext(i);return a.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function s(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:r(e.components),a.createElement(i.Provider,{value:t},e.children)}},96907:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>u,contentTitle:()=>c,default:()=>m,frontMatter:()=>l,metadata:()=>a,toc:()=>d});const a=JSON.parse('{"id":"Installation/automated","title":"Automated","description":"Install Kairos automatically, with zero touch provisioning","source":"@site/docs/Installation/automated.md","sourceDirName":"Installation","slug":"/Installation/automated","permalink":"/docs/next/Installation/automated","draft":false,"unlisted":false,"editUrl":"https://github.com/kairos-io/kairos-docs/tree/main/docs/Installation/automated.md","tags":[],"version":"current","lastUpdatedBy":"Jasper De Keukelaere (imec)","lastUpdatedAt":1765043763000,"sidebarPosition":3,"frontMatter":{"title":"Automated","sidebar_label":"Automated","sidebar_position":3,"date":"2022-11-13T00:00:00.000Z","description":"Install Kairos automatically, with zero touch provisioning"},"sidebar":"tutorialSidebar","previous":{"title":"WebUI","permalink":"/docs/next/Installation/webui"},"next":{"title":"Bare-Metal","permalink":"/docs/next/Installation/bare-metal"}}');var o=n(74848),i=n(28453),r=n(11470),s=n(19365);const l={title:"Automated",sidebar_label:"Automated",sidebar_position:3,date:new Date("2022-11-13T00:00:00.000Z"),description:"Install Kairos automatically, with zero touch provisioning"},c=void 0,u={},d=[{value:"Data source",id:"data-source",level:2},{value:"Via config URL",id:"via-config-url",level:2},{value:"ISO remastering",id:"iso-remastering",level:2},{value:"Locally",id:"locally",level:3},{value:"Kubernetes",id:"kubernetes",level:3}];function h(e){const t={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",...(0,i.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(t.p,{children:"To automate Kairos installation, you can configure a specific portion of the installation configuration file. The configuration file can then be supplied in a few different ways, such as creating an additional ISO to mount, specifying a URL, or even creating an ISO from a container image with an embedded configuration file."}),"\n",(0,o.jsx)(t.p,{children:"Here's an example of how you might customize the install block:"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-yaml",children:'install:\n  # Device for automated installs\n  device: "/dev/sda"\n  # Reboot after installation\n  reboot: true\n  # Power off after installation\n  poweroff: true\n  # Set to true to enable automated installations\n  auto: true\n  # A list of bundles\n  bundles:\n    -  quay.io/kairos/packages:k9s-utils-0.26.7\n'})}),"\n",(0,o.jsx)(t.p,{children:"This block allows you to specify the device on which to install Kairos, whether to reboot or power off after installation, and which bundles to include."}),"\n",(0,o.jsx)(t.h2,{id:"data-source",children:"Data source"}),"\n",(0,o.jsx)(t.p,{children:"To supply your Kairos configuration file, you can create an ISO that contains both a user-data file (which contains your configuration) and a meta-data file."}),"\n",(0,o.jsxs)(t.p,{children:["Here's an example ",(0,o.jsx)(t.code,{children:"user-data"})," configuration that is set up to automatically install Kairos onto /dev/sda and reboot after installation:"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-yaml",children:'#cloud-config\n\ninstall:\n  device: "/dev/sda"\n  reboot: true\n  poweroff: false\n  auto: true # Required, for automated installations\n\nkairos:\n  network_token: ....\n# extra configuration\n'})}),"\n",(0,o.jsxs)(t.p,{children:["The token ",(0,o.jsx)(t.code,{children:"p2p.network_token"})," is a base64 encoded string which\ncontains an ",(0,o.jsxs)(t.a,{href:"https://github.com/mudler/edgevpn/blob/master/docs/content/en/docs/Concepts/Token/_index",children:[(0,o.jsx)(t.code,{children:"edgevpn"})," token"]}),". For more information, ",(0,o.jsx)(t.a,{href:"../../architecture/network",children:"check out the architecture section"}),"."]}),"\n",(0,o.jsxs)(t.p,{children:["Save this file as ",(0,o.jsx)(t.code,{children:"cloud_init.yaml"}),", then create an ISO with the following steps:"]}),"\n",(0,o.jsxs)(t.ol,{children:["\n",(0,o.jsx)(t.li,{children:"Create a new directory and navigate to it:"}),"\n"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:"$ mkdir -p build\n$ cd build\n"})}),"\n",(0,o.jsxs)(t.ol,{children:["\n",(0,o.jsxs)(t.li,{children:["Create empty ",(0,o.jsx)(t.code,{children:"meta-data"})," and copy your config as ",(0,o.jsx)(t.code,{children:"user-data"}),":"]}),"\n"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:"$ touch meta-data\n$ cp -rfv cloud_init.yaml user-data\n"})}),"\n",(0,o.jsxs)(t.ol,{children:["\n",(0,o.jsxs)(t.li,{children:["Use ",(0,o.jsx)(t.code,{children:"mkisofs"})," to create the ISO file:"]}),"\n"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:"$ mkisofs -output ci.iso -volid cidata -joliet -rock user-data meta-data\n"})}),"\n",(0,o.jsx)(t.p,{children:"Once the ISO is created, you can attach it to your machine and boot up as usual, along with the Kairos ISO."}),"\n",(0,o.jsxs)(t.admonition,{title:"Warning",type:"warning",children:[(0,o.jsxs)(t.p,{children:["For security reasons, when Kairos is installed in ",(0,o.jsx)(t.a,{href:"../../Installation/trustedboot",children:"trusted boot mode"}),", datasources are not parsed after installation. This prevents someone from plugging a usb stick on an edge device, applying arbitrary configuration to the system post-installation. To force parsing of the datasources after installation, you can set add the ",(0,o.jsx)(t.code,{children:"kairos.pull_datasources"})," option to the cmdline. This requires extending the cmdline when building the installation medium with AuroraBoot (",(0,o.jsx)(t.a,{href:"../../Installation/trustedboot#additional-efi-entries",children:"read more"}),")."]}),(0,o.jsx)(t.p,{children:'This security feature is only enabled when the system boots in trusted boot mode and only after installation (they are parsed in "live" mode). On "plain" boot mode, datasources are always parsed.'})]}),"\n",(0,o.jsx)(t.h2,{id:"via-config-url",children:"Via config URL"}),"\n",(0,o.jsxs)(t.p,{children:["Another way to supply your Kairos configuration file is to specify a URL as a boot argument during startup. To do this, add ",(0,o.jsx)(t.code,{children:"config_url=<URL>"})," as a boot argument. This will allow the machine to download your configuration from the specified URL and perform the installation using the provided settings."]}),"\n",(0,o.jsxs)(t.p,{children:["After installation, the configuration will be available on the system at ",(0,o.jsx)(t.code,{children:"/oem/90_custom.yaml"}),"."]}),"\n",(0,o.jsx)(t.p,{children:"If you're not sure where to host your configuration file, a common option is to upload it as a GitHub gist."}),"\n",(0,o.jsx)(t.h2,{id:"iso-remastering",children:"ISO remastering"}),"\n",(0,o.jsxs)(t.p,{children:["It is possible to create custom ISOs with an embedded cloud configuration. This allows the machine to automatically boot with a pre-specified configuration file, which will be installed on the system after provisioning is complete. See also ",(0,o.jsx)(t.a,{href:"../../reference/auroraboot",children:"AuroraBoot"})," for documentation."]}),"\n",(0,o.jsx)(t.h3,{id:"locally",children:"Locally"}),"\n",(0,o.jsx)(t.p,{children:"To create a custom ISO, you will need Docker installed on your machine."}),"\n",(0,o.jsx)(t.p,{children:"Here's an example of how you might do this:"}),"\n",(0,o.jsxs)(t.admonition,{title:"Warning",type:"warning",children:[(0,o.jsxs)(t.p,{children:["The image passed to the auroraboot image, needs to have one of the accepted schemes: ",(0,o.jsx)(t.code,{children:"docker"}),", ",(0,o.jsx)(t.code,{children:"oci"}),", ",(0,o.jsx)(t.code,{children:"file"}),", ",(0,o.jsx)(t.code,{children:"dir"})," or ",(0,o.jsx)(t.code,{children:"channel"}),"."]}),(0,o.jsx)(t.p,{children:"If you don't pass one, we will make an attempt to read it as a web URL but depending on your URL this might throw an error."})]}),"\n","\n",(0,o.jsxs)(r.A,{children:[(0,o.jsxs)(s.A,{value:"auroraboot",label:"AuroraBoot",children:[(0,o.jsxs)(t.p,{children:["We can use ",(0,o.jsx)(t.a,{href:"../../reference/auroraboot",children:"AuroraBoot"})," to handle the the ISO build process, for example:"]}),(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:'$ IMAGE=<scheme://host[:port]/path[:tag]>\n$ docker pull $IMAGE\n# Build the ISO\n$ docker run -v $PWD/cloud_init.yaml:/cloud_init.yaml \\\n                    -v $PWD/build:/tmp/auroraboot \\\n                    -v /var/run/docker.sock:/var/run/docker.sock \\\n                    --rm -ti quay.io/kairos/auroraboot \\\n                    --set container_image=docker://$IMAGE \\\n                    --set "disable_http_server=true" \\\n                    --set "disable_netboot=true" \\\n                    --cloud-config /cloud_init.yaml \\\n                    --set "state_dir=/tmp/auroraboot"\n# Artifacts are under build/\n$ sudo ls -liah build/iso\ntotal 778M\n34648528 drwx------ 2 root root 4.0K Feb  8 16:39 .\n34648526 drwxr-xr-x 5 root root 4.0K Feb  8 16:38 ..\n34648529 -rw-r--r-- 1 root root  253 Feb  8 16:38 config.yaml\n34649370 -rw-r--r-- 1 root root 389M Feb  8 16:38 kairos.iso\n34649371 -rw-r--r-- 1 root root   76 Feb  8 16:39 kairos.iso.sha256\n'})})]}),(0,o.jsx)(s.A,{value:"manually",label:"Manually",children:(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:'$ IMAGE=<scheme://host[:port]/path[:tag]>\n$ mkdir -p files-iso/boot/grub2\n# You can replace this step with your own grub config. This GRUB configuration is the boot menu of the ISO\n$ wget https://raw.githubusercontent.com/kairos-io/packages/main/packages/livecd/grub2/config/grub_live_bios.cfg -O files-iso/boot/grub2/grub.cfg\n\n# Copy the config file\n$ cp -rfv cloud_init.yaml files-iso/cloud_config.yaml\n# Pull the image locally\n$ docker pull $IMAGE\n# Optionally, modify the image here!\n# docker run --entrypoint /bin/bash --name changes -ti $IMAGE\n# docker commit changes $IMAGE\n# Build an ISO with $IMAGE\n$ docker run -v $PWD:/cOS -v /var/run/docker.sock:/var/run/docker.sock -i --rm quay.io/kairos/auroraboot:latest --debug build-iso --name "custom-iso" --date=false --overlay-iso /cOS/files-iso --output /cOS/ $IMAGE\n'})})})]}),"\n",(0,o.jsx)(t.admonition,{title:"Cloud config",type:"note",children:(0,o.jsxs)(t.p,{children:["In the case of Auroraboot, make sure that the cloud config that you are mounting in the container (",(0,o.jsx)(t.code,{children:"-v $PWD/cloud_init.yaml:/cloud_init.yaml"}),") exists. Otherwise docker will create an empty directory to mount it on the container without any warnings and you will end up with an empty cloud config."]})}),"\n",(0,o.jsx)(t.p,{children:"This will create a new ISO with your specified cloud configuration embedded in it. You can then use this ISO to boot your machine and automatically install Kairos with your desired settings."}),"\n",(0,o.jsxs)(t.p,{children:["You can as well modify the image in this step and add additional packages before deployment. See ",(0,o.jsx)(t.a,{href:"../../advanced/customizing",children:"customizing the system image"}),"."]}),"\n",(0,o.jsxs)(t.p,{children:["Check out the ",(0,o.jsx)(t.a,{href:"../../reference/auroraboot",children:"AuroraBoot documentation"})," and the ",(0,o.jsx)(t.a,{href:"../../examples",children:"examples"})," for learn more on how to generate customized images for installation."]}),"\n",(0,o.jsx)(t.h3,{id:"kubernetes",children:"Kubernetes"}),"\n",(0,o.jsx)(t.p,{children:"It is possible to create custom ISOs and derivatives using extended Kubernetes API resources with an embedded configuration file. This allows you to drive automated installations and customize the container image without breaking the concept of immutability."}),"\n",(0,o.jsxs)(t.p,{children:["You can read more about it ",(0,o.jsx)(t.a,{href:"../../Advanced/build#build-an-iso",children:"here"}),"."]})]})}function m(e={}){const{wrapper:t}={...(0,i.R)(),...e.components};return t?(0,o.jsx)(t,{...e,children:(0,o.jsx)(h,{...e})}):h(e)}}}]);