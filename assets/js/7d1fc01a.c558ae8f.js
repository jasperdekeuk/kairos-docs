"use strict";(globalThis.webpackChunkkairos_docs=globalThis.webpackChunkkairos_docs||[]).push([[8704],{27659:(e,i,s)=>{s.r(i),s.d(i,{assets:()=>l,contentTitle:()=>r,default:()=>u,frontMatter:()=>a,metadata:()=>t,toc:()=>c});const t=JSON.parse('{"id":"Advanced/creating_custom_cloud_images","title":"Creating Custom Cloud Images","description":"A comprehensive guide to creating custom cloud images with Kairos using the latest tools","source":"@site/versioned_docs/version-3.6.0/Advanced/creating_custom_cloud_images.md","sourceDirName":"Advanced","slug":"/Advanced/creating_custom_cloud_images","permalink":"/kairos-docs/docs/3.6.0/Advanced/creating_custom_cloud_images","draft":false,"unlisted":false,"editUrl":"https://github.com/kairos-io/kairos-docs/tree/main/versioned_docs/version-3.6.0/Advanced/creating_custom_cloud_images.md","tags":[],"version":"3.6.0","lastUpdatedBy":"Jasper De Keukelaere (imec)","lastUpdatedAt":1765142882000,"sidebarPosition":1,"frontMatter":{"title":"Creating Custom Cloud Images","sidebar_label":"Creating Custom Cloud Images","sidebar_position":1,"description":"A comprehensive guide to creating custom cloud images with Kairos using the latest tools"},"sidebar":"tutorialSidebar","previous":{"title":"Configuring partitions","permalink":"/kairos-docs/docs/3.6.0/Advanced/configuring_partitions"},"next":{"title":"Customization","permalink":"/kairos-docs/docs/3.6.0/Advanced/customizing"}}');var o=s(74848),n=s(28453);const a={title:"Creating Custom Cloud Images",sidebar_label:"Creating Custom Cloud Images",sidebar_position:1,description:"A comprehensive guide to creating custom cloud images with Kairos using the latest tools"},r=void 0,l={},c=[{value:"Overview",id:"overview",level:2},{value:"Prerequisites",id:"prerequisites",level:2},{value:"Step 1: Creating a Base Image with kairos-init",id:"step-1-creating-a-base-image-with-kairos-init",level:2},{value:"Step 2: Customizing the Image",id:"step-2-customizing-the-image",level:2},{value:"Step 3: Building Bootable Images with AuroraBoot",id:"step-3-building-bootable-images-with-auroraboot",level:2},{value:"State Partition Sizing",id:"state-partition-sizing",level:3},{value:"Step 4: Cloud Configuration",id:"step-4-cloud-configuration",level:2},{value:"Step 5: Building for Specific Platforms",id:"step-5-building-for-specific-platforms",level:2},{value:"AWS",id:"aws",level:3},{value:"Google Cloud",id:"google-cloud",level:3},{value:"Microsoft Azure",id:"microsoft-azure",level:3},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"Next Steps",id:"next-steps",level:2}];function d(e){const i={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,n.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)(i.p,{children:["This guide provides a complete walkthrough for creating custom cloud images with Kairos. It covers the entire process from start to finish, using the latest tools like ",(0,o.jsx)(i.code,{children:"kairos-init"})," and ",(0,o.jsx)(i.code,{children:"AuroraBoot"}),"."]}),"\n",(0,o.jsx)(i.h2,{id:"overview",children:"Overview"}),"\n",(0,o.jsx)(i.p,{children:"Kairos provides several tools to create custom cloud images:"}),"\n",(0,o.jsxs)(i.ol,{children:["\n",(0,o.jsxs)(i.li,{children:[(0,o.jsx)(i.strong,{children:"kairos-init"}),": A tool for creating base container images"]}),"\n",(0,o.jsxs)(i.li,{children:[(0,o.jsx)(i.strong,{children:"AuroraBoot"}),": A tool for generating bootable images (ISOs, cloud images, etc.)"]}),"\n",(0,o.jsxs)(i.li,{children:[(0,o.jsx)(i.strong,{children:"Customization tools"}),": Various methods to customize the images"]}),"\n"]}),"\n",(0,o.jsx)(i.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,o.jsx)(i.p,{children:"Before starting, ensure you have:"}),"\n",(0,o.jsxs)(i.ul,{children:["\n",(0,o.jsx)(i.li,{children:"Docker installed and running"}),"\n",(0,o.jsx)(i.li,{children:"A Linux machine with KVM support (for testing)"}),"\n",(0,o.jsx)(i.li,{children:"Basic understanding of container images and cloud configurations"}),"\n"]}),"\n",(0,o.jsx)(i.h2,{id:"step-1-creating-a-base-image-with-kairos-init",children:"Step 1: Creating a Base Image with kairos-init"}),"\n",(0,o.jsxs)(i.p,{children:["The first step is to create a base container image using ",(0,o.jsx)(i.a,{href:"https://github.com/kairos-io/kairos-init",children:(0,o.jsx)(i.code,{children:"kairos-init"})}),". This tool allows you to create a custom base image from popular distributions."]}),"\n",(0,o.jsx)(i.p,{children:"Here's a basic example of creating a base image:"}),"\n",(0,o.jsx)(i.pre,{children:(0,o.jsx)(i.code,{className:"language-bash",children:'docker build -t my-custom-image - <<EOF\nARG BASE_IMAGE=ubuntu:24.04\n\nFROM quay.io/kairos/kairos-init:latest AS kairos-init\n\nFROM ${BASE_IMAGE} AS base-kairos\nARG VARIANT=core\nARG MODEL=generic\nARG TRUSTED_BOOT=false\nARG KUBERNETES_DISTRO=k3s\nARG KUBERNETES_VERSION=latest\nARG FRAMEWORK_VERSION=v2.20.0\nARG VERSION\n\nCOPY --from=kairos-init /kairos-init /kairos-init\nRUN /kairos-init -f "${FRAMEWORK_VERSION}" -l debug -s install -m "${MODEL}" -v "${VARIANT}" -t "${TRUSTED_BOOT}" -k "${KUBERNETES_DISTRO}" --k8sversion "${KUBERNETES_VERSION}" --version "${VERSION}"\nRUN /kairos-init -f "${FRAMEWORK_VERSION}" -l debug -s init -m "${MODEL}" -v "${VARIANT}" -t "${TRUSTED_BOOT}" -k "${KUBERNETES_DISTRO}" --k8sversion "${KUBERNETES_VERSION}" --version "${VERSION}"\nRUN /kairos-init -f "${FRAMEWORK_VERSION}" -l debug --validate -m "${MODEL}" -v "${VARIANT}" -t "${TRUSTED_BOOT}" -k "${KUBERNETES_DISTRO}" --k8sversion "${KUBERNETES_VERSION}" --version "${VERSION}"\nRUN rm /kairos-init\nEOF\n'})}),"\n",(0,o.jsx)(i.h2,{id:"step-2-customizing-the-image",children:"Step 2: Customizing the Image"}),"\n",(0,o.jsx)(i.p,{children:"Once you have a base image, you can customize it by:"}),"\n",(0,o.jsxs)(i.ol,{children:["\n",(0,o.jsx)(i.li,{children:"Adding packages"}),"\n",(0,o.jsx)(i.li,{children:"Modifying configurations"}),"\n",(0,o.jsx)(i.li,{children:"Adding custom services"}),"\n",(0,o.jsx)(i.li,{children:"Including additional files"}),"\n"]}),"\n",(0,o.jsxs)(i.p,{children:["See the ",(0,o.jsx)(i.a,{href:"./customizing",children:"Customizing Images"})," guide for detailed instructions."]}),"\n",(0,o.jsx)(i.h2,{id:"step-3-building-bootable-images-with-auroraboot",children:"Step 3: Building Bootable Images with AuroraBoot"}),"\n",(0,o.jsx)(i.p,{children:"After creating and customizing your base image, you can use AuroraBoot to create bootable images:"}),"\n",(0,o.jsx)(i.pre,{children:(0,o.jsx)(i.code,{className:"language-bash",children:'docker run -v "$PWD"/build:/tmp/auroraboot \\\n             -v /var/run/docker.sock:/var/run/docker.sock \\\n             --rm -ti quay.io/kairos/auroraboot:latest \\\n             --set container_image=my-custom-image \\\n             --set "disable_http_server=true" \\\n             --set "disable_netboot=true" \\\n             --cloud-config /path/to/cloud-config.yaml \\\n             --set "state_dir=/tmp/auroraboot"\n'})}),"\n",(0,o.jsx)(i.admonition,{title:"Note",type:"info",children:(0,o.jsxs)(i.p,{children:["For more details about AuroraBoot options and configurations, see the ",(0,o.jsx)(i.a,{href:"./auroraboot",children:"AuroraBoot documentation"}),"."]})}),"\n",(0,o.jsx)(i.h3,{id:"state-partition-sizing",children:"State Partition Sizing"}),"\n",(0,o.jsx)(i.p,{children:"When creating cloud images, it's important to consider the size of the state partition. The state partition is created at image build time and cannot be resized later. This partition needs to accommodate all images (passive, active, and transition image for upgrades) that might be used with the system."}),"\n",(0,o.jsxs)(i.p,{children:["By default, AuroraBoot sets the state partition size to 3 times the size of the current image plus some additional space for system files. This is usually sufficient for most use cases, but if you need to ensure the state partition can accommodate larger future images, you can override this with the ",(0,o.jsx)(i.code,{children:"disk.state_size"})," option:"]}),"\n",(0,o.jsx)(i.pre,{children:(0,o.jsx)(i.code,{className:"language-bash",children:'docker run -v "$PWD"/build:/tmp/auroraboot \\\n             -v /var/run/docker.sock:/var/run/docker.sock \\\n             --rm -ti quay.io/kairos/auroraboot \\\n             --set container_image=my-custom-image \\\n             --set "disable_http_server=true" \\\n             --set "disable_netboot=true" \\\n             --set "disk.state_size=6000" \\\n             --cloud-config /path/to/cloud-config.yaml \\\n             --set "state_dir=/tmp/auroraboot"\n'})}),"\n",(0,o.jsx)(i.p,{children:"The value is specified in megabytes (MB). When setting a custom size, make sure it's at least 3 times the size of the largest image you plan to use, plus some additional space for system files. This ensures there's enough space for the passive, active, and transition images, plus some overhead for future updates."}),"\n",(0,o.jsx)(i.h2,{id:"step-4-cloud-configuration",children:"Step 4: Cloud Configuration"}),"\n",(0,o.jsxs)(i.p,{children:["Your cloud configuration file (",(0,o.jsx)(i.code,{children:"cloud-config.yaml"}),") is crucial for defining how your image will behave. Here's a basic example:"]}),"\n",(0,o.jsx)(i.pre,{children:(0,o.jsx)(i.code,{className:"language-yaml",children:'#cloud-config\n\nhostname: kairos-{{ trunc 4 .MachineID }}\n\nusers:\n- name: "kairos"\n  passwd: kairos\n  groups:\n  - admin\n\nreset:\n  source: "oci:quay.io/kairos/opensuse:leap-15.6-standard-amd64-generic-master-k3sv1.32.1-rc2-k3s1"\n'})}),"\n",(0,o.jsxs)(i.p,{children:['In the example above, we are specifying a custom image that will be used during the first boot to reset the system. When you launch an instance, Kairos will boot into "auto-reset mode" by default. This means that Kairos will "install" itself on the first boot and then reboot. The ',(0,o.jsx)(i.code,{children:"reset.source"})," field in the cloud-config specifies which image will be installed during this process."]}),"\n",(0,o.jsx)(i.p,{children:"As explained in the section above, sizing the state partition properly is important when using this option."}),"\n",(0,o.jsx)(i.h2,{id:"step-5-building-for-specific-platforms",children:"Step 5: Building for Specific Platforms"}),"\n",(0,o.jsx)(i.h3,{id:"aws",children:"AWS"}),"\n",(0,o.jsxs)(i.p,{children:["To install on AWS, follow the ",(0,o.jsx)(i.a,{href:"./aws",children:"AWS Guide"}),"."]}),"\n",(0,o.jsx)(i.h3,{id:"google-cloud",children:"Google Cloud"}),"\n",(0,o.jsxs)(i.p,{children:["To install on Google Cloud, follow the ",(0,o.jsx)(i.a,{href:"./gce",children:"Google Cloud Installation Guide"}),"."]}),"\n",(0,o.jsx)(i.h3,{id:"microsoft-azure",children:"Microsoft Azure"}),"\n",(0,o.jsxs)(i.p,{children:["For Azure deployments, see the ",(0,o.jsx)(i.a,{href:"./azure",children:"Azure Installation Guide"}),"."]}),"\n",(0,o.jsx)(i.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,o.jsx)(i.p,{children:"Common issues and solutions:"}),"\n",(0,o.jsxs)(i.ol,{children:["\n",(0,o.jsxs)(i.li,{children:[(0,o.jsx)(i.strong,{children:"Disk Size"}),": Ensure your VM disk is large enough for all partitions. If there isn't enough space, the auro-reset will fail and the VM will never boot into ",(0,o.jsx)(i.code,{children:"active_boot"})," mode."]}),"\n",(0,o.jsxs)(i.li,{children:[(0,o.jsx)(i.strong,{children:"State Partition Size"}),": If you encounter issues when resetting to a new image, it might be because the state partition is too small. Use the ",(0,o.jsx)(i.code,{children:"disk.state_size"})," option when creating the image to set an appropriate size."]}),"\n"]}),"\n",(0,o.jsx)(i.h2,{id:"next-steps",children:"Next Steps"}),"\n",(0,o.jsxs)(i.ul,{children:["\n",(0,o.jsx)(i.li,{children:(0,o.jsx)(i.a,{href:"./customizing",children:"Customizing Images"})}),"\n",(0,o.jsx)(i.li,{children:(0,o.jsx)(i.a,{href:"./auroraboot",children:"AuroraBoot Reference"})}),"\n",(0,o.jsx)(i.li,{children:(0,o.jsx)(i.a,{href:"./configuration",children:"Cloud Configuration Reference"})}),"\n"]})]})}function u(e={}){const{wrapper:i}={...(0,n.R)(),...e.components};return i?(0,o.jsx)(i,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}},28453:(e,i,s)=>{s.d(i,{R:()=>a,x:()=>r});var t=s(96540);const o={},n=t.createContext(o);function a(e){const i=t.useContext(n);return t.useMemo(function(){return"function"==typeof e?e(i):{...i,...e}},[i,e])}function r(e){let i;return i=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:a(e.components),t.createElement(n.Provider,{value:i},e.children)}}}]);