<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-Architecture/cloud-init" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">Cloud init based | Kairos</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://kairos.io/kairos-docs/img/Kairos_800x419.png"><meta data-rh="true" name="twitter:image" content="https://kairos.io/kairos-docs/img/Kairos_800x419.png"><meta data-rh="true" property="og:url" content="https://kairos.io/kairos-docs/docs/next/Architecture/cloud-init"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Cloud init based | Kairos"><meta data-rh="true" name="description" content="Kairos supports the standard cloud-init syntax and its own extended syntax to allow to configure a system declaratively with a cloud-config centric approach."><meta data-rh="true" property="og:description" content="Kairos supports the standard cloud-init syntax and its own extended syntax to allow to configure a system declaratively with a cloud-config centric approach."><link data-rh="true" rel="icon" href="/kairos-docs/img/logo.svg"><link data-rh="true" rel="canonical" href="https://kairos.io/kairos-docs/docs/next/Architecture/cloud-init"><link data-rh="true" rel="alternate" href="https://kairos.io/kairos-docs/docs/next/Architecture/cloud-init" hreflang="en"><link data-rh="true" rel="alternate" href="https://kairos.io/kairos-docs/docs/next/Architecture/cloud-init" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Architecture","item":"https://kairos.io/kairos-docs/docs/next/category/architecture"},{"@type":"ListItem","position":2,"name":"Cloud init based","item":"https://kairos.io/kairos-docs/docs/next/Architecture/cloud-init"}]}</script><link rel="alternate" type="application/rss+xml" href="/kairos-docs/blog/rss.xml" title="Kairos RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/kairos-docs/blog/atom.xml" title="Kairos Atom Feed">




<script src="https://buttons.github.io/buttons.js" async defer="defer"></script><link rel="stylesheet" href="/kairos-docs/assets/css/styles.c9791132.css">
<script src="/kairos-docs/assets/js/runtime~main.32d1f2f4.js" defer="defer"></script>
<script src="/kairos-docs/assets/js/main.a6b903dc.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/kairos-docs/img/logo.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/kairos-docs/"><div class="navbar__logo"><img src="/kairos-docs/img/logo.svg" alt="Kairos Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/kairos-docs/img/logo.svg" alt="Kairos Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Kairos</b></a><a class="navbar__item navbar__link" href="/kairos-docs/docs/getting-started">Getting Started</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/kairos-docs/docs/next/getting-started/">Documentation</a><a class="navbar__item navbar__link" href="/kairos-docs/blog">Blog</a><a href="https://kairos.io/community/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Community<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/kairos-docs/docs/next/Architecture/cloud-init">Next ðŸš§</a><ul class="dropdown__menu"><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/kairos-docs/docs/next/Architecture/cloud-init">Next ðŸš§</a></li><li><a class="dropdown__link" href="/kairos-docs/docs/3.6.0/Architecture/cloud-init">3.6.0 (Latest)</a></li><li><a class="dropdown__link" href="/kairos-docs/docs/3.5.7/Architecture/cloud-init">3.5.7</a></li></ul></div><div class="navbar__item"><a class="github-button" href="https://github.com/kairos-io/kairos" data-icon="octicon-star" data-size="large" data-show-count="true" aria-label="Star kairos-io/kairos on GitHub">Star</a></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/kairos-docs/docs/next/getting-started/"><span title="Getting Started" class="categoryLinkLabel_W154">Getting Started</span></a><button aria-label="Expand sidebar category &#x27;Getting Started&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/kairos-docs/docs/next/category/installation"><span title="Installation" class="categoryLinkLabel_W154">Installation</span></a><button aria-label="Expand sidebar category &#x27;Installation&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--active" href="/kairos-docs/docs/next/category/architecture"><span title="Architecture" class="categoryLinkLabel_W154">Architecture</span></a><button aria-label="Collapse sidebar category &#x27;Architecture&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/kairos-docs/docs/next/Architecture/immutable"><span title="Immutable" class="linkLabel_WmDU">Immutable</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/kairos-docs/docs/next/Architecture/container"><span title="Container" class="linkLabel_WmDU">Container</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/kairos-docs/docs/next/Architecture/cloud-init"><span title="Cloud init based" class="linkLabel_WmDU">Cloud init based</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/kairos-docs/docs/next/Architecture/secureboot"><span title="SecureBoot support" class="linkLabel_WmDU">SecureBoot support</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/kairos-docs/docs/next/Architecture/meta"><span title="Meta-Distribution" class="linkLabel_WmDU">Meta-Distribution</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/kairos-docs/docs/next/Architecture/network"><span title="P2P Network" class="linkLabel_WmDU">P2P Network</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/kairos-docs/docs/next/Architecture/trustedboot"><span title="Trusted Boot" class="linkLabel_WmDU">Trusted Boot</span></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/kairos-docs/docs/next/category/advanced"><span title="Advanced" class="categoryLinkLabel_W154">Advanced</span></a><button aria-label="Expand sidebar category &#x27;Advanced&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/kairos-docs/docs/next/Upgrade/manual"><span title="Upgrade" class="categoryLinkLabel_W154">Upgrade</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/kairos-docs/docs/next/category/reference"><span title="Reference" class="categoryLinkLabel_W154">Reference</span></a><button aria-label="Expand sidebar category &#x27;Reference&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/kairos-docs/docs/next/category/development"><span title="Development" class="categoryLinkLabel_W154">Development</span></a><button aria-label="Expand sidebar category &#x27;Development&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/kairos-docs/docs/next/Examples/boot_assessment_trusted_boot"><span title="Examples" class="categoryLinkLabel_W154">Examples</span></a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="theme-doc-version-banner alert alert--warning margin-bottom--md" role="alert"><div>This is unreleased documentation for <!-- -->Kairos<!-- --> <b>Next ðŸš§</b> version.</div><div class="margin-top--md">For up-to-date documentation, see the <b><a href="/kairos-docs/docs/3.6.0/Architecture/cloud-init">latest version</a></b> (<!-- -->3.6.0 (Latest)<!-- -->).</div></div><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/kairos-docs/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/kairos-docs/docs/next/category/architecture"><span>Architecture</span></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Cloud init based</span></li></ul></nav><span class="theme-doc-version-badge badge badge--secondary">Version: Next ðŸš§</span><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Cloud init based</h1></header><p>Kairos supports the <a href="https://github.com/mudler/yip#compatibility-with-cloud-init-format" target="_blank" rel="noopener noreferrer" class="">standard cloud-init syntax</a> and <a href="https://github.com/mudler/yip" target="_blank" rel="noopener noreferrer" class="">its own extended syntax</a> to allow to configure a system declaratively with a cloud-config centric approach.</p>
<p>If you are not familiar with the concepts of cloud-init, <a href="https://cloud-init.io/" target="_blank" rel="noopener noreferrer" class="">official cloud-init</a> is a recommended read.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="configuration-persistency">Configuration persistency<a href="#configuration-persistency" class="hash-link" aria-label="Direct link to Configuration persistency" title="Direct link to Configuration persistency" translate="no">â€‹</a></h2>
<p>Kairos is an Immutable OS and the only configuration that is persistent across reboots is the cloud-init configuration.
Multiple cloud-init files can be present in the system and Kairos will read them and process them in sequence (lexicographic order) allowing to extend the configuration with additional pieces also after deployment, or to manage logical configuration pieces separately.</p>
<p>In Kairos the <code>/oem</code> directory keeps track of all the configuration of the system and stores the configuration files. Multiple files are allowed and they are all executed during the various system stages. <code>/usr/local/cloud-config</code> can be optionally used as well to store cloud config files in the persistent partition instead. <code>/system/oem</code> is instead reserved to default cloud-init files that are shipped by the base OS image.</p>
<p>By using the standard cloud-config syntax, a subset of the functionalities are available and the settings will be executed in the boot stage.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="configuration-order">Configuration order<a href="#configuration-order" class="hash-link" aria-label="Direct link to Configuration order" title="Direct link to Configuration order" translate="no">â€‹</a></h3>
<p>When an action is done (install, upgrade, reset) several default directories in the system are read to obtain the configuration and are merged together.
The directories and the order in which they are read and merged, is as shown below, from first to last. Notice that any values found in different directories will override existing ones in previous directories.</p>
<ul>
<li class="">/run/initramfs/live (Only available on LiveCD/Netboot)</li>
<li class="">/usr/local/cloud-config</li>
<li class="">/etc/kairos</li>
<li class="">/etc/elemental (deprecated)</li>
<li class="">/oem</li>
</ul>
<p>This means that you could ship an ISO with a bundled config (see <a class="" href="/kairos-docs/docs/Installation/automated">Automated install</a> or <a class="" href="/kairos-docs/docs/Reference/auroraboot">Auroraboot</a> to see how) that adds a generic configuration that you want everywhere, and using userdata you can then overwrite the default config if needed per node/datacenter/deployment, as the useradata is read and stored into <code>/oem</code> it will be read later in the process and overwrite whatever you shipped on the defaults bundled with the ISO.</p>
<p>In order to see the final config, you can run on a running system <code>kairos-agent config</code> and that should show the final configuration after scanning all sources.</p>
<p>NOTE: Other than configuration (for installation/upgrade/reset/etc), in the cloud config files, you can also define <a href="#boot-stages" class="">&quot;stages&quot;</a> to be run during boot. When the same stage is defined in more than one cloud config files, all definitions will be respected. In other words, stages won&#x27;t be overwritten.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="boot-stages">Boot stages<a href="#boot-stages" class="hash-link" aria-label="Direct link to Boot stages" title="Direct link to Boot stages" translate="no">â€‹</a></h2>
<p>During boot the stages are emitted in an event-based pattern until a system completes its boot process</p>
<p><img decoding="async" loading="lazy" src="https://user-images.githubusercontent.com/2420543/195111193-3167eab8-8058-4676-a1a0-f64aea745646.png" alt="Kairos-boot-events" class="img_ev3q"></p>
<p>The events can be used in the cloud-config extended syntax to hook into the various stages, which can allow to hook inside the different stages of a node lifecycle.</p>
<p>For instance, to execute something before reset is sufficient to add the following to the config file used to bootstrap a node:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Run something before reset&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">stages</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token key atrule" style="color:#00a4db">before-reset</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Setting&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token key atrule" style="color:#00a4db">commands</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token scalar string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          echo &quot;Run a command before reset the node!&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>Below there is a detailed list of the stages available that can be used in the cloud-init configuration files:</p>
<table><thead><tr><th><strong>Stage</strong></th><th><strong>Description</strong></th></tr></thead><tbody><tr><td><em>rootfs</em></td><td>This is the earliest stage, running before switching root, just right after the root is mounted in /sysroot and before applying the immutable rootfs configuration. This stage is executed over initrd root, no chroot is applied.</td></tr><tr><td><em>initramfs</em></td><td>This is still an early stage, running before switching root. Here you can apply radical changes to the booting setup of Kairos. Despite this is executed before switching root this execution runs chrooted into the target root after the immutable rootfs is set up and ready.</td></tr><tr><td><em>boot</em></td><td>This stage is executed after initramfs has switched root, during the systemd bootup process.</td></tr><tr><td><em>fs</em></td><td>This stage is executed when fs is mounted and is guaranteed to have access to the state and persistent partitions ( <code>COS_STATE</code>  and  <code>COS_PERSISTENT</code> respectively).</td></tr><tr><td><em>network</em></td><td>This stage is executed when network is available</td></tr><tr><td><em>reconcile</em></td><td>This stage is executed 5m after boot and periodically each 60m.</td></tr><tr><td><em>kairos-install.pre</em></td><td>This stage is executed before installation of the OS starts</td></tr><tr><td><em>kairos-uki-install.pre</em></td><td>This stage is executed before installation of the OS starts. Only run under Trusted Boot</td></tr><tr><td><em>kairos-install.after</em></td><td>This stage is executed after installation of the OS ends</td></tr><tr><td><em>kairos-uki-install.after</em></td><td>This stage is executed after installation of the OS ends. Only run under Trusted Boot</td></tr><tr><td><em>kairos-uki-reset.pre</em></td><td>This stage is executed before reset. Only run under Trusted Boot</td></tr><tr><td><em>kairos-uki-reset.after</em></td><td>This stage is executed after reset. Only run under Trusted Boot</td></tr><tr><td><em>kairos-uki-upgrade.pre</em></td><td>This stage is executed before upgrade. Only run under Trusted Boot</td></tr><tr><td><em>kairos-uki-upgrade.after</em></td><td>This stage is executed after upgrade. Only run under Trusted Boot</td></tr><tr><td><em>before-install</em></td><td>This stage happens after partitioning but before the image OS is applied</td></tr><tr><td><em>after-install-chroot</em></td><td>This stage happens after installing active and grub inside chroot<sup><a href="#user-content-fn-1" id="user-content-fnref-1" data-footnote-ref="true" aria-describedby="footnote-label" class="anchorTargetStickyNavbar_Vzrq">1</a></sup></td></tr><tr><td><em>after-install</em></td><td>This stage runs after active,passive and recovery images are installed and after disks have been encrypted</td></tr><tr><td><em>before-reset</em></td><td>This stage happens after partitions have been formatted and mounted but before the image has been reset</td></tr><tr><td><em>after-reset</em></td><td>This stage happens after partitions have been formatted and mounted and active and passive images reset</td></tr><tr><td><em>after-reset-chroot</em></td><td>This stage happens after active has been reset but before passive has been touched inside chroot<sup><a href="#user-content-fn-1" id="user-content-fnref-1-2" data-footnote-ref="true" aria-describedby="footnote-label" class="anchorTargetStickyNavbar_Vzrq">1</a></sup></td></tr><tr><td><em>before-upgrade</em></td><td>This stage happens after mounting partitions with RW but before any image has been upgraded</td></tr><tr><td><em>after-upgrade</em></td><td>This stage happens after upgrade has been done</td></tr><tr><td><em>after-upgrade-chroot</em></td><td>This stage happens after the image has been upgraded inside chroot<sup><a href="#user-content-fn-1" id="user-content-fnref-1-3" data-footnote-ref="true" aria-describedby="footnote-label" class="anchorTargetStickyNavbar_Vzrq">1</a></sup></td></tr></tbody></table>
<p>In case you&#x27;re using a standard image, with the Kairos provider, then these other stages are also available</p>
<table><thead><tr><th><strong>Stage</strong></th><th><strong>Description</strong></th></tr></thead><tbody><tr><td><em>provider-kairos.bootstrap.before.&lt;role&gt;</em></td><td>The provider fires this stage before starting to bootstrap K3S.</td></tr><tr><td><em>provider-kairos.bootstrap.after.&lt;role&gt;</em></td><td>The provider fires this stage after it finished bootstrapping K3S.</td></tr></tbody></table>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="system-stages-with-after-and-before-substages">System stages with after and before substages<a href="#system-stages-with-after-and-before-substages" class="hash-link" aria-label="Direct link to System stages with after and before substages" title="Direct link to System stages with after and before substages" translate="no">â€‹</a></h3>
<p>The system run stages that are not part of an action (install,upgrade,reset) all have sub-stages so users can override or modify system behaviour.</p>
<p>This applies to <code>rootfs</code>, <code>initramfs</code>, <code>boot</code>, <code>fs</code>, <code>reconcile</code> and <code>network</code> stages. All of those stages will also run a suffixed <code>after</code> and <code>before</code> substage that users can hook into to change different setting before the main stage is run.</p>
<p>As those stages are run as part of the system os during different phases and some default configs are shipped with a Kairos system, we add those stages on the fly so they are easily overridable or reverted if one would not want something that ships with KAiros.</p>
<p>For example if we detect that we are running on a VM, <a href="https://github.com/kairos-io/packages/blob/main/packages/static/kairos-overlay-files/files/system/oem/26_vm.yaml" target="_blank" rel="noopener noreferrer" class="">we try to enable the helper services that VM vendors provide</a> but that may conflict with a user approach of having no superfluous services running. As that config is shipped as part of the base image, its not easy to remove it unless you build a new artifact.</p>
<p>Instead we can revert that by having a config that disables it as soon as possible.</p>
<p>We know that the stage is run during <code>boot</code> stage as shown in the <a href="https://github.com/kairos-io/packages/blob/main/packages/static/kairos-overlay-files/files/system/oem/26_vm.yaml" target="_blank" rel="noopener noreferrer" class="">config file</a> so we could write the following config:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Disable QEMU tools&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">stages</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">boot.after</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Disable QEMU&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">if</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token scalar string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">        grep -iE &quot;qemu|kvm|Virtual Machine&quot; /sys/class/dmi/id/product_name &amp;&amp; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">        ( [ -e &quot;/sbin/systemctl&quot; ] || [ -e &quot;/usr/bin/systemctl&quot; ] || [ -e &quot;/usr/sbin/systemctl&quot; ] || [ -e &quot;/usr/bin/systemctl&quot; ] )</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">commands</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> systemctl stop qemu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">guest</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">agent</span><br></span></code></pre></div></div>
<p>Notice how we set the stage to be <code>boot.after</code>. That will run immediately after the <code>boot</code> stage has run, so we dont have to know where it will run and play with trying to disable it in the same stage and run into race problems, we can just use that substage to make sure that our configs runs after the default system ones.</p>
<p>All the mentioned stages (<code>rootfs</code>, <code>initramfs</code>, <code>boot</code>, <code>fs</code>, <code>reconcile</code> and <code>network</code>) have <code>STAGE.before</code> and <code>STAGE.after</code> substages.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="stages-during-kairos-agent-operations-in-detail">Stages during kairos-agent operations in detail<a href="#stages-during-kairos-agent-operations-in-detail" class="hash-link" aria-label="Direct link to Stages during kairos-agent operations in detail" title="Direct link to Stages during kairos-agent operations in detail" translate="no">â€‹</a></h3>
<p><img decoding="async" loading="lazy" src="https://github.com/user-attachments/assets/b050f247-990a-4395-9b45-334e04f84d45" alt="Install Stages" class="img_ev3q"></p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="modules">Modules<a href="#modules" class="hash-link" aria-label="Direct link to Modules" title="Direct link to Modules" translate="no">â€‹</a></h3>
<p>For each stage, a number of modules are available, that implement various useful functions.
Read more about them in this page: <a class="" href="/kairos-docs/docs/Reference/stage_modules">Stage modules</a></p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="sentinels">Sentinels<a href="#sentinels" class="hash-link" aria-label="Direct link to Sentinels" title="Direct link to Sentinels" translate="no">â€‹</a></h3>
<p>When a Kairos boots it creates sentinel files in order to allow to execute cloud-init steps programmaticaly.</p>
<ul>
<li class="">/run/cos/recovery_mode is being created when booting from the recovery partition</li>
<li class="">/run/cos/live_mode is created when booting from the LiveCD</li>
</ul>
<p>To execute a block using the sentinel files you can specify: <code>if: &#x27;[ -f &quot;/run/cos/...&quot; ]&#x27;</code>, for instance:</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="default-kairos-configs">Default Kairos configs<a href="#default-kairos-configs" class="hash-link" aria-label="Direct link to Default Kairos configs" title="Direct link to Default Kairos configs" translate="no">â€‹</a></h2>
<p>We have a set of default cloud-init configs that are shipped with the base image, and can be found in <code>/system/oem/</code>. These configs are executed during the various boot stages and can be overridden by user-provided configs in <code>/oem</code> or <code>/usr/local/cloud-config</code>.</p>
<p>You can check the default configs in the <a href="https://github.com/kairos-io/kairos-init/tree/main/pkg/bundled/cloudconfigs" target="_blank" rel="noopener noreferrer" class="">kairos-init repository</a>.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="overriding-default-configs">Overriding default configs<a href="#overriding-default-configs" class="hash-link" aria-label="Direct link to Overriding default configs" title="Direct link to Overriding default configs" translate="no">â€‹</a></h2>
<p>You can override the default configs by creating a new file in <code>/oem</code> and adding your custom configuration. For example, if you want to override the <a href="https://github.com/kairos-io/kairos-init/blob/e23d3947934c5af3de4069eff3ed650f0c5f8e6d/pkg/bundled/cloudconfigs/09_systemd_services.yaml#L7" target="_blank" rel="noopener noreferrer" class="">default sysctl configuration</a> provided by Kairos on the <code>boot</code> stage you would create a file under /oem with the following content:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Override&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">stages</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">boot</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;modify sysctl settings&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">sysctl</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">fs.inotify.max_user_instances</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">123192</span><br></span></code></pre></div></div>
<p>Now, we need to make sure that the file is run <em>after</em> the default sysctl configuration is applied, so we can use the <code>boot.after</code> stage to ensure that our custom configuration is applied after the default one:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Override&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">stages</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">boot.after</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;modify sysctl settings&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">sysctl</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">fs.inotify.max_user_instances</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">123192</span><br></span></code></pre></div></div>
<p>This would ensure that our custom sysctl setting is applied after the default sysctl configuration provided by Kairos.</p>
<p><strong>What about overriding stages that are in the same stage? Or making sure they run after our wanted step</strong></p>
<p>For example, you have a default stage that runs in the <code>boot.after</code> stage, and you want to override it with your own configuration.</p>
<p>In this case, running them would not guarantee that your configuration is applied after the default one, as both configurations are in the same stage.</p>
<p>For this case <a href="https://github.com/mudler/yip" target="_blank" rel="noopener noreferrer" class="">yip</a> provides an <code>after</code> directive that allows you to run your configuration after the default one, even if they are in the same stage.</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Override&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">stages</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">boot</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;modify sysctl settings&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">sysctl</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">fs.inotify.max_user_instances</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">123192</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">after</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;FULL NAME OF THE STAGE TO OVERRIDE&quot;</span><br></span></code></pre></div></div>
<p>This would ensure that your custom sysctl setting is applied after the default sysctl configuration provided by Kairos, even if they are in the same stage and step, yip will move it into a different layer to assure that it is run after.</p>
<p>For a practical example:</p>
<p>/oem/01_first.yaml</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">stages</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">test</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;First stage&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">commands</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> echo &quot;Hello&quot;</span><br></span></code></pre></div></div>
<p>/oem/02_second.yaml</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">stages</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">test</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;after stage&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">after</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;/oem/01_first.yaml.First stage&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">commands</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> echo &quot;Hello&quot;</span><br></span></code></pre></div></div>
<p>Notice the after directive in the second file, that allows running the command after the first stage has been executed, even if they are in the same stage. And fully guarantees that the second stage will run after the first one, even if they are in the same stage and layer.</p>
<p>The name of the stage to override is the full name of the stage, which is a combination of the file path and the stage name, in this case <code>/oem/01_first.yaml.First stage</code>.</p>
<p>If you are not sure of the name of the stage to override, you can run <code>kairos-agent run-stage -a STAGE</code> to see the final DAG of the stage, which will include the full name of the stage, and you can use that to override it. Notice that if the yaml file has a root name, that will be used instead of the file name.</p>
<p>Here is a real example of the output of <code>kairos-agent run-stage -a boot</code>:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> &lt;init&gt; (background: false) (weak: false)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> &lt;Start agent.0&gt; (background: false) (weak: true)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> &lt;Start recovery on tty1.Recovery&gt; (background: false) (weak: true)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> &lt;Start installer on tty1..0&gt; (background: false) (weak: true)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> &lt;Default config.Default sysctl settings&gt; (background: false) (weak: true)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> &lt;Enable QEMU tools.Enable QEMU.0&gt; (background: false) (weak: true)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> &lt;Enable QEMU tools.Enable QEMU.1&gt; (background: false) (weak: true)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> &lt;Start installer on tty1..1&gt; (background: false) (weak: true)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> &lt;Enable QEMU tools.Enable VBOX.2&gt; (background: false) (weak: true)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> &lt;Enable QEMU tools.Enable VBOX.3&gt; (background: false) (weak: true)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-07-04T07:18:12Z DBG [2994] Generating op for stage &#x27;/oem/91_sysctl.yaml.first step&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-07-04T07:18:12Z DBG [2994] Generating op for stage &#x27;/oem/92_another.yaml.0&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> &lt;init&gt; (background: false) (weak: false)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> &lt;/oem/91_sysctl.yaml.first step&gt; (background: false) (weak: true)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> &lt;/oem/92_another.yaml.0&gt; (background: false) (weak: true)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<ul>
<li class=""><code>Start agent.0</code> -&gt; The file has a root name <code>Start agent</code> and the step doesn&#x27;t have a set name so it gets the step number</li>
</ul>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Start agent&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">stages</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">boot</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">if</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;[ ! -f &quot;/run/cos/recovery_mode&quot; ]&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">only_service_manager</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;systemd&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">files</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /etc/systemd/system/kairos</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">agent.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">...</span><br></span></code></pre></div></div>
<ul>
<li class=""><code>Start recovery on tty1.Recovery</code> -&gt; The file has a root name <code>Start recovery on tty1</code> and the step has a name <code>Recovery</code></li>
</ul>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Start recovery on tty1&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">stages</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">boot</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Recovery&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">if</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;[ -f &quot;/run/cos/recovery_mode&quot; ]&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">hostname</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;cos-recovery&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">commands</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">...</span><br></span></code></pre></div></div>
<ul>
<li class=""><code>/oem/91_sysctl.yaml.first step</code> -&gt; The file has no root name and the step has a name <code>first step</code>, so it gets the file name plus step name.</li>
</ul>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">stages</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">boot</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> first step</span><br></span></code></pre></div></div>
<ul>
<li class=""><code>/oem/92_another.yaml.0</code> -&gt; The file has no root name and the step has no name, so it gets the file name plus step number.</li>
</ul>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">stages</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">boot</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> commands</span><span class="token punctuation" style="color:#393A34">:</span><br></span></code></pre></div></div>
<!-- -->
<section data-footnotes="true" class="footnotes"><h2 class="anchor anchorTargetStickyNavbar_Vzrq sr-only" id="footnote-label">Footnotes<a href="#footnote-label" class="hash-link" aria-label="Direct link to Footnotes" title="Direct link to Footnotes" translate="no">â€‹</a></h2>
<ol>
<li class="anchorTargetStickyNavbar_Vzrq" id="user-content-fn-1">
<p>Steps executed at the <code>chroot</code> stage are running inside the new OS as chroot, allowing to write persisting changes to the image, for example by downloading and installing additional software. <a href="#user-content-fnref-1" data-footnote-backref="" aria-label="Back to reference 1" class="data-footnote-backref">â†©</a> <a href="#user-content-fnref-1-2" data-footnote-backref="" aria-label="Back to reference 1-2" class="data-footnote-backref">â†©<sup>2</sup></a> <a href="#user-content-fnref-1-3" data-footnote-backref="" aria-label="Back to reference 1-3" class="data-footnote-backref">â†©<sup>3</sup></a></p>
</li>
</ol>
</section></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col noPrint_WFHX"><a href="https://github.com/kairos-io/kairos-docs/tree/main/docs/Architecture/cloud-init.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2025-12-06T17:56:03.000Z" itemprop="dateModified">Dec 6, 2025</time></b> by <b>Jasper De Keukelaere (imec)</b></span></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/kairos-docs/docs/next/Architecture/container"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Container</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/kairos-docs/docs/next/Architecture/secureboot"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">SecureBoot support</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#configuration-persistency" class="table-of-contents__link toc-highlight">Configuration persistency</a><ul><li><a href="#configuration-order" class="table-of-contents__link toc-highlight">Configuration order</a></li></ul></li><li><a href="#boot-stages" class="table-of-contents__link toc-highlight">Boot stages</a><ul><li><a href="#system-stages-with-after-and-before-substages" class="table-of-contents__link toc-highlight">System stages with after and before substages</a></li><li><a href="#stages-during-kairos-agent-operations-in-detail" class="table-of-contents__link toc-highlight">Stages during kairos-agent operations in detail</a></li><li><a href="#modules" class="table-of-contents__link toc-highlight">Modules</a></li><li><a href="#sentinels" class="table-of-contents__link toc-highlight">Sentinels</a></li></ul></li><li><a href="#default-kairos-configs" class="table-of-contents__link toc-highlight">Default Kairos configs</a></li><li><a href="#overriding-default-configs" class="table-of-contents__link toc-highlight">Overriding default configs</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Documentation</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/kairos-docs/docs/getting-started">Getting Started</a></li><li class="footer__item"><a class="footer__link-item" href="/kairos-docs/docs/installation">Installation</a></li><li class="footer__item"><a class="footer__link-item" href="/kairos-docs/docs/architecture">Architecture</a></li><li class="footer__item"><a class="footer__link-item" href="/kairos-docs/docs/examples">Examples</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://slack.cncf.io/#kairos" target="_blank" rel="noopener noreferrer" class="footer__link-item">Slack<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://github.com/kairos-io/kairos/discussions" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub Discussions<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://www.linkedin.com/company/kairos-oss/" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://x.com/Kairos_OSS" target="_blank" rel="noopener noreferrer" class="footer__link-item">X (Twitter)<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/kairos-docs/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/kairos-io/kairos" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://www.spectrocloud.com/solutions/kairos-support" target="_blank" rel="noopener noreferrer" class="footer__link-item">Commercial Support<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2025 Kairos authors</div></div></div></footer></div>
</body>
</html>