<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-Installation/trustedboot" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">Trusted Boot Installations | Kairos</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://kairos.io/kairos-docs/img/Kairos_800x419.png"><meta data-rh="true" name="twitter:image" content="https://kairos.io/kairos-docs/img/Kairos_800x419.png"><meta data-rh="true" property="og:url" content="https://kairos.io/kairos-docs/docs/next/Installation/trustedboot"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Trusted Boot Installations | Kairos"><meta data-rh="true" name="description" content="Learn how to enable Trusted Boot with Secure Boot, full disk encryption, and measured boot to protect systems from tampering."><meta data-rh="true" property="og:description" content="Learn how to enable Trusted Boot with Secure Boot, full disk encryption, and measured boot to protect systems from tampering."><link data-rh="true" rel="icon" href="/kairos-docs/img/logo.svg"><link data-rh="true" rel="canonical" href="https://kairos.io/kairos-docs/docs/next/Installation/trustedboot"><link data-rh="true" rel="alternate" href="https://kairos.io/kairos-docs/docs/next/Installation/trustedboot" hreflang="en"><link data-rh="true" rel="alternate" href="https://kairos.io/kairos-docs/docs/next/Installation/trustedboot" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Installation","item":"https://kairos.io/kairos-docs/docs/next/category/installation"},{"@type":"ListItem","position":2,"name":"Trusted Boot","item":"https://kairos.io/kairos-docs/docs/next/Installation/trustedboot"}]}</script><link rel="alternate" type="application/rss+xml" href="/kairos-docs/blog/rss.xml" title="Kairos RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/kairos-docs/blog/atom.xml" title="Kairos Atom Feed">




<script src="https://buttons.github.io/buttons.js" async defer="defer"></script><link rel="stylesheet" href="/kairos-docs/assets/css/styles.c9791132.css">
<script src="/kairos-docs/assets/js/runtime~main.f112c33f.js" defer="defer"></script>
<script src="/kairos-docs/assets/js/main.a6b903dc.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/kairos-docs/img/logo.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/kairos-docs/"><div class="navbar__logo"><img src="/kairos-docs/img/logo.svg" alt="Kairos Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/kairos-docs/img/logo.svg" alt="Kairos Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Kairos</b></a><a class="navbar__item navbar__link" href="/kairos-docs/docs/getting-started">Getting Started</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/kairos-docs/docs/next/getting-started/">Documentation</a><a class="navbar__item navbar__link" href="/kairos-docs/blog">Blog</a><a href="https://kairos.io/community/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Community<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/kairos-docs/docs/next/Installation/trustedboot">Next ðŸš§</a><ul class="dropdown__menu"><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/kairos-docs/docs/next/Installation/trustedboot">Next ðŸš§</a></li><li><a class="dropdown__link" href="/kairos-docs/docs/3.6.0/Installation/trustedboot">3.6.0 (Latest)</a></li><li><a class="dropdown__link" href="/kairos-docs/docs/3.5.7/Installation/trustedboot">3.5.7</a></li></ul></div><div class="navbar__item"><a class="github-button" href="https://github.com/kairos-io/kairos" data-icon="octicon-star" data-size="large" data-show-count="true" aria-label="Star kairos-io/kairos on GitHub">Star</a></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/kairos-docs/docs/next/getting-started/"><span title="Getting Started" class="categoryLinkLabel_W154">Getting Started</span></a><button aria-label="Expand sidebar category &#x27;Getting Started&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--active" href="/kairos-docs/docs/next/category/installation"><span title="Installation" class="categoryLinkLabel_W154">Installation</span></a><button aria-label="Collapse sidebar category &#x27;Installation&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/kairos-docs/docs/next/Installation/check-the-signatures"><span title="Check the Signatures" class="linkLabel_WmDU">Check the Signatures</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/kairos-docs/docs/next/Installation/interactive"><span title="Interactive" class="linkLabel_WmDU">Interactive</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/kairos-docs/docs/next/Installation/manual"><span title="Manual installation" class="linkLabel_WmDU">Manual installation</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/kairos-docs/docs/next/Installation/qrcode"><span title="QR Code" class="linkLabel_WmDU">QR Code</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/kairos-docs/docs/next/Installation/webui"><span title="WebUI" class="linkLabel_WmDU">WebUI</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/kairos-docs/docs/next/Installation/automated"><span title="Automated" class="linkLabel_WmDU">Automated</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/kairos-docs/docs/next/Installation/bare-metal"><span title="Bare-Metal" class="linkLabel_WmDU">Bare-Metal</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/kairos-docs/docs/next/Installation/netboot"><span title="Network booting" class="linkLabel_WmDU">Network booting</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/kairos-docs/docs/next/Installation/p2p"><span title="P2P support" class="linkLabel_WmDU">P2P support</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/kairos-docs/docs/next/Installation/trustedboot"><span title="Trusted Boot" class="linkLabel_WmDU">Trusted Boot</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/kairos-docs/docs/next/Installation/takeover"><span title="Takeover" class="linkLabel_WmDU">Takeover</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" tabindex="0" href="/kairos-docs/docs/next/category/cloud-servers"><span title="Cloud servers" class="categoryLinkLabel_W154">Cloud servers</span></a><button aria-label="Expand sidebar category &#x27;Cloud servers&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" tabindex="0" href="/kairos-docs/docs/next/category/edge-devices"><span title="Edge devices" class="categoryLinkLabel_W154">Edge devices</span></a><button aria-label="Expand sidebar category &#x27;Edge devices&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/kairos-docs/docs/next/category/architecture"><span title="Architecture" class="categoryLinkLabel_W154">Architecture</span></a><button aria-label="Expand sidebar category &#x27;Architecture&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/kairos-docs/docs/next/category/advanced"><span title="Advanced" class="categoryLinkLabel_W154">Advanced</span></a><button aria-label="Expand sidebar category &#x27;Advanced&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/kairos-docs/docs/next/Upgrade/manual"><span title="Upgrade" class="categoryLinkLabel_W154">Upgrade</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/kairos-docs/docs/next/category/reference"><span title="Reference" class="categoryLinkLabel_W154">Reference</span></a><button aria-label="Expand sidebar category &#x27;Reference&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/kairos-docs/docs/next/category/development"><span title="Development" class="categoryLinkLabel_W154">Development</span></a><button aria-label="Expand sidebar category &#x27;Development&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/kairos-docs/docs/next/Examples/boot_assessment_trusted_boot"><span title="Examples" class="categoryLinkLabel_W154">Examples</span></a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="theme-doc-version-banner alert alert--warning margin-bottom--md" role="alert"><div>This is unreleased documentation for <!-- -->Kairos<!-- --> <b>Next ðŸš§</b> version.</div><div class="margin-top--md">For up-to-date documentation, see the <b><a href="/kairos-docs/docs/3.6.0/Installation/trustedboot">latest version</a></b> (<!-- -->3.6.0 (Latest)<!-- -->).</div></div><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/kairos-docs/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/kairos-docs/docs/next/category/installation"><span>Installation</span></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Trusted Boot</span></li></ul></nav><span class="theme-doc-version-badge badge badge--secondary">Version: Next ðŸš§</span><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Trusted Boot Installations</h1></header><p>&quot;Trusted Boot&quot; is a combination of technologies that allows us to guarantee that a system was not tampered with, and the user-data is protected by cold attacks, it is composed by FDE, Secure Boot and Measured Boot.</p>
<p>If you want to learn more on what Trusted Boot is and how it works, see the <a class="" href="/kairos-docs/docs/architecture/trustedboot">Trusted Boot Architecture</a> page. This page describes how to enable Trusted Boot support in Kairos.</p>
<p>Kairos supports Trusted boot by generating specific installable medium. This feature is optional and works alongside how Kairos works.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="requirements">Requirements<a href="#requirements" class="hash-link" aria-label="Direct link to Requirements" title="Direct link to Requirements" translate="no">â€‹</a></h2>
<p>The Hardware that will run Kairos needs to have the following requirements:</p>
<ul>
<li class="">Secure boot available in the system</li>
<li class="">The Hardware should have a TPM chip or fTPM enabled</li>
<li class="">Fast boot disabled at BIOS level ( See also <a href="https://github.com/kairos-io/kairos/issues/2579" target="_blank" rel="noopener noreferrer" class="">https://github.com/kairos-io/kairos/issues/2579</a> )</li>
<li class="">The Hardware should be capable of booting large EFI files (&gt;32MB)</li>
<li class="">Base image of the OS needs to have at least systemd 252 or newer ( for example ubuntu &gt;=23.10 or fedora &gt;=38 )</li>
</ul>
<p>To build the installable medium you need the following installed in the system you use to build the installable medium:</p>
<ul>
<li class="">Docker</li>
<li class="">Git</li>
<li class="">A Linux machine with KVM (for testing the images locally)</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="usage">Usage<a href="#usage" class="hash-link" aria-label="Direct link to Usage" title="Direct link to Usage" translate="no">â€‹</a></h2>
<p>In order to boot into UKI mode, you need to build a special ISO file with the UKI files. To build this medium you have to generate a set of keypairs first: one for the Secure boot and one for the PCR policies required to encrypt the user-data.</p>
<p>Any change, or upgrade of the node to a new version of the OS requires those assets to be regenerated with these keypairs, including the installer ISO, and the EFI files used for upgrading. The keys are used to <em>sign</em> and <em>verify</em> the EFI files, and the PCR policies are used to <em>encrypt</em> and <em>decrypt</em> the user-data, and thus are required to be the same for the whole lifecycle of the node.</p>
<p>The steps below will guide you into generating the installable assets, and how to re-generate the assets to upgrade the node to a new version of the OS.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="key-generation">Key generation<a href="#key-generation" class="hash-link" aria-label="Direct link to Key generation" title="Direct link to Key generation" translate="no">â€‹</a></h2>
<p>Keys can be generated from scratch, or the Microsoft certificates can be used, alternatively, if you can export the keys from your BIOS/UEFI you can use the same PK keys.</p>
<p>By default keys are generated including the Microsoft ones, but you can skip them if you know what you are doing (see below).</p>
<p>To generate the Secure boot certificates and keys along with the Microsoft keys run the following commands:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">MY_ORG=&quot;Acme Corp&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Generate the keys</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker run -v $PWD/keys:/work/keys -ti --rm quay.io/kairos/auroraboot:latest genkey --expiration-in-days 365 -o /work/keys &quot;$MY_ORG&quot;</span><br></span></code></pre></div></div>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>Warning</div><div class="admonitionContent_BuS1"><p>Substitute <code>$MY_ORG</code> for your own string, this can be anything but it help identifying the Keys. The keys duration can specified with <code>--expiration-in-days</code>. It is not possible to create keys that do not expire, but it is possible to specify an extremely large value (e.g. 200 years, etc.)</p></div></div>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>Warning</div><div class="admonitionContent_BuS1"><p>It is very important to preserve the keys generated in this process in a safe place. Loosing the keys will prevent you to generate new images that can be used for upgrades.</p></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="custom-certificates-by-skipping-microsoft-certificate-keys">Custom certificates by skipping Microsoft certificate keys<a href="#custom-certificates-by-skipping-microsoft-certificate-keys" class="hash-link" aria-label="Direct link to Custom certificates by skipping Microsoft certificate keys" title="Direct link to Custom certificates by skipping Microsoft certificate keys" translate="no">â€‹</a></h3>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>Warning</div><div class="admonitionContent_BuS1"><p>Some firmware is signed and verified with Microsoft&#x27;s or other vendor keys when secure boot is enabled. Removing those keys could brick them. It is preferable to not use the Microsoft certificates for precaution and security reasons, however as this might be potentially a dangerous action, only do this if you know what you are doing. To check if your firmware is signed with Microsoft&#x27;s keys, you can check <a href="https://github.com/Foxboron/sbctl/wiki/FAQ#option-rom" target="_blank" rel="noopener noreferrer" class="">https://github.com/Foxboron/sbctl/wiki/FAQ#option-rom</a>. See also: <a href="https://wiki.archlinux.org/title/Unified_Extensible_Firmware_Interface/Secure_Boot#Enrolling_Option_ROM_digests" target="_blank" rel="noopener noreferrer" class="">https://wiki.archlinux.org/title/Unified_Extensible_Firmware_Interface/Secure_Boot#Enrolling_Option_ROM_digests</a>.</p></div></div>
<p>If your hardware supports booting with custom Secure Boot keys, you can optionally create keys from scratch and skip the Microsoft certificate keys. To do so, run the following command:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">MY_ORG=&quot;Acme Corp&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Generate the keys</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker run -v $PWD/keys:/work/keys -ti --rm quay.io/kairos/auroraboot:latest genkey --skip-microsoft-certs-I-KNOW-WHAT-IM-DOING --expiration-in-days 365 -o /work/keys &quot;$MY_ORG&quot;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="exporting-keys-from-biosuefi-and-using-them">Exporting keys from BIOS/UEFI and using them<a href="#exporting-keys-from-biosuefi-and-using-them" class="hash-link" aria-label="Direct link to Exporting keys from BIOS/UEFI and using them" title="Direct link to Exporting keys from BIOS/UEFI and using them" translate="no">â€‹</a></h3>
<p>This is useful if you want to handle mass-installations where you don&#x27;t want to enroll the generated keys manually in your bios/uefi.</p>
<p>Some hardware might require additional vendor keys, that could be e.g. used to sign additional firmware. In order to re-use the same set of keys in the machine, you can export the keys from the BIOS/UEFI and use them to generate the UKI files.</p>
<p>Some BIOS/UEFI allows to export the keys to USB stick directly from the BIOS/UEFI setup menu (for example <a href="https://techlibrary.hpe.com/docs/iss/proliant-gen10-uefi/GUID-26E9F167-8061-4D85-9A0A-B610D00DFA3B.html" target="_blank" rel="noopener noreferrer" class="">HPE</a>). If you have the keys in a USB stick, you can copy in a directory and use them to generate the UKI files.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">MY_ORG=&quot;Acme Corp&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MACHINE_CERTS=&quot;$PWD/path/to/machine-certs&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># ~$ tree $MACHINE_CERTS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># /path/to/machine-certs/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># â”œâ”€â”€ db</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># â”œâ”€â”€ dbx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># â”œâ”€â”€ KEK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># â””â”€â”€ PK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Generate the keys</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker run -v $MACHINE_CERTS:/work/machine-keys -v $PWD/keys:/work/keys -ti --rm quay.io/kairos/auroraboot:latest genkey --custom-cert-dir /work/machine-keys --expiration-in-days 365 -o /work/keys &quot;$MY_ORG&quot;</span><br></span></code></pre></div></div>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>Warning</div><div class="admonitionContent_BuS1"><p>This command can be combined with the <code>--skip-microsoft-certs-I-KNOW-WHAT-IM-DOING</code> flag to avoid auto-enrolling the Microsoft keys if not needed (or already present in the &quot;custom certs&quot;)</p></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="using-a-hardware-key-for-signing">Using a hardware key for signing<a href="#using-a-hardware-key-for-signing" class="hash-link" aria-label="Direct link to Using a hardware key for signing" title="Direct link to Using a hardware key for signing" translate="no">â€‹</a></h2>
<p>You can use hardware keys which are compatible with the <em>PKCS #11</em> standard,  like for example a <a href="https://www.nitrokey.com/" target="_blank" rel="noopener noreferrer" class="">nitrokey</a> to sign the UKI files. In order to do so, you need to have the keys generated in the hardware key and then generate a certificate signed by the key like so:</p>
<p>Generate your key in the hardware key, for example with a nitrokey:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">gpg --card-edit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># In the gpg console, run the following commands:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">admin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">generate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Follow the instructions to generate the key, you can use the default values</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># After the key is generated, you can run the following command to list the keys:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ pkcs11-tool --module opensc-pkcs11.so -L                        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Available slots:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Slot 0 (0x0): Nitrokey Nitrokey Start (FSIJ-1.2.19-C5B562D9) 00 00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  token label        : OpenPGP card (User PIN)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  token manufacturer : OpenPGP project</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  token model        : PKCS#15 emulated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  token flags        : login required, rng, token initialized, PIN initialized</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  hardware version   : 2.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  firmware version   : 2.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  serial num         : fffec5b562d9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  pin min/max        : 6/127</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  uri                : pkcs11:model=PKCS%2315%20emulated;manufacturer=OpenPGP%20project;serial=fffec5b562d9;token=OpenPGP%20card%20%28User%20PIN%29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Slot 1 (0x1): Nitrokey Nitrokey Start (FSIJ-1.2.19-C5B562D9) 00 00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  token label        : OpenPGP card (User PIN (sig))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  token manufacturer : OpenPGP project</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  token model        : PKCS#15 emulated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  token flags        : login required, rng, token initialized, PIN initialized</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  hardware version   : 2.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  firmware version   : 2.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  serial num         : fffec5b562d9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  pin min/max        : 6/127</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  uri                : pkcs11:model=PKCS%2315%20emulated;manufacturer=OpenPGP%20project;serial=fffec5b562d9;token=OpenPGP%20card%20%28User%20PIN%20%28sig%29%29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># You can use the slot-id and id to refer to the key in the hardware key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># For example, to refer to the key in slot 1, you can use the following pkcs11 url:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># pkcs11:slot-id=1;id=%01</span><br></span></code></pre></div></div>
<p>Now create your SSL config in order to use the hardware key to sign the certificate:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ cat &lt;&lt;EOF &gt; openssl-pkcs11.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">openssl_conf = openssl_init</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[openssl_init]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">providers = provider_sect</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[provider_sect]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">default = default_sect</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">base = base_sect</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pkcs11 = pkcs11_sect</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[default_sect]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">activate = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[base_sect]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">activate = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[pkcs11_sect]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">activate = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pkcs11-module-path = /usr/lib/pkcs11/opensc-pkcs11.so # Change to the path of yours, can differ by OS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span></code></pre></div></div>
<p>Generate a certificate signing request (CSR) with the private key in the hardware key:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ OPENSSL_CONF=openssl-pkcs11.conf openssl req -new  -key &quot;pkcs11:slot-id=1;id=%01&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -sha256 -out nitrokey.csr.pem -subj &quot;/CN=SecureBoot Key/&quot;</span><br></span></code></pre></div></div>
<blockquote>
<p>You can append ;pin-value=&lt;YOUR USER PIN&gt; to the pkcs11 url to not have to write it. If you don&#x27;t add it, openssl will ask you for it</p>
</blockquote>
<p>Sign the CSR with the private key in the hardware key:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ OPENSSL_CONF=openssl-pkcs11.conf openssl x509 -req -days 3650 -in nitrokey.csr.pem \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -signkey &quot;pkcs11:slot-id=1;id=%01&quot; -out nitrokey.crt.pem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Now you can use the hardware key and certificate to sign the UKI files.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## Building installable medium</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">To build the installable medium you need to run the following commands:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#TODO -&gt; fix this</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[//]: # (&lt;Tabs&gt;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[//]: # (&lt;TabItem value=&quot;from-a-container-image&quot; label=&quot;From a container image&quot;&gt;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[//]: # (```bash title=&quot;Ubuntu 24.04, Fedora 40&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[//]: # (CONTAINER_IMAGE=quay.io/kairos/kairos-core:latest-uki)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[//]: # (docker run -ti --rm -v $PWD/build:/result -v $PWD/keys/:/keys quay.io/kairos/auroraboot:latest build-uki -t iso -d /result/ --public-keys /keys --tpm-pcr-private-key $PATH_TO_TPM_KEY --sb-key $PATH_TO_SB_KEY --sb-cert $PATH_TO_SB_CERT $CONTAINER_IMAGE)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[//]: # (# to build an EFI file only)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[//]: # (docker run -ti --rm -v $PWD/build:/result -v $PWD/keys/:/keys quay.io/kairos/auroraboot:latest build-uki -t uki -d /result/ --public-keys /keys --tpm-pcr-private-key $PATH_TO_TPM_KEY --sb-key $PATH_TO_SB_KEY --sb-cert $PATH_TO_SB_CERT $CONTAINER_IMAGE)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[//]: # (```)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[//]: # (&lt;/TabItem&gt;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[//]: # (&lt;TabItem value=&quot;from-a-directory&quot; label=&quot;From a directory&quot;&gt;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[//]: # (```bash)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[//]: # (# Assuming you have a &quot;rootfs&quot; directory with the content of the OS)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[//]: # (# If the image is in a directory &amp;#40;$PWD/rootfs&amp;#41; you can use the following command)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[//]: # (docker run -ti --rm -v $PWD/build:/result -v $PWD/rootfs:/rootfs -v $PWD/keys/:/keys quay.io/kairos/auroraboot:latest build-uki -t iso -d /result/ --public-keys /keys --tpm-pcr-private-key $PATH_TO_TPM_KEY --sb-key $PATH_TO_SB_KEY --sb-cert $PATH_TO_SB_CERT dir:/rootfs/)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[//]: # (```)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[//]: # (&lt;/TabItem&gt;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[//]: # (&lt;/Tabs&gt;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Let&#x27;s explain some of the flags used here, especially the ones related to Trusted Boot keys:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- `-t iso` specifies that the output should be an installable medium (ISO file). You can use `-t uki` to generate an EFI file only. Or `-t container` to generate a container image with the UKI files on it, perfect to push to a remote registry for upgrades.\</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- `-d /result/` specifies the output directory where the output type will be saved.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- `--tpm-pcr-private-key` specifies the path to the private key used to sign the PCR policies. This is required for the user-data encryption.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- `--sb-key` specifies the path to the Secure Boot key used to sign the UKI files.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- `--sb-cert` specifies the path to the Secure Boot certificate used to sign the UKI files.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- `--public-keys /keys` specifies the directory where the public keys are stored. These are the keys that are auto enrolled on first boot. They are 3 (DB,KEK, PK) and are in .auth format.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">:::info[Keys format]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The .auth format in Secure Boot refers to EFI Signature Lists (ESLs) wrapped in an authentication structure, which allows UEFI firmware to verify and install Secure Boot keys securely. These files are used when manually enrolling Secure Boot keys into a UEFI system, typically through the firmware setup interface. `.auth` files are signed versions of `.esl` files. An `.esl` file is a binary format defined by the UEFI specification that wraps one or more EFI Signature Data entries (usually X.509 certs or SHA256 hashes).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">:::</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">For a more secure process you can use a hardware key to generate and sign the certificate and sign the EFI files, so you dont need to keep the private key in the filesystem.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">To do so, `--sb-key` accepts a pkcs11 url, for example:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">```bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker run -ti --rm -v /run/pcscd:/run/pcscd -v $PWD/build:/result -v $PWD/keys/:/keys quay.io/kairos/auroraboot:latest build-uki -t iso -d /result/ --public-keys /keys --tpm-pcr-private-key $PATH_TO_TPM_KEY --sb-key &quot;pkcs11:slot-id=1;id=%01&quot; --sb-cert $PATH_TO_SB_CERT $CONTAINER_IMAGE</span><br></span></code></pre></div></div>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>Warning</div><div class="admonitionContent_BuS1"><p>Notice that for this to work you need to have the <code>pcscd</code> service running in your system, and the hardware key must be connected to the system.
The command mounts the <code>/run/pcscd</code> directory to the container, so that the container can access the hardware key.</p></div></div>
<p>For more info about pkcs11 urls, see the <a href="https://www.rfc-editor.org/rfc/rfc7512.html" target="_blank" rel="noopener noreferrer" class="">RFC 7512</a> which describes the format of the pkcs11 urls.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="bundling-system-extensions-during-the-installable-medium-build">Bundling system extensions during the installable medium build<a href="#bundling-system-extensions-during-the-installable-medium-build" class="hash-link" aria-label="Direct link to Bundling system extensions during the installable medium build" title="Direct link to Bundling system extensions during the installable medium build" translate="no">â€‹</a></h2>
<p>System extensions can be bundled in the installable medium. To bundle system extensions, you need to create a new image with the extensions you want to add. System extensions are bundled in the root on the media install. When building your Trusted Boot image, you can add the system extensions to the iso by using the <code>--overlay-iso</code> flag and pointing it to the directory containing the system extensions.</p>
<div class="theme-tabs-container tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">From a container image</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">From a directory</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">Ubuntu+24.04,Fedora+40</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Assuming your system extensions are stored on $PWD/system-extensions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CONTAINER_IMAGE=quay.io/kairos/kairos-core:latest-uki</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker run -ti --rm -v $PWD/system-extensions:/system-extensions -v $PWD/build:/result -v $PWD/keys/:/keys quay.io/kairos/auroraboot:latest build-uki -t iso -d /result/ --public-keys /keys --tpm-pcr-private-key $PATH_TO_TPM_KEY --sb-key $PATH_TO_SB_KEY --sb-cert $PATH_TO_SB_CERT --overlay-iso /system-extensions $CONTAINER_IMAGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># to build an EFI file only</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker run -ti --rm -v $PWD/build:/result -v $PWD/keys/:/keys quay.io/kairos/auroraboot:latest build-uki -t uki -d /result/ --public-keys /keys --tpm-pcr-private-key $PATH_TO_TPM_KEY --sb-key $PATH_TO_SB_KEY --sb-cert $PATH_TO_SB_CERT $CONTAINER_IMAGE</span><br></span></code></pre></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Assuming you have a &quot;rootfs&quot; directory with the content of the OS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># If the image is in a directory ($PWD/rootfs) you can use the following command</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Assuming your system extensions are stored on $PWD/system-extensions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker run -ti --rm -v $PWD/system-extensions:/system-extensions -v $PWD/build:/result -v $PWD/rootfs:/rootfs -v $PWD/keys/:/keys quay.io/kairos/auroraboot:latest build-uki -t iso -d /result/ --public-keys /keys --tpm-pcr-private-key $PATH_TO_TPM_KEY --sb-key $PATH_TO_SB_KEY --sb-cert $PATH_TO_SB_CERT --overlay-iso /system-extensions dir:/rootfs/</span><br></span></code></pre></div></div></div></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="config-files">Config files<a href="#config-files" class="hash-link" aria-label="Direct link to Config files" title="Direct link to Config files" translate="no">â€‹</a></h3>
<p>Included in the artifact will be a configuration file. On the installation/upgrade media, it is called <code>norole.conf</code> but once it has been installed it will be named <code>active.conf</code>, <code>passive.conf</code> or <code>recovery.conf</code> which represents the configuration for the &quot;cos&quot;, &quot;fallback&quot; and &quot;recovery&quot; images respectively.</p>
<p>This configuration file includes the &quot;title&quot; of the artifact in the boot menu and the location of the &quot;efi&quot; file to boot. Here&#x27;s an example:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># cat /efi/loader/entries/active.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">efi /EFI/kairos/active.efi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">title Kairos</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="branding">Branding<a href="#branding" class="hash-link" aria-label="Direct link to Branding" title="Direct link to Branding" translate="no">â€‹</a></h3>
<p>You can overwrite the default &quot;Kairos&quot; title if you pass the <code>--boot-branding</code> flag to auroraboot.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">Ubuntu+24.04,Fedora+40</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">CONTAINER_IMAGE=quay.io/kairos/kairos-core:latest-uki</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker run -ti --rm -v $PWD/build:/result -v $PWD/keys/:/keys quay.io/kairos/auroraboot:latest build-uki -t iso -d /result/ --public-keys /keys --tpm-pcr-private-key $PATH_TO_TPM_KEY --sb-key $PATH_TO_SB_KEY --sb-cert $PATH_TO_SB_CERT --boot-branding &quot;My Awesome OS&quot; $CONTAINER_IMAGE</span><br></span></code></pre></div></div>
<p>Your config file should look now like this:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># cat /efi/loader/entries/active.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">efi /EFI/kairos/active.efi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">title My Awesome OS</span><br></span></code></pre></div></div>
<p>You can use a custom boot splash screen by specifying the  <code>--splash</code> flag when calling auroraboot.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">Ubuntu+24.04,Fedora+40</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">CONTAINER_IMAGE=quay.io/kairos/kairos-core:latest-uki</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker run -ti --rm -v $PWD/build:/result -v $PWD/keys/:/keys -v $PWD/splash/:/splash quay.io/kairos/auroraboot:latest build-uki -t iso -d /result/ --public-keys /keys --tpm-pcr-private-key $PATH_TO_TPM_KEY --sb-key $PATH_TO_SB_KEY --sb-cert $PATH_TO_SB_CERT --boot-branding &quot;My Awesome OS&quot; --splash /splash/my-awesome-splash.bmp $CONTAINER_IMAGE</span><br></span></code></pre></div></div>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>Info</div><div class="admonitionContent_BuS1"><p>Splash images must be provided in 32 bit BMP format, no other image formats besides BMP are supported.</p></div></div>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>Warning</div><div class="admonitionContent_BuS1"><p>Remember when you build upgrade mediums, to also add your branding, otherwise the new active image will be named differently than your fallback and recovery ones.</p></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="version-and-cmdline-in-the-config-files">Version and cmdline in the config files<a href="#version-and-cmdline-in-the-config-files" class="hash-link" aria-label="Direct link to Version and cmdline in the config files" title="Direct link to Version and cmdline in the config files" translate="no">â€‹</a></h3>
<p>In addition to having the &quot;title&quot; and &quot;efi&quot; attributes, you can include in the config files the OS &quot;version&quot; and &quot;cmdline&quot;. To do so, pass <code>--include-version-in-config</code> or <code>--include-cmdline-in-config</code> flags to auroraboot.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>Info</div><div class="admonitionContent_BuS1"><p>The cmdline, will only show what is different between the default cmdline and the currently used cmdline. If you pass <code>--include-cmdline-in-config</code> to a default installation, the attribute cmdline will be empty.</p></div></div>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cmdline awesome=true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">title Awesome OS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">efi /EFI/kairos/active.efi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">version latest</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="installation">Installation<a href="#installation" class="hash-link" aria-label="Direct link to Installation" title="Direct link to Installation" translate="no">â€‹</a></h2>
<p>The installation process is performed as usual and the <a class="" href="/kairos-docs/docs/installation">Installation instructions</a> can be followed, however the difference is that user-data will be automatically encrypted (both the OEM and the persistent partition) by using the TPM chip and the Trusted Boot mechanism.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="enroll-the-keys-in-secure-boot">Enroll the keys in Secure Boot<a href="#enroll-the-keys-in-secure-boot" class="hash-link" aria-label="Direct link to Enroll the keys in Secure Boot" title="Direct link to Enroll the keys in Secure Boot" translate="no">â€‹</a></h3>
<p>If your machine is in UEFI setup mode Secure Boot keys will be automatically enrolled. To enter UEFI Setup mode you need to clear the Secure Boot keys (PKs) from the BIOS/UEFI.</p>
<p>If UEFI setup mode is not available, you need to enroll the keys manually in the BIOS/UEFI.</p>
<p>This process can vary depending on the vendor, but in general you need to enter the BIOS/UEFI setup during early boot and import the keys, for an example outline you can check the steps for <a href="https://techlibrary.hpe.com/docs/iss/proliant-gen10-uefi/GUID-E4427875-D123-4BBF-9056-342168478A02.html" target="_blank" rel="noopener noreferrer" class="">HPE Hardware</a>.</p>
<p>A video of the process of importing keys in QEMU is available <a href="https://github.com/kairos-io/kairos/assets/2420543/e45f6a08-ec74-4cfd-bdf0-aeb7b23ac9bc" target="_blank" rel="noopener noreferrer" class="">here</a>.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="upgrades">Upgrades<a href="#upgrades" class="hash-link" aria-label="Direct link to Upgrades" title="Direct link to Upgrades" translate="no">â€‹</a></h2>
<p>See the <a class="" href="/kairos-docs/docs/upgrade/trustedboot">Trusted Boot Upgrade</a> page.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="testing-the-images-locally">Testing the images locally<a href="#testing-the-images-locally" class="hash-link" aria-label="Direct link to Testing the images locally" title="Direct link to Testing the images locally" translate="no">â€‹</a></h2>
<p>To test the ISO file locally QEMU can be used. In order to test Secure Boot components you need an ed2k firmware with secureboot in QEMU. If you don&#x27;t have QEMU locally and/or you don&#x27;t have the correct dependencies you can follow the steps below that build a container image with QEMU and the needed dependencies and use that container to run the ISO file in a VM with Docker.</p>
<ol>
<li class="">Build the container image with the QEMU/Secure Boot dependencies (note to replace disk size/cpu/ram not needed):</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">docker build -t fedora-qemu -&lt;&lt;DOCKER</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FROM fedora</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN dnf install -y dnf-plugins-core</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN dnf config-manager --add-repo http://www.kraxel.org/repos/firmware.repo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN dnf install -y edk2.git-ovmf-x64 qemu</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN dnf install -y swtpm wget</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WORKDIR /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN wget -q https://github.com/mudler/cos-demo-labs/raw/tests/efivars.fd -O /efivars.fd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WORKDIR /work</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN &lt;&lt;EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;#!/bin/bash -ex&quot; &gt;&gt; /entrypoint.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &#x27;[ ! -e /work/disk.img ] &amp;&amp; qemu-img create -f qcow2 &quot;/work/disk.img&quot; 35G&#x27; &gt;&gt; /entrypoint.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &#x27;/usr/bin/qemu-system-x86_64 -drive if=pflash,format=raw,unit=0,file=&quot;/usr/share/edk2/ovmf/OVMF_CODE.secboot.fd&quot;,readonly=on -drive if=pflash,unit=1,format=raw,file=&quot;/efivars.fd&quot; -accel kvm -cpu host -m 8096 -drive file=/work/disk.img,if=none,index=0,media=disk,format=qcow2,id=disk1 -device virtio-blk-pci,drive=disk1,bootindex=0 -boot order=dc -vga virtio -cpu host -smp cores=4,threads=1 -machine q35,smm=on -chardev socket,id=chrtpm,path=/tmp/swtpm-sock -tpmdev emulator,id=tpm0,chardev=chrtpm -device tpm-tis,tpmdev=tpm0 \$@&#x27; &gt;&gt; /entrypoint.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN chmod +x /entrypoint.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ENTRYPOINT [ &quot;/entrypoint.sh&quot; ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DOCKER</span><br></span></code></pre></div></div>
<ol start="2">
<li class="">Start a TPM socket:</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">docker run --privileged --entrypoint swtpm -v $PWD/tpmstate:/tmp --rm -ti fedora-qemu socket --tpmstate dir=/tmp/ --ctrl type=unixio,path=/tmp/swtpm-sock --log level=20 --tpm2</span><br></span></code></pre></div></div>
<p>Note: you need to keep the TPM container up and running for the VM to boot. Run the commands below in another terminal window.</p>
<ol start="3">
<li class="">Run the container image with the ISO file (replace the iso file name with yours):</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">Ubuntu+24.04,Fedora+40</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># console only</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker run --privileged -v $PWD/tpmstate:/tmp -v $PWD:/work -v /dev/kvm:/dev/kvm --rm -ti fedora-qemu -nographic -cdrom kairos-@flavor-@flavorRelease-core-amd64-generic-latest.uki.iso</span><br></span></code></pre></div></div>
<p>Note: To stop the QEMU container you can use <code>Ctrl-a x</code> or <code>Ctrl-a c</code> to enter the QEMU console and then <code>quit</code> to exit.</p>
<ol start="4">
<li class="">After installation, you can run the container image by booting only with the disk</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># console only</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker run --privileged -v $PWD/tpmstate:/tmp -v $PWD:/work -v /dev/kvm:/dev/kvm --rm -ti fedora-qemu -nographic</span><br></span></code></pre></div></div>
<p>Note: you need to keep the TPM container up and running for the VM to boot.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="data-encryption">Data Encryption<a href="#data-encryption" class="hash-link" aria-label="Direct link to Data Encryption" title="Direct link to Data Encryption" translate="no">â€‹</a></h2>
<p>The user-data will be automatically encrypted during installation, along with the OEM and the persistent partition by using the TPM chip and the Trusted Boot mechanism.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="additional-partitions">Additional partitions<a href="#additional-partitions" class="hash-link" aria-label="Direct link to Additional partitions" title="Direct link to Additional partitions" translate="no">â€‹</a></h3>
<p>Additional partitions can be encrypted and specified as part of the cloud-config used during the installation process, for example:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">install</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">extra-partitions</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> second_partition</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">size</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">fs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ext2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">label</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> PARTITION_TWO</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">encrypted_partitions</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> PARTITION_TWO</span><br></span></code></pre></div></div>
<p>A full example can be:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">install</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">device</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;auto&quot;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Install to the biggest drive</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">auto</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Enables auto installation</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">partitions</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">persistent</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">size</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">500</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Set persistent partition to 500MB (otherwise takes the whole disk)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">extra-partitions</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> second_partition</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">size</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">fs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ext2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">label</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> PARTITION_TWO</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">encrypted_partitions</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> PARTITION_TWO</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="notes">Notes<a href="#notes" class="hash-link" aria-label="Direct link to Notes" title="Direct link to Notes" translate="no">â€‹</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="install-additional-files-from-the-installer-iso-to-the-encrypted-portions">Install additional files from the Installer ISO to the encrypted portions<a href="#install-additional-files-from-the-installer-iso-to-the-encrypted-portions" class="hash-link" aria-label="Direct link to Install additional files from the Installer ISO to the encrypted portions" title="Direct link to Install additional files from the Installer ISO to the encrypted portions" translate="no">â€‹</a></h3>
<p>The ISO installer images can be used to install additional content in the encrypted portion of the disk.</p>
<p>The osbuilder image can overlay additional files into the iso. For example specify <code>--overlay-iso /additional/path</code> to have added the files in the folder inside the ISO. The content can be accessed during installation in <code>/run/initramfs/live</code>.
For example, to install content of the ISO inside the OEM partition, and to restore those after a reset we can use the following cloud config:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">#cloud-config</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">install</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">device</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;/dev/vda&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">auto</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">partitions</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">oem</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">size</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">fs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ext4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">users</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;kairos&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">passwd</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;kairos&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">stages</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">after-install</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">commands</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> echo &quot;Copying files to oem and persistent&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> /usr/lib/systemd/systemd</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">cryptsetup attach persistent $(findfs PARTLABEL=persistent) </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> tpm2</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">device=auto</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> /usr/lib/systemd/systemd</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">cryptsetup attach oem $(findfs PARTLABEL=oem) </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> tpm2</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">device=auto</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> mount /dev/mapper/persistent /usr/local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> mount /dev/mapper/oem /oem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> mkdir </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">p /usr/local/.state/opt.bind</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> mkdir </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">p /oem/opt.bind</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> cp </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">rfv /run/initramfs/live/data/* /usr/local/.state/opt.bind</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> cp </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">rfv /run/initramfs/live/data/* /oem/opt.bind</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> umount /dev/mapper/persistent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> umount /dev/mapper/oem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> cryptsetup close /dev/mapper/persistent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> cryptsetup close /dev/mapper/oem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">after-reset</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">commands</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token scalar string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          /bin/bash &lt;&lt;&#x27;EOF&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          #!/bin/bash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          set </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">e</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          echo &quot;Copying files from oem to persistent&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic"># /oem was mounted in my tests. Let&#x27;s umount it to be sure.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          umount /oem </span><span class="token punctuation" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain"> true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic"># Close all encrypted partitions</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          for p in $(ls /dev/mapper/vda</span><span class="token important">*);</span><span class="token plain"> do cryptsetup close $p; done</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          /usr/lib/systemd/systemd</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">cryptsetup attach persistent $(findfs PARTLABEL=persistent) </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> tpm2</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">device=auto</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          /usr/lib/systemd/systemd</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">cryptsetup attach oem $(findfs PARTLABEL=oem) </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> tpm2</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">device=auto</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          mount /dev/mapper/persistent /usr/local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          mount /dev/mapper/oem /oem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          mkdir </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">p /usr/local/.state/opt.bind</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          cp </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">rfv /oem/opt.bind/* /usr/local/.state/opt.bind</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          umount /dev/mapper/persistent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          umount /dev/mapper/oem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          cryptsetup close /dev/mapper/persistent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          cryptsetup close /dev/mapper/oem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          EOF</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="mount-partitions-after-install">Mount partitions after install<a href="#mount-partitions-after-install" class="hash-link" aria-label="Direct link to Mount partitions after install" title="Direct link to Mount partitions after install" translate="no">â€‹</a></h3>
<p><code>/oem</code> and <code>/usr/local</code> can be mounted after installation to prepare content before first-boot.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Note: replace /dev/vda2 with the oem partition location (see with `blkid`)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># [root@ ~]# blkid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># /dev/sr0: BLOCK_SIZE=&quot;2048&quot; UUID=&quot;2024-02-05-17-00-05-00&quot; LABEL=&quot;UKI_ISO_INSTALL&quot; TYPE=&quot;iso9660&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># /dev/vda2: UUID=&quot;8bfa06f9-ca4f-56dc-90c9-49cf20f4f45e&quot; TYPE=&quot;crypto_LUKS&quot; PARTLABEL=&quot;oem&quot; PARTUUID=&quot;63deb673-ec99-46f6-9cb6-8399315e4f19&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># /dev/vda3: UUID=&quot;85c39d0f-4867-5227-8334-f5eec606d9eb&quot; TYPE=&quot;crypto_LUKS&quot; PARTLABEL=&quot;persistent&quot; PARTUUID=&quot;d01d9b51-d61a-4b7e-bb1a-8af5c212a213&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># /dev/vda1: LABEL_FATBOOT=&quot;COS_GRUB&quot; LABEL=&quot;COS_GRUB&quot; UUID=&quot;1C4C-97AA&quot; BLOCK_SIZE=&quot;512&quot; TYPE=&quot;vfat&quot; PARTLABEL=&quot;efi&quot; PARTUUID=&quot;6e42d80e-d67a-462b-b99c-2c1b5dda91cf&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># /dev/mapper/oem: LABEL=&quot;COS_OEM&quot; UUID=&quot;d10fc63d-9387-442c-9db8-a00e081858ec&quot; BLOCK_SIZE=&quot;1024&quot; TYPE=&quot;ext4&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Mount OEM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/usr/lib/systemd/systemd-cryptsetup attach oem $(findfs PARTLABEL=oem) - tpm2-device=auto</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mount /dev/mapper/oem /oem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Mount persistent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/usr/lib/systemd/systemd-cryptsetup attach persistent $(findfs PARTLABEL=persistent) - tpm2-device=auto</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mount /dev/mapper/persistent /usr/local</span><br></span></code></pre></div></div>
<p>To mount <code>/oem</code> and <code>/usr/local</code> after install you can also manually call <code>kcrypt unlock-all</code>. However this isn&#x27;t <a href="https://github.com/kairos-io/kairos/issues/2217" target="_blank" rel="noopener noreferrer" class="">supported yet</a>.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="force-certificates-auto-enrollments">Force certificates auto-enrollments<a href="#force-certificates-auto-enrollments" class="hash-link" aria-label="Direct link to Force certificates auto-enrollments" title="Direct link to Force certificates auto-enrollments" translate="no">â€‹</a></h3>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>Warning</div><div class="admonitionContent_BuS1"><p>Don&#x27;t run auto-enrollments by default! this option is here after you are sure that the certificates generated are correct and after you have verified that manuall enrolling the certificates does not brick your device!</p><p>This is specific for large-scale deployments to generate auto-installing ISOs that are meant to be used on similar hardware multiple times (thus the process only needs to be manually verified once).</p></div></div>
<p>If you want to force the auto-enrollment of the certificates in the BIOS/UEFI, you can use the <code>--secure-boot-enroll</code> flag in the <code>build-uki</code> command.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">Ubuntu+24.04,Fedora+40</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">CONTAINER_IMAGE=quay.io/kairos/kairos-core:latest-uki</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker run -ti --rm -v $PWD/build:/result -v $PWD/keys/:/keys quay.io/kairos/auroraboot:latest build-uki --secure-boot-enroll force -t iso -d /result/ --public-keys /keys --tpm-pcr-private-key $PATH_TO_TPM_KEY --sb-key $PATH_TO_SB_KEY --sb-cert $PATH_TO_SB_CERT $CONTAINER_IMAGE</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="additional-efi-entries">Additional efi entries<a href="#additional-efi-entries" class="hash-link" aria-label="Direct link to Additional efi entries" title="Direct link to Additional efi entries" translate="no">â€‹</a></h3>
<p>When booting in UKI mode, the cmdline is part of the signed artifact. This means that in order to pass additional options through the cmdline,
this has to be done at build time. For that reason, <code>auroraboot build-uki</code> supports the following arguments:</p>
<ul>
<li class=""><code>--extend-cmdline</code>: Use this option to add cmdline parameters to the default entries (active/passive/recovery/auto-reset). This option will not generate additional entries in the systemd-boot menu.</li>
<li class=""><code>--extra-cmdline</code>: Use this option to generate additional entries in the systemd-boot menu. For each one of the default entries, a new entry will be created with the specified cmdline (added to the default cmdline).</li>
<li class=""><code>--single-efi-cmdline</code>: Use this option to generate entries that are not related to default ones. This option will generate a single entry with the provided cmdline (added to the default cmdline). This argument can be used multiple times.</li>
</ul>
<p>Examples:</p>
<p>Building with a command like this:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">auroraboot build-uki ...more options... --single-efi-cmdline &quot;Lets debug: rd.debug rd.immucore.debug&quot;</span><br></span></code></pre></div></div>
<p>Will create a boot menu with the default entries, plus one more: &quot;Lets debug&quot; which will have the debug parameters set.
Notice how the title of the entry and the cmdline to be used are split by a colon.</p>
<p>Building with a command like this:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">auroraboot build-uki ...more options... --extra-cmdline &quot;rd.debug rd.immucore.debug&quot;</span><br></span></code></pre></div></div>
<p>Will create a boot menu with the default entries, plus one more for each of the active/passive/recovery entries. Each of these entries will have the debug parameters set.</p>
<p>Building with a command like this:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">auroraboot build-uki ...more options... --extend-cmdline &quot;rd.debug rd.immucore.debug&quot;</span><br></span></code></pre></div></div>
<p>Will create a boot menu with just the default entries but this time they will have the debug parameters set.</p>
<p>NOTE: <code>--boot-branding</code> is applied to <code>--single-efi-cmdline</code> too. For example, this command:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">auroraboot build-uki ...more options... --boot-branding &quot;My awesome OS&quot; --single-efi-cmdline &quot;Debug logs: rd.debug rd.immucore.debug&quot;</span><br></span></code></pre></div></div>
<p>will create this entry:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">My awesome OS (Debug logs)</span><br></span></code></pre></div></div>
<p>with the additional cmdline parameters.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col noPrint_WFHX"><a href="https://github.com/kairos-io/kairos-docs/tree/main/docs/Installation/trustedboot.mdx" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2025-12-06T17:56:03.000Z" itemprop="dateModified">Dec 6, 2025</time></b> by <b>Jasper De Keukelaere (imec)</b></span></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/kairos-docs/docs/next/Installation/p2p"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">P2P support</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/kairos-docs/docs/next/Installation/takeover"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Takeover</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#requirements" class="table-of-contents__link toc-highlight">Requirements</a></li><li><a href="#usage" class="table-of-contents__link toc-highlight">Usage</a></li><li><a href="#key-generation" class="table-of-contents__link toc-highlight">Key generation</a><ul><li><a href="#custom-certificates-by-skipping-microsoft-certificate-keys" class="table-of-contents__link toc-highlight">Custom certificates by skipping Microsoft certificate keys</a></li><li><a href="#exporting-keys-from-biosuefi-and-using-them" class="table-of-contents__link toc-highlight">Exporting keys from BIOS/UEFI and using them</a></li></ul></li><li><a href="#using-a-hardware-key-for-signing" class="table-of-contents__link toc-highlight">Using a hardware key for signing</a></li><li><a href="#bundling-system-extensions-during-the-installable-medium-build" class="table-of-contents__link toc-highlight">Bundling system extensions during the installable medium build</a><ul><li><a href="#config-files" class="table-of-contents__link toc-highlight">Config files</a></li><li><a href="#branding" class="table-of-contents__link toc-highlight">Branding</a></li><li><a href="#version-and-cmdline-in-the-config-files" class="table-of-contents__link toc-highlight">Version and cmdline in the config files</a></li></ul></li><li><a href="#installation" class="table-of-contents__link toc-highlight">Installation</a><ul><li><a href="#enroll-the-keys-in-secure-boot" class="table-of-contents__link toc-highlight">Enroll the keys in Secure Boot</a></li></ul></li><li><a href="#upgrades" class="table-of-contents__link toc-highlight">Upgrades</a></li><li><a href="#testing-the-images-locally" class="table-of-contents__link toc-highlight">Testing the images locally</a></li><li><a href="#data-encryption" class="table-of-contents__link toc-highlight">Data Encryption</a><ul><li><a href="#additional-partitions" class="table-of-contents__link toc-highlight">Additional partitions</a></li></ul></li><li><a href="#notes" class="table-of-contents__link toc-highlight">Notes</a><ul><li><a href="#install-additional-files-from-the-installer-iso-to-the-encrypted-portions" class="table-of-contents__link toc-highlight">Install additional files from the Installer ISO to the encrypted portions</a></li><li><a href="#mount-partitions-after-install" class="table-of-contents__link toc-highlight">Mount partitions after install</a></li><li><a href="#force-certificates-auto-enrollments" class="table-of-contents__link toc-highlight">Force certificates auto-enrollments</a></li><li><a href="#additional-efi-entries" class="table-of-contents__link toc-highlight">Additional efi entries</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Documentation</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/kairos-docs/docs/getting-started">Getting Started</a></li><li class="footer__item"><a class="footer__link-item" href="/kairos-docs/docs/installation">Installation</a></li><li class="footer__item"><a class="footer__link-item" href="/kairos-docs/docs/architecture">Architecture</a></li><li class="footer__item"><a class="footer__link-item" href="/kairos-docs/docs/examples">Examples</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://slack.cncf.io/#kairos" target="_blank" rel="noopener noreferrer" class="footer__link-item">Slack<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://github.com/kairos-io/kairos/discussions" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub Discussions<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://www.linkedin.com/company/kairos-oss/" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://x.com/Kairos_OSS" target="_blank" rel="noopener noreferrer" class="footer__link-item">X (Twitter)<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/kairos-docs/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/kairos-io/kairos" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://www.spectrocloud.com/solutions/kairos-support" target="_blank" rel="noopener noreferrer" class="footer__link-item">Commercial Support<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2025 Kairos authors</div></div></div></footer></div>
</body>
</html>