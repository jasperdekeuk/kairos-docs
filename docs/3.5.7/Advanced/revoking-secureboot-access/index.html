<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-3.5.7 docs-doc-page docs-doc-id-Advanced/revoking-secureboot-access" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">Revoking secure boot access | Kairos</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://kairos.io/kairos-docs/img/Kairos_800x419.png"><meta data-rh="true" name="twitter:image" content="https://kairos.io/kairos-docs/img/Kairos_800x419.png"><meta data-rh="true" property="og:url" content="https://kairos.io/kairos-docs/docs/3.5.7/Advanced/revoking-secureboot-access"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="3.5.7"><meta data-rh="true" name="docusaurus_tag" content="docs-default-3.5.7"><meta data-rh="true" name="docsearch:version" content="3.5.7"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-3.5.7"><meta data-rh="true" property="og:title" content="Revoking secure boot access | Kairos"><meta data-rh="true" name="description" content="This document describes how an administrator can prevent certain OS images from"><meta data-rh="true" property="og:description" content="This document describes how an administrator can prevent certain OS images from"><link data-rh="true" rel="icon" href="/kairos-docs/img/logo.svg"><link data-rh="true" rel="canonical" href="https://kairos.io/kairos-docs/docs/3.5.7/Advanced/revoking-secureboot-access"><link data-rh="true" rel="alternate" href="https://kairos.io/kairos-docs/docs/3.5.7/Advanced/revoking-secureboot-access" hreflang="en"><link data-rh="true" rel="alternate" href="https://kairos.io/kairos-docs/docs/3.5.7/Advanced/revoking-secureboot-access" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Advanced","item":"https://kairos.io/kairos-docs/docs/3.5.7/category/advanced"},{"@type":"ListItem","position":2,"name":"Revoking secure boot access","item":"https://kairos.io/kairos-docs/docs/3.5.7/Advanced/revoking-secureboot-access"}]}</script><link rel="alternate" type="application/rss+xml" href="/kairos-docs/blog/rss.xml" title="Kairos RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/kairos-docs/blog/atom.xml" title="Kairos Atom Feed">




<script src="https://buttons.github.io/buttons.js" async defer="defer"></script><link rel="stylesheet" href="/kairos-docs/assets/css/styles.c9791132.css">
<script src="/kairos-docs/assets/js/runtime~main.9f032563.js" defer="defer"></script>
<script src="/kairos-docs/assets/js/main.17196749.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/kairos-docs/img/logo.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/kairos-docs/"><div class="navbar__logo"><img src="/kairos-docs/img/logo.svg" alt="Kairos Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/kairos-docs/img/logo.svg" alt="Kairos Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Kairos</b></a><a class="navbar__item navbar__link" href="/kairos-docs/docs/getting-started">Getting Started</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/kairos-docs/docs/3.5.7/getting-started/">Documentation</a><a class="navbar__item navbar__link" href="/kairos-docs/blog">Blog</a><a href="https://kairos.io/community/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Community<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/kairos-docs/docs/3.5.7/Advanced/revoking-secureboot-access">3.5.7</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/kairos-docs/docs/next/Advanced/revoking-secureboot-access">Next ðŸš§</a></li><li><a class="dropdown__link" href="/kairos-docs/docs/3.6.0/Advanced/revoking-secureboot-access">3.6.0 (Latest)</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/kairos-docs/docs/3.5.7/Advanced/revoking-secureboot-access">3.5.7</a></li></ul></div><div class="navbar__item"><a class="github-button" href="https://github.com/kairos-io/kairos" data-icon="octicon-star" data-size="large" data-show-count="true" aria-label="Star kairos-io/kairos on GitHub">Star</a></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/kairos-docs/docs/3.5.7/getting-started/"><span title="Getting Started" class="categoryLinkLabel_W154">Getting Started</span></a><button aria-label="Expand sidebar category &#x27;Getting Started&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/kairos-docs/docs/3.5.7/category/installation"><span title="Installation" class="categoryLinkLabel_W154">Installation</span></a><button aria-label="Expand sidebar category &#x27;Installation&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/kairos-docs/docs/3.5.7/category/architecture"><span title="Architecture" class="categoryLinkLabel_W154">Architecture</span></a><button aria-label="Expand sidebar category &#x27;Architecture&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/kairos-docs/docs/3.5.7/category/examples"><span title="Examples" class="categoryLinkLabel_W154">Examples</span></a><button aria-label="Expand sidebar category &#x27;Examples&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--active" href="/kairos-docs/docs/3.5.7/category/advanced"><span title="Advanced" class="categoryLinkLabel_W154">Advanced</span></a><button aria-label="Collapse sidebar category &#x27;Advanced&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/kairos-docs/docs/3.5.7/Advanced/after-install"><span title="After install" class="linkLabel_WmDU">After install</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/kairos-docs/docs/3.5.7/Advanced/configuring_partitions"><span title="Configuring partitions" class="linkLabel_WmDU">Configuring partitions</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/kairos-docs/docs/3.5.7/Advanced/creating_custom_cloud_images"><span title="Creating Custom Cloud Images" class="linkLabel_WmDU">Creating Custom Cloud Images</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/kairos-docs/docs/3.5.7/Advanced/customizing"><span title="Customization" class="linkLabel_WmDU">Customization</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/kairos-docs/docs/3.5.7/Advanced/private_registry_auth"><span title="Private registries authentication" class="linkLabel_WmDU">Private registries authentication</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/kairos-docs/docs/3.5.7/Advanced/adding_opt_to_system_extensions"><span title="Using /opt with System Extensions" class="linkLabel_WmDU">Using /opt with System Extensions</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/kairos-docs/docs/3.5.7/Advanced/build"><span title="Build" class="linkLabel_WmDU">Build</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/kairos-docs/docs/3.5.7/Advanced/networking"><span title="Networking" class="linkLabel_WmDU">Networking</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/kairos-docs/docs/3.5.7/Advanced/sys-extensions"><span title="Extending the system with systemd extensions" class="linkLabel_WmDU">Extending the system with systemd extensions</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/kairos-docs/docs/3.5.7/Advanced/bundles"><span title="Bundles" class="linkLabel_WmDU">Bundles</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/kairos-docs/docs/3.5.7/Advanced/partition_encryption"><span title="Encrypting User Data with Kairos" class="linkLabel_WmDU">Encrypting User Data with Kairos</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/kairos-docs/docs/3.5.7/Advanced/coco"><span title="Confidential Computing" class="linkLabel_WmDU">Confidential Computing</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/kairos-docs/docs/3.5.7/Advanced/revoking-secureboot-access"><span title="Revoking secure boot access" class="linkLabel_WmDU">Revoking secure boot access</span></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/kairos-docs/docs/3.5.7/category/upgrade"><span title="Upgrade" class="categoryLinkLabel_W154">Upgrade</span></a><button aria-label="Expand sidebar category &#x27;Upgrade&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/kairos-docs/docs/3.5.7/category/reference"><span title="Reference" class="categoryLinkLabel_W154">Reference</span></a><button aria-label="Expand sidebar category &#x27;Reference&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/kairos-docs/docs/3.5.7/category/development"><span title="Development" class="categoryLinkLabel_W154">Development</span></a><button aria-label="Expand sidebar category &#x27;Development&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="theme-doc-version-banner alert alert--warning margin-bottom--md" role="alert"><div>This is documentation for <!-- -->Kairos<!-- --> <b>3.5.7</b>, which is no longer actively maintained.</div><div class="margin-top--md">For up-to-date documentation, see the <b><a href="/kairos-docs/docs/3.6.0/Advanced/revoking-secureboot-access">latest version</a></b> (<!-- -->3.6.0 (Latest)<!-- -->).</div></div><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/kairos-docs/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/kairos-docs/docs/3.5.7/category/advanced"><span>Advanced</span></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Revoking secure boot access</span></li></ul></nav><span class="theme-doc-version-badge badge badge--secondary">Version: 3.5.7</span><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Revoking secure boot access</h1></header><p>This document describes how an administrator can prevent certain OS images from
booting on their hardware in the context of <a class="" href="/kairos-docs/docs/architecture/trustedboot">&quot;Trusted Boot&quot;</a>.</p>
<p>Two different scenarios will be covered, with the process being only slightly different for each case.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="scenario-1---signing-certificate-is-no-longer-trusted">Scenario 1 - Signing certificate is no longer trusted<a href="#scenario-1---signing-certificate-is-no-longer-trusted" class="hash-link" aria-label="Direct link to Scenario 1 - Signing certificate is no longer trusted" title="Direct link to Scenario 1 - Signing certificate is no longer trusted" translate="no">â€‹</a></h2>
<p>The process of creating signed images that can be trusted to boot, requires the
signing keys to be safe and only accessible to the vendor that produces the OS images.</p>
<p>In the unfortunate case in which a signing certificate has been compromised, it&#x27;s
important that the key is blacklisted on every machine.
Failing to do so, will make it possible for the malicious actor with access to the key,
to generate OS images that the system will accept to boot.
This will allow them boot and decrypt the filesystem, thus gaining full access
to the data on that machine and full control over it.</p>
<p>The UEFI firmware has a special &quot;database&quot; in which blacklisted certificates can
be &quot;enrolled&quot; (image hashes can also be enrolled, but more on that on the next scenario).</p>
<p>If only one machine is running the signed OS images, and physical access to that machine is
possible, then usually the simplest way is to boot into the machine&#x27;s UEFI management utility
and enroll the certificate in the <code>dbx</code> database manually.</p>
<p>If this process has to be performed on thousands of machines remotely, then it&#x27;s clear
that another approach is required.</p>
<p>Before going over the steps on how to &quot;blacklist&quot; a certificate by enrolling it
in <code>dbx</code>, here is some useful information which will make the steps more clear.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="from-pem-to-auth">From &quot;pem&quot; to &quot;auth&quot;<a href="#from-pem-to-auth" class="hash-link" aria-label="Direct link to From &quot;pem&quot; to &quot;auth&quot;" title="Direct link to From &quot;pem&quot; to &quot;auth&quot;" translate="no">â€‹</a></h3>
<p>The signing certificates are usually stored in one of the well known certificate
formats, e.g. &quot;pem&quot;. If a certificate is stored in a different format, it&#x27;s usually
possible to convert to &quot;pem&quot; with some utility. For this reason we will assume
the certificate is in the &quot;pem&quot; format from now on.</p>
<p>There are various utilities in Linux that allow enrolling certificates in the UEFI
databases but they require those certs to be in a specific format usually in the
ESL (EFI Signature List) or the signed version of the same format, the &quot;signed variables&quot;
format. Using the signed version has the benefit that no private keys need to be present
in order to do the enrollement, while using the unsigned format needs the private
keys to be present.</p>
<p>If you followed <a class="" href="/kairos-docs/docs/Installation/trustedboot#key-generation">the instructions to create signing keys</a>, you should have a directory with a <code>db.pem</code> certificate. This is the certificate
we will blacklist. To do so, we need to convert it to the &quot;esl&quot; format and then
sign it to create the final <code>.auth</code> file, which will be used for enrollement.
The utilities used are usually shipped in the various distros under a name like <code>efitools</code> (e.g. in Ubuntu). Here are the commands to generate the needed signed authenticated variables file:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">export UUID=`uuidgen`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cert-to-efi-sig-list -g &quot;Kairos-$UUID&quot; keys/db.pem db-dbx.esl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sign-efi-sig-list -c keys/KEK.pem -k keys/KEK.key dbx db-dbx.esl db-dbx.auth</span><br></span></code></pre></div></div>
<p>(Notice how we sign the <code>.auth</code> file using the &quot;KEK&quot; key so that enrollement is allowed)</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="pcrs-and-disk-encryption">PCRs and disk encryption<a href="#pcrs-and-disk-encryption" class="hash-link" aria-label="Direct link to PCRs and disk encryption" title="Direct link to PCRs and disk encryption" translate="no">â€‹</a></h3>
<p>As described in the <a class="" href="/kairos-docs/docs/architecture/trustedboot">&quot;Trusted Boot&quot;</a> documentation page,
the decryption of the disk partitions is bound to some PCR registers on the TPM chip.
Specifically registers 11 and 7.
There are 2 ways to bind to a PCR register, the direct and the indirect. You can
read more in the <a href="https://www.freedesktop.org/software/systemd/man/latest/systemd-cryptenroll.html#TPM2%20PCRs%20and%20policies" target="_blank" rel="noopener noreferrer" class=""><code>systemd-cryptenroll</code> docs</a> but in a nutshell, the indirect binding
allows the actual value of the PCR to change while the direct one does not.
<strong>For this reason, in Kairos, the decryption is bound indirectly to PCR 11 (which allows
us to upgrade to newer kernels) and directly to PCR 7, which prevents booting if
the UEFI databases have been altered, e.g. by enrolling a new key.</strong></p>
<p>And although this makes sense, security wise, it&#x27;s exactly what we are trying to achieve here. We
want to enroll a certificate in <code>dbx</code>. This would change the value of PCR 7 thus
decryption of the disk partitions will no longer be possible after reboot.</p>
<p>The method we use to overcome this issue is this:</p>
<ul>
<li class="">We &quot;unbind&quot; decryption from PCR 7, binding only to PCR 11 indirectly.</li>
<li class="">We enroll the blacklisted cert in dbx.</li>
<li class="">We reboot to the upgraded system.</li>
<li class="">We bind decryption again both to PCR 11 and 7 (as before).</li>
</ul>
<p>When we rebind to PCR 7, the register has the new value which includes the cert in dbx.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="steps">Steps<a href="#steps" class="hash-link" aria-label="Direct link to Steps" title="Direct link to Steps" translate="no">â€‹</a></h3>
<p>With the above now clarified, here are the steps to revoke the <code>db.pem</code> certificate from user space in Kairos.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="generate-a-new-db-cert">Generate a new db cert<a href="#generate-a-new-db-cert" class="hash-link" aria-label="Direct link to Generate a new db cert" title="Direct link to Generate a new db cert" translate="no">â€‹</a></h4>
<p>Since it&#x27;s only the db key that we are trying to replace, we can start by copying
the original directory generated by <code>auroraboot genkey</code> and remove the old db files.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cp keys new-keys</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rm new-keys/db.*</span><br></span></code></pre></div></div>
<p>Now create the new db files:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">uuidgen --random &gt; GUID.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">openssl req -newkey rsa:4096 -nodes -keyout db.key -new -x509 -sha256 -days 3650 -subj &quot;/CN=NewKairosDB/&quot; -out db.crt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">openssl x509 -outform DER -in db.crt -out db.cer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cert-to-efi-sig-list -g &quot;$(&lt; GUID.txt)&quot; db.crt db.esl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sign-efi-sig-list -g &quot;$(&lt; GUID.txt)&quot; -k KEK.key -c KEK.pem db db.esl db.auth</span><br></span></code></pre></div></div>
<p>If you are planning to use <code>auroraboot build-uki</code> command to prepare the new OS image,
create the following formats too or the command might complain if they are missing:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ openssl x509 -outform der -in db.crt -out db.der</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ openssl x509 -inform DER -outform PEM -in db.der -out db.pem</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="sign-the-new-image-with-the-new-certificate">Sign the new image with the new certificate<a href="#sign-the-new-image-with-the-new-certificate" class="hash-link" aria-label="Direct link to Sign the new image with the new certificate" title="Direct link to Sign the new image with the new certificate" translate="no">â€‹</a></h4>
<p>The <code>new-keys</code> directory created above can be used to prepare the new image with <code>auroraboot</code>. E.g.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">docker run --rm -v $PWD/unpacked:/unpacked \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -v $PWD/build:/result \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -v $PWD/new-keys/:/keys \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  quay.io/kairos/auroraboot:latest \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  build-uki \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --output-dir /result \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --keys /keys \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --output-type container \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --boot-branding &quot;KairosNewUKI&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  dir:/unpacked</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="enroll-the-new-certificate-in-db">Enroll the new certificate in db<a href="#enroll-the-new-certificate-in-db" class="hash-link" aria-label="Direct link to Enroll the new certificate in db" title="Direct link to Enroll the new certificate in db" translate="no">â€‹</a></h4>
<p>From withing Kairos (still booted in the old image), enroll the new db key:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sudo chattr -i /sys/firmware/efi/efivars/{PK,KEK,db}*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">efi-updatevar -f db.auth db</span><br></span></code></pre></div></div>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>Warning</div><div class="admonitionContent_BuS1"><p>You will need the <code>efitools</code> installed on the Kairos image for this commands to work!</p></div></div>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="upgrade-to-the-new-image">Upgrade to the new image<a href="#upgrade-to-the-new-image" class="hash-link" aria-label="Direct link to Upgrade to the new image" title="Direct link to Upgrade to the new image" translate="no">â€‹</a></h4>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kairos-agent upgrade --source oci:myimage</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="unbind-pcr-7">Unbind PCR 7<a href="#unbind-pcr-7" class="hash-link" aria-label="Direct link to Unbind PCR 7" title="Direct link to Unbind PCR 7" translate="no">â€‹</a></h4>
<p>Bind partition encryption only to PCR 11 policy. From within Kairos again:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;Generating temporary passphrase&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dd if=/dev/random bs=32 count=1 of=/tmp/random_keyfile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;Adding password slot&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># We temporarily switch to a passphrase decryption here, so that we can remove the &quot;tpm&quot; decryption</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># option below. After we add the &quot;tpm&quot; option back (bound to different PCR registers),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># we remove the passphrase again.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cryptsetup luksAddKey --token-type systemd-tpm2 /dev/vda2 /tmp/random_keyfile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cryptsetup luksAddKey --token-type systemd-tpm2 /dev/vda3 /tmp/random_keyfile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;Removing the tpm2 slot&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemd-cryptenroll /dev/vda2 --wipe-slot=tpm2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemd-cryptenroll /dev/vda3 --wipe-slot=tpm2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;Adding tpm2 slot again (pcr 11 policy only, no pcr 7)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemd-cryptenroll --unlock-key-file=/tmp/random_keyfile --tpm2-public-key=/run/systemd/tpm2-pcr-public-key.pem --tpm2-public-key-pcrs=11 --tpm2-pcrs= --tpm2-signature=/run/systemd/tpm2-pcr-signature.json --tpm2-device-key=/run/systemd/tpm2-srk-public-key.tpm2b_public /dev/vda2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemd-cryptenroll --unlock-key-file=/tmp/random_keyfile --tpm2-public-key=/run/systemd/tpm2-pcr-public-key.pem --tpm2-public-key-pcrs=11 --tpm2-pcrs= --tpm2-signature=/run/systemd/tpm2-pcr-signature.json --tpm2-device-key=/run/systemd/tpm2-srk-public-key.tpm2b_public /dev/vda3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;Removing the password slot&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemd-cryptenroll --wipe-slot=password /dev/vda2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemd-cryptenroll --wipe-slot=password /dev/vda3</span><br></span></code></pre></div></div>
<p>Make sure you use the correct device paths for your encrypted partitions
(<code>/dev/vda2</code> and <code>/dev/vda3</code> in the example).</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="enroll-the-old-certificate-in-dbx">Enroll the old certificate in dbx<a href="#enroll-the-old-certificate-in-dbx" class="hash-link" aria-label="Direct link to Enroll the old certificate in dbx" title="Direct link to Enroll the old certificate in dbx" translate="no">â€‹</a></h4>
<p>As describe earlier in this document, you should generate a <code>db-dbx.auth</code> file
from the old db key. This should now be enrolled in dbx. In user space again
(booted in the old Kairos image):</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sudo efi-updatevar -f db-dbx.auth dbx</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="reboot-to-the-upgraded-image">Reboot to the upgraded image:<a href="#reboot-to-the-upgraded-image" class="hash-link" aria-label="Direct link to Reboot to the upgraded image:" title="Direct link to Reboot to the upgraded image:" translate="no">â€‹</a></h4>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">reboot</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="bind-again-to-pcr-11-and-7">Bind again to PCR 11 and 7<a href="#bind-again-to-pcr-11-and-7" class="hash-link" aria-label="Direct link to Bind again to PCR 11 and 7" title="Direct link to Bind again to PCR 11 and 7" translate="no">â€‹</a></h4>
<p>After rebooting to the upgraded image, bind the encryption again to PCR 7 (and 11):</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;Generating temporary passphrase&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dd if=/dev/random bs=32 count=1 of=/tmp/random_keyfile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;Adding password slot&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cryptsetup luksAddKey --token-type systemd-tpm2 /dev/vda2 /tmp/random_keyfile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cryptsetup luksAddKey --token-type systemd-tpm2 /dev/vda3 /tmp/random_keyfile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;Removing the tpm2 slot&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemd-cryptenroll /dev/vda2 --wipe-slot=tpm2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemd-cryptenroll /dev/vda3 --wipe-slot=tpm2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;Adding tpm2 slot again (pcr 11 policy AND pcr 7)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;There is probably a bug in systemd preventing us from using the --tpm2-device-key&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;giving this error: &#x27;Must provide all PCR values when using TPM2 device key.&#x27;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;coming from here: https://github.com/systemd/systemd/blob/7c6028bbcbd03f91e1c4b84dcf46b45e9672c2b6/src/cryptenroll/cryptenroll-tpm2.c#L362&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;so we&#x27;ll opt for --tpm-device=auto&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;The command that fails was originally tried in this script:&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;https://github.com/kairos-io/kairos/issues/2429#issuecomment-2136728261&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemd-cryptenroll --unlock-key-file=/tmp/random_keyfile --tpm2-public-key=/run/systemd/tpm2-pcr-public-key.pem --tpm2-public-key-pcrs=11 --tpm2-pcrs=7 --tpm2-signature=/run/systemd/tpm2-pcr-signature.json --tpm2-device=auto /dev/vda2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemd-cryptenroll --unlock-key-file=/tmp/random_keyfile --tpm2-public-key=/run/systemd/tpm2-pcr-public-key.pem --tpm2-public-key-pcrs=11 --tpm2-pcrs=7 --tpm2-signature=/run/systemd/tpm2-pcr-signature.json --tpm2-device=auto /dev/vda3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;Removing the password slot&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemd-cryptenroll --wipe-slot=password /dev/vda2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemd-cryptenroll --wipe-slot=password /dev/vda3</span><br></span></code></pre></div></div>
<p>The following command:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cryptsetup luksDump /dev/vda2 | grep &quot;pcrs: &quot;</span><br></span></code></pre></div></div>
<p>should show output similar to this:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">	tpm2-hash-pcrs:   7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	tpm2-pubkey-pcrs: 11</span><br></span></code></pre></div></div>
<p>which means the decryption is now bound again to PCR 7 (directly) and PCR 11 (indirectly).</p>
<p>This command:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">systemd-cryptenroll /dev/vda2</span><br></span></code></pre></div></div>
<p>should only show <code>tmp2</code> (and not <code>password</code>)</p>
<p>(same thing for <code>/dev/vda3</code>)</p>
<p>You can now reboot to check if everything works correctly</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">reboot</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="verifying-that-it-worked">Verifying that it worked<a href="#verifying-that-it-worked" class="hash-link" aria-label="Direct link to Verifying that it worked" title="Direct link to Verifying that it worked" translate="no">â€‹</a></h4>
<ul>
<li class="">Check what keys are enrolled in UEFI db:</li>
</ul>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mokutil --list-enrolled --db | grep -E &#x27;Issuer:|Subject:&#x27;</span><br></span></code></pre></div></div>
<p>You should find your new certificate in the list</p>
<ul>
<li class="">Check if the old certificate is in dbx:</li>
</ul>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mokutil --list-enrolled --dbx | grep -E &#x27;Issuer:|Subject:&#x27;</span><br></span></code></pre></div></div>
<p>You should find your old certificate in the list.</p>
<ul>
<li class="">Check that the old images are not bootable</li>
</ul>
<p>Just reboot and when presented with the boot menu, select &quot;fallback&quot; or &quot;recovery&quot;.
Since those images haven&#x27;t been upgraded yet, they are still signed with the old
certificate. They should not boot and UEFI should show an error.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="upgrading-recovery">Upgrading recovery<a href="#upgrading-recovery" class="hash-link" aria-label="Direct link to Upgrading recovery" title="Direct link to Upgrading recovery" translate="no">â€‹</a></h4>
<p>After successfully booting to &quot;active&quot;, you can now upgrade <code>recovery</code> to make
can still boot if the next update goes wrong.</p>
<p>Obviously the recovery image will also need to be signed with the new certificate.</p>
<p>The upgrade command is:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kairos-agent upgrade --recovery --source oci:&lt;YOUR_UPGRADE_IMAGE_HERE&gt;</span><br></span></code></pre></div></div>
<p>The &quot;fallback&quot; image will be upgraded on the next upgrade. Read the <a class="" href="/kairos-docs/docs/architecture/container">&quot;Container based&quot;</a>
document to understand more.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="scenario-2---one-specific-image-is-no-longer-trusted">Scenario 2 - One specific image is no longer trusted<a href="#scenario-2---one-specific-image-is-no-longer-trusted" class="hash-link" aria-label="Direct link to Scenario 2 - One specific image is no longer trusted" title="Direct link to Scenario 2 - One specific image is no longer trusted" translate="no">â€‹</a></h2>
<p>In the previous scenario, we assumed that the signing certificate was compromised, which meant no image signed by that certificate should be bootable anymore.</p>
<p>In this scenario, only one specific image is considered &quot;bad&quot;. For example, an image shipped with a well known security vulnerability.
In order to prevent this image from booting, its &quot;hash&quot; can be blacklisted.</p>
<p>The process is exactly the same as above, but instead of enrolling a certificate in the <code>dbx</code> database, we will enroll an image hash.</p>
<p>Follow the same instructions as in scenario 1, but skipping the steps where a new <code>db</code> key is created.</p>
<p>To generate the file which will be enrolled to <code>dbx</code>, we need access to the <code>.efi</code> image.
If there is a system still running the image that is going to be blacklisted,
the file will be: <code>/efi/EFI/kairos/active.efi</code>.</p>
<p>Since the image is not considered safe (that&#x27;s the reason for blacklisting it after all),
it&#x27;s advisable to not boot it or use it for the calculation. If it&#x27;s possible,
boot from another, safe image, mount the efi partition and find the <code>active.efi</code> file
on the disk.</p>
<p>As a last option, if you still have access to the original install ISO that was used to
install the &quot;bad&quot; image, you can extract the <code>.efi</code> file from that using standard linux tools.</p>
<p>The steps to generate the <code>.auth</code> file are (assumes you have <code>efitools</code> installed):</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># generate the esl file</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hash-to-efi-sig-list /efi/EFI/kairos/active.efi active.esl</span><br></span></code></pre></div></div>
<p>Now <code>scp</code> that file to the machine where you have access to the image signing keys generated by auroraboot.
The command to sign the <code>esl</code> file is similar to the one for the certificates:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sign-efi-sig-list -c keys/KEK.pem -k keys/KEK.key dbx active.esl active.auth</span><br></span></code></pre></div></div>
<p><code>active.auth</code> is the file that should be enrolled to <code>dbx</code>, exactly like we did with the <code>db-dbx.auth</code> file
in the previous scenario. The rest of the steps are similar.</p>
<p>Always keep in mind that after enrolling something (key or hash) to dbx, blacklisted OSes won&#x27;t boot.
Make sure you have successfully completed all the needed steps before you reboot, otherwise you may not be able to boot.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col noPrint_WFHX"><a href="https://github.com/kairos-io/kairos-docs/tree/main/versioned_docs/version-3.5.7/Advanced/revoking-secureboot-access.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2025-12-07T21:28:02.000Z" itemprop="dateModified">Dec 7, 2025</time></b> by <b>Jasper De Keukelaere (imec)</b></span></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/kairos-docs/docs/3.5.7/Advanced/coco"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Confidential Computing</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/kairos-docs/docs/3.5.7/category/upgrade"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Upgrade</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#scenario-1---signing-certificate-is-no-longer-trusted" class="table-of-contents__link toc-highlight">Scenario 1 - Signing certificate is no longer trusted</a><ul><li><a href="#from-pem-to-auth" class="table-of-contents__link toc-highlight">From &quot;pem&quot; to &quot;auth&quot;</a></li><li><a href="#pcrs-and-disk-encryption" class="table-of-contents__link toc-highlight">PCRs and disk encryption</a></li><li><a href="#steps" class="table-of-contents__link toc-highlight">Steps</a></li></ul></li><li><a href="#scenario-2---one-specific-image-is-no-longer-trusted" class="table-of-contents__link toc-highlight">Scenario 2 - One specific image is no longer trusted</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Documentation</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/kairos-docs/docs/getting-started">Getting Started</a></li><li class="footer__item"><a class="footer__link-item" href="/kairos-docs/docs/installation">Installation</a></li><li class="footer__item"><a class="footer__link-item" href="/kairos-docs/docs/architecture">Architecture</a></li><li class="footer__item"><a class="footer__link-item" href="/kairos-docs/docs/examples">Examples</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://slack.cncf.io/#kairos" target="_blank" rel="noopener noreferrer" class="footer__link-item">Slack<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://github.com/kairos-io/kairos/discussions" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub Discussions<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://www.linkedin.com/company/kairos-oss/" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://x.com/Kairos_OSS" target="_blank" rel="noopener noreferrer" class="footer__link-item">X (Twitter)<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/kairos-docs/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/kairos-io/kairos" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://www.spectrocloud.com/solutions/kairos-support" target="_blank" rel="noopener noreferrer" class="footer__link-item">Commercial Support<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2025 Kairos authors</div></div></div></footer></div>
</body>
</html>